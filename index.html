<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RGC Pensiones - Calculadora de Proyección</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" type="text/css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --dark-blue: #003366; /* Azul marino profundo */
            --gold: #D4AF37;      /* Oro metálico */
            --dark-gold: #B8860B; /* Oro oscuro para hover */
            --text-dark: #1A202C;  /* Casi negro */
            --text-medium: #4A5568;/* Gris oscuro */
            --bg-light: #F8F9FA;  /* Gris muy claro */
            --white: #FFFFFF;
            --border-color: #E2E8F0;
            --success-color: #16A34A;
            --danger-color: #DC2626;
        }

        body { 
            font-family: 'Montserrat', sans-serif; 
            background-color: var(--bg-light);
            color: var(--text-medium);
        }
        
        /* Encabezado Principal */
        .main-header {
            background: linear-gradient(135deg, var(--dark-blue) 0%, #002244 100%);
            color: var(--white);
            padding: 2.5rem 1rem;
            text-align: center;
            border-radius: 0 0 40px 40px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 3rem;
        }
        .main-header .logo-text {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--gold);
            text-shadow: 1px 1px 3px rgba(0,0,0,0.4);
            letter-spacing: 1px;
        }
        .main-header h1 {
            font-weight: 800;
            font-size: 2.25rem; /* 36px */
            letter-spacing: -0.5px;
            margin-top: 1rem;
        }
        .main-header p {
            font-size: 1.125rem; /* 18px */
            opacity: 0.85;
            font-weight: 400;
        }

        /* Estructura de Secciones */
        .infographic-section {
            background-color: var(--white);
            border-radius: 20px;
            padding: 2rem 2.5rem;
            margin-bottom: 2.5rem;
            box-shadow: 0 8px 30px rgba(0, 51, 102, 0.08);
            border: 1px solid var(--border-color);
            border-top: 6px solid var(--dark-blue);
        }
        .infographic-section h2 {
            font-size: 1.75rem; /* 28px */
            font-weight: 700;
            margin-bottom: 2rem;
            color: var(--dark-blue);
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }
        .infographic-section h2 i {
            margin-right: 1rem;
            font-size: 1.5rem;
            color: var(--gold);
        }
        .infographic-section h3.subsection-title {
            font-size: 1.25rem; /* 20px */
            font-weight: 600;
            color: var(--dark-blue);
            margin-top: 2rem;
            margin-bottom: 1.5rem;
        }
        
        /* Formularios y Entradas */
        .input-group label {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-medium); 
            font-size: 0.875rem; /* 14px */
            display: block;
        }
        .input-group input[type="text"],
        .input-group input[type="password"],
        .input-group input[type="number"],
        .input-group input[type="month"],
        .input-group input[type="date"],
        .input-group select,
        .input-group textarea {
            padding: 0.8rem 1rem;
            border: 1px solid #CBD5E0;
            border-radius: 0.5rem; /* 8px */
            font-size: 1rem;
            width: 100%;
            transition: all 0.2s ease-in-out;
            background-color: #FDFDFD;
        }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            border-color: var(--gold); 
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
            outline: none;
        }
        .input-group input[readonly] {
            background-color: #E9ECEF;
        }
        
        /* Botones */
        .btn {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            padding: 0.8rem 2rem;
            border-radius: 0.5rem;
            transition: all 0.25s ease-out;
            border: none;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn:disabled {
            background: #A0AEC0;
            color: #E2E8F0;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        
        .btn-gold {
            background: linear-gradient(135deg, var(--gold), var(--dark-gold));
            color: var(--dark-blue);
        }
        .btn-gold:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(212, 175, 55, 0.3);
        }

        .btn-blue {
            background: linear-gradient(135deg, var(--dark-blue), #004488);
            color: var(--white);
        }
        .btn-blue:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 51, 102, 0.3);
        }
        
        .btn-secondary {
            background-color: var(--white);
            color: var(--dark-blue);
            border: 2px solid var(--dark-blue);
            padding: 0.7rem 1.5rem;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: var(--dark-blue);
            color: var(--white);
        }
        
        .btn-danger-icon {
            background-color: #FFF1F2;
            color: #E53E3E;
            border: 1px solid #E53E3E;
            padding: 0.5rem;
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }
        .btn-danger-icon:hover {
            background-color: #E53E3E;
            color: var(--white);
        }
        
        /* Employment Card Styles */
        .employment-card {
            background-color: #F8F9FA;
            border: 1px solid #E2E8F0;
            border-left: 5px solid var(--dark-blue);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
        }
        
        /* Login Container */
        #loginContainer {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-light);
            z-index: 40;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }
        #loginContainer.active {
            opacity: 1;
            pointer-events: auto;
        }

        .login-box {
            background-color: var(--white);
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 51, 102, 0.15);
            width: 100%;
            max-width: 450px;
            border-top: 6px solid var(--gold);
        }
        .login-box h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 2rem;
            font-weight: 800;
            color: var(--dark-blue);
            text-align: center;
            margin-bottom: 2.5rem;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 34, 68, 0.7); /* Azul oscuro semi-transparente */
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: var(--white);
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 51, 102, 0.2);
            max-width: 90%;
            width: 650px;
            border-top: 6px solid var(--gold);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        
        .modal-content-alert {
             text-align: center;
             width: 400px;
        }
        
        .modal-content h2 {
             font-family: 'Montserrat', sans-serif;
             color: var(--dark-blue);
             font-size: 1.5rem;
             font-weight: 700;
             text-align: center;
             margin-bottom: 1.5rem;
             padding-bottom: 1rem;
             border-bottom: 1px solid var(--border-color);
        }
        .privacy-text-container {
            border: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            background-color: var(--bg-light);
            max-height: 55vh;
            overflow-y: auto;
            margin-bottom: 1.5rem;
        }
        .privacy-text-container p {
            font-size: 0.875rem; /* 14px */
            line-height: 1.6;
            margin-bottom: 1rem;
        }
        .privacy-text-container::-webkit-scrollbar { width: 8px; }
        .privacy-text-container::-webkit-scrollbar-track { background: var(--border-color); border-radius: 10px; }
        .privacy-text-container::-webkit-scrollbar-thumb { background-color: var(--gold); border-radius: 10px; }

        .app-footer {
            text-align: center;
            margin-top: 4rem;
            padding: 2.5rem 1rem;
            background-color: var(--dark-blue);
            color: var(--white);
            border-radius: 40px 40px 0 0;
        }
        .app-footer .logo-text-footer {
            color: var(--gold);
            font-weight: 700;
            font-size: 1.25rem;
            margin-bottom: 1rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .app-footer p { opacity: 0.8; }

        #sessionTimerContainer {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            color: var(--text-dark);
            z-index: 100;
            transition: color 0.3s;
        }

        /* Menu Styles */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
        }
        .menu-card {
            background: var(--white);
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 8px 30px rgba(0, 51, 102, 0.08);
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }
        .menu-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px rgba(0, 51, 102, 0.12);
        }
        .menu-card i {
            font-size: 3rem;
            color: var(--gold);
            margin-bottom: 1.5rem;
        }
        .menu-card h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--dark-blue);
            margin-bottom: 0.5rem;
        }
        .menu-card p {
            font-size: 0.875rem;
            color: var(--text-medium);
        }
    </style>
</head>
<body>
    <!-- Confidentiality Agreement Modal -->
    <div id="confidentialityModal" class="modal-overlay">
        <div class="modal-content">
            <h2>CARTA COMPROMISO DE CONFIDENCIALIDAD</h2>
            <div class="privacy-text-container">
                 <p><strong>Fecha:</strong> <span id="agreementDate"></span><br><strong>Lugar:</strong> Ciudad de México, México</p>
                <p>En mi calidad de Asesor para RGC Pensiones y Seguros, manifiesto y acepto de manera voluntaria los siguientes términos y condiciones:</p>
                <p><strong>1. ANTECEDENTES</strong><br>Reconozco que, en virtud de mi relación profesional con RGC Pensiones, se me ha proporcionado acceso a una herramienta de software especializada (en adelante, "la Herramienta"), la cual es fundamental para el desempeño de mis funciones.</p>
                <p><strong>2. PROPIEDAD INTELECTUAL</strong><br>Declaro tener pleno conocimiento de que la Herramienta es propiedad intelectual exclusiva del C. Ivan Roberto Ortiz Cano, y que RGC Pensiones cuenta con la licencia y autorización para su uso con fines corporativos específicos. Entiendo que mi acceso a la misma es una concesión temporal y está estrictamente limitado al ejercicio de mis responsabilidades dentro de esta empresa.</p>
                <p><strong>3. COMPROMISO DE USO EXCLUSIVO</strong><br>Me comprometo de manera irrevocable a utilizar la Herramienta única y exclusivamente para los fines y objetivos de negocio de RGC Pensiones.</p>
                <p><strong>4. PROHIBICIONES ESPECÍFICAS</strong><br>Queda estrictamente prohibido y me obligo a abstenerme de:<br>
                a) Utilizar la Herramienta, sus funciones, datos, metodologías o resultados para obtener cualquier tipo de lucro o beneficio personal, directo o indirecto.<br>
                b) Emplear la Herramienta para prestar servicios, asesorías o realizar actividades para terceros, ya sean personas físicas o morales, ajenos a RGC Pensiones.<br>
                c) Copiar, reproducir, modificar, distribuir, vender, sublicenciar, descompilar o realizar ingeniería inversa de la Herramienta o cualquiera de sus componentes.<br>
                d) Compartir mis credenciales de acceso (contraseña o cualquier otra forma de acceso) con cualquier otra persona, dentro o fuera de la organización.</p>
                <p><strong>5. CONSECUENCIAS DEL INCUMPLIMIENTO</strong><br>Entiendo y acepto que el incumplimiento de cualquiera de los puntos estipulados en esta carta será considerado una falta grave y se podrá dar lugar a:<br>
                a) Concluir la relación profesional y comercial con RGC Pensiones, sin responsabilidad para la empresa.<br>
                b) El inicio de acciones legales en mi contra por parte de RGC Pensiones y/o del Sr. Ivan Roberto Ortiz Cano, titular de la propiedad intelectual, para reclamar la reparación de los daños y perjuicios ocasionados.</p>
                <p>Este compromiso mantendrá su vigencia durante toda mi relación con RGC Pensiones y subsistirá incluso después de su terminación, por tiempo indefinido.</p>
                <p>Habiendo leído y comprendido en su totalidad el presente documento, lo acepto de conformidad.</p>
            </div>
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <input type="checkbox" id="agreementCheckbox" class="h-5 w-5 text-blue-600 border-gray-400 rounded focus:ring-gold-500">
                    <label for="agreementCheckbox" class="ml-3 block text-sm text-gray-700 font-medium">
                        He leído, comprendido y acepto los términos.
                    </label>
                </div>
                <button id="acceptAgreementButton" onclick="acceptAgreement()" class="btn btn-gold" disabled>
                    Aceptar y Continuar
                </button>
            </div>
        </div>
    </div>

    <div id="sessionTimerContainer" style="display: none;">
        <i class="fas fa-clock mr-2"></i>Tiempo restante: <span id="sessionCountdown">15:00</span>
    </div>

    <!-- Login Section -->
    <div id="loginContainer">
        <div class="login-box">
             <div class="logo-text text-center text-2xl mb-8" style="color: var(--dark-blue); text-shadow: none;">RGC PENSIONES Y SEGUROS</div>
            <h2>Acceso de Asesor</h2>
            <div class="input-group mb-4">
                <label for="login_asesor"><i class="fas fa-user-tie mr-2 opacity-70"></i>Nombre del Asesor</label>
                <input type="text" id="login_asesor" placeholder="Nombre Apellido" class="w-full">
            </div>
            <div class="input-group">
                <label for="login_password"><i class="fas fa-lock mr-2 opacity-70"></i>Contraseña de Acceso</label>
                <input type="password" id="login_password" placeholder="••••••••••" class="w-full">
            </div>
            <div class="text-center mt-8">
                <button id="loginButton" onclick="handleLogin()" class="btn btn-blue w-full">
                    <i class="fas fa-sign-in-alt"></i>Ingresar
                </button>
            </div>
            <div id="login_errorMessage" class="error-message-infographic" style="display: none; margin-top: 1.5rem;"><p></p></div>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="appContainer" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-6xl" style="display: none;">
        
        <!-- Main Menu Section -->
        <div id="mainMenuSection">
            <header class="main-header">
                <div class="logo-text">RGC PENSIONES Y SEGUROS</div>
                <h1>Panel de Asesor</h1>
                <p>Selecciona una herramienta para comenzar.</p>
            </header>
            <div class="menu-grid">
                <div class="menu-card" onclick="showSection('calculatorSection')">
                    <i class="fas fa-calculator"></i>
                    <h3>Cálculo de Pensión y Crédito</h3>
                    <p>Realiza proyecciones detalladas de pensión y financiamiento para clientes.</p>
                </div>
                <div class="menu-card" onclick="showCustomAlert('Este módulo se encuentra en desarrollo.', 'Próximamente')">
                    <i class="fas fa-file-contract"></i>
                    <h3>Conservacion y Vigencia de Derechos, SBC Exacto.</h3>
                    <p>Calcula la conservación, vigencia y el SBC exacto para tus clientes.</p>
                </div>
                <div class="menu-card" onclick="showSection('contractSection')">
                    <i class="fas fa-pencil-alt"></i>
                    <h3>Realizar Contrato</h3>
                    <p>Módulo para la generación de contratos.</p>
                </div>
                <div class="menu-card" onclick="showCustomAlert('Este módulo se encuentra en desarrollo.', 'Próximamente')">
                    <i class="fas fa-users"></i>
                    <h3>Cartera de Clientes</h3>
                    <p>Gestiona y consulta la información de tus clientes.</p>
                </div>
                 <div class="menu-card md:col-span-2" onclick="promptForCommissions()">
                    <i class="fas fa-money-bill-wave"></i>
                    <h3>Comisiones</h3>
                    <p>Calcula, registra y reporta comisiones y anticipos para el equipo.</p>
                </div>
            </div>
        </div>

        <!-- Calculator Section -->
        <div id="calculatorSection" style="display: none;">
            <button onclick="showSection('mainMenuSection')" class="btn btn-secondary mb-6"><i class="fas fa-arrow-left mr-2"></i>Volver al Menú</button>
            <section id="infoSection1" class="infographic-section">
                <h2><i class="fas fa-user-edit"></i>Paso 1: Datos y Análisis de Historial</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 mb-8">
                    <div class="input-group">
                        <label for="info_nombreCompleto">Nombre Completo:</label>
                        <input type="text" id="info_nombreCompleto" placeholder="Nombre completo del cliente" class="w-full">
                    </div>
                    <div class="input-group">
                        <label for="info_curpCliente">CURP:</label>
                        <input type="text" id="info_curpCliente" placeholder="CURP del cliente (18 caracteres)" maxlength="18" oninput="this.value = this.value.toUpperCase();" class="w-full">
                    </div>
                    <div class="input-group md:col-span-2">
                        <label for="info_semanasTotalesManual">Semanas Totales Cotizadas (Manual):</label>
                        <input type="number" id="info_semanasTotalesManual" placeholder="Ej: 1500" class="w-full">
                    </div>
                </div>

                <h3 class="subsection-title">Historial de Empleos</h3>
                <div id="employmentCardsContainer">
                    <!-- Employment cards will be added here by JS -->
                </div>
                <button onclick="addEmploymentCard()" class="btn btn-secondary mt-4"><i class="fas fa-plus mr-2"></i>Agregar Empleo</button>
                
                <div class="text-center mt-10">
                    <button onclick="analizarYCalcularSBC()" class="btn btn-blue text-lg">
                        <i class="fas fa-cogs"></i>Analizar Historial y Calcular
                    </button>
                </div>

                <div id="sbcAnalysisResultsContainer" class="mt-8" style="display: none;">
                    <h3 class="subsection-title">Resultados del Análisis</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="text-sm text-blue-800">SBC Promedio</p>
                            <p id="res_sbcPromedio" class="text-2xl font-bold text-blue-900">$0.00</p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="text-sm text-blue-800">Edad Actual</p>
                            <p id="res_edadActual" class="text-2xl font-bold text-blue-900">0 años</p>
                        </div>
                        <div id="vigenciaResultBox" class="p-4 rounded-lg">
                            <p id="vigenciaResultText" class="text-2xl font-bold">--</p>
                            <p id="vigenciaResultSubText" class="text-sm">--</p>
                        </div>
                    </div>
                     <div class="mt-6 overflow-x-auto">
                        <h4 class="font-semibold text-gray-700 mb-2">Periodos Utilizados para el Cálculo del SBC</h4>
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-2">Fecha Inicio</th>
                                    <th class="p-2">Fecha Fin</th>
                                    <th class="p-2 text-right">Días Usados</th>
                                    <th class="p-2 text-right">SBC Diario</th>
                                    <th class="p-2 text-right">SBC Ponderado</th>
                                </tr>
                            </thead>
                            <tbody id="sbcAnalysisTableBody">
                                <!-- Rows will be added here by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="basePensionResultsContainer" class="mt-8" style="display: none;">
                    <h3 class="subsection-title">Resultados de Pensión Base (Sin M40)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <p class="text-sm text-green-800">Pensión Mensual Estimada</p>
                            <p id="res_base_pensionMensual" class="text-2xl font-bold text-green-900">$0.00</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <p class="text-sm text-green-800">Aguinaldo Estimado</p>
                            <p id="res_base_aguinaldo" class="text-2xl font-bold text-green-900">$0.00</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <p class="text-sm text-green-800">Ingreso Anual Total</p>
                            <p id="res_base_ingresoAnual" class="text-2xl font-bold text-green-900">$0.00</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="infoSection2" class="infographic-section">
                <h2><i class="fas fa-chart-line"></i>Paso 2: Estrategia Modalidad 40</h2>
                <h3 class="subsection-title">Definir Periodo de Inversión en M40</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-x-8 gap-y-6">
                    <div class="input-group">
                        <label for="info_m40_p1_inicio">Fecha Inicio M40:</label>
                        <input type="month" id="info_m40_p1_inicio" onchange="actualizarSBCMaximoM40(); actualizarFechaFinM40Display();" class="w-full">
                    </div>
                    <div class="input-group">
                        <label for="info_m40_p1_meses">Meses a Invertir:</label>
                        <input type="number" id="info_m40_p1_meses" placeholder="Ej: 60" max="60" oninput="actualizarFechaFinM40Display()" class="w-full">
                    </div>
                    <div class="input-group">
                        <label for="info_m40_p1_sbc">SBC Diario M40 (Tope):</label>
                        <input type="number" id="info_m40_p1_sbc" placeholder="Automático" class="w-full">
                    </div>
                    <div class="md:col-span-3 mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg text-center">
                        <div id="info_m40_baja_display" class="text-sm font-semibold text-blue-800 leading-relaxed">
                            -- Ingrese fechas para ver la edad de baja --
                        </div>
                    </div>
                </div>
                <div class="text-center mt-10">
                    <button id="btnCalcularEscenarioM40" onclick="calcularEscenarioM40Infografia()" class="btn btn-gold">
                        <i class="fas fa-cogs"></i>Calcular Proyección M40
                    </button>
                </div>
            </section>

            <section id="infoSection3" class="infographic-section">
                <h2><i class="fas fa-hand-holding-usd"></i>Paso 3: Análisis Financiero</h2>
                <h3 class="subsection-title">Fuentes de Cobertura y Comisiones</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div class="input-group">
                        <label for="info_aforeActual">AFORE Actual ($):</label>
                        <input type="number" id="info_aforeActual" placeholder="0.00" oninput="recalculateScenario(1); recalculateScenario(2);">
                    </div>
                    <div class="input-group">
                        <label for="info_mesesPrimerDeposito">Meses para Primer Depósito (6-12):</label>
                        <input type="number" id="info_mesesPrimerDeposito" value="6" min="6" max="12" onchange="handleMesesDepositoChange(this)" data-last-valid="6">
                    </div>
                     <div class="input-group md:col-span-2">
                        <label for="info_comisionExcedente">Comisión por Excedente ($):</label>
                        <input type="number" id="info_comisionExcedente" placeholder="0.00" oninput="recalculateScenario(1); recalculateScenario(2);">
                    </div>
                </div>
            </section>
            
            <section id="infoSection4" class="infographic-section">
                <h2><i class="fas fa-balance-scale-right"></i>Paso 4: Comparador de Escenarios</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Scenario 1 Card -->
                    <div class="bg-gray-50 p-6 rounded-xl border">
                        <h3 class="text-lg font-bold text-blue-800 mb-4 text-center">Escenario 1</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="input-group">
                                <label for="scenario_1_meses">Meses M40:</label>
                                <input type="number" id="scenario_1_meses" class="w-full" oninput="recalculateScenario(1)">
                            </div>
                            <div class="input-group">
                                <label for="scenario_1_semanas">Semanas Totales:</label>
                                <input type="number" id="scenario_1_semanas" class="w-full" readonly>
                            </div>
                        </div>
                        <div id="scenario_1_results" class="mt-4 pt-4 border-t text-sm space-y-2">
                             <!-- Key Data -->
                            <div class="bg-white p-3 rounded-md shadow-sm mb-3">
                                <p><strong>Edad Final:</strong> <span id="scenario_1_edad_final" class="font-semibold float-right"></span></p>
                                <p><strong>SBC Promedio Final:</strong> <span id="scenario_1_sbc_final" class="font-semibold float-right"></span></p>
                                <p><strong>Semanas Finales:</strong> <span id="scenario_1_semanas_finales" class="font-semibold float-right"></span></p>
                            </div>
                            <!-- Pension -->
                            <p class="font-semibold text-base">Pensión Mensual: <span id="scenario_1_pension" class="float-right font-bold text-green-600">$0.00</span></p>
                            <p class="font-semibold">Aguinaldo: <span id="scenario_1_aguinaldo" class="float-right font-bold text-green-600">$0.00</span></p>
                            <hr class="my-2">
                            <!-- Financials -->
                            <p>Costo Total Proyecto: <span id="scenario_1_costo_total" class="float-right font-bold text-red-600">$0.00</span></p>
                            <p>Cobertura AFORE: <span id="scenario_1_cobertura_afore" class="float-right text-gray-700">$0.00</span></p>
                            <p>Cobertura 1er Depósito: <span id="scenario_1_cobertura_deposito" class="float-right text-gray-700">$0.00</span></p>
                            <p>Cobertura Extra AFORE: <span id="scenario_1_cobertura_extra" class="float-right text-gray-700">$0.00</span></p>
                            <p>Préstamo Requerido: <span id="scenario_1_prestamo" class="float-right font-bold text-blue-600">$0.00</span></p>
                            <p class="font-semibold text-base mt-1">Resultado: <span id="scenario_1_resultado_final" class="float-right font-bold">$0.00</span></p>
                            <!-- Projection Table -->
                            <div id="scenario_1_proyeccion" class="mt-3 overflow-x-auto"></div>
                        </div>
                    </div>
                    <!-- Scenario 2 Card -->
                    <div class="bg-gray-50 p-6 rounded-xl border">
                        <h3 class="text-lg font-bold text-blue-800 mb-4 text-center">Escenario 2</h3>
                         <div class="grid grid-cols-2 gap-4">
                            <div class="input-group">
                                <label for="scenario_2_meses">Meses M40:</label>
                                <input type="number" id="scenario_2_meses" class="w-full" oninput="recalculateScenario(2)">
                            </div>
                            <div class="input-group">
                                <label for="scenario_2_semanas">Semanas Totales:</label>
                                <input type="number" id="scenario_2_semanas" class="w-full" readonly>
                            </div>
                        </div>
                        <div id="scenario_2_results" class="mt-4 pt-4 border-t text-sm space-y-2">
                            <!-- Key Data -->
                            <div class="bg-white p-3 rounded-md shadow-sm mb-3">
                                <p><strong>Edad Final:</strong> <span id="scenario_2_edad_final" class="font-semibold float-right"></span></p>
                                <p><strong>SBC Promedio Final:</strong> <span id="scenario_2_sbc_final" class="font-semibold float-right"></span></p>
                                <p><strong>Semanas Finales:</strong> <span id="scenario_2_semanas_finales" class="font-semibold float-right"></span></p>
                            </div>
                            <!-- Pension -->
                            <p class="font-semibold text-base">Pensión Mensual: <span id="scenario_2_pension" class="float-right font-bold text-green-600">$0.00</span></p>
                            <p class="font-semibold">Aguinaldo: <span id="scenario_2_aguinaldo" class="float-right font-bold text-green-600">$0.00</span></p>
                            <hr class="my-2">
                             <!-- Financials -->
                            <p>Costo Total Proyecto: <span id="scenario_2_costo_total" class="float-right font-bold text-red-600">$0.00</span></p>
                            <p>Cobertura AFORE: <span id="scenario_2_cobertura_afore" class="float-right text-gray-700">$0.00</span></p>
                            <p>Cobertura 1er Depósito: <span id="scenario_2_cobertura_deposito" class="float-right text-gray-700">$0.00</span></p>
                            <p>Cobertura Extra AFORE: <span id="scenario_2_cobertura_extra" class="float-right text-gray-700">$0.00</span></p>
                            <p>Préstamo Requerido: <span id="scenario_2_prestamo" class="float-right font-bold text-blue-600">$0.00</span></p>
                            <p class="font-semibold text-base mt-1">Resultado: <span id="scenario_2_resultado_final" class="float-right font-bold">$0.00</span></p>
                             <!-- Projection Table -->
                            <div id="scenario_2_proyeccion" class="mt-3 overflow-x-auto"></div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="infoSection5" class="infographic-section text-center">
                <h2><i class="fas fa-file-pdf"></i>Paso 5: Exportar Reportes</h2>
                <p class="mb-8 text-gray-600 text-lg max-w-2xl mx-auto">Genera los reportes en PDF con la información de los escenarios analizados en el Paso 4.</p>
                <div class="flex justify-center gap-6">
                    <button onclick="generateClientPDF()" class="btn btn-blue text-lg">
                        <i class="fas fa-user"></i>Comparativa para Cliente
                    </button>
                    <button onclick="promptForPassword()" class="btn btn-gold text-lg">
                        <i class="fas fa-lock"></i>Reporte Técnico Completo
                    </button>
                </div>
            </section>
        </div>

        <!-- Contract Section -->
        <div id="contractSection" style="display: none;">
            <button onclick="showSection('mainMenuSection')" class="btn btn-secondary mb-6"><i class="fas fa-arrow-left mr-2"></i>Volver al Menú</button>
            <section class="infographic-section">
                <h2><i class="fas fa-file-signature"></i>Generador de Contrato de Servicios</h2>
                <div class="input-group mb-6">
                    <label for="contract_monto">Monto del Contrato (Precio de Venta Total) $:</label>
                    <input type="number" id="contract_monto" placeholder="Ej: 500000.00" class="w-full">
                </div>

                <h3 class="subsection-title">Datos del Cliente</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div class="input-group">
                        <label for="contract_cliente_nombre">Nombre Completo:</label>
                        <input type="text" id="contract_cliente_nombre" placeholder="Nombre(s) Apellido Paterno Apellido Materno" class="w-full">
                    </div>
                    <div class="input-group">
                        <label for="contract_cliente_telefono">Teléfono (10 dígitos):</label>
                        <input type="text" id="contract_cliente_telefono" placeholder="5512345678" maxlength="10" class="w-full">
                    </div>
                    <div class="input-group">
                        <label for="contract_cliente_email">Correo Electrónico:</label>
                        <input type="text" id="contract_cliente_email" placeholder="cliente@email.com" class="w-full">
                    </div>
                    <div class="input-group">
                        <label for="contract_cliente_direccion">Dirección Completa:</label>
                        <input type="text" id="contract_cliente_direccion" placeholder="Calle, Número, Colonia, Alcaldía, C.P., Ciudad" class="w-full">
                    </div>
                </div>

                <h3 class="subsection-title mt-8">Datos del Responsable Solidario</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div class="input-group">
                        <label for="contract_rs_nombre">Nombre Completo:</label>
                        <input type="text" id="contract_rs_nombre" placeholder="Nombre(s) Apellido Paterno Apellido Materno" class="w-full">
                    </div>
                    <div class="input-group">
                        <label for="contract_rs_telefono">Teléfono (10 dígitos):</label>
                        <input type="text" id="contract_rs_telefono" placeholder="5587654321" maxlength="10" class="w-full">
                    </div>
                     <div class="input-group">
                        <label for="contract_rs_email">Correo Electrónico:</label>
                        <input type="text" id="contract_rs_email" placeholder="responsable@email.com" class="w-full">
                    </div>
                    <div class="input-group">
                        <label for="contract_rs_direccion">Dirección Completa:</label>
                        <input type="text" id="contract_rs_direccion" placeholder="Calle, Número, Colonia, Alcaldía, C.P., Ciudad" class="w-full">
                    </div>
                </div>

                <div class="text-center mt-10">
                    <button onclick="generateContractPDF()" class="btn btn-gold text-lg">
                        <i class="fas fa-file-pdf"></i>Generar y Descargar Contrato
                    </button>
                </div>
            </section>
        </div>
        
        <footer class="app-footer">
            <div class="logo-text-footer">RGC PENSIONES Y SEGUROS</div>
            <p>&copy; <span id="currentYear"></span> RGC Pensiones y Seguros. Todos los derechos reservados.</p>
            <p class="text-xs mt-1 opacity-70">Esta es una simulación y los resultados pueden variar. Consulta a un asesor para una evaluación detallada.</p>
        </footer>
    </div>

    <!-- Custom Alert Modal -->
    <div id="customAlertModal" class="modal-overlay">
        <div class="modal-content modal-content-alert">
            <h2 id="customAlertTitle" class="text-xl">Alerta</h2>
            <p id="customAlertMessage" class="text-base my-6"></p>
            <div id="passwordPromptContainer" style="display: none;" class="mt-4">
                <input type="password" id="pdfPasswordInput" class="w-full p-2 border rounded" placeholder="Contraseña de asesor">
            </div>
            <button id="customAlertButton" onclick="closeCustomAlert()" class="btn btn-blue mt-4">Aceptar</button>
        </div>
    </div>
    
    <script>
        // --- Global Variables ---
        let nombreAsesorGlobal = "";
        let passwordPromptContext = {};
        let employmentCardIdCounter = 0;
        let scenarioData = { 1: {}, 2: {} };
        
        // --- Session Timer Logic ---
        let sessionTimeout;
        let sessionInterval;
        const sessionDuration = 15 * 60 * 1000; // 15 minutes
        let sessionEndTime;

        function startSessionTimer() {
            clearTimeout(sessionTimeout);
            clearInterval(sessionInterval);
            sessionEndTime = Date.now() + sessionDuration;
            sessionTimeout = setTimeout(logout, sessionDuration);
            sessionInterval = setInterval(updateCountdown, 1000);
            showElement('sessionTimerContainer');
            updateCountdown();
        }

        function updateCountdown() {
            const remainingTime = sessionEndTime - Date.now();
            if (remainingTime <= 0) {
                logout();
                return;
            }
            const minutes = Math.floor((remainingTime / 1000) / 60);
            const seconds = Math.floor((remainingTime / 1000) % 60);
            const countdownEl = document.getElementById('sessionCountdown');
            const timerContainer = document.getElementById('sessionTimerContainer');
            countdownEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            if (remainingTime < 2 * 60 * 1000) { timerContainer.style.color = '#DC2626'; } 
            else { timerContainer.style.color = 'var(--text-dark)';}
        }

        function logout() {
            clearTimeout(sessionTimeout);
            clearInterval(sessionInterval);
            hideElement('appContainer');
            hideElement('sessionTimerContainer');
            showElement('loginContainer');
            document.getElementById('login_password').value = '';
            document.getElementById('login_asesor').value = '';
            showCustomAlert("Tu sesión ha expirado. Por favor, ingresa de nuevo.");
        }

        function showElement(id, displayType = 'block') {
            const el = document.getElementById(id);
            if (!el) return;
            if (id.includes('Modal') || id.includes('loginContainer')) {
                el.classList.add('active');
            } else {
                el.style.display = displayType;
            }
        }

        function hideElement(id) {
             const el = document.getElementById(id);
             if (!el) return;
            if (id.includes('Modal') || id.includes('loginContainer')) {
                el.classList.remove('active');
            } else {
                el.style.display = 'none';
            }
        }

        function showCustomAlert(message, title = "Atención") {
            document.getElementById('customAlertTitle').textContent = title;
            document.getElementById('customAlertMessage').textContent = message;
            document.getElementById('passwordPromptContainer').style.display = 'none';
            const btn = document.getElementById('customAlertButton');
            btn.textContent = 'Aceptar';
            btn.onclick = closeCustomAlert;
            showElement('customAlertModal');
        }

        function closeCustomAlert() {
            hideElement('customAlertModal');
            document.getElementById('passwordPromptContainer').style.display = 'none';
        }
        
        function acceptAgreement() {
            hideElement('confidentialityModal');
            showElement('loginContainer');
            document.getElementById('login_asesor').focus();
        }
        
        function showSection(sectionId) {
            // Hide all main sections
            document.getElementById('mainMenuSection').style.display = 'none';
            document.getElementById('calculatorSection').style.display = 'none';
            document.getElementById('contractSection').style.display = 'none';
            
            // Show the requested section
            const sectionToShow = document.getElementById(sectionId);
            if (sectionToShow) {
                sectionToShow.style.display = 'block';
            }
        }


        // --- LOGIN FUNCTIONALITY ---
        function handleLogin() {
            const loginButton = document.getElementById('loginButton');
            const originalButtonContent = loginButton.innerHTML;
            loginButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i>Ingresando...`;
            loginButton.disabled = true;

            const asesorInput = document.getElementById('login_asesor');
            const passwordInput = document.getElementById('login_password');
            const password = passwordInput.value.trim();
            
            // --- Asesor Name Validation ---
            let asesorName = asesorInput.value.trim().replace(/[^a-zA-Z\s]/g, '').replace(/\s+/g, ' ').toUpperCase();
            const nameParts = asesorName.split(' ');
            if (nameParts.length < 2 || nameParts[0].length === 0 || nameParts[1].length === 0) {
                showCustomAlert("El nombre del asesor debe incluir al menos un nombre y un apellido.", "Error de Validación");
                loginButton.innerHTML = originalButtonContent;
                loginButton.disabled = false;
                return;
            }
            nombreAsesorGlobal = asesorName;

            setTimeout(() => {
                if (password === "OICI120566010503") { 
                    hideElement('loginContainer');
                    showElement('appContainer');
                    showSection('mainMenuSection');
                    startSessionTimer(); 
                } else {
                    const loginErrorTextEl = document.querySelector('#login_errorMessage p');
                    if (loginErrorTextEl) loginErrorTextEl.textContent = "Contraseña incorrecta. Inténtalo de nuevo.";
                    showElement('login_errorMessage');
                    loginButton.innerHTML = originalButtonContent;
                    loginButton.disabled = false;
                }
            }, 500);
        }
        
        function initializeMainAppDisplay() {
            document.getElementById('currentYear').textContent = new Date().getFullYear();
        }


        // --- LÓGICA DE CÁLCULO Y DATOS ECONÓMICOS ---
        let pensionBaseResultadosInfo = { PENSION_MENSUAL_ESTIMADA: 0, AGUINALDO_ESTIMADO: 0 };
        let datosClienteInfo = { nombre: '', semanasCotizadasBase: 0, edadBase: 0, sbcPromedioBase: 0 };
        let aforeProyectadaGlobalInfo = 0;
        let m40ResultadosInfo = { 
            pensionMensualInicial: 0, 
            aguinaldo: 0, costoTotalP1: 0, 
            sbcPromedioParaCalculoPensionM40: 0, 
            sbcM40Ingresado: 0, 
            nuevasSemanas: 0, nuevaEdad: 0 
        };
        let datosCompletosParaPDFInfo = {};
        
        let economicData = {
            umas: { 2018: 80.60, 2019: 84.49, 2020: 86.88, 2021: 89.62, 2022: 96.22, 2023: 103.74, 2024: 108.57, 2025: 113.14, 2026: 118.64, 2027: 124.00, 2028: 129.68, 2029: 135.61, 2030: 141.81 },
            smgv_diario: { 2018: 88.36, 2019: 102.68, 2020: 123.22, 2021: 141.70, 2022: 172.87, 2023: 207.44, 2024: 248.93 },
            inpc: { "2018-12": 101.355, "2019-12": 104.236, "2020-12": 107.608, "2021-12": 115.499, "2022-12": 124.507, "2023-12": 130.036, "2024-01": 131.396, "2024-02": 131.500, "2024-03": 131.650, "2024-04": 131.800, "2024-05": 132.000, "2024-06": 132.660, "2024-07": 133.323, "2024-08": 133.990, "2024-09": 134.660, "2024-10": 135.333, "2024-11": 136.010, "2024-12": 136.690, "2025-01": 137.373, "2025-02": 138.060, "2025-03": 138.750, "2025-04": 139.444, "2025-05": 140.141, "2025-06": 140.842, "2025-07": 141.546 }
        };
        const currentFullYear = new Date().getFullYear();
        for (let y = Math.max(...Object.keys(economicData.umas).map(Number)) + 1; y <= currentFullYear + 10; y++) {
            if (!economicData.umas[y]) economicData.umas[y] = parseFloat((economicData.umas[y-1] * 1.045).toFixed(2));
        }
        for (let y = Math.max(...Object.keys(economicData.smgv_diario).map(Number)) + 1; y <= currentFullYear + 10; y++) {
             if (!economicData.smgv_diario[y]) economicData.smgv_diario[y] = parseFloat((economicData.smgv_diario[y-1] * 1.10).toFixed(2));
        }

        const averageAnnualINPCGrowth = 0.06; // UPDATED INFLATION
        const SMGV_DF_Global = 88.36; 
        const FACTOR_FOX_Global = 1.11;
        const tablaCuantiasGlobal = [ 
            { minRatio: 0,    maxRatio: 1.00, pcb: 80.00, pia: 0.563 }, { minRatio: 1.01, maxRatio: 1.25, pcb: 77.11, pia: 0.814 },
            { minRatio: 1.26, maxRatio: 1.50, pcb: 58.18, pia: 1.178 }, { minRatio: 1.51, maxRatio: 1.75, pcb: 49.23, pia: 1.430 },
            { minRatio: 1.76, maxRatio: 2.00, pcb: 42.67, pia: 1.615 }, { minRatio: 2.01, maxRatio: 2.25, pcb: 37.65, pia: 1.756 },
            { minRatio: 2.26, maxRatio: 2.50, pcb: 33.68, pia: 1.868 }, { minRatio: 2.51, maxRatio: 2.75, pcb: 30.48, pia: 1.958 },
            { minRatio: 2.76, maxRatio: 3.00, pcb: 27.83, pia: 2.033 }, { minRatio: 3.01, maxRatio: 3.25, pcb: 25.60, pia: 2.096 },
            { minRatio: 3.26, maxRatio: 3.50, pcb: 23.70, pia: 2.149 }, { minRatio: 3.51, maxRatio: 3.75, pcb: 22.07, pia: 2.195 },
            { minRatio: 3.76, maxRatio: 4.00, pcb: 20.65, pia: 2.235 }, { minRatio: 4.01, maxRatio: 4.25, pcb: 19.39, pia: 2.271 },
            { minRatio: 4.26, maxRatio: 4.50, pcb: 18.29, pia: 2.302 }, { minRatio: 4.51, maxRatio: 4.75, pcb: 17.30, pia: 2.330 },
            { minRatio: 4.76, maxRatio: 5.00, pcb: 16.41, pia: 2.355 }, { minRatio: 5.01, maxRatio: 5.25, pcb: 15.61, pia: 2.377 },
            { minRatio: 5.26, maxRatio: 5.50, pcb: 14.88, pia: 2.398 }, { minRatio: 5.51, maxRatio: 5.75, pcb: 14.22, pia: 2.416 },
            { minRatio: 5.76, maxRatio: 6.00, pcb: 13.62, pia: 2.433 }, { minRatio: 6.01, maxRatio: Infinity, pcb: 13.00, pia: 2.450 }
        ];
        const tasasPagoM40 = { 
            2022: 0.10075, 2023: 0.11166, 2024: 0.12256, 2025: 0.13347,
            2026: 0.14438, 2027: 0.15528, 2028: 0.16619, 2029: 0.17709, 2030: 0.18800
        };
        const PRESTAMO_PUNTO_A_DESCUENTO = 1115.61; 
        const PRESTAMO_PUNTO_A_MONTO = 31000;
        const PRESTAMO_PUNTO_B_DESCUENTO = 33450.42; 
        const PRESTAMO_PUNTO_B_MONTO = 929500;
        const DIAS_PROMEDIO_PENSION = 1750; 

        function formatNumber(num, decimals = 2) {
            if (typeof num !== 'number' || isNaN(num)) return (0).toFixed(decimals);
            return num.toLocaleString('es-MX', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        }
        function getNumeroInfo(id) { return parseFloat(document.getElementById(id).value.replace(/,/g, '')) || 0; }
        function getDiasEnMes(a, m) { return new Date(a, m, 0).getDate(); }
        
        function getUMA(y, m = new Date().getMonth() + 1) { 
            let uY = parseInt(y);
            if (m === 1 && economicData.umas[uY-1]) uY = parseInt(y)-1; 
            return economicData.umas[uY] || economicData.umas[Object.keys(economicData.umas).sort((a,b) => b-a)[0]] || 0;
        }
        
        function getINPC(year, month) {
            const key = `${year}-${String(month).padStart(2, '0')}`;
            if (economicData.inpc[key]) {
                return economicData.inpc[key];
            }
            // Projection for future values
            const lastKnownKey = Object.keys(economicData.inpc).sort().pop();
            const [lastYear, lastMonth] = lastKnownKey.split('-').map(Number);
            const lastValue = economicData.inpc[lastKnownKey];
            const monthsDiff = (year - lastYear) * 12 + (month - lastMonth);
            if (monthsDiff > 0) {
                return lastValue * Math.pow(1 + (averageAnnualINPCGrowth / 12), monthsDiff);
            }
            return null; // Return null if historical data is missing
        }

        function _calcularPensionDetallado(sbcP, semC, edadC, smgv, fFox, tC) {
            if (sbcP <= 0 || semC < 500 || edadC < 60) return { PENSION_MENSUAL_ESTIMADA: 0, AGUINALDO_ESTIMADO: 0 };
            const rSBCvsSMGV = sbcP / smgv; let pcb = 0, pia = 0;
            for (const rg of tC) { if (rSBCvsSMGV >= rg.minRatio && rSBCvsSMGV <= rg.maxRatio) { pcb = rg.pcb; pia = rg.pia; break; } }
            if (pcb === 0 && pia === 0 && rSBCvsSMGV > tC[tC.length-1].maxRatio && tC[tC.length-1].maxRatio !== Infinity) { const u = tC[tC.length-1]; pcb = u.pcb; pia = u.pia; }
            const cBAP = (sbcP * 365) * (pcb / 100); const CBF = cBAP * fFox;
            let fNIF = 0; if (semC > 500) fNIF = Math.floor((semC - 500) / 52 * 100) / 100; 
            const iACP = (sbcP * 365) * (pia / 100) * fNIF; const IAVF = iACP * fFox;
            const pVAB = CBF + IAVF; let pE = 0;
            if (edadC >= 65) pE = 1.00; else if (edadC === 64) pE = 0.95; else if (edadC === 63) pE = 0.90;
            else if (edadC === 62) pE = 0.85; else if (edadC === 61) pE = 0.80; else if (edadC === 60) pE = 0.75;
            const pVAAE = pVAB * pE; const pACA = pVAAE * 1.15;
            const PME = pACA / 12; 
            const aguinaldoEstimado = (PME / 1.15);
            return { PENSION_MENSUAL_ESTIMADA: PME, AGUINALDO_ESTIMADO: aguinaldoEstimado };
        }
        function extraerFechaNacimientoCURP(curp) {
            if (typeof curp !== 'string' || curp.length !== 18) return null;
            const aS = curp.substring(4,6); const mS = curp.substring(6,8); const dS = curp.substring(8,10);
            let anio = parseInt(aS); const mes = parseInt(mS); const dia = parseInt(dS);
            if (isNaN(anio) || isNaN(mes) || isNaN(dia) || mes < 1 || mes > 12 || dia < 1 || dia > 31 ) return null;
            const cIS = curp.charAt(16); let siglo = 1900; const cYLT = new Date().getFullYear() % 100;
            if (!isNaN(parseInt(cIS))) siglo = (anio > cYLT + 10) ? 1900 : 2000;
            else if (cIS >= 'A' && cIS <= 'Z') siglo = 2000;
            anio = siglo + anio; 
            try { const f = new Date(anio, mes-1, dia); if (f.getFullYear() === anio && f.getMonth() === (mes-1) && f.getDate() === dia) return f; return null; } catch (e) { return null; }
        }
        function calcularEdadExacta(fN, fR) {
            if (!fN || !(fN instanceof Date) || isNaN(fN) || !fR || !(fR instanceof Date) || isNaN(fR)) return { anos: 0, meses: 0, dias: 0 };
            let a = fR.getFullYear() - fN.getFullYear(); let m = fR.getMonth() - fN.getMonth(); let d = fR.getDate() - fN.getDate();
            if (d < 0) { m--; d += new Date(fR.getFullYear(), fR.getMonth(), 0).getDate(); }
            if (m < 0) { a--; m += 12; }
            return { anos: a, meses: m, dias: d };
        }
        function getTasaM40Porcentaje(a) {
            if (a <= 2022) return tasasPagoM40[2022]; if (a >= 2030) return tasasPagoM40[2030];
            return tasasPagoM40[a] || tasasPagoM40[Object.keys(tasasPagoM40).sort((x,y)=>y-x)[0]]; 
        }
         function calcularFechaFinDesdeMeses(fechaInicioStr, numMeses) {
            if (!fechaInicioStr || !numMeses || numMeses <= 0) return null;
            const [anioInicio, mesInicio] = fechaInicioStr.split('-').map(Number);
            if (isNaN(anioInicio) || isNaN(mesInicio)) return null;
            const fechaInicioObj = new Date(Date.UTC(anioInicio, mesInicio - 1, 1)); 
            const fechaFinObj = new Date(Date.UTC(fechaInicioObj.getUTCFullYear(), fechaInicioObj.getUTCMonth() + Number(numMeses), 1));
            fechaFinObj.setUTCDate(0); 
            return `${fechaFinObj.getUTCFullYear()}-${String(fechaFinObj.getUTCMonth() + 1).padStart(2, '0')}`;
        }
        
        function actualizarSBCMaximoM40() {
            const inicioP1Str = document.getElementById('info_m40_p1_inicio').value;
            const sbcM40Input = document.getElementById('info_m40_p1_sbc');
            if (inicioP1Str) {
                const [anioInicioP1, mesInicioP1] = inicioP1Str.split('-').map(Number);
                const umaP1 = getUMA(anioInicioP1, mesInicioP1);
                const sbcMaxP1 = umaP1 * 25;
                sbcM40Input.value = formatNumber(sbcMaxP1, 2).replace(/,/g, '');
                sbcM40Input.setAttribute('data-max-sbc', sbcMaxP1);
            } else {
                sbcM40Input.value = '';
                sbcM40Input.removeAttribute('data-max-sbc');
            }
        }
        
        function actualizarFechaFinM40Display() {
            const fechaInicioStr = document.getElementById('info_m40_p1_inicio').value;
            const numMesesStr = document.getElementById('info_m40_p1_meses').value;
            const curp = document.getElementById('info_curpCliente').value;
            const calcularBtn = document.getElementById('btnCalcularEscenarioM40');
            const bajaDisplayEl = document.getElementById('info_m40_baja_display');

            if(calcularBtn) calcularBtn.disabled = false;

            if (!fechaInicioStr || !numMesesStr || numMesesStr === '0') {
                bajaDisplayEl.innerHTML = '-- Ingrese fechas y CURP para ver la edad de baja --';
                return;
            }
            
            if (curp.length !== 18) {
                bajaDisplayEl.innerHTML = '<span class="text-red-600">Ingrese un CURP válido (18 caracteres) para calcular la edad.</span>';
                return;
            }
            
            const fechaNacimiento = extraerFechaNacimientoCURP(curp);
            if (!fechaNacimiento) {
                bajaDisplayEl.innerHTML = '<span class="text-red-600">CURP inválido, no se puede calcular la edad.</span>';
                return;
            }

            const numMeses = parseInt(numMesesStr);
            if (numMeses > 0) {
                const fechaFinStr = calcularFechaFinDesdeMeses(fechaInicioStr, numMeses);
                if (fechaFinStr) {
                    const [finAnio, finMes] = fechaFinStr.split('-').map(Number);
                    
                    const fechaFinM40RealObj = new Date(Date.UTC(finAnio, finMes - 1, getDiasEnMes(finAnio, finMes)));
                    const edadFinM40 = calcularEdadExacta(fechaNacimiento, fechaFinM40RealObj);
                    
                    const fechaFinDisplay = new Date(Date.UTC(finAnio, finMes - 1, 1)).toLocaleDateString('es-MX', { month: 'long', year: 'numeric', timeZone: 'UTC' });

                    bajaDisplayEl.innerHTML = `
                        <i class="fas fa-calendar-alt mr-2"></i>Fecha de Baja Modalidad 40: <strong class="text-blue-900">${fechaFinDisplay.charAt(0).toUpperCase() + fechaFinDisplay.slice(1)}</strong><br>
                        <i class="fas fa-birthday-cake mr-2 mt-1"></i>Edad al finalizar: <strong class="text-blue-900">${edadFinM40.anos} años, ${edadFinM40.meses} meses y ${edadFinM40.dias} días</strong>
                    `;

                    const hoy = new Date();
                    const primerDiaMesActual = new Date(Date.UTC(hoy.getUTCFullYear(), hoy.getUTCMonth(), 1));
                    const ultimoDiaMesFinM40 = new Date(Date.UTC(finAnio, finMes -1, getDiasEnMes(finAnio, finMes)));
                    
                    if (ultimoDiaMesFinM40 < primerDiaMesActual) {
                        if(calcularBtn) calcularBtn.disabled = true;
                    } else {
                        if(calcularBtn) calcularBtn.disabled = false;
                    }
                } else {
                     bajaDisplayEl.innerHTML = '-- Ingrese fechas y CURP para ver la edad de baja --';
                }
            } else {
                 bajaDisplayEl.innerHTML = '-- Ingrese fechas y CURP para ver la edad de baja --';
            }
        }
        
        function addEmploymentCard() {
            employmentCardIdCounter++;
            const container = document.getElementById('employmentCardsContainer');
            const cardHTML = `
                <div class="employment-card" id="empCard_${employmentCardIdCounter}">
                     <button onclick="removeEmploymentCard(this)" class="btn-danger-icon absolute top-4 right-4" title="Eliminar Empleo"><i class="fas fa-times"></i></button>
                    <div class="input-group">
                        <label for="emp_history_${employmentCardIdCounter}">Historial para Empleo #${employmentCardIdCounter}:</label>
                        <textarea id="emp_history_${employmentCardIdCounter}" class="emp_history_text w-full font-mono text-sm" rows="6" placeholder="Pegue aquí los movimientos (REINGRESO, MODIFICACION, BAJA) para este empleador."></textarea>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', cardHTML);
        }

        function removeEmploymentCard(button) {
            button.closest('.employment-card').remove();
        }

        function analizarYCalcularSBC() {
            const cards = document.querySelectorAll('.employment-card');
            const curp = document.getElementById('info_curpCliente').value;
            const nombre = document.getElementById('info_nombreCompleto').value;
            const semanasManuales = getNumeroInfo('info_semanasTotalesManual');

            if (!nombre || curp.length !== 18 || !extraerFechaNacimientoCURP(curp) || semanasManuales <= 0) {
                showCustomAlert("Por favor, complete Nombre, CURP y Semanas Totales (debe ser > 0) antes de analizar.", "Datos Faltantes");
                return;
            }
            if (cards.length === 0) {
                showCustomAlert("Por favor, agregue al menos un bloque de empleo.", "Datos Faltantes");
                return;
            }

            let todosLosMovimientos = [];
            let isValid = true;
            
            cards.forEach((card, index) => {
                if (!isValid) return;
                const texto = card.querySelector('.emp_history_text').value.trim();
                if (!texto) {
                    showCustomAlert(`El cuadro de texto para el Empleo #${index + 1} está vacío.`, "Datos Faltantes");
                    isValid = false;
                    return;
                }

                const lineas = texto.split('\n').filter(line => line.trim() !== '');
                const regex = /(.+?)\s+(\d{2}\/\d{2}\/\d{4})\s*(?:\$\s*([\d,]+\.?\d*))?/;
                
                for (const linea of lineas) {
                    const match = linea.trim().match(regex);
                    if (match) {
                        const tipo = match[1].trim().toUpperCase();
                        const fechaStr = match[2];
                        const [dia, mes, anio] = fechaStr.split('/');
                        const fecha = new Date(Date.UTC(anio, mes - 1, dia));
                        const sbc = match[3] ? parseFloat(match[3].replace(/,/g, '')) : null;
                        todosLosMovimientos.push({ tipo, fecha, sbc });
                    } else {
                        showCustomAlert(`En Empleo #${index + 1}, la línea "${linea}" no tiene un formato válido.`, "Error de Formato");
                        isValid = false; return;
                    }
                }
            });

            if (!isValid) return;
            
            todosLosMovimientos.sort((a, b) => a.fecha - b.fecha); // Oldest first

            let periodos = [];
            for(let i = 0; i < todosLosMovimientos.length; i++) {
                const mov = todosLosMovimientos[i];
                if(mov.sbc === null) continue; 

                const fechaInicio = mov.fecha;
                let fechaFin;

                if (i + 1 < todosLosMovimientos.length) {
                    const siguienteMov = todosLosMovimientos[i+1];
                    fechaFin = new Date(siguienteMov.fecha);
                    fechaFin.setUTCDate(fechaFin.getUTCDate() - 1);
                } else {
                    const hoy = new Date();
                    fechaFin = new Date(Date.UTC(hoy.getUTCFullYear(), hoy.getUTCMonth() + 1, 0));
                }

                if (mov.tipo.includes('BAJA')) {
                   fechaFin = mov.fecha;
                }

                if (fechaFin >= fechaInicio) {
                     periodos.push({
                        fechaInicio: fechaInicio,
                        fechaFin: fechaFin,
                        sbc: mov.sbc,
                        dias: Math.round((fechaFin - fechaInicio) / (1000 * 60 * 60 * 24)) + 1
                    });
                }
            }

            periodos.sort((a, b) => b.fechaFin - a.fechaFin);

            let diasAcumuladosSBC = 0;
            let sbcPonderadoTotal = 0;
            const periodosParaTabla = [];
            
            for (const p of periodos) {
                if (diasAcumuladosSBC >= DIAS_PROMEDIO_PENSION) break;
                const diasAUsar = Math.min(p.dias, DIAS_PROMEDIO_PENSION - diasAcumuladosSBC);
                sbcPonderadoTotal += p.sbc * diasAUsar;
                diasAcumuladosSBC += diasAUsar;
                 periodosParaTabla.push({
                    fechaInicio: p.fechaInicio,
                    fechaFin: p.fechaFin,
                    dias: diasAUsar,
                    sbc: p.sbc,
                    ponderado: p.sbc * diasAUsar
                });
            }

            const sbcPromedioFinal = diasAcumuladosSBC > 0 ? sbcPonderadoTotal / diasAcumuladosSBC : 0;
            
            const fechaNacimiento = extraerFechaNacimientoCURP(curp);
            const edadObj = calcularEdadExacta(fechaNacimiento, new Date());
            const edadActual = edadObj.anos;

            datosClienteInfo = { nombre, sbcPromedioBase: sbcPromedioFinal, semanasCotizadasBase: semanasManuales, edadBase: edadActual };

            document.getElementById('res_sbcPromedio').textContent = '$' + formatNumber(sbcPromedioFinal);
            document.getElementById('res_edadActual').textContent = `${edadActual} años`;
            
            const tableBody = document.getElementById('sbcAnalysisTableBody');
            tableBody.innerHTML = '';
            for (const p of periodosParaTabla) {
                const row = `<tr>
                    <td class="p-2 border-b">${p.fechaInicio.toLocaleDateString('es-MX', {timeZone: 'UTC'})}</td>
                    <td class="p-2 border-b">${p.fechaFin.toLocaleDateString('es-MX', {timeZone: 'UTC'})}</td>
                    <td class="p-2 border-b text-right">${formatNumber(p.dias, 0)}</td>
                    <td class="p-2 border-b text-right">$${formatNumber(p.sbc)}</td>
                    <td class="p-2 border-b text-right">$${formatNumber(p.ponderado)}</td>
                </tr>`;
                tableBody.innerHTML += row;
            }
            
            // Vigencia de Derechos Calculation
            const movimientosDeBaja = todosLosMovimientos.filter(m => m.tipo.includes('BAJA')).sort((a,b) => b.fecha - a.fecha);
            let ultimaFechaBaja = null;
            if(movimientosDeBaja.length > 0) {
                ultimaFechaBaja = movimientosDeBaja[0].fecha;
            } else if (periodos.length > 0) {
                const ultimoMovimiento = todosLosMovimientos[todosLosMovimientos.length - 1];
                if (!ultimoMovimiento.tipo.includes('BAJA')) {
                    ultimaFechaBaja = new Date(); // Assume currently employed
                }
            }

            const vigenciaBox = document.getElementById('vigenciaResultBox');
            const vigenciaText = document.getElementById('vigenciaResultText');
            const vigenciaSubText = document.getElementById('vigenciaResultSubText');

            if (ultimaFechaBaja) {
                const fechaCincoAniosAtras = new Date(ultimaFechaBaja);
                fechaCincoAniosAtras.setFullYear(fechaCincoAniosAtras.getFullYear() - 5);

                let diasCotizadosEnVentana = 0;
                for (const p of periodos) {
                    const inicio = p.fechaInicio > fechaCincoAniosAtras ? p.fechaInicio : fechaCincoAniosAtras;
                    const fin = p.fechaFin < ultimaFechaBaja ? p.fechaFin : ultimaFechaBaja;
                    if (fin >= inicio) {
                        diasCotizadosEnVentana += ((fin - inicio) / (1000 * 60 * 60 * 24)) + 1;
                    }
                }
                diasCotizadosEnVentana = Math.round(diasCotizadosEnVentana);

                if (diasCotizadosEnVentana >= 365) {
                    vigenciaBox.className = "p-4 rounded-lg bg-green-100 text-green-800";
                    vigenciaText.textContent = "CON DERECHO A M40";
                    vigenciaSubText.textContent = `Cotizó ${diasCotizadosEnVentana} días en los 5 años previos a la baja.`;
                } else {
                    vigenciaBox.className = "p-4 rounded-lg bg-red-100 text-red-800";
                    vigenciaText.textContent = "SIN DERECHO A M40";
                    vigenciaSubText.textContent = `Cotizó solo ${diasCotizadosEnVentana} días de 365 requeridos.`;
                }
            } else {
                 vigenciaBox.className = "p-4 rounded-lg bg-gray-100 text-gray-800";
                 vigenciaText.textContent = "Estado Indeterminado";
                 vigenciaSubText.textContent = `No se encontró una fecha de baja.`;
            }


            showElement('sbcAnalysisResultsContainer');

            const pensionData = _calcularPensionDetallado(sbcPromedioFinal, semanasManuales, edadActual, SMGV_DF_Global, FACTOR_FOX_Global, tablaCuantiasGlobal);
            pensionBaseResultadosInfo = pensionData;

            const pensionMensual = pensionData.PENSION_MENSUAL_ESTIMADA;
            const aguinaldo = pensionData.AGUINALDO_ESTIMADO;
            const ingresoAnual = (pensionMensual * 12) + aguinaldo;

            document.getElementById('res_base_pensionMensual').textContent = '$' + formatNumber(pensionMensual);
            document.getElementById('res_base_aguinaldo').textContent = '$' + formatNumber(aguinaldo);
            document.getElementById('res_base_ingresoAnual').textContent = '$' + formatNumber(ingresoAnual);
            
            showElement('basePensionResultsContainer');
            
            if(ultimaFechaBaja) {
                const fechaInicioM40 = new Date(ultimaFechaBaja);
                fechaInicioM40.setUTCDate(fechaInicioM40.getUTCDate() + 1);
                const anioSugerido = fechaInicioM40.getUTCFullYear();
                const mesSugerido = String(fechaInicioM40.getUTCMonth() + 1).padStart(2, '0');
                document.getElementById('info_m40_p1_inicio').value = `${anioSugerido}-${mesSugerido}`;
                actualizarSBCMaximoM40();
                actualizarFechaFinM40Display();
            }

            showCustomAlert("Análisis completado. El SBC Promedio y la pensión base han sido calculados.", "Éxito");
        }
        
        function calcularEscenarioM40Infografia() {
            if (datosClienteInfo.sbcPromedioBase <= 0) {
                 showCustomAlert("Primero debes analizar el historial en el Paso 1.", "Acción Requerida");
                 return;
            }

            const curp = document.getElementById('info_curpCliente').value;
            if (curp.length !== 18) { showCustomAlert("El CURP debe tener 18 caracteres.", "Dato Inválido"); return; }
            
            const inicioP1Str = document.getElementById('info_m40_p1_inicio').value;
            const numMesesP1 = parseInt(document.getElementById('info_m40_p1_meses').value) || 0;
            
            const sbcM40Ingresado = parseFloat(document.getElementById('info_m40_p1_sbc').value.replace(/,/g, '')) || 0;
            m40ResultadosInfo.sbcM40Ingresado = sbcM40Ingresado;

            if (!inicioP1Str || numMesesP1 <= 0 || sbcM40Ingresado <= 0) {
                showCustomAlert("Define el periodo M40: Fecha de Inicio, Meses y SBC M40 son obligatorios.", "Datos Faltantes");
                return;
            }
            
            document.getElementById('scenario_1_meses').value = numMesesP1;
            recalculateScenario(1);
            document.getElementById('scenario_2_meses').value = '';
            recalculateScenario(2);
            
            showCustomAlert("Proyección calculada. Revisa los resultados en el Comparador de Escenarios (Paso 4).", "Éxito");
        }
        
        // --- CONTRACT GENERATION LOGIC ---
        function generateContractPDF() {
            const data = {
                monto: getNumeroInfo('contract_monto'),
                clienteNombre: document.getElementById('contract_cliente_nombre').value.trim().toUpperCase(),
                clienteTel: document.getElementById('contract_cliente_telefono').value.trim(),
                clienteEmail: document.getElementById('contract_cliente_email').value.trim(),
                clienteDir: document.getElementById('contract_cliente_direccion').value.trim(),
                rsNombre: document.getElementById('contract_rs_nombre').value.trim().toUpperCase(),
                rsTel: document.getElementById('contract_rs_telefono').value.trim(),
                rsEmail: document.getElementById('contract_rs_email').value.trim(),
                rsDir: document.getElementById('contract_rs_direccion').value.trim()
            };

            if (!data.monto || !data.clienteNombre || !data.clienteTel || !data.clienteEmail || !data.clienteDir || !data.rsNombre || !data.rsTel || !data.rsEmail || !data.rsDir) {
                showCustomAlert("Todos los campos son obligatorios para generar el contrato.", "Datos Incompletos");
                return;
            }
            if (data.clienteTel.length !== 10 || data.rsTel.length !== 10 || !/^\d+$/.test(data.clienteTel) || !/^\d+$/.test(data.rsTel)) {
                showCustomAlert("Los números de teléfono deben contener 10 dígitos numéricos.", "Dato Inválido");
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'pt', 'letter');
                const PAGE_WIDTH = pdf.internal.pageSize.getWidth();
                const MARGIN = 50;
                let yPos = MARGIN;

                const printText = (text, x, y, options = {}) => {
                    const maxWidth = PAGE_WIDTH - (MARGIN * 2);
                    const lines = pdf.splitTextToSize(text, maxWidth);
                    pdf.text(lines, x, y, options);
                    return y + (lines.length * pdf.getLineHeight() * 0.7);
                };

                pdf.setFont('helvetica', 'bold');
                pdf.setFontSize(12);
                pdf.text("CONTRATO DE PRESTACIÓN DE SERVICIOS PROFESIONALES Y FINANCIAMIENTO", PAGE_WIDTH / 2, yPos, { align: 'center' });
                yPos += 30;

                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(10);
                let partiesText = `CONTRATO DE PRESTACIÓN DE SERVICIOS QUE CELEBRAN, POR UNA PARTE, RGC PENSIONES Y SEGUROS, REPRESENTADA EN ESTE ACTO POR LOS CC. ALMA GUADALUPE CANO PEREZ, MIGUEL ANGEL ROSEMBERG SALAZAR Y MARIANO GODINEZ NAVA, A QUIEN EN LO SUCESIVO SE LE DENOMINARÁ "EL PRESTADOR", Y POR LA OTRA PARTE, EL/LA C. ${data.clienteNombre}, A QUIEN EN LO SUCESIVO SE LE DENOMINARÁ "EL CLIENTE". AMBAS PARTES SE SUJETAN AL TENOR DE LAS SIGUIENTES DECLARACIONES Y CLÁUSULAS:`;
                yPos = printText(partiesText, MARGIN, yPos);
                yPos += 20;

                pdf.setFont('helvetica', 'bold');
                pdf.text("C L Á U S U L A S", PAGE_WIDTH / 2, yPos, { align: 'center' });
                yPos += 20;

                const clauses = [
                    { title: "PRIMERA. - OBJETO.", text: `EL PRESTADOR se obliga a proporcionar a EL CLIENTE servicios de asesoría, gestoría, planeación estratégica y financiamiento con el único fin de mejorar las condiciones de su futura pensión bajo la Ley del Seguro Social de 1973.` },
                    { title: "SEGUNDA. - MONTO Y FORMA DE PAGO.", text: `EL CLIENTE se obliga a pagar a EL PRESTADOR la cantidad total de $${formatNumber(data.monto)} MXN (SON: ${numeroALetras(data.monto)} 00/100 M.N.). Este monto será liquidado en su totalidad una vez que EL CLIENTE reciba la resolución de su pensión y los fondos correspondientes a su cuenta AFORE, primer(os) pago(s) de pensión y/o el préstamo para pensionado que se gestione. EL CLIENTE autoriza en este acto a que dichos fondos sean utilizados para liquidar el presente contrato, manifestando que no se requiere ningún pago por adelantado.` },
                    { title: "TERCERA. - OBLIGACIONES DEL PRESTADOR.", text: `EL PRESTADOR se compromete a realizar todos los análisis, cálculos, trámites y gestiones necesarias ante las instituciones correspondientes para lograr el objetivo pactado, manteniendo siempre informado a EL CLIENTE del progreso.` },
                    { title: "QUARTA. - OBLIGACIONES DEL CLIENTE.", text: `EL CLIENTE deberá proporcionar toda la documentación e información verídica que EL PRESTADOR requiera, así como firmar los documentos necesarios para la gestión de los trámites. La omisión o falsedad en la información proporcionada será causa de rescisión del contrato.` },
                    { title: "QUINTA. - RESPONSABLE SOLIDARIO.", text: `El/La C. ${data.rsNombre}, con domicilio en ${data.rsDir}, se constituye en este acto como RESPONSABLE SOLIDARIO de todas las obligaciones de pago adquiridas por EL CLIENTE, renunciando a los beneficios de orden y excusión.` },
                    { title: "SEXTA. - PAGARÉ.", text: `Para garantizar la obligación de pago, EL CLIENTE y su RESPONSABLE SOLIDARIO suscriben en este mismo acto un pagaré mercantil que forma parte integral del presente contrato, el cual se detalla al final de este documento.` },
                    { title: "SÉPTIMA. - CONFIDENCIALIDAD.", text: `Ambas partes se comprometen a guardar la más estricta confidencialidad sobre la información y documentos proporcionados mutuamente.` },
                    { title: "OCTAVA. - JURISDICCIÓN.", text: `Para la interpretación y cumplimiento del presente contrato, las partes se someten a la jurisdicción de los tribunales competentes de la Ciudad de México, renunciando a cualquier otro fuero que pudiera corresponderles por razón de sus domicilios presentes o futuros.` }
                ];

                pdf.setFontSize(9);
                clauses.forEach(clause => {
                    pdf.setFont('helvetica', 'bold');
                    yPos = printText(clause.title, MARGIN, yPos);
                    pdf.setFont('helvetica', 'normal');
                    yPos = printText(clause.text, MARGIN, yPos);
                    yPos += 10;
                });
                
                yPos = printText(`Leído que fue el presente contrato y enteradas las partes de su contenido y alcance legal, lo firman por duplicado en la Ciudad de México el día ${new Date().toLocaleDateString('es-MX', { day: 'numeric', month: 'long', year: 'numeric' })}.`, MARGIN, yPos);
                yPos += 50;

                pdf.text("__________________________________", MARGIN, yPos);
                pdf.text("__________________________________", PAGE_WIDTH - MARGIN, yPos, { align: 'right'});
                yPos += 15;
                pdf.text("EL CLIENTE", MARGIN, yPos);
                pdf.text("RESPONSABLE SOLIDARIO", PAGE_WIDTH - MARGIN, yPos, { align: 'right'});
                yPos += 15;
                pdf.text(data.clienteNombre, MARGIN, yPos);
                pdf.text(data.rsNombre, PAGE_WIDTH - MARGIN, yPos, { align: 'right'});
                yPos += 50;
                pdf.text("__________________________________", PAGE_WIDTH/2, yPos, { align: 'center'});
                yPos += 15;
                pdf.text("EL PRESTADOR", PAGE_WIDTH/2, yPos, { align: 'center'});
                yPos += 15;
                pdf.text("RGC PENSIONES Y SEGUROS", PAGE_WIDTH/2, yPos, { align: 'center'});

                yPos += 40;
                pdf.setLineDash([2, 2], 0);
                pdf.line(MARGIN, yPos, PAGE_WIDTH - MARGIN, yPos);
                pdf.setLineDash([], 0);
                yPos += 20;

                pdf.setFont('helvetica', 'bold');
                pdf.setFontSize(14);
                pdf.text("P A G A R É", PAGE_WIDTH / 2, yPos, { align: 'center' });
                yPos += 20;

                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(9);
                let pagareText = `Por valor recibido, DEBO(EMOS) Y PAGARÉ(MOS) incondicionalmente por este Pagaré a la orden de RGC PENSIONES Y SEGUROS en la Ciudad de México, el día que reciba mi resolución de pensión, la cantidad de $${formatNumber(data.monto)} MXN (SON: ${numeroALetras(data.monto)} 00/100 M.N.). Este pagaré forma parte del contrato de prestación de servicios de esta misma fecha y está sujeto a sus términos y condiciones.`;
                yPos = printText(pagareText, MARGIN, yPos);
                yPos += 30;

                pdf.text(`DEUDOR PRINCIPAL (EL CLIENTE)`, MARGIN, yPos);
                pdf.text(`RESPONSABLE SOLIDARIO`, PAGE_WIDTH - MARGIN, yPos, { align: 'right'});
                yPos += 15;
                pdf.text(`Nombre: ${data.clienteNombre}`, MARGIN, yPos);
                pdf.text(`Nombre: ${data.rsNombre}`, PAGE_WIDTH - MARGIN, yPos, { align: 'right'});
                yPos += 15;
                pdf.text(`Dirección: ${data.clienteDir}`, MARGIN, yPos);
                pdf.text(`Dirección: ${data.rsDir}`, PAGE_WIDTH - MARGIN, yPos, { align: 'right'});
                yPos += 15;
                pdf.text(`Teléfono: ${data.clienteTel}`, MARGIN, yPos);
                pdf.text(`Teléfono: ${data.rsTel}`, PAGE_WIDTH - MARGIN, yPos, { align: 'right'});
                yPos += 30;
                pdf.text("___________________________", MARGIN, yPos);
                pdf.text("___________________________", PAGE_WIDTH - MARGIN, yPos, { align: 'right'});
                yPos += 15;
                pdf.text("Firma", MARGIN, yPos);
                pdf.text("Firma", PAGE_WIDTH - MARGIN, yPos, { align: 'right'});

                pdf.save(`Contrato_RGC_${data.clienteNombre.replace(/\s/g, '_')}.pdf`);

            } catch(e) {
                console.error("Error al generar el PDF del contrato:", e);
                showCustomAlert("Ocurrió un error al generar el PDF. Revisa la consola para más detalles.", "Error de Exportación");
            }
        }
        
        function numeroALetras(n) {
            const unidades = ["", "UN", "DOS", "TRES", "CUATRO", "CINCO", "SEIS", "SIETE", "OCHO", "NUEVE"];
            const decenas = ["", "DIEZ", "VEINTE", "TREINTA", "CUARENTA", "CINCUENTA", "SESENTA", "SETENTA", "OCHENTA", "NOVENTA"];
            const centenas = ["", "CIENTO", "DOSCIENTOS", "TRESCIENTOS", "CUATROCIENTOS", "QUINIENTOS", "SEISCIENTOS", "SETECIENTOS", "OCHOCIENTOS", "NOVECIENTOS"];
            const especiales = {11:"ONCE", 12:"DOCE", 13:"TRECE", 14:"CATORCE", 15:"QUINCE", 16:"DIECISEIS", 17:"DIECISIETE", 18:"DIECIOCHO", 19:"DIECINUEVE", 21:"VEINTIUN", 22:"VEINTIDOS", 23:"VEINTITRES", 24:"VEINTICUATRO", 25:"VEINTICINCO", 26:"VEINTISEIS", 27:"VEINTISIETE", 28:"VEINTIOCHO", 29:"VEINTINUEVE"};
            
            function getDecenas(num) {
                if (num < 10) return unidades[num];
                if (num >= 10 && num < 20 || num > 20 && num < 30) return especiales[num] || (decenas[Math.floor(num/10)] + (num%10 !== 0 ? " Y " + unidades[num%10] : ""));
                return decenas[Math.floor(num/10)] + (num%10 !== 0 ? " Y " + unidades[num%10] : "");
            }
            function getCentenas(num) {
                if(num > 99) {
                    if (num === 100) return "CIEN";
                    return centenas[Math.floor(num/100)] + " " + getDecenas(num%100);
                }
                return getDecenas(num);
            }
            function getMiles(num) {
                if (num > 999) {
                    const mil = Math.floor(num/1000);
                    const resto = num%1000;
                    return (mil === 1 ? "MIL" : getCentenas(mil) + " MIL") + (resto > 0 ? " " + getCentenas(resto) : "");
                }
                return getCentenas(num);
            }
            function getMillones(num) {
                if (num >= 1000000) {
                     const millon = Math.floor(num/1000000);
                     const resto = num%1000000;
                     return (millon === 1 ? "UN MILLON" : getMiles(millon) + " MILLONES") + (resto > 0 ? " " + getMiles(resto) : "");
                }
                return getMiles(num);
            }
            if (n === 0) return "CERO";
            return getMillones(n);
        }

        // --- PASSWORD & SCENARIO LOGIC ---
        function showPasswordPrompt(message, title, onConfirm) {
            document.getElementById('customAlertTitle').textContent = title;
            document.getElementById('customAlertMessage').textContent = message;
            
            const passwordInput = document.getElementById('pdfPasswordInput');
            passwordInput.value = ''; 
            document.getElementById('passwordPromptContainer').style.display = 'block';

            const confirmButton = document.getElementById('customAlertButton');
            confirmButton.textContent = 'Confirmar';
            confirmButton.onclick = () => {
                onConfirm(passwordInput.value);
            };
            
            showElement('customAlertModal');
        }

        function promptForPassword() {
             if (Object.keys(scenarioData[1]).length === 0) {
                showCustomAlert("Primero debe calcular al menos un escenario en el Paso 4.", "Acción Requerida");
                return;
            }
            showPasswordPrompt(
                "Esta acción requiere privilegios de asesor. Por favor, ingresa tu contraseña para generar el reporte técnico completo.",
                "Acceso Restringido",
                (password) => {
                    if (password === "OICI120566010503") {
                        closeCustomAlert();
                        generateTechnicalPDF();
                    } else {
                        showCustomAlert("Contraseña incorrecta. No se puede generar el reporte.", "Acceso Denegado");
                    }
                }
            );
        }

        function handleMesesDepositoChange(input) {
            let value = parseInt(input.value);
            const lastValidValue = input.getAttribute('data-last-valid');

            if (isNaN(value) || value < 6 || value > 12) {
                input.value = lastValidValue;
                showCustomAlert("El valor debe ser un número entre 6 y 12.", "Valor Inválido");
                return;
            }

            if (value > 9) {
                passwordPromptContext = {
                    inputElement: input,
                    newValue: value,
                    oldValue: lastValidValue
                };
                showPasswordPrompt(
                    "Se requiere autorización para plazos mayores a 9 meses.",
                    "Contraseña de Autorización",
                    (password) => {
                        const ctx = passwordPromptContext;
                        if (password === "OICI120566010503") {
                            ctx.inputElement.setAttribute('data-last-valid', ctx.newValue);
                            showCustomAlert("Autorización exitosa. Plazo extendido.", "Éxito");
                            closeCustomAlert();
                            recalculateScenario(1);
                            recalculateScenario(2);
                        } else {
                            showCustomAlert("Contraseña incorrecta.", "Error de Autorización");
                            ctx.inputElement.value = ctx.oldValue;
                        }
                    }
                );
            } else {
                input.setAttribute('data-last-valid', value);
                recalculateScenario(1);
                recalculateScenario(2);
            }
        }

        function recalculateScenario(scenarioNum) {
            const meses = parseInt(document.getElementById(`scenario_${scenarioNum}_meses`).value) || 0;
            const semanasInput = document.getElementById(`scenario_${scenarioNum}_semanas`);
            const semanas = Math.round(datosClienteInfo.semanasCotizadasBase + (meses * (52.1429 / 12)));
            semanasInput.value = semanas;
            
            const results = {
                pension: document.getElementById(`scenario_${scenarioNum}_pension`),
                aguinaldo: document.getElementById(`scenario_${scenarioNum}_aguinaldo`),
                costoTotal: document.getElementById(`scenario_${scenarioNum}_costo_total`),
                coberturaAfore: document.getElementById(`scenario_${scenarioNum}_cobertura_afore`),
                coberturaDeposito: document.getElementById(`scenario_${scenarioNum}_cobertura_deposito`),
                coberturaExtra: document.getElementById(`scenario_${scenarioNum}_cobertura_extra`),
                prestamo: document.getElementById(`scenario_${scenarioNum}_prestamo`),
                resultadoFinal: document.getElementById(`scenario_${scenarioNum}_resultado_final`),
                proyeccionContainer: document.getElementById(`scenario_${scenarioNum}_proyeccion`),
                edadFinal: document.getElementById(`scenario_${scenarioNum}_edad_final`),
                sbcFinal: document.getElementById(`scenario_${scenarioNum}_sbc_final`),
                semanasFinales: document.getElementById(`scenario_${scenarioNum}_semanas_finales`),
            };

            if (meses <= 0 || semanas < 500) {
                Object.values(results).forEach(el => {
                    if(el.tagName === 'SPAN') el.textContent = '$0.00';
                    if(el.tagName === 'DIV') el.innerHTML = '';
                });
                results.edadFinal.textContent = '--';
                results.sbcFinal.textContent = '--';
                results.semanasFinales.textContent = '--';
                semanasInput.value = datosClienteInfo.semanasCotizadasBase;
                scenarioData[scenarioNum] = {};
                return;
            }

            const curp = document.getElementById('info_curpCliente').value;
            const fechaNacimiento = extraerFechaNacimientoCURP(curp);
            const inicioP1Str = document.getElementById('info_m40_p1_inicio').value;
            const sbcM40Ingresado = parseFloat(document.getElementById('info_m40_p1_sbc').value.replace(/,/g, '')) || 0;

            if (!fechaNacimiento || !inicioP1Str || !sbcM40Ingresado) {
                showCustomAlert("Faltan datos base (CURP, Fecha Inicio M40) del cálculo principal.", "Error");
                return;
            }

            const finP1Str = calcularFechaFinDesdeMeses(inicioP1Str, meses);
            if (!finP1Str) return;
            const [aF, mF] = finP1Str.split('-').map(Number);
            const fechaFinM40RealObj = new Date(Date.UTC(aF, mF - 1, getDiasEnMes(aF, mF)));
            const edadFinM40 = calcularEdadExacta(fechaNacimiento, fechaFinM40RealObj);
            let edadParaPorcentaje = edadFinM40.anos;
            if (edadFinM40.meses > 6 || (edadFinM40.meses === 6 && edadFinM40.dias >= 1)) {
                edadParaPorcentaje++;
            }

            const diasEnM40 = meses * (365.25 / 12);
            const diasASumarDeM40 = Math.min(diasEnM40, DIAS_PROMEDIO_PENSION);
            const diasBasePrevios = DIAS_PROMEDIO_PENSION - diasASumarDeM40;
            const sbcPromedio = ((sbcM40Ingresado * diasASumarDeM40) + (datosClienteInfo.sbcPromedioBase * diasBasePrevios)) / DIAS_PROMEDIO_PENSION;

            const pensionData = _calcularPensionDetallado(sbcPromedio, semanas, edadParaPorcentaje, SMGV_DF_Global, FACTOR_FOX_Global, tablaCuantiasGlobal);
            const pensionMensual = pensionData.PENSION_MENSUAL_ESTIMADA - 250;
            const aguinaldo = pensionData.AGUINALDO_ESTIMADO;

            let costoM40 = 0;
            let totalActualizacion = 0;
            let totalRecargos = 0;
            const [anioInicioP1Val, mesInicioP1Val] = inicioP1Str.split('-').map(Number);
            const fechaSimulacionPago = new Date(Date.UTC(aF, mF - 1, getDiasEnMes(aF, mF)));
            const mesActualizacion = new Date(fechaSimulacionPago);
            mesActualizacion.setUTCMonth(mesActualizacion.getUTCMonth() - 1);
            const inpcNumerador = getINPC(mesActualizacion.getUTCFullYear(), mesActualizacion.getUTCMonth() + 1);

            for (let m = 0; m < meses; m++) {
                const fechaCuota = new Date(Date.UTC(anioInicioP1Val, mesInicioP1Val - 1 + m, 1));
                const anioCuota = fechaCuota.getUTCFullYear();
                const mesCuota = fechaCuota.getUTCMonth() + 1;
                const tasaM40Anual = getTasaM40Porcentaje(anioCuota);
                const costoBaseMensual = sbcM40Ingresado * tasaM40Anual * getDiasEnMes(anioCuota, mesCuota);
                
                let actualizacion = 0;
                const inpcDenominador = getINPC(anioCuota, mesCuota);
                if (inpcNumerador && inpcDenominador && inpcNumerador > inpcDenominador) {
                    actualizacion = costoBaseMensual * ((inpcNumerador / inpcDenominador) - 1);
                }
                const pagoBaseActualizado = costoBaseMensual + actualizacion;
                
                let montoRecargos = 0;
                const fechaVencimiento = new Date(Date.UTC(anioCuota, mesCuota, 17));
                if (fechaSimulacionPago > fechaVencimiento) {
                    const mesesRetraso = (fechaSimulacionPago.getUTCFullYear() - fechaVencimiento.getUTCFullYear()) * 12 + (fechaSimulacionPago.getUTCMonth() - fechaVencimiento.getUTCMonth());
                    if (mesesRetraso > 0) montoRecargos = pagoBaseActualizado * 0.0147 * mesesRetraso;
                }
                costoM40 += pagoBaseActualizado + montoRecargos;
                totalActualizacion += actualizacion;
                totalRecargos += montoRecargos;
            }

            const comisionExcedente = getNumeroInfo('info_comisionExcedente');
            const costoFijoAdicional = 140000;
            const comision = costoM40 * 0.16;
            const factorMultiplicador = costoM40 * 0.5;
            const costoTotalContrato = (costoM40 + factorMultiplicador + costoFijoAdicional + comision + comisionExcedente) - 35000;
            
            const aforeActual = getNumeroInfo('info_aforeActual');
            const mesesPrimerDeposito = parseInt(document.getElementById('info_mesesPrimerDeposito').value) || 6;
            const primerDeposito = pensionMensual * mesesPrimerDeposito;
            const extraAfore = diasEnM40 * sbcM40Ingresado * 0.02;
            const subtotalCobertura = aforeActual + primerDeposito + extraAfore;
            const deficit = costoTotalContrato - subtotalCobertura;
            
            const descuentoMaximoPermitido = pensionMensual * 0.30;
            const slopePrestamo = (PRESTAMO_PUNTO_B_MONTO - PRESTAMO_PUNTO_A_MONTO) / (PRESTAMO_PUNTO_B_DESCUENTO - PRESTAMO_PUNTO_A_DESCUENTO);
            let prestamoAlcanzable = slopePrestamo * (descuentoMaximoPermitido - PRESTAMO_PUNTO_A_DESCUENTO) + PRESTAMO_PUNTO_A_MONTO;
            prestamoAlcanzable = Math.max(0, prestamoAlcanzable);
            
            let prestamoReal = 0;
            let descuentoMensual = 0;
            let resultadoFinalTexto = '';
            let resultadoFinalColor = 'text-gray-800';

            if (deficit > 0) {
                prestamoReal = Math.min(deficit, prestamoAlcanzable);
                if (prestamoReal > 0) {
                    const slopeDescuento = (PRESTAMO_PUNTO_B_DESCUENTO - PRESTAMO_PUNTO_A_DESCUENTO) / (PRESTAMO_PUNTO_B_MONTO - PRESTAMO_PUNTO_A_MONTO);
                    descuentoMensual = slopeDescuento * (prestamoReal - PRESTAMO_PUNTO_A_MONTO) + PRESTAMO_PUNTO_A_DESCUENTO;
                }
            }
            
            const saldoFinal = subtotalCobertura + prestamoReal - costoTotalContrato;

            if (saldoFinal > 0.01) {
                resultadoFinalTexto = `SALDO A FAVOR: $${formatNumber(saldoFinal)}`;
                resultadoFinalColor = 'text-green-600';
            } else if (saldoFinal >= -0.01) {
                resultadoFinalTexto = "PROYECTO VIABLE";
                resultadoFinalColor = 'text-blue-600';
            } else {
                resultadoFinalTexto = `DÉFICIT: $${formatNumber(Math.abs(saldoFinal))}`;
                resultadoFinalColor = 'text-red-600';
            }
            
            results.pension.textContent = '$' + formatNumber(pensionMensual);
            results.aguinaldo.textContent = '$' + formatNumber(aguinaldo);
            results.costoTotal.textContent = '$' + formatNumber(costoTotalContrato);
            results.coberturaAfore.textContent = '$' + formatNumber(aforeActual);
            results.coberturaDeposito.textContent = '$' + formatNumber(primerDeposito);
            results.coberturaExtra.textContent = '$' + formatNumber(extraAfore);
            results.prestamo.textContent = '$' + formatNumber(prestamoReal);
            results.resultadoFinal.textContent = resultadoFinalTexto;
            results.resultadoFinal.className = `float-right font-bold ${resultadoFinalColor}`;
            results.edadFinal.textContent = `${edadFinM40.anos}a, ${edadFinM40.meses}m, ${edadFinM40.dias}d`;
            results.sbcFinal.textContent = '$' + formatNumber(sbcPromedio);
            results.semanasFinales.textContent = formatNumber(semanas, 0);

            let htmlProyeccion = `<table class="w-full text-xs mt-2">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="p-1 text-left">Año</th>
                        <th class="p-1 text-right">P. Bruta (Inflación)</th>
                        <th class="p-1 text-right">Desc. Préstamo</th>
                        <th class="p-1 text-right">P. Neta Mensual</th>
                    </tr>
                </thead>
                <tbody>`;
            
            for (let i = 1; i <= 10; i++) {
                const pensionBruta = pensionMensual * Math.pow(1 + averageAnnualINPCGrowth, i - 1);
                const descuentoAplicado = (i <= 5 && deficit > 0) ? descuentoMensual : 0;
                const pensionNeta = pensionBruta - descuentoAplicado;
                
                htmlProyeccion += `<tr>
                    <td class="p-1 border-b text-left">${i}</td>
                    <td class="p-1 border-b text-right">$${formatNumber(pensionBruta)}</td>
                    <td class="p-1 border-b text-right text-red-600">-$${formatNumber(descuentoAplicado)}</td>
                    <td class="p-1 border-b text-right font-bold text-green-700">$${formatNumber(pensionNeta)}</td>
                </tr>`;
            }
            htmlProyeccion += `</tbody></table>`;
            results.proyeccionContainer.innerHTML = htmlProyeccion;
            
            // Store data for PDF
            scenarioData[scenarioNum] = {
                mesesM40: meses,
                semanasFinales: semanas,
                edadFinal: `${edadFinM40.anos}a, ${edadFinM40.meses}m`,
                sbcPromedioFinal: sbcPromedio,
                pensionMensual,
                aguinaldo,
                costoTotalContrato,
                coberturaAfore: aforeActual,
                coberturaDeposito: primerDeposito,
                coberturaExtra: extraAfore,
                prestamoRequerido: prestamoReal,
                resultadoFinal: resultadoFinalTexto,
                costoM40,
                totalActualizacion,
                totalRecargos,
                factorMultiplicador,
                comision,
                comisionExcedente,
                costoFijoAdicional,
                proyeccion: []
            };
            for (let i = 1; i <= 10; i++) {
                const pensionBruta = pensionMensual * Math.pow(1 + averageAnnualINPCGrowth, i - 1);
                const descuentoAplicado = (i <= 5 && deficit > 0) ? descuentoMensual : 0;
                const pensionNeta = pensionBruta - descuentoAplicado;
                scenarioData[scenarioNum].proyeccion.push([i, `$${formatNumber(pensionBruta)}`, `-$${formatNumber(descuentoAplicado)}`, `$${formatNumber(pensionNeta)}`]);
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            initializeMainAppDisplay();
            document.getElementById('agreementCheckbox').addEventListener('change', (e) => {
                document.getElementById('acceptAgreementButton').disabled = !e.target.checked;
            });
            
            document.getElementById('login_password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            
            document.getElementById('agreementDate').textContent = new Date().toLocaleDateString('es-MX', { day: 'numeric', month: 'long', year: 'numeric' });

            showElement('confidentialityModal');
        });

    </script>
</body>
</html>

