<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RGC Pensiones - Calculadora de Proyecci√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --dark-blue: #003366; /* Azul marino profundo */
            --gold: #D4AF37;      /* Oro met√°lico */
            --dark-gold: #B8860B; /* Oro oscuro para hover */
            --text-dark: #1A202C;  /* Casi negro */
            --text-medium: #4A5568;/* Gris oscuro */
            --bg-light: #F8F9FA;  /* Gris muy claro */
            --white: #FFFFFF;
            --border-color: #E2E8F0;
            --success-color: #16A34A;
            --danger-color: #DC2626;
        }

        body { 
            font-family: 'Montserrat', sans-serif; 
            background-color: var(--bg-light);
            color: var(--text-medium);
        }
        
        /* Encabezado Principal */
        .main-header {
            background: linear-gradient(135deg, var(--dark-blue) 0%, #002244 100%);
            color: var(--white);
            padding: 2.5rem 1rem;
            text-align: center;
            border-radius: 0 0 40px 40px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 3rem;
        }
        .main-header .logo-text {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--gold);
            text-shadow: 1px 1px 3px rgba(0,0,0,0.4);
            letter-spacing: 1px;
        }
        .main-header h1 {
            font-weight: 800;
            font-size: 2.25rem; /* 36px */
            letter-spacing: -0.5px;
            margin-top: 1rem;
        }
        .main-header p {
            font-size: 1.125rem; /* 18px */
            opacity: 0.85;
            font-weight: 400;
        }

        /* Estructura de Secciones */
        .infographic-section {
            background-color: var(--white);
            border-radius: 20px;
            padding: 2rem 2.5rem;
            margin-bottom: 2.5rem;
            box-shadow: 0 8px 30px rgba(0, 51, 102, 0.08);
            border: 1px solid var(--border-color);
            border-top: 6px solid var(--dark-blue);
        }
        .infographic-section h2 {
            font-size: 1.75rem; /* 28px */
            font-weight: 700;
            margin-bottom: 2rem;
            color: var(--dark-blue);
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }
        .infographic-section h2 i {
            margin-right: 1rem;
            font-size: 1.5rem;
            color: var(--gold);
        }
        .infographic-section h3.subsection-title {
            font-size: 1.25rem; /* 20px */
            font-weight: 600;
            color: var(--dark-blue);
            margin-top: 2rem;
            margin-bottom: 1.5rem;
        }
        
        /* Formularios y Entradas */
        .input-group label {
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-medium); 
            font-size: 0.875rem; /* 14px */
            display: block;
        }
        .input-group input[type="text"],
        .input-group input[type="password"],
        .input-group input[type="number"],
        .input-group input[type="month"],
        .input-group select {
            padding: 0.8rem 1rem;
            border: 1px solid #CBD5E0;
            border-radius: 0.5rem; /* 8px */
            font-size: 1rem;
            width: 100%;
            transition: all 0.2s ease-in-out;
            background-color: #FDFDFD;
        }
        .input-group input:focus, .input-group select:focus {
            border-color: var(--gold); 
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
            outline: none;
        }
        .input-group input[readonly] {
            background-color: #E9ECEF;
        }
        
        /* Real-time Validation Styles */
        .input-valid {
            border-color: var(--success-color);
            box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.2);
        }
        .input-invalid {
            border-color: var(--danger-color);
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.2);
        }
        .validation-message {
            font-size: 0.75rem; /* 12px */
            color: var(--danger-color);
            margin-top: 0.25rem;
            height: 1rem; /* Reserve space to prevent layout shift */
        }

        /* Botones */
        .btn {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            padding: 0.8rem 2rem;
            border-radius: 0.5rem;
            transition: all 0.25s ease-out;
            border: none;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn:disabled {
            background: #A0AEC0;
            color: #E2E8F0;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        
        .btn-gold {
            background: linear-gradient(135deg, var(--gold), var(--dark-gold));
            color: var(--dark-blue);
        }
        .btn-gold:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(212, 175, 55, 0.3);
        }

        .btn-blue {
            background: linear-gradient(135deg, var(--dark-blue), #004488);
            color: var(--white);
        }
        .btn-blue:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 51, 102, 0.3);
        }
        
        .btn-secondary {
            background-color: var(--white);
            color: var(--dark-blue);
            border: 2px solid var(--dark-blue);
            padding: 0.7rem 1.5rem;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: var(--dark-blue);
            color: var(--white);
        }
        
        .btn-danger-icon {
            background-color: #FFF1F2;
            color: #E53E3E;
            border: 1px solid #E53E3E;
            padding: 0.5rem;
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }
        .btn-danger-icon:hover {
            background-color: #E53E3E;
            color: var(--white);
        }

        /* Tarjetas de Resultados */
        .results-card {
            background-color: var(--white);
            padding: 2rem;
            border-radius: 1rem;
            margin-top: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .results-card .highlight { font-size: 1.5rem; font-weight: 700; }
        .results-card .highlight-gold { color: var(--dark-gold); }
        .results-card .highlight-blue { color: var(--dark-blue); }
        .results-card .highlight-green { color: #16A34A; }
        .results-card .highlight-red { color: #DC2626; }
        
        /* Login Container */
        #loginContainer {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-light);
            z-index: 40;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }
        #loginContainer.active {
            opacity: 1;
            pointer-events: auto;
        }

        .login-box {
            background-color: var(--white);
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 51, 102, 0.15);
            width: 100%;
            max-width: 450px;
            border-top: 6px solid var(--gold);
        }
        .login-box h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 2rem;
            font-weight: 800;
            color: var(--dark-blue);
            text-align: center;
            margin-bottom: 2.5rem;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 34, 68, 0.7); /* Azul oscuro semi-transparente */
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: var(--white);
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 51, 102, 0.2);
            max-width: 90%;
            width: 650px;
            border-top: 6px solid var(--gold);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        
        .modal-content-alert {
             text-align: center;
             width: 400px;
        }
        
        .modal-content h2 {
             font-family: 'Montserrat', sans-serif;
             color: var(--dark-blue);
             font-size: 1.5rem;
             font-weight: 700;
             text-align: center;
             margin-bottom: 1.5rem;
             padding-bottom: 1rem;
             border-bottom: 1px solid var(--border-color);
        }
        .privacy-text-container {
            border: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            background-color: var(--bg-light);
            max-height: 55vh;
            overflow-y: auto;
            margin-bottom: 1.5rem;
        }
        .privacy-text-container p {
            font-size: 0.875rem; /* 14px */
            line-height: 1.6;
            margin-bottom: 1rem;
        }
        .privacy-text-container::-webkit-scrollbar { width: 8px; }
        .privacy-text-container::-webkit-scrollbar-track { background: var(--border-color); border-radius: 10px; }
        .privacy-text-container::-webkit-scrollbar-thumb { background-color: var(--gold); border-radius: 10px; }

        .app-footer {
            text-align: center;
            margin-top: 4rem;
            padding: 2.5rem 1rem;
            background-color: var(--dark-blue);
            color: var(--white);
            border-radius: 40px 40px 0 0;
        }
        .app-footer .logo-text-footer {
            color: var(--gold);
            font-weight: 700;
            font-size: 1.25rem;
            margin-bottom: 1rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .app-footer p { opacity: 0.8; }

        #sessionTimerContainer {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            color: var(--text-dark);
            z-index: 100;
            transition: color 0.3s;
        }
    </style>
</head>
<body>
    <!-- Confidentiality Agreement Modal -->
    <div id="confidentialityModal" class="modal-overlay">
        <div class="modal-content">
            <h2>CARTA COMPROMISO DE CONFIDENCIALIDAD</h2>
            <div class="privacy-text-container">
                 <p><strong>Fecha:</strong> <span id="agreementDate"></span><br><strong>Lugar:</strong> Ciudad de M√©xico, M√©xico</p>
                <p>En mi calidad de Asesor para RGC Pensiones y Seguros, manifiesto y acepto de manera voluntaria los siguientes t√©rminos y condiciones:</p>
                <p><strong>1. ANTECEDENTES</strong><br>Reconozco que, en virtud de mi relaci√≥n profesional con RGC Pensiones, se me ha proporcionado acceso a una herramienta de software especializada (en adelante, "la Herramienta"), la cual es fundamental para el desempe√±o de mis funciones.</p>
                <p><strong>2. PROPIEDAD INTELECTUAL</strong><br>Declaro tener pleno conocimiento de que la Herramienta es propiedad intelectual exclusiva del C. Ivan Roberto Ortiz Cano, y que RGC Pensiones cuenta con la licencia y autorizaci√≥n para su uso con fines corporativos espec√≠ficos. Entiendo que mi acceso a la misma es una concesi√≥n temporal y est√° estrictamente limitado al ejercicio de mis responsabilidades dentro de esta empresa.</p>
                <p><strong>3. COMPROMISO DE USO EXCLUSIVO</strong><br>Me comprometo de manera irrevocable a utilizar la Herramienta √∫nica y exclusivamente para los fines y objetivos de negocio de RGC Pensiones.</p>
                <p><strong>4. PROHIBICIONES ESPEC√çFICAS</strong><br>Queda estrictamente prohibido y me obligo a abstenerme de:<br>
                a) Utilizar la Herramienta, sus funciones, datos, metodolog√≠as o resultados para obtener cualquier tipo de lucro o beneficio personal, directo o indirecto.<br>
                b) Emplear la Herramienta para prestar servicios, asesor√≠as o realizar actividades para terceros, ya sean personas f√≠sicas o morales, ajenos a RGC Pensiones.<br>
                c) Copiar, reproducir, modificar, distribuir, vender, sublicenciar, descompilar o realizar ingenier√≠a inversa de la Herramienta o cualquiera de sus componentes.<br>
                d) Compartir mis credenciales de acceso (contrase√±a o cualquier otra forma de acceso) con cualquier otra persona, dentro o fuera de la organizaci√≥n.</p>
                <p><strong>5. CONSECUENCIAS DEL INCUMPLIMIENTO</strong><br>Entiendo y acepto que el incumplimiento de cualquiera de los puntos estipulados en esta carta ser√° considerado una falta grave y se podr√° dar lugar a:<br>
                a) Concluir la relaci√≥n profesional y comercial con RGC Pensiones, sin responsabilidad para la empresa.<br>
                b) El inicio de acciones legales en mi contra por parte de RGC Pensiones y/o del Sr. Ivan Roberto Ortiz Cano, titular de la propiedad intelectual, para reclamar la reparaci√≥n de los da√±os y perjuicios ocasionados.</p>
                <p>Este compromiso mantendr√° su vigencia durante toda mi relaci√≥n con RGC Pensiones y subsistir√° incluso despu√©s de su terminaci√≥n, por tiempo indefinido.</p>
                <p>Habiendo le√≠do y comprendido en su totalidad el presente documento, lo acepto de conformidad.</p>
            </div>
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <input type="checkbox" id="agreementCheckbox" class="h-5 w-5 text-blue-600 border-gray-400 rounded focus:ring-gold-500">
                    <label for="agreementCheckbox" class="ml-3 block text-sm text-gray-700 font-medium">
                        He le√≠do, comprendido y acepto los t√©rminos.
                    </label>
                </div>
                <button id="acceptAgreementButton" onclick="acceptAgreement()" class="btn btn-gold" disabled>
                    Aceptar y Continuar
                </button>
            </div>
        </div>
    </div>

    <div id="sessionTimerContainer" style="display: none;">
        <i class="fas fa-clock mr-2"></i>Tiempo restante: <span id="sessionCountdown">10:00</span>
    </div>

    <!-- Login Section -->
    <div id="loginContainer">
        <div class="login-box">
             <div class="logo-text text-center text-2xl mb-8" style="color: var(--dark-blue); text-shadow: none;">RGC PENSIONES Y SEGUROS</div>
            <h2>Acceso de Asesor</h2>
            <div class="input-group mb-4">
                <label for="login_asesor"><i class="fas fa-user-tie mr-2 opacity-70"></i>Nombre del Asesor</label>
                <input type="text" id="login_asesor" placeholder="Nombre Apellido" class="w-full">
            </div>
            <div class="input-group">
                <label for="login_password"><i class="fas fa-lock mr-2 opacity-70"></i>Contrase√±a de Acceso</label>
                <input type="password" id="login_password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full">
            </div>
            <div class="text-center mt-8">
                <button id="loginButton" onclick="handleLogin()" class="btn btn-blue w-full">
                    <i class="fas fa-sign-in-alt"></i>Ingresar
                </button>
            </div>
            <div id="login_errorMessage" class="error-message-infographic" style="display: none; margin-top: 1.5rem;"><p></p></div>
        </div>
    </div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-6xl">
        <!-- Main Application Content -->
        <div id="mainContentContainer" style="display: none;">
            <header class="main-header">
                <div class="logo-text">RGC PENSIONES Y SEGUROS</div>
                <h1>Calculadora de Proyecci√≥n de Pensi√≥n</h1>
                <p>Una herramienta exclusiva para transformar el futuro de nuestros clientes.</p>
            </header>

            <section id="infoSection1" class="infographic-section">
                <h2><i class="fas fa-user-edit"></i>Paso 1: Datos del Cliente</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div class="input-group">
                        <label for="info_nombreCompleto">Nombre Completo:</label>
                        <input type="text" id="info_nombreCompleto" placeholder="Nombre completo del cliente" class="w-full">
                    </div>
                    <div class="input-group">
                        <label for="info_semanasCotizadas">Semanas Cotizadas Netas:</label>
                        <input type="number" id="info_semanasCotizadas" placeholder="Ej: 1250" class="w-full">
                        <p id="info_semanasCotizadas_error" class="validation-message"></p>
                    </div>
                    <div class="input-group">
                        <label for="info_edadCliente">Edad Actual:</label>
                        <input type="number" id="info_edadCliente" placeholder="Ej: 60" class="w-full">
                        <p id="info_edadCliente_error" class="validation-message"></p>
                    </div>
                    <div class="input-group">
                        <label for="info_sbcPromedio">SBC Promedio Base (250 sem):</label>
                        <input type="number" id="info_sbcPromedio" placeholder="Ingresar o calcular" class="w-full">
                        <p id="info_sbcPromedio_error" class="validation-message"></p>
                    </div>
                </div>
                
                <div class="mt-8 mb-4">
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="info_usarSBCDetallado" class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-gold-500" onchange="toggleSBCDetalladoSeccion()">
                        <span class="ml-3 text-gray-700 font-medium">Usar C√°lculo de SBC Detallado (Modo Precisi√≥n)</span>
                    </label>
                </div>

                <div id="info_seccionSBCDetallado" class="mt-6 p-6 border border-gray-200 rounded-xl bg-gray-50" style="display: none;">
                    <h3 class="subsection-title">C√°lculo Detallado de SBC Promedio (√öltimos 1750 d√≠as)</h3>
                    <div class="overflow-x-auto mb-4">
                        <table id="info_tablaHistorialLaboral" class="sbc-detalle-table w-full text-sm text-left">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>
                                    <th scope="col" class="px-4 py-3">Fecha Mov.</th>
                                    <th scope="col" class="px-4 py-3">Tipo Mov.</th>
                                    <th scope="col" class="px-4 py-3">Nombre Patr√≥n</th>
                                    <th scope="col" class="px-4 py-3">SBC Diario ($)</th>
                                    <th scope="col" class="px-4 py-3 w-24 text-center">Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="info_tablaHistorialLaboralBody"></tbody>
                        </table>
                    </div>
                    <button type="button" onclick="agregarMovimientoHistorialInfografia()" class="btn btn-secondary text-sm py-2 px-4"><i class="fas fa-plus"></i>Agregar</button>
                    <button type="button" onclick="calcularYUsarSBCDetalladoInfografia()" class="btn btn-blue text-sm py-2 px-4 float-right">
                        <i class="fas fa-check-circle"></i>Calcular y Usar
                    </button>
                </div>

                <div class="text-center mt-10">
                    <button onclick="calcularPensionBaseInfografia()" class="btn btn-blue">
                        <i class="fas fa-calculator"></i>Calcular Pensi√≥n Base
                    </button>
                </div>
                <div id="info_resultadosPensionBase" class="results-card" style="display: none;">
                    <h3 class="text-lg font-semibold mb-4 text-blue-700">Pensi√≥n Base Estimada</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 mb-6">
                        <div>
                            <p class="text-sm text-gray-500">Pensi√≥n Mensual:</p>
                            <p id="info_resPensionMensual" class="text-2xl font-bold highlight-blue">$0.00</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Aguinaldo Anual:</p>
                            <p id="info_resAguinaldo" class="text-2xl font-bold highlight-blue">$0.00</p>
                        </div>
                        <div class="md:col-span-2 mt-2 pt-2 border-t">
                             <p class="text-sm text-gray-500">Ingreso Total (Primer A√±o):</p>
                             <p id="info_resIngresoAnual" class="text-2xl font-bold highlight-green">$0.00</p>
                        </div>
                    </div>
                    <h4 class="text-md font-semibold mt-6 mb-3 text-blue-700">Proyecci√≥n de Crecimiento (5% inflaci√≥n anual)</h4>
                    <div id="info_proyeccionPensionBase" class="overflow-x-auto">
                        <!-- Table will be generated by JS -->
                    </div>
                </div>
                <div id="info_mensajeErrorBase" class="error-message-infographic" style="display: none;"><p></p></div>
            </section>

            <section id="infoSection2" class="infographic-section">
                <h2><i class="fas fa-chart-line"></i>Paso 2: Estrategia Modalidad 40</h2>
                 <div class="input-group mb-6">
                    <label for="info_curpCliente">CURP:</label>
                    <input type="text" id="info_curpCliente" placeholder="CURP del cliente (18 caracteres)" maxlength="18" oninput="this.value = this.value.toUpperCase()" class="w-full">
                    <p id="info_curpCliente_error" class="validation-message"></p>
                </div>
                <h3 class="subsection-title">Definir Periodo de Inversi√≥n en M40</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-x-8 gap-y-6">
                    <div class="input-group">
                        <label for="info_m40_p1_inicio">Fecha Inicio M40:</label>
                        <input type="month" id="info_m40_p1_inicio" onchange="actualizarSBCMaximoM40(); actualizarFechaFinM40Display();" class="w-full">
                    </div>
                    <div class="input-group">
                        <label for="info_m40_p1_meses">Meses a Invertir:</label>
                        <input type="number" id="info_m40_p1_meses" placeholder="Ej: 60" max="60" oninput="actualizarFechaFinM40Display()" class="w-full">
                    </div>
                    <div class="input-group">
                        <label for="info_m40_p1_sbc">SBC Diario M40 (Tope):</label>
                        <input type="number" id="info_m40_p1_sbc" placeholder="Autom√°tico" class="w-full">
                    </div>
                </div>
                <div class="text-center mt-10">
                    <button id="btnCalcularEscenarioM40" onclick="calcularEscenarioM40Infografia()" class="btn btn-gold">
                        <i class="fas fa-cogs"></i>Calcular Proyecci√≥n M40
                    </button>
                </div>
                <div id="info_resultadosEscenarioM40" class="results-card" style="display: none;">
                    <h3 class="text-xl font-bold mb-4 text-center" style="color: var(--dark-gold);">Resultados de la Proyecci√≥n</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="text-center p-4 rounded-lg bg-gray-50">
                            <h4 class="text-gray-500 font-semibold">Pensi√≥n Base Mensual</h4>
                            <p id="info_compPensionBase" class="text-3xl font-bold highlight-blue">$0.00</p>
                        </div>
                        <div class="text-center p-4 rounded-lg border-2 border-amber-400 bg-amber-50">
                            <h4 class="text-amber-800 font-semibold">Pensi√≥n M40 Mensual</h4>
                            <p id="info_compPensionM40" class="text-3xl font-bold highlight-gold">$0.00</p>
                        </div>
                    </div>
                    <p class="text-center text-2xl font-bold mb-6"><span class="highlight-green">Incremento Mensual de: <span id="info_compIncrementoNetoM40">$0.00</span>!</span> üöÄ</p>
                    <hr class="my-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                        <p><strong>Nuevo SBC Promedio:</strong> <span id="info_nuevoSBCPromedioM40" class="font-semibold"></span> MXN</p>
                        <p><strong>Nuevas Semanas Cotizadas:</strong> <span id="info_nuevasSemanasM40" class="font-semibold"></span></p>
                        <p><strong>Edad para % Pensi√≥n:</strong> <span id="info_nuevaEdadM40" class="font-semibold"></span> a√±os</p>
                        <p><strong>Costo Total M40 (c/Act+Rec):</strong> <span id="info_costoTotalM40Simulacion" class="font-semibold highlight-red"></span> MXN</p>
                    </div>
                </div>
            </section>

            <section id="infoSection3" class="infographic-section">
                <h2><i class="fas fa-hand-holding-usd"></i>Paso 3: An√°lisis Financiero</h2>
                <h3 class="subsection-title">Fuentes de Cobertura</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div class="input-group">
                        <label for="info_aforeActual">AFORE Actual ($):</label>
                        <input type="number" id="info_aforeActual" placeholder="0.00" oninput="recalcularCoberturaTrasCambio()" class="w-full">
                    </div>
                    <div class="input-group">
                        <label for="info_mesesPrimerDeposito">Meses para Primer Dep√≥sito (6-10):</label>
                        <input type="number" id="info_mesesPrimerDeposito" value="6" min="6" max="10" oninput="recalcularCoberturaTrasCambio()" class="w-full">
                    </div>
                </div>
                 <div class="mt-8 pt-6 border-t">
                    <h3 class="subsection-title">Ajustes Adicionales al Costo</h3>
                    <div class="input-group">
                        <label for="info_comisionExcedente">Comisi√≥n por Excedente ($):</label>
                        <input type="number" id="info_comisionExcedente" placeholder="0.00" oninput="recalcularCoberturaTrasCambio()" class="w-full">
                    </div>
                </div>
                <div class="results-card mt-8">
                    <p><strong>Costo Total del Contrato (Bruto):</strong> <span id="info_costoTotalContratoBruto" class="font-semibold highlight-red float-right">$0.00</span></p>
                    <hr class="my-4">
                    <p>1. Saldo AFORE: <span id="info_coberturaAfore" class="font-semibold highlight-green float-right">$0.00</span></p>
                    <p>2. Primer Dep√≥sito (<span id="display_mesesPrimerDeposito">6</span> meses): <span id="info_coberturaPrimerDeposito" class="font-semibold highlight-green float-right">$0.00</span></p>
                    <p>3. Extra AFORE (Retiro M40): <span id="info_coberturaExtraAfore" class="font-semibold highlight-green float-right">$0.00</span></p>
                    <hr class="my-4">
                    <p class="font-bold">Subtotal Cobertura: <span id="info_coberturaSubtotalSinPrestamo" class="font-semibold highlight-green float-right">$0.00</span></p>
                     <div id="info_prestamoInfo" class="mt-4 border-t pt-4" style="display: none;">
                        <p class="text-red-700 font-medium">D√©ficit a cubrir: <span id="info_deficitAntesPrestamo" class="font-semibold float-right">$0.00</span></p>
                        <p class="text-blue-700 font-medium">Pr√©stamo Necesario (Estimado): <span id="info_prestamoNecesario" class="font-semibold float-right">$0.00</span></p>
                        <p class="text-blue-700 font-medium">Descuento Mensual Pr√©stamo: <span id="info_descuentoMensualPrestamo" class="font-semibold float-right">$0.00</span></p>
                    </div>
                     <p class="mt-6 text-xl font-bold text-center"><span id="info_resultadoAnalisisCredito"></span></p>
                     <p class="text-center text-lg"><span id="info_etiquetaSaldoFinal" class="font-semibold"></span> <span id="info_montoSaldoFinal" class="font-bold">$0.00</span></p>
                </div>
            </section>

            <section id="infoSection4" class="infographic-section">
                <h2><i class="fas fa-rocket"></i>Paso 4: Resumen de Beneficios</h2>
                 <div class="results-card bg-blue-50 border-blue-200">
                    <p class="text-center text-2xl font-bold text-blue-800 mb-6">
                        Incremento Neto Mensual (A√±o 1): <span id="info_ventajaIncrementoNeto" class="highlight-green">$0.00</span>
                    </p>
                    <div class="text-center mb-6">
                        <i class="fas fa-home fa-4x text-blue-400 mb-2"></i>
                        <p class="mt-2 text-lg text-gray-700">Tu nueva pensi√≥n equivale a un inmueble de:</p>
                        <p class="text-3xl font-bold text-blue-700" id="info_ventajaValorInmueble">$0.00 MXN</p>
                        <p class="text-sm text-gray-500">(Generando rentas vitalicias, cap. 0.4% mensual)</p>
                    </div>
                     <hr class="my-6">
                    <h4 class="text-lg font-semibold text-blue-800 mb-3">Proyecci√≥n de Pensi√≥n Neta Anual:</h4>
                    <div id="info_proyeccionPensionNetaAnual" class="space-y-1 text-sm overflow-x-auto"></div>
                </div>
            </section>
            
            <section id="infoSection5" class="infographic-section text-center">
                <h2><i class="fas fa-file-pdf"></i>Paso 5: Exportar Propuesta</h2>
                <p class="mb-8 text-gray-600 text-lg max-w-2xl mx-auto">Genera un reporte profesional en PDF con todos los detalles de esta proyecci√≥n para compartir con el cliente.</p>
                <button id="exportPdfButton" onclick="exportarPropuestaPDFInfografia()" class="btn btn-gold text-lg">
                    <i class="fas fa-download"></i>Exportar a PDF
                </button>
            </section>

            <footer class="app-footer">
                <div class="logo-text-footer">RGC PENSIONES Y SEGUROS</div>
                <p>&copy; <span id="currentYear"></span> RGC Pensiones y Seguros. Todos los derechos reservados.</p>
                <p class="text-xs mt-1 opacity-70">Esta es una simulaci√≥n y los resultados pueden variar. Consulta a un asesor para una evaluaci√≥n detallada.</p>
            </footer>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="customAlertModal" class="modal-overlay">
        <div class="modal-content modal-content-alert">
            <h2 id="customAlertTitle" class="text-xl">Alerta</h2>
            <p id="customAlertMessage" class="text-base my-6"></p>
            <button onclick="closeCustomAlert()" class="btn btn-blue">Aceptar</button>
        </div>
    </div>
    
    <script>
        // --- Global Variables ---
        let nombreAsesorGlobal = "";
        
        // --- Session Timer Logic ---
        let sessionTimeout;
        let sessionInterval;
        const sessionDuration = 10 * 60 * 1000; // 10 minutes
        let sessionEndTime;

        function startSessionTimer() {
            clearTimeout(sessionTimeout);
            clearInterval(sessionInterval);
            sessionEndTime = Date.now() + sessionDuration;
            sessionTimeout = setTimeout(logout, sessionDuration);
            sessionInterval = setInterval(updateCountdown, 1000);
            showElement('sessionTimerContainer');
            updateCountdown();
        }

        function updateCountdown() {
            const remainingTime = sessionEndTime - Date.now();
            if (remainingTime <= 0) {
                logout();
                return;
            }
            const minutes = Math.floor((remainingTime / 1000) / 60);
            const seconds = Math.floor((remainingTime / 1000) % 60);
            const countdownEl = document.getElementById('sessionCountdown');
            const timerContainer = document.getElementById('sessionTimerContainer');
            countdownEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            if (remainingTime < 2 * 60 * 1000) { timerContainer.style.color = '#DC2626'; } 
            else { timerContainer.style.color = 'var(--text-dark)';}
        }

        function logout() {
            clearTimeout(sessionTimeout);
            clearInterval(sessionInterval);
            hideElement('mainContentContainer');
            hideElement('sessionTimerContainer');
            showElement('loginContainer');
            document.getElementById('login_password').value = '';
            document.getElementById('login_asesor').value = '';
            showCustomAlert("Tu sesi√≥n ha expirado. Por favor, ingresa de nuevo.");
        }

        function showElement(id, displayType = 'block') {
            const el = document.getElementById(id);
            if (!el) return;
            if (id.includes('Modal') || id.includes('loginContainer')) {
                el.classList.add('active');
            } else {
                el.style.display = displayType;
            }
        }

        function hideElement(id) {
             const el = document.getElementById(id);
             if (!el) return;
            if (id.includes('Modal') || id.includes('loginContainer')) {
                el.classList.remove('active');
            } else {
                el.style.display = 'none';
            }
        }

        function showCustomAlert(message, title = "Atenci√≥n") {
            document.getElementById('customAlertTitle').textContent = title;
            document.getElementById('customAlertMessage').textContent = message;
            showElement('customAlertModal');
        }

        function closeCustomAlert() {
            hideElement('customAlertModal');
        }
        
        function acceptAgreement() {
            hideElement('confidentialityModal');
            showElement('loginContainer');
            document.getElementById('login_asesor').focus();
        }

        // --- LOGIN FUNCTIONALITY ---
        function handleLogin() {
            const loginButton = document.getElementById('loginButton');
            const originalButtonContent = loginButton.innerHTML;
            loginButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i>Ingresando...`;
            loginButton.disabled = true;

            const asesorInput = document.getElementById('login_asesor');
            const passwordInput = document.getElementById('login_password');
            const password = passwordInput.value.trim();
            
            // --- Asesor Name Validation ---
            let asesorName = asesorInput.value.trim().replace(/[^a-zA-Z\s]/g, '').replace(/\s+/g, ' ').toUpperCase();
            const nameParts = asesorName.split(' ');
            if (nameParts.length < 2 || nameParts[0].length === 0 || nameParts[1].length === 0) {
                showCustomAlert("El nombre del asesor debe incluir al menos un nombre y un apellido.", "Error de Validaci√≥n");
                loginButton.innerHTML = originalButtonContent;
                loginButton.disabled = false;
                return;
            }
            nombreAsesorGlobal = asesorName;

            setTimeout(() => {
                if (password === "OICI120566010503") { 
                    hideElement('loginContainer');
                    showElement('mainContentContainer');
                    initializeMainAppDisplay();
                    startSessionTimer(); 
                } else {
                    const loginErrorTextEl = document.querySelector('#login_errorMessage p');
                    if (loginErrorTextEl) loginErrorTextEl.textContent = "Contrase√±a incorrecta. Int√©ntalo de nuevo.";
                    showElement('login_errorMessage');
                    loginButton.innerHTML = originalButtonContent;
                    loginButton.disabled = false;
                }
            }, 500);
        }
        
        function initializeMainAppDisplay() {
            hideElement('info_resultadosPensionBase'); 
            hideElement('info_resultadosEscenarioM40');
            document.getElementById('currentYear').textContent = new Date().getFullYear();
        }


        // --- L√ìGICA DE C√ÅLCULO Y DATOS ECON√ìMICOS ---
        let pensionBaseResultadosInfo = { PENSION_MENSUAL_ESTIMADA: 0, AGUINALDO_ESTIMADO: 0 };
        let datosClienteInfo = { nombre: '', semanasCotizadasBase: 0, edadBase: 0, sbcPromedioBase: 0, sbcDetalladoUsado: false };
        let aforeProyectadaGlobalInfo = 0;
        let m40ResultadosInfo = { 
            pensionMensualInicial: 0, 
            aguinaldo: 0, costoTotalP1: 0, 
            sbcPromedioParaCalculoPensionM40: 0, 
            sbcM40Ingresado: 0, 
            nuevasSemanas: 0, nuevaEdad: 0 
        };
        let datosCompletosParaPDFInfo = {};
        
        let economicData = {
            umas: { 2018: 80.60, 2019: 84.49, 2020: 86.88, 2021: 89.62, 2022: 96.22, 2023: 103.74, 2024: 108.57, 2025: 113.14, 2026: 118.64, 2027: 124.00, 2028: 129.68, 2029: 135.61, 2030: 141.81 },
            smgv_diario: { 2018: 88.36, 2019: 102.68, 2020: 123.22, 2021: 141.70, 2022: 172.87, 2023: 207.44, 2024: 248.93 },
            inpc: { "2018-12": 101.355, "2019-12": 104.236, "2020-12": 107.608, "2021-12": 115.499, "2022-12": 124.507, "2023-12": 130.036, "2024-01": 131.396, "2024-02": 131.500, "2024-03": 131.650, "2024-04": 131.800, "2024-05": 132.000, "2024-06": 132.660, "2024-07": 133.323, "2024-08": 133.990, "2024-09": 134.660, "2024-10": 135.333, "2024-11": 136.010, "2024-12": 136.690, "2025-01": 137.373, "2025-02": 138.060, "2025-03": 138.750, "2025-04": 139.444, "2025-05": 140.141, "2025-06": 140.842, "2025-07": 141.546 }
        };
        const currentFullYear = new Date().getFullYear();
        for (let y = Math.max(...Object.keys(economicData.umas).map(Number)) + 1; y <= currentFullYear + 10; y++) {
            if (!economicData.umas[y]) economicData.umas[y] = parseFloat((economicData.umas[y-1] * 1.045).toFixed(2));
        }
        for (let y = Math.max(...Object.keys(economicData.smgv_diario).map(Number)) + 1; y <= currentFullYear + 10; y++) {
             if (!economicData.smgv_diario[y]) economicData.smgv_diario[y] = parseFloat((economicData.smgv_diario[y-1] * 1.10).toFixed(2));
        }

        const averageAnnualINPCGrowth = 0.06; // UPDATED INFLATION
        const SMGV_DF_Global = 88.36; 
        const FACTOR_FOX_Global = 1.11;
        const tablaCuantiasGlobal = [ 
            { minRatio: 0,    maxRatio: 1.00, pcb: 80.00, pia: 0.563 }, { minRatio: 1.01, maxRatio: 1.25, pcb: 77.11, pia: 0.814 },
            { minRatio: 1.26, maxRatio: 1.50, pcb: 58.18, pia: 1.178 }, { minRatio: 1.51, maxRatio: 1.75, pcb: 49.23, pia: 1.430 },
            { minRatio: 1.76, maxRatio: 2.00, pcb: 42.67, pia: 1.615 }, { minRatio: 2.01, maxRatio: 2.25, pcb: 37.65, pia: 1.756 },
            { minRatio: 2.26, maxRatio: 2.50, pcb: 33.68, pia: 1.868 }, { minRatio: 2.51, maxRatio: 2.75, pcb: 30.48, pia: 1.958 },
            { minRatio: 2.76, maxRatio: 3.00, pcb: 27.83, pia: 2.033 }, { minRatio: 3.01, maxRatio: 3.25, pcb: 25.60, pia: 2.096 },
            { minRatio: 3.26, maxRatio: 3.50, pcb: 23.70, pia: 2.149 }, { minRatio: 3.51, maxRatio: 3.75, pcb: 22.07, pia: 2.195 },
            { minRatio: 3.76, maxRatio: 4.00, pcb: 20.65, pia: 2.235 }, { minRatio: 4.01, maxRatio: 4.25, pcb: 19.39, pia: 2.271 },
            { minRatio: 4.26, maxRatio: 4.50, pcb: 18.29, pia: 2.302 }, { minRatio: 4.51, maxRatio: 4.75, pcb: 17.30, pia: 2.330 },
            { minRatio: 4.76, maxRatio: 5.00, pcb: 16.41, pia: 2.355 }, { minRatio: 5.01, maxRatio: 5.25, pcb: 15.61, pia: 2.377 },
            { minRatio: 5.26, maxRatio: 5.50, pcb: 14.88, pia: 2.398 }, { minRatio: 5.51, maxRatio: 5.75, pcb: 14.22, pia: 2.416 },
            { minRatio: 5.76, maxRatio: 6.00, pcb: 13.62, pia: 2.433 }, { minRatio: 6.01, maxRatio: Infinity, pcb: 13.00, pia: 2.450 }
        ];
        const tasasPagoM40 = { 
            2022: 0.10075, 2023: 0.11166, 2024: 0.12256, 2025: 0.13347,
            2026: 0.14438, 2027: 0.15528, 2028: 0.16619, 2029: 0.17709, 2030: 0.18800
        };
        const PRESTAMO_PUNTO_A_DESCUENTO = 1115.61; 
        const PRESTAMO_PUNTO_A_MONTO = 31000;
        const PRESTAMO_PUNTO_B_DESCUENTO = 33450.42; 
        const PRESTAMO_PUNTO_B_MONTO = 929500;
        const DIAS_PROMEDIO_PENSION = 1750; 

        function formatNumber(num, decimals = 2) {
            if (typeof num !== 'number' || isNaN(num)) return (0).toFixed(decimals);
            return num.toLocaleString('es-MX', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        }
        function getNumeroInfo(id) { return parseFloat(document.getElementById(id).value.replace(/,/g, '')) || 0; }
        function getDiasEnMes(a, m) { return new Date(a, m, 0).getDate(); }
        
        function getUMA(y, m = new Date().getMonth() + 1) { 
            let uY = parseInt(y);
            if (m === 1 && economicData.umas[uY-1]) uY = parseInt(y)-1; 
            return economicData.umas[uY] || economicData.umas[Object.keys(economicData.umas).sort((a,b) => b-a)[0]] || 0;
        }
        
        function getINPC(year, month) {
            const key = `${year}-${String(month).padStart(2, '0')}`;
            if (economicData.inpc[key]) {
                return economicData.inpc[key];
            }
            // Projection for future values
            const lastKnownKey = Object.keys(economicData.inpc).sort().pop();
            const [lastYear, lastMonth] = lastKnownKey.split('-').map(Number);
            const lastValue = economicData.inpc[lastKnownKey];
            const monthsDiff = (year - lastYear) * 12 + (month - lastMonth);
            if (monthsDiff > 0) {
                return lastValue * Math.pow(1 + (averageAnnualINPCGrowth / 12), monthsDiff);
            }
            return null; // Return null if historical data is missing
        }

        function _calcularPensionDetallado(sbcP, semC, edadC, smgv, fFox, tC) {
            if (sbcP <= 0 || semC < 500 || edadC < 60) return { PENSION_MENSUAL_ESTIMADA: 0, AGUINALDO_ESTIMADO: 0 };
            const rSBCvsSMGV = sbcP / smgv; let pcb = 0, pia = 0;
            for (const rg of tC) { if (rSBCvsSMGV >= rg.minRatio && rSBCvsSMGV <= rg.maxRatio) { pcb = rg.pcb; pia = rg.pia; break; } }
            if (pcb === 0 && pia === 0 && rSBCvsSMGV > tC[tC.length-1].maxRatio && tC[tC.length-1].maxRatio !== Infinity) { const u = tC[tC.length-1]; pcb = u.pcb; pia = u.pia; }
            const cBAP = (sbcP * 365) * (pcb / 100); const CBF = cBAP * fFox;
            let fNIF = 0; if (semC > 500) fNIF = Math.floor((semC - 500) / 52 * 100) / 100; 
            const iACP = (sbcP * 365) * (pia / 100) * fNIF; const IAVF = iACP * fFox;
            const pVAB = CBF + IAVF; let pE = 0;
            if (edadC >= 65) pE = 1.00; else if (edadC === 64) pE = 0.95; else if (edadC === 63) pE = 0.90;
            else if (edadC === 62) pE = 0.85; else if (edadC === 61) pE = 0.80; else if (edadC === 60) pE = 0.75;
            const pVAAE = pVAB * pE; const pACA = pVAAE * 1.15;
            const PME = pACA / 12; 
            const aguinaldoEstimado = (PME / 1.15);
            return { PENSION_MENSUAL_ESTIMADA: PME, AGUINALDO_ESTIMADO: aguinaldoEstimado };
        }
        function extraerFechaNacimientoCURP(curp) {
            if (typeof curp !== 'string' || curp.length !== 18) return null;
            const aS = curp.substring(4,6); const mS = curp.substring(6,8); const dS = curp.substring(8,10);
            let anio = parseInt(aS); const mes = parseInt(mS); const dia = parseInt(dS);
            if (isNaN(anio) || isNaN(mes) || isNaN(dia) || mes < 1 || mes > 12 || dia < 1 || dia > 31 ) return null;
            const cIS = curp.charAt(16); let siglo = 1900; const cYLT = new Date().getFullYear() % 100;
            if (!isNaN(parseInt(cIS))) siglo = (anio > cYLT + 10) ? 1900 : 2000;
            else if (cIS >= 'A' && cIS <= 'Z') siglo = 2000;
            anio = siglo + anio; 
            try { const f = new Date(anio, mes-1, dia); if (f.getFullYear() === anio && f.getMonth() === (mes-1) && f.getDate() === dia) return f; return null; } catch (e) { return null; }
        }
        function calcularEdadExacta(fN, fR) {
            if (!fN || !(fN instanceof Date) || isNaN(fN) || !fR || !(fR instanceof Date) || isNaN(fR)) return { anos: 0, meses: 0, dias: 0 };
            let a = fR.getFullYear() - fN.getFullYear(); let m = fR.getMonth() - fN.getMonth(); let d = fR.getDate() - fN.getDate();
            if (d < 0) { m--; d += new Date(fR.getFullYear(), fR.getMonth(), 0).getDate(); }
            if (m < 0) { a--; m += 12; }
            return { anos: a, meses: m, dias: d };
        }
        function getTasaM40Porcentaje(a) {
            if (a <= 2022) return tasasPagoM40[2022]; if (a >= 2030) return tasasPagoM40[2030];
            return tasasPagoM40[a] || tasasPagoM40[Object.keys(tasasPagoM40).sort((x,y)=>y-x)[0]]; 
        }
         function calcularFechaFinDesdeMeses(fechaInicioStr, numMeses) {
            if (!fechaInicioStr || !numMeses || numMeses <= 0) return null;
            const [anioInicio, mesInicio] = fechaInicioStr.split('-').map(Number);
            if (isNaN(anioInicio) || isNaN(mesInicio)) return null;
            const fechaInicioObj = new Date(Date.UTC(anioInicio, mesInicio - 1, 1)); 
            const fechaFinObj = new Date(Date.UTC(fechaInicioObj.getUTCFullYear(), fechaInicioObj.getUTCMonth() + Number(numMeses), 1));
            fechaFinObj.setUTCDate(0); 
            return `${fechaFinObj.getUTCFullYear()}-${String(fechaFinObj.getUTCMonth() + 1).padStart(2, '0')}`;
        }

        function showError(sectionSuffix, message) {
            showCustomAlert(message, "Error en Datos");
        }
        
        function actualizarSBCMaximoM40() {
            const inicioP1Str = document.getElementById('info_m40_p1_inicio').value;
            const sbcM40Input = document.getElementById('info_m40_p1_sbc');
            if (inicioP1Str) {
                const [anioInicioP1, mesInicioP1] = inicioP1Str.split('-').map(Number);
                const umaP1 = getUMA(anioInicioP1, mesInicioP1);
                const sbcMaxP1 = umaP1 * 25;
                sbcM40Input.value = formatNumber(sbcMaxP1, 2).replace(/,/g, '');
                sbcM40Input.setAttribute('data-max-sbc', sbcMaxP1);
            } else {
                sbcM40Input.value = '';
                sbcM40Input.removeAttribute('data-max-sbc');
            }
        }
        
        function actualizarFechaFinM40Display() {
            const fechaInicioStr = document.getElementById('info_m40_p1_inicio').value;
            const numMesesStr = document.getElementById('info_m40_p1_meses').value;
            const calcularBtn = document.getElementById('btnCalcularEscenarioM40');

            if (fechaInicioStr && numMesesStr) {
                const numMeses = parseInt(numMesesStr);
                if (numMeses > 0) {
                    const fechaFinStr = calcularFechaFinDesdeMeses(fechaInicioStr, numMeses);
                    if (fechaFinStr) {
                        const [finAnio, finMes] = fechaFinStr.split('-').map(Number);
                        const hoy = new Date();
                        const primerDiaMesActual = new Date(Date.UTC(hoy.getUTCFullYear(), hoy.getUTCMonth(), 1));
                        const ultimoDiaMesFinM40 = new Date(Date.UTC(finAnio, finMes -1, getDiasEnMes(finAnio, finMes)));
                        
                        if (ultimoDiaMesFinM40 < primerDiaMesActual) {
                            if(calcularBtn) calcularBtn.disabled = true;
                        } else {
                            if(calcularBtn) calcularBtn.disabled = false;
                        }
                    }
                }
            }
        }

        function toggleSBCDetalladoSeccion() {
            const checkbox = document.getElementById('info_usarSBCDetallado');
            const sbcPromedioInput = document.getElementById('info_sbcPromedio');
            const tbody = document.getElementById('info_tablaHistorialLaboralBody'); 
            if (checkbox.checked) {
                showElement('info_seccionSBCDetallado');
                sbcPromedioInput.readOnly = true;
                sbcPromedioInput.placeholder = "Se calcular√° abajo";
                datosClienteInfo.sbcDetalladoUsado = true;
                 if (tbody.querySelectorAll('tr').length === 0) { 
                    agregarMovimientoHistorialInfografia();
                 }
            } else {
                hideElement('info_seccionSBCDetallado');
                sbcPromedioInput.readOnly = false;
                sbcPromedioInput.placeholder = "Ingresar o calcular";
                datosClienteInfo.sbcDetalladoUsado = false;
            }
        }

        function agregarMovimientoHistorialInfografia() {
            const tbody = document.getElementById('info_tablaHistorialLaboralBody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td class="px-4 py-2"><input type="date" name="hist_fechaMov" class="w-full p-2 border rounded"></td>
                <td class="px-4 py-2">
                    <select name="hist_tipoMov" class="w-full p-2 border rounded">
                        <option value="ALTA">ALTA</option>
                        <option value="MODIFICACION">MODIFICACION</option>
                        <option value="BAJA">BAJA</option>
                    </select>
                </td>
                <td class="px-4 py-2"><input type="text" name="hist_patron" placeholder="Patr√≥n" class="w-full p-2 border rounded"></td>
                <td class="px-4 py-2"><input type="number" name="hist_sbc" placeholder="0.00" step="0.01" class="w-full p-2 border rounded"></td>
                <td class="px-4 py-2 text-center"><button type="button" class="btn btn-danger-icon" onclick="eliminarMovimientoHistorialInfografia(this)"><i class="fas fa-trash-alt"></i></button></td>
            `;
        }
        function eliminarMovimientoHistorialInfografia(button) {
            button.closest('tr').remove();
        }

        function calcularYUsarSBCDetalladoInfografia() {
            const tbody = document.getElementById('info_tablaHistorialLaboralBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            if (rows.length === 0) {
                showCustomAlert("Agregue al menos un movimiento para calcular el SBC detallado.", "Error");
                return;
            }

            let movimientos = rows.map(row => ({
                fecha: row.querySelector('input[name="hist_fechaMov"]').value,
                tipo: row.querySelector('select[name="hist_tipoMov"]').value,
                patron: row.querySelector('input[name="hist_patron"]').value,
                sbc: parseFloat(row.querySelector('input[name="hist_sbc"]').value) || 0,
            }));

            for (const mov of movimientos) {
                if (!mov.fecha || !mov.tipo || !mov.patron || mov.sbc <= 0) {
                    showCustomAlert(`Fila inv√°lida en historial: Verifique Fecha, Tipo, Patr√≥n y SBC (>0). Patr√≥n: ${mov.patron || 'N/A'}`, "Error");
                    return;
                }
            }
            
            movimientos.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

            let segmentosSBC = [];
            let fechaInicioSegmentoActual = null;
            let sbcSegmentoActual = 0;
            const todayForCalc = new Date(); todayForCalc.setUTCHours(0,0,0,0);

            for (let i = 0; i < movimientos.length; i++) {
                const mov = movimientos[i];
                const fechaMovimiento = new Date(mov.fecha + "T00:00:00Z");

                if (mov.tipo === 'ALTA' || mov.tipo === 'MODIFICACION') {
                    if (fechaInicioSegmentoActual && sbcSegmentoActual > 0) {
                        const fechaFinPrevSegmento = new Date(fechaMovimiento);
                        fechaFinPrevSegmento.setUTCDate(fechaFinPrevSegmento.getUTCDate() -1);
                        if (fechaFinPrevSegmento >= fechaInicioSegmentoActual) {
                            const dias = (fechaFinPrevSegmento - fechaInicioSegmentoActual) / (1000 * 60 * 60 * 24) + 1;
                            segmentosSBC.push({ sbc: sbcSegmentoActual, dias: dias });
                        }
                    }
                    fechaInicioSegmentoActual = fechaMovimiento;
                    sbcSegmentoActual = mov.sbc;
                } else if (mov.tipo === 'BAJA') {
                    if (fechaInicioSegmentoActual && sbcSegmentoActual > 0 && fechaMovimiento >= fechaInicioSegmentoActual) {
                        const dias = (fechaMovimiento - fechaInicioSegmentoActual) / (1000 * 60 * 60 * 24) + 1; 
                        segmentosSBC.push({ sbc: sbcSegmentoActual, dias: dias });
                    }
                    fechaInicioSegmentoActual = null;
                    sbcSegmentoActual = 0;
                }

                if (i === movimientos.length - 1 && (mov.tipo === 'ALTA' || mov.tipo === 'MODIFICACION') && fechaInicioSegmentoActual) {
                    if (todayForCalc >= fechaInicioSegmentoActual) {
                        const dias = (todayForCalc - fechaInicioSegmentoActual) / (1000 * 60 * 60 * 24) + 1;
                        segmentosSBC.push({ sbc: sbcSegmentoActual, dias: dias });
                    }
                }
            }
            
            segmentosSBC.reverse(); 
            let totalDiasConsiderados = 0;
            let sumaPonderadaSBC = 0;
            
            for (const seg of segmentosSBC) {
                if (totalDiasConsiderados >= DIAS_PROMEDIO_PENSION) break;
                let diasASumarDeSegmento = seg.dias;
                if (totalDiasConsiderados + diasASumarDeSegmento > DIAS_PROMEDIO_PENSION) {
                    diasASumarDeSegmento = DIAS_PROMEDIO_PENSION - totalDiasConsiderados;
                }
                sumaPonderadaSBC += seg.sbc * diasASumarDeSegmento;
                totalDiasConsiderados += diasASumarDeSegmento;
            }

            if (totalDiasConsiderados === 0) {
                showCustomAlert("No se calcularon d√≠as para el promedio de SBC detallado. Verifique los movimientos y sus fechas.", "Error");
                return;
            }

            const sbcPromedioDetallado = sumaPonderadaSBC / totalDiasConsiderados;
            datosClienteInfo.sbcPromedioBase = sbcPromedioDetallado; 
            document.getElementById('info_sbcPromedio').value = formatNumber(sbcPromedioDetallado, 2).replace(/,/g,'');
            showCustomAlert("SBC Detallado calculado y aplicado: $" + formatNumber(sbcPromedioDetallado), "C√°lculo Exitoso");
        }
        
        function calcularPensionBaseInfografia() {
            datosClienteInfo.nombre = document.getElementById('info_nombreCompleto').value;
            datosClienteInfo.semanasCotizadasBase = getNumeroInfo('info_semanasCotizadas');
            datosClienteInfo.edadBase = getNumeroInfo('info_edadCliente');
            datosClienteInfo.sbcPromedioBase = getNumeroInfo('info_sbcPromedio');

            if (!datosClienteInfo.nombre || datosClienteInfo.semanasCotizadasBase < 500 || datosClienteInfo.edadBase < 60 || datosClienteInfo.sbcPromedioBase <= 0) {
                showError('Base', "Verifica los datos: Nombre, Semanas (m√≠n. 500), Edad (m√≠n. 60) y SBC Promedio Base (> 0) son obligatorios.");
                hideElement('info_resultadosPensionBase');
                return;
            }
            
            pensionBaseResultadosInfo = _calcularPensionDetallado(datosClienteInfo.sbcPromedioBase, datosClienteInfo.semanasCotizadasBase, datosClienteInfo.edadBase, SMGV_DF_Global, FACTOR_FOX_Global, tablaCuantiasGlobal);
            
            const pensionMensual = pensionBaseResultadosInfo.PENSION_MENSUAL_ESTIMADA;
            const aguinaldo = pensionBaseResultadosInfo.AGUINALDO_ESTIMADO;
            const ingresoAnualTotal = (pensionMensual * 12) + aguinaldo;

            document.getElementById('info_resPensionMensual').textContent = '$' + formatNumber(pensionMensual);
            document.getElementById('info_resAguinaldo').textContent = '$' + formatNumber(aguinaldo);
            document.getElementById('info_resIngresoAnual').textContent = '$' + formatNumber(ingresoAnualTotal);

            // --- Projection Logic ---
            const proyeccionContenedor = document.getElementById('info_proyeccionPensionBase');
            proyeccionContenedor.innerHTML = ''; // Clear previous results
            const tablaProyeccion = document.createElement('table');
            tablaProyeccion.className = 'w-full text-left border-collapse text-sm';
            let htmlProyeccion = `<thead><tr class="bg-gray-100"><th class="p-2 border">A√±o</th><th class="p-2 border">Pensi√≥n Mensual Estimada</th></tr></thead><tbody>`;

            const inflacionProyeccionBase = 0.05; // 5% as requested for this specific table

            for (let i = 1; i <= 5; i++) {
                const pensionProyectada = pensionMensual * Math.pow(1 + inflacionProyeccionBase, i - 1);
                htmlProyeccion += `<tr>
                    <td class="p-2 border">${i}</td>
                    <td class="p-2 border font-semibold text-gray-800">$${formatNumber(pensionProyectada)}</td>
                </tr>`;
            }
            htmlProyeccion += `</tbody>`;
            tablaProyeccion.innerHTML = htmlProyeccion;
            proyeccionContenedor.appendChild(tablaProyeccion);

            showElement('info_resultadosPensionBase');
            document.getElementById('info_compPensionBase').textContent = '$' + formatNumber(pensionMensual);
            
            hideElement('info_resultadosEscenarioM40');
            m40ResultadosInfo = { pensionMensualInicial: 0, aguinaldo: 0, costoTotalP1: 0, sbcPromedioParaCalculoPensionM40: 0, sbcM40Ingresado: 0, nuevasSemanas: 0, nuevaEdad: 0 };
        }

        function recalcularCoberturaTrasCambio() {
            if (document.getElementById('info_resultadosEscenarioM40').style.display !== 'none') {
                 if (m40ResultadosInfo.pensionMensualInicial > 0 || m40ResultadosInfo.costoTotalP1 > 0) {
                     calcularAFOREProyectadaInfografia(); 
                 }
            }
        }

        function calcularAFOREProyectadaInfografia() {
            const aforeActual = getNumeroInfo('info_aforeActual');
            aforeProyectadaGlobalInfo = aforeActual;
            document.getElementById('info_coberturaAfore').textContent = '$' + formatNumber(aforeProyectadaGlobalInfo);
            
             if (document.getElementById('info_resultadosEscenarioM40').style.display !== 'none' && 
                 (m40ResultadosInfo.pensionMensualInicial > 0 || m40ResultadosInfo.costoTotalP1 > 0)) {
                calcularCoberturaInfografia();
            }
        }

        function calcularEscenarioM40Infografia() {
            if (pensionBaseResultadosInfo.PENSION_MENSUAL_ESTIMADA === 0 && datosClienteInfo.sbcPromedioBase === 0) {
                 showError('M40', "Primero calcula tu Pensi√≥n Base en el Paso 1.");
                 return;
            }

            const curp = document.getElementById('info_curpCliente').value;
            if (curp.length !== 18) { showError('M40', "El CURP debe tener 18 caracteres."); return; }
            const fechaNacimiento = extraerFechaNacimientoCURP(curp);
            if (!fechaNacimiento) { showError('M40', "CURP inv√°lido o formato de fecha no reconocido."); return; }

            const inicioP1Str = document.getElementById('info_m40_p1_inicio').value;
            const numMesesP1 = parseInt(document.getElementById('info_m40_p1_meses').value) || 0;
            
            const sbcM40Ingresado = parseFloat(document.getElementById('info_m40_p1_sbc').value.replace(/,/g, '')) || 0;
            m40ResultadosInfo.sbcM40Ingresado = sbcM40Ingresado;

            if (!inicioP1Str || numMesesP1 <= 0 || sbcM40Ingresado <= 0) {
                showError('M40', "Define el periodo M40: Fecha de Inicio, Meses y SBC M40 son obligatorios.");
                hideElement('info_resultadosEscenarioM40');
                return;
            }

            const finP1Str = calcularFechaFinDesdeMeses(inicioP1Str, numMesesP1); 
            if (!finP1Str) { showError('M40', "Error calculando fecha fin de M40."); return; }
            const [aF, mF] = finP1Str.split('-').map(Number);
            const fechaFinM40RealObj = new Date(Date.UTC(aF, mF - 1, getDiasEnMes(aF, mF))); 
            
            const edadFinM40 = calcularEdadExacta(fechaNacimiento, fechaFinM40RealObj);
            let edadParaPorcentajeM40 = edadFinM40.anos;
            if (edadFinM40.meses > 6 || (edadFinM40.meses === 6 && edadFinM40.dias >= 1)) {
                edadParaPorcentajeM40++;
            }
            
            const diasEnM40 = numMesesP1 * (365.25 / 12); 
            const diasBasePrevios = Math.max(0, DIAS_PROMEDIO_PENSION - diasEnM40); 
            let sbcPromedioCalculadoParaPensionM40 = ((sbcM40Ingresado * diasEnM40) + (datosClienteInfo.sbcPromedioBase * diasBasePrevios)) / DIAS_PROMEDIO_PENSION;
            m40ResultadosInfo.sbcPromedioParaCalculoPensionM40 = sbcPromedioCalculadoParaPensionM40;
            
            m40ResultadosInfo.nuevasSemanas = Math.round((datosClienteInfo.semanasCotizadasBase || 0) + (numMesesP1 * (52/12)));
            m40ResultadosInfo.nuevaEdad = edadParaPorcentajeM40;

            const pensionConM40 = _calcularPensionDetallado(m40ResultadosInfo.sbcPromedioParaCalculoPensionM40, m40ResultadosInfo.nuevasSemanas, m40ResultadosInfo.nuevaEdad, SMGV_DF_Global, FACTOR_FOX_Global, tablaCuantiasGlobal);
            m40ResultadosInfo.pensionMensualInicial = pensionConM40.PENSION_MENSUAL_ESTIMADA - 250; 
            m40ResultadosInfo.aguinaldo = pensionConM40.AGUINALDO_ESTIMADO;

            // --- Corrected Cost Calculation with Updates and Surcharges ---
            let costoTotalM40P1 = 0;
            const [anioInicioP1Val, mesInicioP1Val] = inicioP1Str.split('-').map(Number);
            const fechaSimulacionPago = new Date(Date.UTC(aF, mF - 1, getDiasEnMes(aF, mF)));
            const mesActualizacion = new Date(fechaSimulacionPago);
            mesActualizacion.setUTCMonth(mesActualizacion.getUTCMonth() - 1);
            const inpcNumerador = getINPC(mesActualizacion.getUTCFullYear(), mesActualizacion.getUTCMonth() + 1);

            for (let m = 0; m < numMesesP1; m++) {
                const fechaCuota = new Date(Date.UTC(anioInicioP1Val, mesInicioP1Val - 1 + m, 1));
                const anioCuota = fechaCuota.getUTCFullYear();
                const mesCuota = fechaCuota.getUTCMonth() + 1;

                const tasaM40Anual = getTasaM40Porcentaje(anioCuota);
                const costoBaseMensual = sbcM40Ingresado * tasaM40Anual * getDiasEnMes(anioCuota, mesCuota);
                
                let montoActualizacion = 0;
                let pagoBaseActualizado = costoBaseMensual;
                
                const inpcDenominador = getINPC(anioCuota, mesCuota);

                if (inpcNumerador && inpcDenominador && inpcNumerador > inpcDenominador) {
                    montoActualizacion = costoBaseMensual * ((inpcNumerador / inpcDenominador) - 1);
                    pagoBaseActualizado += montoActualizacion;
                }
                
                let montoRecargos = 0;
                const fechaVencimiento = new Date(Date.UTC(anioCuota, mesCuota, 17)); // Payment due on 17th of next month
                if (fechaSimulacionPago > fechaVencimiento) {
                    const mesesRetraso = (fechaSimulacionPago.getUTCFullYear() - fechaVencimiento.getUTCFullYear()) * 12 + (fechaSimulacionPago.getUTCMonth() - fechaVencimiento.getUTCMonth());
                    if (mesesRetraso > 0) {
                        montoRecargos = pagoBaseActualizado * 0.0147 * mesesRetraso;
                    }
                }
                
                costoTotalM40P1 += pagoBaseActualizado + montoRecargos;
            }
            m40ResultadosInfo.costoTotalP1 = costoTotalM40P1;

            document.getElementById('info_compPensionM40').textContent = '$' + formatNumber(m40ResultadosInfo.pensionMensualInicial);
            const incrementoNeto = m40ResultadosInfo.pensionMensualInicial - (pensionBaseResultadosInfo.PENSION_MENSUAL_ESTIMADA || 0);
            document.getElementById('info_compIncrementoNetoM40').textContent = '$' + formatNumber(incrementoNeto);
            
            document.getElementById('info_nuevoSBCPromedioM40').textContent = formatNumber(m40ResultadosInfo.sbcPromedioParaCalculoPensionM40);
            document.getElementById('info_nuevasSemanasM40').textContent = formatNumber(m40ResultadosInfo.nuevasSemanas, 0);
            document.getElementById('info_nuevaEdadM40').textContent = m40ResultadosInfo.nuevaEdad;
            document.getElementById('info_costoTotalM40Simulacion').textContent = '$' + formatNumber(m40ResultadosInfo.costoTotalP1);
            
            showElement('info_resultadosEscenarioM40');
            calcularAFOREProyectadaInfografia(); 
        }

        function calcularCoberturaInfografia() {
            const costoM40P1 = m40ResultadosInfo.costoTotalP1 || 0;
            const pensionM40Inicial = m40ResultadosInfo.pensionMensualInicial || 0; 
            
            const comisionExcedente = getNumeroInfo('info_comisionExcedente'); 
            const costoFijoAdicional = 140000; 
            const comision = costoM40P1 * 0.16;
            const factorMultiplicador = costoM40P1 * 0.5; 
            const costoTotalContrato = (costoM40P1 + factorMultiplicador + costoFijoAdicional + comision + comisionExcedente) - 35000;
            document.getElementById('info_costoTotalContratoBruto').textContent = '$' + formatNumber(costoTotalContrato);

            const aforeProy = aforeProyectadaGlobalInfo;
            
            let mesesPrimerDepositoInput = parseInt(document.getElementById('info_mesesPrimerDeposito').value) || 6;
            document.getElementById('display_mesesPrimerDeposito').textContent = mesesPrimerDepositoInput;

            const primerDeposito = pensionM40Inicial * mesesPrimerDepositoInput; 
            document.getElementById('info_coberturaPrimerDeposito').textContent = '$' + formatNumber(primerDeposito);

            const sbcM40Ingresado = m40ResultadosInfo.sbcM40Ingresado || 0;
            const diasP1Total = (parseInt(document.getElementById('info_m40_p1_meses').value) || 0) * (365.25 / 12);
            const extraAfore = diasP1Total * sbcM40Ingresado * 0.02; // SAR 2%
            document.getElementById('info_coberturaExtraAfore').textContent = '$' + formatNumber(extraAfore);

            const subtotalCobertura = aforeProy + primerDeposito + extraAfore;
            document.getElementById('info_coberturaSubtotalSinPrestamo').textContent = '$' + formatNumber(subtotalCobertura);

            const deficit = costoTotalContrato - subtotalCobertura;
            
            const descuentoMaximoPermitidoPorLey = pensionM40Inicial * 0.30;
            const slopePrestamoPorDescuento = (PRESTAMO_PUNTO_B_MONTO - PRESTAMO_PUNTO_A_MONTO) / (PRESTAMO_PUNTO_B_DESCUENTO - PRESTAMO_PUNTO_A_DESCUENTO);
            let prestamoAlcanzableConDescMaxLey = slopePrestamoPorDescuento * (descuentoMaximoPermitidoPorLey - PRESTAMO_PUNTO_A_DESCUENTO) + PRESTAMO_PUNTO_A_MONTO;
            prestamoAlcanzableConDescMaxLey = Math.max(0, prestamoAlcanzableConDescMaxLey);
            
            let prestamoRealUtilizado = 0;
            let descuentoMensualRealDelPrestamo = 0;

            if (deficit > 0) {
                showElement('info_prestamoInfo');
                document.getElementById('info_deficitAntesPrestamo').textContent = '$' + formatNumber(deficit);
                if(deficit <= prestamoAlcanzableConDescMaxLey) {
                    prestamoRealUtilizado = deficit;
                    const slopeDescuentoPorPrestamo = (PRESTAMO_PUNTO_B_DESCUENTO - PRESTAMO_PUNTO_A_DESCUENTO) / (PRESTAMO_PUNTO_B_MONTO - PRESTAMO_PUNTO_A_MONTO);
                    descuentoMensualRealDelPrestamo = slopeDescuentoPorPrestamo * (prestamoRealUtilizado - PRESTAMO_PUNTO_A_MONTO) + PRESTAMO_PUNTO_A_DESCUENTO;
                } else {
                    prestamoRealUtilizado = prestamoAlcanzableConDescMaxLey;
                    descuentoMensualRealDelPrestamo = descuentoMaximoPermitidoPorLey;
                }
                document.getElementById('info_prestamoNecesario').textContent = '$' + formatNumber(prestamoRealUtilizado);
                document.getElementById('info_descuentoMensualPrestamo').textContent = '$' + formatNumber(descuentoMensualRealDelPrestamo);
            } else {
                hideElement('info_prestamoInfo');
            }
            
            const coberturaFinal = subtotalCobertura + prestamoRealUtilizado;
            const saldoFinal = coberturaFinal - costoTotalContrato;
            
            if (saldoFinal > 0.01) {
                document.getElementById('info_resultadoAnalisisCredito').textContent = "¬°EXCELENTE! PROYECTO FINANCIADO CON SALDO A FAVOR";
                document.getElementById('info_etiquetaSaldoFinal').textContent = "Saldo a tu favor:";
                document.getElementById('info_montoSaldoFinal').textContent = '$' + formatNumber(saldoFinal);
                document.getElementById('info_montoSaldoFinal').className = 'font-bold highlight-green';
            } else if (saldoFinal >= -0.01 && saldoFinal <= 0.01) {
                document.getElementById('info_resultadoAnalisisCredito').textContent = "¬°PROYECTO VIABLE!";
                document.getElementById('info_etiquetaSaldoFinal').textContent = "CR√âDITO AUTORIZADO";
                document.getElementById('info_montoSaldoFinal').textContent = "";
            } else {
                document.getElementById('info_resultadoAnalisisCredito').textContent = "REQUIERE AN√ÅLISIS ADICIONAL";
                document.getElementById('info_etiquetaSaldoFinal').textContent = "D√©ficit Restante:";
                document.getElementById('info_montoSaldoFinal').textContent = '$' + formatNumber(Math.abs(saldoFinal));
                document.getElementById('info_montoSaldoFinal').className = 'font-bold highlight-red';
            }

            const incrementoNetoGlobalAnio1 = (m40ResultadosInfo.pensionMensualInicial || 0) - (pensionBaseResultadosInfo.PENSION_MENSUAL_ESTIMADA || 0);
            document.getElementById('info_ventajaIncrementoNeto').textContent = '$' + formatNumber(incrementoNetoGlobalAnio1);
            
            const valorInmuebleAnio1 = (m40ResultadosInfo.pensionMensualInicial || 0) / 0.004;
            document.getElementById('info_ventajaValorInmueble').textContent = '$' + formatNumber(valorInmuebleAnio1);
            
            const proyeccionContenedor = document.getElementById('info_proyeccionPensionNetaAnual');
            proyeccionContenedor.innerHTML = ''; 
            const tablaProyeccion = document.createElement('table');
            tablaProyeccion.className = 'w-full text-left border-collapse';
            let htmlProyeccion = `<thead><tr class="bg-blue-100"><th class="p-2 border">A√±o</th><th class="p-2 border">Pensi√≥n Bruta</th><th class="p-2 border">Descuento</th><th class="p-2 border">Pensi√≥n Neta</th></tr></thead><tbody>`;
            
            let proyeccionAnualData = [];
            for (let i = 1; i <= 10; i++) { 
                const pensionBrutaEsteAnio = (m40ResultadosInfo.pensionMensualInicial || 0) * Math.pow(1 + averageAnnualINPCGrowth, i - 1);
                const descuentoEsteAnio = (i <= 5 && deficit > 0) ? descuentoMensualRealDelPrestamo : 0; 
                const pensionNetaEsteAnio = pensionBrutaEsteAnio - descuentoEsteAnio;
                proyeccionAnualData.push({ anio: i, pensionBruta: pensionBrutaEsteAnio, descuento: descuentoEsteAnio, pensionNeta: pensionNetaEsteAnio });
                htmlProyeccion += `<tr>
                    <td class="p-2 border">${i}</td>
                    <td class="p-2 border">$${formatNumber(pensionBrutaEsteAnio)}</td>
                    <td class="p-2 border">$${formatNumber(descuentoEsteAnio)}</td>
                    <td class="p-2 border font-semibold ${pensionNetaEsteAnio >= pensionBrutaEsteAnio ? 'text-green-700' : 'text-amber-700'}">$${formatNumber(pensionNetaEsteAnio)}</td>
                </tr>`;
            }
            tablaProyeccion.innerHTML = htmlProyeccion + `</tbody>`;
            proyeccionContenedor.appendChild(tablaProyeccion);
            
            // Populate data for PDF
            let resultadoAnalisis, etiquetaSaldoFinal, montoSaldoFinal;
            if (saldoFinal > 0.01) {
                resultadoAnalisis = "¬°EXCELENTE! PROYECTO FINANCIADO CON SALDO A FAVOR";
                etiquetaSaldoFinal = "Saldo a tu favor:";
                montoSaldoFinal = saldoFinal;
            } else if (saldoFinal >= -0.01 && saldoFinal <= 0.01) {
                resultadoAnalisis = "¬°PROYECTO VIABLE!";
                etiquetaSaldoFinal = "CR√âDITO AUTORIZADO";
                montoSaldoFinal = 0;
            } else {
                resultadoAnalisis = "REQUIERE AN√ÅLISIS ADICIONAL";
                etiquetaSaldoFinal = "D√©ficit Restante:";
                montoSaldoFinal = Math.abs(saldoFinal);
            }

            datosCompletosParaPDFInfo = {
                 asesor: nombreAsesorGlobal,
                 cliente: datosClienteInfo, pensionBase: pensionBaseResultadosInfo,
                 curp: document.getElementById('info_curpCliente').value,
                 m40Periodo: {
                     inicio: document.getElementById('info_m40_p1_inicio').value,
                     meses: parseInt(document.getElementById('info_m40_p1_meses').value) || 0,
                     sbcTope: m40ResultadosInfo.sbcM40Ingresado }, 
                 m40Resultados: {...m40ResultadosInfo}, 
                 cobertura: {
                     aforeProyectada: aforeProyectadaGlobalInfo, mesesPrimerDeposito: mesesPrimerDepositoInput, primerDeposito: primerDeposito, extraAfore: extraAfore,
                     costoTotalContrato: costoTotalContrato, prestamoRealUtilizado: prestamoRealUtilizado, descuentoMensualPrestamoFijo: descuentoMensualRealDelPrestamo,
                     resultadoAnalisis: resultadoAnalisis, 
                     etiquetaSaldoFinal: etiquetaSaldoFinal, 
                     montoSaldoFinal: montoSaldoFinal,
                     // For cost breakdown page
                     costoM40P1: costoM40P1,
                     factorMultiplicador: factorMultiplicador,
                     comision: comision,
                     sumaFijaAdicional: costoFijoAdicional,
                     comisionExcedente: comisionExcedente,
                     ajusteManual: -35000
                  },
                 ventajas: {
                     incrementoNetoGlobalAnio1: incrementoNetoGlobalAnio1, valorInmuebleEquivalenteAnio1: valorInmuebleAnio1, proyeccionAnualPensionNeta: proyeccionAnualData
                  }
             };
        }
        
        async function exportarPropuestaPDFInfografia() {
            const exportButton = document.getElementById('exportPdfButton');
            exportButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i>Generando...`;
            exportButton.disabled = true;

            await new Promise(resolve => setTimeout(resolve, 50));
            
            const d = datosCompletosParaPDFInfo;
            if (!d || !d.m40Resultados || d.m40Resultados.pensionMensualInicial <= 0) {
                 showCustomAlert("Por favor, calcula una proyecci√≥n completa antes de exportar.", "Datos incompletos");
                 exportButton.innerHTML = `<i class="fas fa-download"></i>Exportar a PDF`;
                 exportButton.disabled = false;
                 return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'pt', 'letter');
                
                // --- PDF Styling ---
                const RGC_BLUE = [0, 51, 102], RGC_GOLD = [212, 175, 55];
                const TEXT_DARK = [26, 32, 44], TEXT_MEDIUM = [74, 85, 104];
                const WHITE = [255, 255, 255], BG_LIGHT_BLUE = [240, 248, 255];
                const GREEN = [22, 163, 74], RED = [220, 38, 38];
                const MARGIN = 40;
                const PAGE_WIDTH = pdf.internal.pageSize.getWidth();
                let yPos = 0;

                const addHeader = (title) => {
                    pdf.setFillColor(RGC_BLUE[0], RGC_BLUE[1], RGC_BLUE[2]);
                    pdf.rect(0, 0, PAGE_WIDTH, 70, 'F');
                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(18);
                    // Shadow
                    pdf.setTextColor(0, 0, 0);
                    pdf.text("RGC PENSIONES Y SEGUROS", MARGIN + 1, 43);
                    // Main Text
                    pdf.setTextColor(RGC_GOLD[0], RGC_GOLD[1], RGC_GOLD[2]);
                    pdf.text("RGC PENSIONES Y SEGUROS", MARGIN, 42);

                    pdf.setFontSize(10);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(WHITE[0], WHITE[1], WHITE[2]);
                    pdf.text(new Date().toLocaleDateString('es-MX'), PAGE_WIDTH - MARGIN, 42, { align: 'right' });
                    yPos = 100;
                    pdf.setFontSize(16);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(RGC_BLUE[0], RGC_BLUE[1], RGC_BLUE[2]);
                    pdf.text(title, PAGE_WIDTH / 2, yPos, { align: 'center' });
                    yPos += 25;
                };

                const addFooter = (pageNumber, totalPages) => {
                    pdf.setFontSize(8);
                    pdf.setTextColor(TEXT_MEDIUM[0], TEXT_MEDIUM[1], TEXT_MEDIUM[2]);
                    pdf.text(`P√°gina ${pageNumber} de ${totalPages}`, PAGE_WIDTH / 2, pdf.internal.pageSize.getHeight() - 30, { align: 'center' });
                    pdf.text(`Propuesta preparada por: ${d.asesor}`, MARGIN, pdf.internal.pageSize.getHeight() - 30);
                };

                const addSectionTitle = (text) => {
                    pdf.setFontSize(12);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(RGC_GOLD[0], RGC_GOLD[1], RGC_GOLD[2]);
                    pdf.text(text, MARGIN, yPos);
                    yPos += 8;
                    pdf.setDrawColor(RGC_GOLD[0], RGC_GOLD[1], RGC_GOLD[2]);
                    pdf.setLineWidth(0.5);
                    pdf.line(MARGIN, yPos, PAGE_WIDTH - MARGIN, yPos);
                    yPos += 20;
                };

                const addDataRow = (label, value, valueColor = TEXT_DARK) => {
                    pdf.setFontSize(10);
                    pdf.setFont('helvetica', 'normal');
                    pdf.setTextColor(TEXT_MEDIUM[0], TEXT_MEDIUM[1], TEXT_MEDIUM[2]);
                    pdf.text(label, MARGIN, yPos);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setTextColor(valueColor[0], valueColor[1], valueColor[2]);
                    pdf.text(String(value), PAGE_WIDTH - MARGIN, yPos, { align: 'right' });
                    yPos += 18;
                };
                
                // --- PDF Page 1: Detailed Proposal ---
                addHeader("Proyecci√≥n de Pensi√≥n Personalizada");
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(TEXT_DARK[0], TEXT_DARK[1], TEXT_DARK[2]);
                pdf.text(`Para: ${d.cliente.nombre}`, MARGIN, yPos);
                yPos += 30;

                addSectionTitle("Resumen de Proyecci√≥n");
                addDataRow("Pensi√≥n Mensual Base (Estimada):", `$${formatNumber(d.pensionBase.PENSION_MENSUAL_ESTIMADA)}`, RGC_BLUE);
                addDataRow("Pensi√≥n Mensual con M40 (A√±o 1):", `$${formatNumber(d.m40Resultados.pensionMensualInicial)}`, GREEN);
                yPos += 5;
                pdf.setFontSize(14);
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(GREEN[0], GREEN[1], GREEN[2]);
                pdf.text(`Incremento Mensual: $${formatNumber(d.ventajas.incrementoNetoGlobalAnio1)}`, PAGE_WIDTH / 2, yPos, { align: 'center' });
                yPos += 30;

                addSectionTitle("Detalles de la Estrategia");
                addDataRow("Meses de Inversi√≥n en M40:", `${d.m40Periodo.meses}`);
                addDataRow("SBC Diario Aplicado en M40:", `$${formatNumber(d.m40Periodo.sbcTope)}`);
                addDataRow("SBC Promedio Final (para c√°lculo):", `$${formatNumber(d.m40Resultados.sbcPromedioParaCalculoPensionM40)}`);
                addDataRow("Semanas Cotizadas Totales:", `${formatNumber(d.m40Resultados.nuevasSemanas, 0)}`);
                yPos += 10;
                
                addSectionTitle("An√°lisis Financiero del Proyecto");
                addDataRow("Costo Total del Proyecto (Estimado):", `$${formatNumber(d.cobertura.costoTotalContrato)}`, RED);
                yPos += 5;
                addDataRow("Cobertura con Saldo AFORE:", `(+) $${formatNumber(d.cobertura.aforeProyectada)}`, GREEN);
                addDataRow(`Cobertura con Primeros ${d.cobertura.mesesPrimerDeposito} Meses de Pensi√≥n:`, `(+) $${formatNumber(d.cobertura.primerDeposito)}`, GREEN);
                addDataRow("Cobertura con Extra AFORE (SAR):", `(+) $${formatNumber(d.cobertura.extraAfore)}`, GREEN);
                if(d.cobertura.prestamoRealUtilizado > 0) {
                    addDataRow("Pr√©stamo Necesario:", `(+) $${formatNumber(d.cobertura.prestamoRealUtilizado)}`, RGC_GOLD);
                }
                yPos += 10;
                pdf.setFillColor(BG_LIGHT_BLUE[0], BG_LIGHT_BLUE[1], BG_LIGHT_BLUE[2]);
                pdf.rect(MARGIN, yPos, PAGE_WIDTH - MARGIN*2, 40, 'F');
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(RGC_BLUE[0], RGC_BLUE[1], RGC_BLUE[2]);
                pdf.text(d.cobertura.resultadoAnalisis, MARGIN + 10, yPos + 25);
                let finalBalanceText = d.cobertura.etiquetaSaldoFinal;
                if (d.cobertura.etiquetaSaldoFinal !== "CR√âDITO AUTORIZADO") {
                    finalBalanceText += ` $${formatNumber(d.cobertura.montoSaldoFinal)}`;
                }
                pdf.text(finalBalanceText, PAGE_WIDTH - MARGIN - 10, yPos + 25, { align: 'right' });
                yPos += 60;
                
                addFooter(1, 5);
                
                // --- PDF Page 2: Annual Projection ---
                pdf.addPage();
                addHeader("Proyecci√≥n Anual y Beneficios");
                
                pdf.autoTable({
                    startY: yPos,
                    head: [['A√±o', 'Pensi√≥n Bruta Mensual', 'Descuento Pr√©stamo', 'Pensi√≥n Neta Mensual']],
                    body: d.ventajas.proyeccionAnualPensionNeta.map(p => [
                        p.anio,
                        `$${formatNumber(p.pensionBruta)}`,
                        p.descuento > 0 ? `$${formatNumber(p.descuento)}` : '-',
                        `$${formatNumber(p.pensionNeta)}`
                    ]),
                    theme: 'grid',
                    headStyles: { fillColor: RGC_BLUE, textColor: WHITE, fontStyle: 'bold' },
                    alternateRowStyles: { fillColor: BG_LIGHT_BLUE },
                    didParseCell: (data) => {
                        if (data.section === 'body' && data.column.index === 3) {
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.textColor = data.cell.raw.includes('-') ? TEXT_DARK : GREEN;
                        }
                    }
                });
                yPos = pdf.lastAutoTable.finalY + 25;

                pdf.setFontSize(9);
                pdf.setTextColor(TEXT_MEDIUM[0], TEXT_MEDIUM[1], TEXT_MEDIUM[2]);
                pdf.text(`Nota: La pensi√≥n bruta se proyecta con un incremento anual del ${averageAnnualINPCGrowth*100}%. El descuento de pr√©stamo (si aplica) es fijo por 5 a√±os.`, MARGIN, yPos);
                yPos += 30;

                pdf.setFillColor(BG_LIGHT_BLUE[0], BG_LIGHT_BLUE[1], BG_LIGHT_BLUE[2]);
                pdf.rect(MARGIN, yPos, PAGE_WIDTH - MARGIN*2, 70, 'F');
                pdf.setFontSize(11);
                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(RGC_BLUE[0], RGC_BLUE[1], RGC_BLUE[2]);
                pdf.text("Tu pensi√≥n M40 (A√±o 1) podr√≠a equivaler a tener un inmueble de:", PAGE_WIDTH / 2, yPos + 25, { align: 'center' });
                pdf.setFontSize(18);
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(RGC_GOLD[0], RGC_GOLD[1], RGC_GOLD[2]);
                pdf.text(`$${formatNumber(d.ventajas.valorInmuebleEquivalenteAnio1)} MXN`, PAGE_WIDTH / 2, yPos + 50, { align: 'center' });
                
                addFooter(2, 5);

                // --- PDF Page 3: Client Summary (With Strategy) ---
                pdf.addPage();
                addHeader("Estudio de Pensi√≥n (Con Estrategia M40)");
                pdf.text(`Cliente: ${d.cliente.nombre}`, MARGIN, yPos);
                yPos += 30;

                addSectionTitle("Datos Clave de Proyecci√≥n");
                addDataRow("N√∫mero de Semanas Cotizadas:", formatNumber(d.m40Resultados.nuevasSemanas, 0));
                addDataRow("Salario Diario Promedio:", `$ ${formatNumber(d.m40Resultados.sbcPromedioParaCalculoPensionM40)}`);
                addDataRow("Edad de Pensi√≥n:", `${d.m40Resultados.nuevaEdad} a√±os`);
                addDataRow("SBC M40 Retroactiva:", `$ ${formatNumber(d.m40Periodo.sbcTope)}`);
                yPos += 10;

                addSectionTitle("Resultados de Pensi√≥n");
                addDataRow("Pensi√≥n Mensual por Cesant√≠a:", `$ ${formatNumber(d.m40Resultados.pensionMensualInicial)}`, GREEN);
                addDataRow("Pensi√≥n Anual (12 mensualidades):", `$ ${formatNumber(d.m40Resultados.pensionMensualInicial * 12)}`);
                addDataRow("Pensi√≥n Anual m√°s Aguinaldo:", `$ ${formatNumber((d.m40Resultados.pensionMensualInicial * 12) + d.m40Resultados.aguinaldo)}`);
                yPos += 10;
                
                addSectionTitle("Resumen Financiero");
                const financialData = d.cobertura;
                addDataRow("Costo Total del Proyecto:", `$ ${formatNumber(financialData.costoTotalContrato)}`, RED);
                addDataRow("1er Dep√≥sito (Aportaci√≥n Cliente):", `(-) $ ${formatNumber(financialData.primerDeposito)}`);
                addDataRow("AFORE:", `(-) $ ${formatNumber(financialData.aforeProyectada)}`);
                addDataRow("Extra (SAR/INFONAVIT):", `(-) $ ${formatNumber(financialData.extraAfore)}`);
                addDataRow("Pr√©stamo (D√©ficit):", `(-) $ ${formatNumber(financialData.prestamoRealUtilizado)}`);
                pdf.setDrawColor(TEXT_DARK[0], TEXT_DARK[1], TEXT_DARK[2]);
                pdf.line(PAGE_WIDTH - MARGIN - 150, yPos, PAGE_WIDTH - MARGIN, yPos);
                yPos += 5;
                addDataRow(financialData.etiquetaSaldoFinal, `$ ${formatNumber(financialData.montoSaldoFinal)}`, GREEN);
                
                addFooter(3, 5);

                // --- PDF Page 4: Client Summary (Without Strategy) ---
                pdf.addPage();
                addHeader("Estudio de Pensi√≥n (Situaci√≥n Actual)");
                pdf.text(`Cliente: ${d.cliente.nombre}`, MARGIN, yPos);
                yPos += 30;

                addSectionTitle("Datos Clave Actuales");
                addDataRow("N√∫mero de Semanas Cotizadas:", formatNumber(d.cliente.semanasCotizadasBase, 0));
                addDataRow("Salario Diario Promedio:", `$ ${formatNumber(d.cliente.sbcPromedioBase)}`);
                addDataRow("Edad de Pensi√≥n:", `${d.cliente.edadBase} a√±os`);
                yPos += 10;

                addSectionTitle("Resultados de Pensi√≥n Sin Estrategia");
                addDataRow("Pensi√≥n Mensual por Cesant√≠a:", `$ ${formatNumber(d.pensionBase.PENSION_MENSUAL_ESTIMADA)}`, RGC_BLUE);
                addDataRow("Pensi√≥n Anual (12 mensualidades):", `$ ${formatNumber(d.pensionBase.PENSION_MENSUAL_ESTIMADA * 12)}`);
                addDataRow("Pensi√≥n Anual m√°s Aguinaldo:", `$ ${formatNumber((d.pensionBase.PENSION_MENSUAL_ESTIMADA * 12) + d.pensionBase.AGUINALDO_ESTIMADO)}`);
                
                addFooter(4, 5);

                // --- PDF Page 5: Technical Cost Breakdown ---
                pdf.addPage();
                addHeader("Desglose T√©cnico de Costos");
                const costData = d.cobertura;
                const subtotal = costData.costoM40P1 + costData.factorMultiplicador + costData.comision + costData.sumaFijaAdicional + costData.comisionExcedente;
                pdf.autoTable({
                    startY: yPos,
                    head: [['Concepto', 'Monto']],
                    body: [
                        ['Costo M40 (c/Act+Rec)', `$ ${formatNumber(costData.costoM40P1)}`],
                        ['Factor Multiplicador (50% s/M40)', `$ ${formatNumber(costData.factorMultiplicador)}`],
                        ['Comisi√≥n (16% s/M40)', `$ ${formatNumber(costData.comision)}`],
                        ['Suma Fija Adicional', `$ ${formatNumber(costData.sumaFijaAdicional)}`],
                        ['Comisi√≥n por Excedente', `$ ${formatNumber(costData.comisionExcedente)}`],
                        ['Subtotal', `$ ${formatNumber(subtotal)}`],
                        ['Ajuste Manual', `(-) $ ${formatNumber(Math.abs(costData.ajusteManual))}`],
                        ['Costo Total Final del Contrato', `$ ${formatNumber(costData.costoTotalContrato)}`]
                    ],
                    theme: 'grid',
                    headStyles: { fillColor: RGC_BLUE, textColor: WHITE, fontStyle: 'bold' },
                    bodyStyles: { fontStyle: 'bold', fontSize: 10 },
                    columnStyles: { 1: { halign: 'right' } },
                    didParseCell: (data) => {
                        if (data.row.index >= 5) { // Subtotal, Ajuste, Total
                            data.cell.styles.fillColor = BG_LIGHT_BLUE;
                            data.cell.styles.fontStyle = 'bold';
                        }
                        if (data.row.index === 7) { // Total
                            data.cell.styles.textColor = RGC_BLUE;
                            data.cell.styles.fontSize = 12;
                        }
                    }
                });

                addFooter(5, 5);

                pdf.save(`Propuesta_RGC_${d.cliente.nombre.replace(/\s/g, '_')}.pdf`);

            } catch(e) {
                console.error("Error generating PDF:", e);
                showCustomAlert("Ocurri√≥ un error al generar el PDF. Por favor, intenta de nuevo.", "Error de Exportaci√≥n");
            } finally {
                exportButton.innerHTML = `<i class="fas fa-download"></i>Exportar a PDF`;
                exportButton.disabled = false;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('agreementCheckbox').addEventListener('change', (e) => {
                document.getElementById('acceptAgreementButton').disabled = !e.target.checked;
            });
            
            document.getElementById('login_password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            
            document.getElementById('agreementDate').textContent = new Date().toLocaleDateString('es-MX', { day: 'numeric', month: 'long', year: 'numeric' });

            // --- Real-time Validation Setup ---
            const setValidationState = (element, isValid, message = "") => {
                const errorElement = document.getElementById(`${element.id}_error`);
                element.classList.remove('input-valid', 'input-invalid');
                if (!errorElement) return;

                errorElement.textContent = "";
                
                if (element.value.length === 0) return;

                if (isValid) {
                    element.classList.add('input-valid');
                } else {
                    element.classList.add('input-invalid');
                    errorElement.textContent = message;
                }
            };

            const validateField = (element) => {
                const value = element.value;
                const numValue = parseFloat(value);

                switch (element.id) {
                    case 'info_semanasCotizadas':
                        setValidationState(element, !isNaN(numValue) && numValue >= 500, 'Debe ser un n√∫mero mayor o igual a 500.');
                        break;
                    case 'info_edadCliente':
                        setValidationState(element, !isNaN(numValue) && numValue >= 60, 'La edad m√≠nima para pensionarse es 60.');
                        break;
                    case 'info_sbcPromedio':
                        setValidationState(element, !isNaN(numValue) && numValue > 0, 'Debe ser un n√∫mero mayor a 0.');
                        break;
                    case 'info_curpCliente':
                        setValidationState(element, value.length === 18, 'El CURP debe tener 18 caracteres.');
                        break;
                }
            };

            const fieldsToValidate = ['info_semanasCotizadas', 'info_edadCliente', 'info_sbcPromedio', 'info_curpCliente'];
            fieldsToValidate.forEach(id => {
                const field = document.getElementById(id);
                if (field) {
                    field.addEventListener('input', () => validateField(field));
                }
            });


            // Initially show the confidentiality modal
            showElement('confidentialityModal');
        });

    </script>
</body>
</html>


