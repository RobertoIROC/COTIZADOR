<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RGC Pensiones - Calculadora de Proyección</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --dark-blue: #003366; /* Azul marino profundo */
            --gold: #D4AF37;     /* Oro metálico */
            --dark-gold: #B8860B; /* Oro oscuro para hover */
            --text-dark: #1A202C;  /* Casi negro */
            --text-medium: #4A5568;/* Gris oscuro */
            --bg-light: #F8F9FA;  /* Gris muy claro */
            --white: #FFFFFF;
            --border-color: #E2E8F0;
            --success-color: #16A34A;
            --danger-color: #DC2626;
        }

        body { 
            font-family: 'Lato', sans-serif; 
            background-color: var(--bg-light);
            color: var(--text-medium);
        }
        
        /* Encabezado Principal */
        .main-header {
            background: linear-gradient(135deg, var(--dark-blue) 0%, #002244 100%);
            color: var(--white);
            padding: 2.5rem 1rem;
            text-align: center;
            border-radius: 0 0 40px 40px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 3rem;
            position: relative;
        }
        .logo-text-elegant {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            font-size: 2.5rem;
            color: var(--gold);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.4);
            letter-spacing: 1px;
        }
        .main-header .logo-text-elegant {
            font-size: 2rem;
            margin-bottom: 1rem;
        }
        .main-header h1 {
            font-family: 'Lato', sans-serif;
            font-weight: 900;
            font-size: 2.25rem; /* 36px */
            letter-spacing: -0.5px;
        }
        .main-header p {
            font-size: 1.125rem; /* 18px */
            opacity: 0.85;
            font-weight: 400;
        }

        /* Estructura de Secciones */
        .infographic-section {
            background-color: var(--white);
            border-radius: 20px;
            padding: 2rem 2.5rem;
            margin-bottom: 2.5rem;
            box-shadow: 0 8px 30px rgba(0, 51, 102, 0.08);
            border: 1px solid var(--border-color);
            border-top: 6px solid var(--dark-blue);
            position: relative;
        }
        .infographic-section h2 {
            font-family: 'Lato', sans-serif;
            font-weight: 900;
            font-size: 1.75rem; /* 28px */
            margin-bottom: 2rem;
            color: var(--dark-blue);
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }
        .infographic-section h2 i {
            margin-right: 1rem;
            font-size: 1.5rem;
            color: var(--gold);
        }
        .infographic-section h3.subsection-title {
            font-family: 'Lato', sans-serif;
            font-weight: 700;
            font-size: 1.25rem; /* 20px */
            color: var(--dark-blue);
            margin-top: 2rem;
            margin-bottom: 1.5rem;
        }
        
        /* Formularios y Entradas */
        .input-group label {
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: var(--text-medium); 
            font-size: 0.875rem; /* 14px */
            display: block;
        }
        .input-group input[type="text"],
        .input-group input[type="password"],
        .input-group input[type="number"],
        .input-group input[type="month"],
        .input-group input[type="date"],
        .input-group select,
        .input-group textarea {
            padding: 0.8rem 1rem;
            border: 1px solid #CBD5E0;
            border-radius: 0.5rem; /* 8px */
            font-size: 1rem;
            width: 100%;
            transition: all 0.2s ease-in-out;
            background-color: #FDFDFD;
        }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            border-color: var(--gold); 
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
            outline: none;
        }
        .input-group input[readonly] {
            background-color: #E9ECEF;
            cursor: not-allowed;
        }
        
        /* Botones */
        .btn {
            font-family: 'Lato', sans-serif;
            font-weight: 700;
            padding: 0.8rem 2rem;
            border-radius: 0.5rem;
            transition: all 0.25s ease-out;
            border: none;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn:disabled {
            background: #A0AEC0;
            color: #E2E8F0;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        
        .btn-gold {
            background: linear-gradient(135deg, var(--gold), var(--dark-gold));
            color: var(--dark-blue);
        }
        .btn-gold:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(212, 175, 55, 0.3);
        }

        .btn-blue {
            background: linear-gradient(135deg, var(--dark-blue), #004488);
            color: var(--white);
        }
        .btn-blue:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 51, 102, 0.3);
        }
        
        .btn-secondary {
            background-color: var(--white);
            color: var(--dark-blue);
            border: 2px solid var(--dark-blue);
            padding: 0.7rem 1.5rem;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: var(--dark-blue);
            color: var(--white);
        }
        
        .btn-danger-icon {
            background-color: #FFF1F2;
            color: #E53E3E;
            border: 1px solid #E53E3E;
            padding: 0.5rem;
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }
        .btn-danger-icon:hover {
            background-color: #E53E3E;
            color: var(--white);
        }
        
        /* Employment Card Styles */
        .employment-card {
            background-color: #F8F9FA;
            border: 1px solid #E2E8F0;
            border-left: 5px solid var(--dark-blue);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            position: relative;
        }
        
        /* Login Container */
        #loginContainer {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-light);
            z-index: 40;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }
        #loginContainer.active {
            opacity: 1;
            pointer-events: auto;
        }

        .login-box {
            background-color: var(--white);
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 51, 102, 0.15);
            width: 100%;
            max-width: 450px;
            border-top: 6px solid var(--gold);
        }
        .login-box h2 {
            font-family: 'Lato', sans-serif;
            font-weight: 900;
            font-size: 2rem;
            color: var(--dark-blue);
            text-align: center;
            margin-bottom: 2.5rem;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 34, 68, 0.7); /* Azul oscuro semi-transparente */
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: var(--white);
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 51, 102, 0.2);
            max-width: 90%;
            width: 650px;
            border-top: 6px solid var(--gold);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
        
        .modal-content-alert {
             text-align: center;
             width: 400px;
        }
        
        .modal-content h2 {
             font-family: 'Lato', sans-serif;
             color: var(--dark-blue);
             font-size: 1.5rem;
             font-weight: 700;
             text-align: center;
             margin-bottom: 1.5rem;
             padding-bottom: 1rem;
             border-bottom: 1px solid var(--border-color);
        }
        .privacy-text-container {
            border: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            background-color: var(--bg-light);
            max-height: 55vh;
            overflow-y: auto;
            margin-bottom: 1.5rem;
        }
        .privacy-text-container p {
            font-size: 0.875rem; /* 14px */
            line-height: 1.6;
            margin-bottom: 1rem;
        }
        .privacy-text-container::-webkit-scrollbar { width: 8px; }
        .privacy-text-container::-webkit-scrollbar-track { background: var(--border-color); border-radius: 10px; }
        .privacy-text-container::-webkit-scrollbar-thumb { background-color: var(--gold); border-radius: 10px; }

        .app-footer {
            text-align: center;
            margin-top: 4rem;
            padding: 2.5rem 1rem;
            background-color: var(--dark-blue);
            color: var(--white);
            border-radius: 40px 40px 0 0;
        }
        .app-footer .logo-text-footer {
            font-family: 'Playfair Display', serif;
            color: var(--gold);
            font-weight: 700;
            font-size: 1.25rem;
            margin-bottom: 1rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .app-footer p { opacity: 0.8; }

        #sessionTimerContainer {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-family: 'Lato', sans-serif;
            font-weight: 700;
            color: var(--text-dark);
            z-index: 100;
            transition: color 0.3s;
        }

        /* Menu Styles */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
        }
        .menu-card {
            background: var(--white);
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 8px 30px rgba(0, 51, 102, 0.08);
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }
        .menu-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px rgba(0, 51, 102, 0.12);
        }
        .menu-card i {
            font-size: 3rem;
            color: var(--gold);
            margin-bottom: 1.5rem;
        }
        .menu-card h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--dark-blue);
            margin-bottom: 0.5rem;
        }
        .menu-card p {
            font-size: 0.875rem;
            color: var(--text-medium);
        }

        /* D3 Timeline Tooltip Styles */
        #timeline-tooltip {
            position: absolute;
            text-align: left;
            padding: 8px 12px;
            font-size: 12px;
            background: #2d3748;
            color: white;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }

        /* Admin Advisor Toggle Switch */
        .switch {
          position: relative;
          display: inline-block;
          width: 60px;
          height: 34px;
        }
        .switch input { 
          opacity: 0;
          width: 0;
          height: 0;
        }
        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: #ccc;
          transition: .4s;
          border-radius: 34px;
        }
        .slider:before {
          position: absolute;
          content: "";
          height: 26px;
          width: 26px;
          left: 4px;
          bottom: 4px;
          background-color: white;
          transition: .4s;
          border-radius: 50%;
        }
        input:checked + .slider {
          background-color: var(--dark-blue);
        }
        input:checked + .slider:before {
          transform: translateX(26px);
        }
    </style>
</head>
<body>
    
    <div id="confidentialityModal" class="modal-overlay">
        <div class="modal-content">
            <h2>CARTA COMPROMISO DE CONFIDENCIALIDAD</h2>
            <div class="privacy-text-container">
                 <p><strong>Fecha:</strong> <span id="agreementDate"></span><br><strong>Lugar:</strong> Ciudad de México, México</p>
                 <p>En mi calidad de Asesor para RGC Pensiones y Seguros, manifiesto y acepto de manera voluntaria los siguientes términos y condiciones:</p>
                 <p><strong>1. ANTECEDENTES</strong><br>Reconozco que, en virtud de mi relación profesional con RGC Pensiones, se me ha proporcionado acceso a una herramienta de software especializada (en adelante, "la Herramienta"), la cual es fundamental para el desempeño de mis funciones.</p>
                 <p><strong>2. PROPIEDAD INTELECTUAL</strong><br>Declaro tener pleno conocimiento de que la Herramienta es propiedad intelectual exclusiva del C. Ivan Roberto Ortiz Cano, y que RGC Pensiones cuenta con la licencia y autorización para su uso con fines corporativos específicos. Entiendo que mi acceso a la misma es una concesión temporal y está estrictamente limitado al ejercicio de mis responsabilidades dentro de esta empresa.</p>
                 <p><strong>3. COMPROMISO DE USO EXCLUSIVO</strong><br>Me comprometo de manera irrevocable a utilizar la Herramienta única y exclusivamente para los fines y objetivos de negocio de RGC Pensiones. Me doy por enterado de que existe un límite de dos (2) descargas de reportes en formato PDF por cada inicio de sesión.</p>
                 <p><strong>4. PROHIBICIONES ESPECÍFICAS</strong><br>Queda estrictamente prohibido y me obligo a abstenerme de:<br>
                 a) Utilizar la Herramienta, sus funciones, datos, metodologías o resultados para obtener cualquier tipo de lucro o beneficio personal, directo o indirecto.<br>
                 b) Emplear la Herramienta para prestar servicios, asesorías o realizar actividades para terceros, ya sean personas físicas o morales, ajenos a RGC Pensiones.<br>
                 c) Copiar, reproducir, modificar, distribuir, vender, sublicenciar, descompilar o realizar ingeniería inversa de la Herramienta o cualquiera de sus componentes.<br>
                 d) Compartir mis credenciales de acceso (contraseña o cualquier otra forma de acceso) con cualquier otra persona, dentro o fuera de la organización.<br>
                 e) Utilizar la Herramienta fuera de las instalaciones y oficinas de RGC Pensiones.</p>
                 <p><strong>5. CONSECUENCIAS DEL INCUMPLIMIENTO</strong><br>Entiendo y acepto que el incumplimiento de cualquiera de los puntos estipulados en esta carta será considerado una falta grave y se podrá dar lugar a:<br>
                 a) Concluir la relación profesional y comercial con RGC Pensiones, sin responsabilidad para la empresa.<br>
                 b) El inicio de acciones legales en mi contra por parte de RGC Pensiones y/o del Sr. Ivan Roberto Ortiz Cano, titular de la propiedad intelectual, para reclamar la reparación de los daños y perjuicios ocasionados.</p>
                 <p>Este compromiso mantendrá su vigencia durante toda mi relación con RGC Pensiones y subsistirá incluso después de su terminación, por tiempo indefinido.</p>
                 <p>Habiendo leído y comprendido en su totalidad el presente documento, lo acepto de conformidad.</p>
            </div>
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <input type="checkbox" id="agreementCheckbox" class="h-5 w-5 text-blue-600 border-gray-400 rounded focus:ring-gold-500">
                    <label for="agreementCheckbox" class="ml-3 block text-sm text-gray-700 font-medium">
                        He leído, comprendido y acepto los términos.
                    </label>
                </div>
                <button id="acceptAgreementButton" onclick="acceptAgreement()" class="btn btn-gold" disabled>
                    Aceptar y Continuar
                </button>
            </div>
        </div>
    </div>

    <div id="sessionTimerContainer" style="display: none;">
        <i class="fas fa-clock mr-2"></i>Tiempo restante: <span id="sessionCountdown">15:00</span>
    </div>

    
    <div id="loginContainer">
        <div class="login-box">
            <div class="logo-text-elegant text-center mb-8">RGC Pensiones y Seguros</div>
            <h2>Acceso de Asesor</h2>
            <div class="input-group mb-4">
                <label for="login_asesor"><i class="fas fa-user-tie mr-2 opacity-70"></i>Usuario:</label>
                <input type="text" id="login_asesor" placeholder="Usuario" class="w-full">
            </div>
            <div class="input-group">
                <label for="login_password"><i class="fas fa-lock mr-2 opacity-70"></i>Contraseña:</label>
                <input type="password" id="login_password" placeholder="••••••••••" class="w-full">
            </div>
            <div class="text-center mt-8">
                <button id="loginButton" onclick="handleLogin()" class="btn btn-blue w-full">
                    <i class="fas fa-sign-in-alt"></i>Ingresar
                </button>
            </div>
            <div id="login_errorMessage" class="error-message-infographic" style="display: none; margin-top: 1.5rem;"><p></p></div>
        </div>
    </div>

    
    <div id="appContainer" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-6xl" style="display: none;">
        
        <div id="vigenciaAlertContainer" class="hidden mb-6"></div>
        
        <div id="mainMenuSection" style="display: none;">
            <header class="main-header">
                <div class="logo-text-elegant">RGC Pensiones y Seguros</div>
                <h1>Panel de Asesor</h1>
                <p>Selecciona una herramienta para comenzar.</p>
                <p id="asesorNameDisplay" class="text-lg font-semibold mt-2 opacity-90"></p>
                <button onclick="logout('Has cerrado sesión correctamente.')" class="btn !py-2 !px-4 text-sm absolute top-4 right-4 bg-red-100 !border-red-500 !text-red-600 hover:!bg-red-500 hover:!text-white">
                    <i class="fas fa-sign-out-alt"></i>Cerrar Sesión
                </button>
            </header>
            <div class="menu-grid">
                <div class="menu-card" id="menuCardCalculator" onclick="showSection('calculatorSection')">
                    <i class="fas fa-calculator"></i>
                    <h3>Cálculo de Pensión y Crédito</h3>
                    <p>Realiza proyecciones detalladas de pensión y financiamiento para clientes.</p>
                </div>
                <div class="menu-card" id="menuCardContract" onclick="showSection('contractSection')" style="display: none;">
                    <i class="fas fa-pencil-alt"></i>
                    <h3>Realizar Contrato</h3>
                    <p>Módulo para la generación de contratos.</p>
                </div>
                <div class="menu-card" id="menuCardCrm" onclick="showSection('crmSection')" style="display: none;">
                    <i class="fas fa-users"></i>
                    <h3>Cartera de Clientes</h3>
                    <p>Gestiona y consulta la información de tus clientes.</p>
                </div>
                <div id="adminMenuCard" class="menu-card md:col-span-2" onclick="showSection('adminSection')" style="display: none;">
                    <i class="fas fa-user-shield"></i>
                    <h3>Panel de Administrador</h3>
                    <p>Ver registros de actividad y gestionar asesores.</p>
                </div>
            </div>
        </div>

        
        <div id="calculatorSection" style="display: none;">
            <div class="flex justify-between items-center mb-6">
                <button onclick="showSection('mainMenuSection')" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i>Volver al Menú</button>
                <button onclick="logout('Has cerrado sesión correctamente.')" class="btn !py-2 !px-3 bg-red-100 !border-red-500 !text-red-600 hover:!bg-red-500 hover:!text-white text-sm">
                    <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesión
                </button>
            </div>
            
            <section id="infoSection1" class="infographic-section">
                <h2><i class="fas fa-user-edit"></i>Paso 1: Datos y Análisis de Historial</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-12 gap-y-8">
                    <div>
                        <h3 class="subsection-title !mt-0">Datos del Cliente</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 mb-8">
                            <div class="input-group">
                                <label for="info_nombreCompleto">Nombre Completo (Apellidos Nombre):</label>
                                <input type="text" id="info_nombreCompleto" placeholder="Se llena automático o manual" class="w-full">
                            </div>
                            <div class="input-group">
                                <label for="info_curpCliente">CURP:</label>
                                <input type="text" id="info_curpCliente" placeholder="Se llena automático o manual" maxlength="18" oninput="this.value = this.value.toUpperCase();" class="w-full">
                            </div>
                             <div class="input-group">
                                 <label for="info_telefonoCliente">Teléfono (10 dígitos):</label>
                                 <input type="text" id="info_telefonoCliente" placeholder="5512345678" maxlength="10" class="w-full">
                             </div>
                            <div class="input-group">
                                <label for="info_semanasTotalesManual">Semanas Totales Cotizadas:</label>
                                <input type="number" id="info_semanasTotalesManual" placeholder="Se llena automático o manual" class="w-full">
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="subsection-title !mt-0">Fuente de Datos del Historial</h3>
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-6">
                             <div class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-700 p-4 rounded-md mb-6" role="alert">
                                 <p class="font-bold">¡Importante!</p>
                                 <p class="text-sm">Para el análisis automático, convierte el PDF de la constancia del IMSS a Word, copia todo el texto y pégalo abajo.</p>
                                 <a href="https://www.ilovepdf.com/es/pdf_a_word" target="_blank" class="btn btn-gold mt-4 text-sm !py-2">
                                     <i class="fas fa-file-word"></i> Ir al Conversor PDF a Word
                                 </a>
                             </div>

                        <div class="input-group">
                            <label for="info_textoCompleto">Pegue aquí el texto convertido:</label>
                            <textarea id="info_textoCompleto" class="w-full font-mono text-sm" rows="8" placeholder="Pegue todo el texto, desde el nombre del cliente hasta el último movimiento..."></textarea>
                        </div>
                        <div class="text-center mt-4">
                            <button onclick="analizarTextoCompleto()" class="btn btn-blue">
                                <i class="fas fa-magic"></i> Extraer y Analizar Texto
                            </button>
                        </div>
                        </div>
                        
                        <div>
                            <h3 class="subsection-title">... O ingrese los datos manualmente:</h3>
                             <div id="employmentCardsContainerWrapper">
                                 <button id="toggleCardsBtn" onclick="toggleAutoCards()" class="btn btn-secondary mb-4" style="display: none;">Mostrar/Ocultar Tarjetas Automáticas</button>
                                 <div id="employmentCardsContainer" style="display: none;"></div>
                             </div>
                            <button onclick="addEmploymentCard()" class="btn btn-secondary mt-4"><i class="fas fa-plus mr-2"></i>Agregar Empleo Manualmente</button>
                        </div>
                    </div>
                </div>


                <div id="sbcAnalysisResultsContainer" class="mt-12 pt-8 border-t" style="display: none;">
                    <h3 class="subsection-title">Resultados del Análisis</h3>
                    <div id="ageAdjustmentWarning" class="mb-4 p-3 rounded-lg text-sm bg-yellow-50 border border-yellow-200 text-yellow-800" style="display: none;"></div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="text-sm text-blue-800">SBC Promedio</p>
                            <p id="res_sbcPromedio" class="text-2xl font-bold text-blue-900">$0.00</p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="text-sm text-blue-800">Edad Actual</p>
                            <p id="res_edadActual" class="text-2xl font-bold text-blue-900">0 años</p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="text-sm text-blue-800">Teléfono</p>
                            <p id="res_telefonoCliente" class="text-2xl font-bold text-blue-900">--</p>
                        </div>
                        <div id="vigenciaResultBox" class="p-4 rounded-lg md:col-span-3">
                            <p id="vigenciaResultText" class="text-2xl font-bold">--</p>
                            <p id="vigenciaResultSubText" class="text-sm">--</p>
                        </div>
                    </div>
                     <div class="mt-6 overflow-x-auto">
                         <div class="flex justify-between items-center mb-2 flex-wrap gap-4">
                             <h4 class="font-semibold text-gray-700">Periodos del Historial Laboral</h4>
                             <div class="flex items-center space-x-4">
                                 <div class="flex items-center">
                                     <input type="checkbox" id="showFullHistoryCheckbox" onchange="renderSbcAnalysisTable()" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                     <label for="showFullHistoryCheckbox" class="ml-2 text-sm text-gray-600">Mostrar historial completo</label>
                                 </div>
                                 <div class="flex items-center">
                                     <input type="checkbox" id="showSbcBreakdownCheckbox" onchange="renderSbcAnalysisTable()" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                     <label for="showSbcBreakdownCheckbox" class="ml-2 text-sm text-gray-600">Desglose por empleador</label>
                                 </div>
                             </div>
                         </div>
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-2">Registro Patronal</th>
                                    <th class="p-2">Fecha Inicio</th>
                                    <th class="p-2">Fecha Fin</th>
                                    <th class="p-2 text-right">Días</th>
                                    <th class="p-2 text-right">SBC Diario</th>
                                    <th class="p-2 text-right">SBC Ponderado (para cálculo)</th>
                                </tr>
                            </thead>
                            <tbody id="sbcAnalysisTableBody">
                            </tbody>
                            <tfoot id="sbcAnalysisTableFooter" class="font-bold bg-gray-100">
                            </tfoot>
                        </table>
                         <div id="sbcDaysWarning" class="mt-4 p-3 rounded-lg text-sm" style="display: none;"></div>
                         <div id="modalitySummaryContainer" class="mt-6"></div>
                    </div>
                </div>

                <div id="timelineSection" class="mt-12 pt-8 border-t" style="display: none;">
                    <h3 class="subsection-title">Línea de Tiempo del Historial Laboral (Últimos 10 Años)</h3>
                    <div id="timeline-container" class="w-full h-96 overflow-x-auto"><svg id="timeline-svg"></svg></div>
                    <div id="timeline-legend" class="flex flex-wrap gap-x-4 gap-y-2 mt-4 p-2 border-t"></div>
                </div>

                <div id="basePensionResultsContainer" class="mt-8" style="display: none;">
                    <h3 class="subsection-title">Resultados de Pensión Base (Sin M40)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <p class="text-sm text-green-800">Pensión Mensual Estimada</p>
                            <p id="res_base_pensionMensual" class="text-2xl font-bold text-green-900">$0.00</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <p class="text-sm text-green-800">Aguinaldo Estimado</p>
                            <p id="res_base_aguinaldo" class="text-2xl font-bold text-green-900">$0.00</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <p class="text-sm text-green-800">Ingreso Anual Total</p>
                            <p id="res_base_ingresoAnual" class="text-2xl font-bold text-green-900">$0.00</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="infoSection2" class="infographic-section">
                <h2><i class="fas fa-chart-line"></i>Paso 2: Estrategia Modalidad 40</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div>
                         <h3 class="subsection-title">Definir Periodo de Inversión en M40</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-6">
                            <div class="input-group">
                                <label for="info_m40_p1_inicio">Fecha Inicio M40:</label>
                                <input type="date" id="info_m40_p1_inicio" onchange="handleM40StartDateChange()" class="w-full">
                                <div id="m40_start_date_clarification" class="text-xs text-gray-500 mt-1 pl-1"></div>
                            </div>
                            <div class="input-group">
                                <label for="info_m40_p1_meses">Meses a Invertir:</label>
                                <input type="number" id="info_m40_p1_meses" placeholder="Ej: 60" max="60" oninput="actualizarFechaFinM40Display()" class="w-full">
                            </div>
                            <div class="input-group sm:col-span-2">
                                <label for="info_m40_p1_sbc">SBC Diario M40 (Tope):</label>
                                <input type="number" id="info_m40_p1_sbc" placeholder="Automático" class="w-full">
                            </div>
                        </div>
                         <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-center">
                             <div id="info_m40_baja_display" class="text-sm font-semibold text-blue-800 leading-relaxed">
                                 -- Ingrese fechas para ver la edad de baja --
                             </div>
                         </div>
                    </div>
                    <div>
                        <h3 class="subsection-title">Tabla de Referencia UMA</h3>
                        <div class="overflow-x-auto max-h-64">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-100 sticky top-0">
                                    <tr>
                                        <th class="p-2">Año</th>
                                        <th class="p-2 text-right">Valor UMA Diario</th>
                                        <th class="p-2 text-right">SBC Tope (25 UMAs)</th>
                                    </tr>
                                </thead>
                                <tbody id="umaReferenceTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-10">
                    <button id="btnCalcularEscenarioM40" onclick="calcularEscenarioM40Infografia()" class="btn btn-gold">
                        <i class="fas fa-cogs"></i>Calcular Proyección M40
                    </button>
                </div>
            </section>

            <section id="infoSection3" class="infographic-section" style="display: none;">
                <h2><i class="fas fa-hand-holding-usd"></i>Paso 3: Análisis Financiero</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div class="input-group">
                        <label for="info_aforeActual">AFORE Actual ($):</label>
                        <input type="number" id="info_aforeActual" placeholder="0.00" oninput="recalculateAllScenarios();">
                    </div>
                    <div class="input-group">
                        <label for="info_mesesPrimerDeposito">Meses para Primer Depósito (6-12):</label>
                        <input type="number" id="info_mesesPrimerDeposito" value="6" min="6" max="12" onchange="handleMesesDepositoChange(this)" data-last-valid="6">
                    </div>
                     <div class="input-group md:col-span-2">
                         <label for="info_comisionExcedente">Comisión por Excedente ($) y Concepto:</label>
                         <div class="flex gap-4">
                             <input type="number" id="info_comisionExcedente" placeholder="0.00" oninput="recalculateAllScenarios();" class="w-1/2">
                             <input type="text" id="info_comisionExcedente_concepto" placeholder="Concepto para reporte" class="w-1/2">
                         </div>
                     </div>
                </div>
            </section>
            
            <section id="infoSection4" class="infographic-section" style="display: none;">
                <h2><i class="fas fa-balance-scale-right"></i>Paso 4: Comparador de Escenarios</h2>
                <div id="scenariosContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    </div>
                 <div class="text-center mt-8">
                     <button id="addScenarioBtn" onclick="addScenarioCard()" class="btn btn-secondary"><i class="fas fa-plus mr-2"></i>Agregar Escenario</button>
                 </div>
            </section>

            <section id="infoSection5" class="infographic-section text-center" style="display: none;">
                <h2><i class="fas fa-file-export"></i>Paso 5: Exportar Reportes</h2>
                 <p class="mb-8 text-gray-600 text-lg max-w-2xl mx-auto">Genera reportes detallados en PDF.</p>
                <div class="flex justify-center flex-wrap gap-6">
                    <button onclick="promptForClientPDF()" class="btn btn-blue text-lg">
                        <i class="fas fa-user"></i> Reporte PDF para Cliente
                    </button>
                    <button onclick="promptForDirectorPDF()" class="btn btn-gold text-lg">
                        <i class="fas fa-user-shield"></i> Reporte PDF para Dirección
                    </button>
                </div>
            </section>
        </div>

        
        <div id="contractSection" style="display: none;">
            <div class="flex justify-between items-center mb-6">
                <button onclick="showSection('mainMenuSection')" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i>Volver al Menú</button>
                <button onclick="logout('Has cerrado sesión correctamente.')" class="btn !py-2 !px-3 bg-red-100 !border-red-500 !text-red-600 hover:!bg-red-500 hover:!text-white text-sm">
                    <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesión
                </button>
            </div>
            <section class="infographic-section">
                <h2><i class="fas fa-file-signature"></i>Generador de Contrato de Servicios</h2>
                <div class="input-group mb-6">
                    <label for="contract_monto">Monto del Contrato (Automático desde Escenario 1)</label>
                    <input type="number" id="contract_monto" placeholder="Se llena al calcular escenario 1" class="w-full" readonly>
                </div>

                <h3 class="subsection-title">Datos del Cliente (Contratante)</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div class="input-group">
                        <label for="contract_cliente_nombre">Nombre Completo:</label>
                        <input type="text" id="contract_cliente_nombre" placeholder="Nombre(s) Apellido Paterno Apellido Materno" class="w-full">
                    </div>
                    <div class="input-group">
                        <label for="contract_cliente_telefono">Teléfono (10 dígitos):</label>
                        <input type="text" id="contract_cliente_telefono" placeholder="5512345678" maxlength="10" class="w-full">
                    </div>
                    <div class="input-group">
                        <label for="contract_cliente_email">Correo Electrónico:</label>
                        <input type="text" id="contract_cliente_email" placeholder="cliente@email.com" class="w-full">
                    </div>
                    <div class="input-group">
                        <label for="contract_cliente_direccion">Dirección Completa:</label>
                        <input type="text" id="contract_cliente_direccion" placeholder="Calle, Número, Colonia, Alcaldía, C.P., Ciudad" class="w-full">
                    </div>
                </div>

                <h3 class="subsection-title mt-8">Datos del Co-Contratante / Responsable Solidario</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div class="input-group">
                        <label for="contract_rs_nombre">Nombre Completo:</label>
                        <input type="text" id="contract_rs_nombre" placeholder="Nombre(s) Apellido Paterno Apellido Materno" class="w-full">
                    </div>
                    <div class="input-group">
                        <label for="contract_rs_telefono">Teléfono (10 dígitos):</label>
                        <input type="text" id="contract_rs_telefono" placeholder="5587654321" maxlength="10" class="w-full">
                    </div>
                     <div class="input-group">
                         <label for="contract_rs_email">Correo Electrónico:</label>
                         <input type="text" id="contract_rs_email" placeholder="responsable@email.com" class="w-full">
                     </div>
                    <div class="input-group">
                        <label for="contract_rs_direccion">Dirección Completa:</label>
                        <input type="text" id="contract_rs_direccion" placeholder="Calle, Número, Colonia, Alcaldía, C.P., Ciudad" class="w-full">
                    </div>
                </div>

                <div class="text-center mt-10">
                    <button onclick="generateContractPDF()" class="btn btn-gold text-lg">
                        <i class="fas fa-file-pdf"></i>Generar y Descargar Contrato
                    </button>
                </div>
            </section>
        </div>

        <div id="crmSection" style="display: none;">
            <div class="flex justify-between items-center mb-6">
                <button onclick="showSection('mainMenuSection')" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i>Volver al Menú</button>
                <button onclick="logout('Has cerrado sesión correctamente.')" class="btn !py-2 !px-3 bg-red-100 !border-red-500 !text-red-600 hover:!bg-red-500 hover:!text-white text-sm">
                    <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesión
                </button>
            </div>
            <section class="infographic-section">
                <h2><i class="fas fa-users"></i>Cartera de Clientes</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2">Nombre Cliente</th>
                                <th class="p-2">Teléfono</th>
                                <th class="p-2">CURP</th>
                                <th class="p-2">Precio Venta</th>
                                <th class="p-2">Pensión Bruta</th>
                                <th class="p-2">Pensión Neta</th>
                                <th class="p-2">Meses M40</th>
                                <th class="p-2">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTableBody">
                            <tr><td colspan="8" class="text-center p-4">Cargando clientes...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <div id="adminSection" style="display: none;">
            <div class="flex justify-between items-center mb-6">
                <button onclick="showSection('mainMenuSection')" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i>Volver al Menú</button>
                <button onclick="logout('Has cerrado sesión correctamente.')" class="btn !py-2 !px-3 bg-red-100 !border-red-500 !text-red-600 hover:!bg-red-500 hover:!text-white text-sm">
                    <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesión
                </button>
            </div>
            <section class="infographic-section">
                <h2><i class="fas fa-user-shield"></i>Panel de Administrador</h2>
                
                <h3 class="subsection-title">Gestión de Acceso de Asesores</h3>
                <div class="overflow-x-auto max-h-96">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="p-2">Asesor</th>
                                <th class="p-2 text-center">Acceso</th>
                            </tr>
                        </thead>
                        <tbody id="advisorsTableBody">
                           </tbody>
                    </table>
                </div>

                <h3 class="subsection-title mt-8">Registros de Inicio de Sesión</h3>
                <div class="overflow-x-auto max-h-96">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="p-2">Asesor</th>
                                <th class="p-2">Fecha y Hora</th>
                            </tr>
                        </thead>
                        <tbody id="loginLogsTableBody">
                           <tr><td colspan="2" class="text-center p-4">Cargando registros...</td></tr>
                        </tbody>
                    </table>
                </div>

                <h3 class="subsection-title mt-8">Registros de Cálculos</h3>
                <div class="overflow-x-auto max-h-96">
                     <table class="w-full text-sm text-left">
                         <thead class="bg-gray-100 sticky top-0">
                             <tr>
                                 <th class="p-2">Fecha</th>
                                 <th class="p-2">Asesor</th>
                                 <th class="p-2">Cliente</th>
                                 <th class="p-2">CURP</th>
                                 <th class="p-2">Teléfono</th>
                                 <th class="p-2">Detalles Escenario 1</th>
                             </tr>
                         </thead>
                         <tbody id="calcLogsTableBody">
                             <tr><td colspan="6" class="text-center p-4">Cargando registros...</td></tr>
                         </tbody>
                     </table>
                </div>

                <h3 class="subsection-title mt-8">Acciones de Administrador</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                    <div class="bg-gray-50 p-4 rounded-lg border">
                        <h4 class="font-bold mb-2">Registros de Inicio de Sesión</h4>
                        <div class="flex gap-4">
                            <button id="downloadLoginLogsBtn" class="btn btn-secondary text-sm flex-1"><i class="fas fa-download mr-2"></i>Descargar CSV</button>
                            <button id="resetLoginLogsBtn" class="btn btn-danger-icon !rounded-lg !w-auto !h-auto !px-4"><i class="fas fa-trash-alt"></i> Resetear</button>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border">
                        <h4 class="font-bold mb-2">Registros de Cálculos</h4>
                        <div class="flex gap-4">
                            <button id="downloadCalcLogsBtn" class="btn btn-secondary text-sm flex-1"><i class="fas fa-download mr-2"></i>Descargar CSV</button>
                            <button id="resetCalcLogsBtn" class="btn btn-danger-icon !rounded-lg !w-auto !h-auto !px-4"><i class="fas fa-trash-alt"></i> Resetear</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        
        <footer class="app-footer">
            <div class="logo-text-footer">RGC PENSIONES Y SEGUROS</div>
            <p>&copy; <span id="currentYear"></span> RGC Pensiones y Seguros. Todos los derechos reservados.</p>
            <p class="text-xs mt-1 opacity-70">Esta es una simulación y los resultados pueden variar. Consulta a un asesor para una evaluación detallada.</p>
        </footer>
    </div>
    
    <div id="customAlertModal" class="modal-overlay">
        <div class="modal-content modal-content-alert">
            <h2 id="customAlertTitle" class="text-xl">Alerta</h2>
            <p id="customAlertMessage" class="text-base my-6"></p>
            <div id="passwordPromptContainer" style="display: none;" class="mt-4">
                <input type="password" id="pdfPasswordInput" class="w-full p-2 border rounded" placeholder="Contraseña de Dirección">
            </div>
            <div class="flex justify-center gap-4 mt-4">
                <button id="customAlertCancelButton" style="display: none;" class="btn btn-secondary">Cancelar</button>
                <button id="customAlertButton" class="btn btn-blue">Aceptar</button>
            </div>
        </div>
    </div>

    <div id="clientDetailsModal" class="modal-overlay">
        <div class="modal-content" style="width: 800px; max-width: 95%;">
            <h2 id="clientDetailsName">Detalles del Cliente</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="subsection-title !mt-0">Información General</h3>
                    <div id="clientInfoPanel" class="text-sm space-y-2"></div>
                </div>
                <div>
                    <h3 class="subsection-title !mt-0">Notas de Seguimiento</h3>
                    <div id="clientNotesContainer" class="space-y-3 max-h-48 overflow-y-auto bg-gray-50 p-3 rounded-lg">
                        </div>
                    <div class="mt-4">
                        <textarea id="newNoteText" class="w-full" rows="3" placeholder="Escribir nueva nota..."></textarea>
                        <button id="saveNoteButton" class="btn btn-gold mt-2 float-right">Guardar Nota</button>
                    </div>
                </div>
            </div>
             <div class="text-center mt-8">
                 <button onclick="hideElement('clientDetailsModal')" class="btn btn-secondary">Cerrar</button>
             </div>
        </div>
    </div>
    
    <div id="timeline-tooltip"></div>

    <script>
        // --- APPLICATION SCOPE & STATE ---
        const AppState = {
            nombreAsesorGlobal: "",
            userRole: "asesor",
            isSpecialUser: false,
            adviserLocation: { lat: null, lon: null, error: null },
            employmentCardIdCounter: 0,
            scenarioData: {},
            activeScenarios: 0,
            datosClienteInfo: { 
                nombre: '', curp: '', telefono: '', 
                semanasCotizadasBase: 0, edadBase: 0, sbcPromedioBase: 0,
                ultimaFechaBaja: null 
            },
            sbcCalculationPeriods: [],
            fullHistoryPeriods: [],
            timelinePeriods: [], // Holds processed periods for the timeline
            pensionBaseResultadosInfo: { PENSION_MENSUAL_ESTIMADA: 0, AGUINALDO_ESTIMADO: 0 },
            session: { timeout: null, interval: null, duration: 15 * 60 * 1000, endTime: null, pdfDownloadCount: 0 },
            pdfGenerated: false // Flag to control scenario visibility
        };

        // --- FINANCIAL & ECONOMIC CONSTANTS ---
        const Constants = {
            DIAS_PROMEDIO_PENSION: 1750,
            SMGV_DF_Global: 88.36,
            FACTOR_FOX_Global: 1.11,
            PRESTAMO_PUNTO_A_DESCUENTO: 1115.61,
            PRESTAMO_PUNTO_A_MONTO: 31000,
            PRESTAMO_PUNTO_B_DESCUENTO: 33450.42,
            PRESTAMO_PUNTO_B_MONTO: 929500,
            COSTO_FIJO_ADICIONAL: 140000,
            COMISION_BASE_M40: 0.16,
            FACTOR_MULTIPLICADOR_COSTO: 0.5,
            AJUSTE_FINAL_CONTRATO: -35000,
            AJUSTE_PENSION_MENSUAL: -250,
            INPC_GROWTH_ESTIMATE: 0.06,
            RECARGO_M40_MENSUAL: 0.0147,
            economicData: {
                umas: { 2016: 73.04, 2017: 75.49, 2018: 80.60, 2019: 84.49, 2020: 86.88, 2021: 89.62, 2022: 96.22, 2023: 103.74, 2024: 108.57, 2025: 113.14 },
                smgv_diario: { 2018: 88.36, 2019: 102.68, 2020: 123.22, 2021: 141.70, 2022: 172.87, 2023: 207.44, 2024: 248.93 },
                inpc: { "2018-12": 101.355, "2019-12": 104.236, "2020-12": 107.608, "2021-12": 115.499, "2022-12": 124.507, "2023-12": 130.036, "2024-01": 131.396, "2024-02": 131.500, "2024-03": 131.650, "2024-04": 131.800, "2024-05": 132.000, "2024-06": 132.660, "2024-07": 133.323 }
            },
            tasasPagoM40: { 2022: 0.10075, 2023: 0.11166, 2024: 0.12256, 2025: 0.13347, 2026: 0.14438, 2027: 0.15528, 2028: 0.16619, 2029: 0.17709, 2030: 0.18800 },
            tablaCuantiasGlobal: [
                { minRatio: 0,    maxRatio: 1.00, pcb: 80.00, pia: 0.563 }, { minRatio: 1.01, maxRatio: 1.25, pcb: 77.11, pia: 0.814 },
                { minRatio: 1.26, maxRatio: 1.50, pcb: 58.18, pia: 1.178 }, { minRatio: 1.51, maxRatio: 1.75, pcb: 49.23, pia: 1.430 },
                { minRatio: 1.76, maxRatio: 2.00, pcb: 42.67, pia: 1.615 }, { minRatio: 2.01, maxRatio: 2.25, pcb: 37.65, pia: 1.756 },
                { minRatio: 2.26, maxRatio: 2.50, pcb: 33.68, pia: 1.868 }, { minRatio: 2.51, maxRatio: 2.75, pcb: 30.48, pia: 1.958 },
                { minRatio: 2.76, maxRatio: 3.00, pcb: 27.83, pia: 2.033 }, { minRatio: 3.01, maxRatio: 3.25, pcb: 25.60, pia: 2.096 },
                { minRatio: 3.26, maxRatio: 3.50, pcb: 23.70, pia: 2.149 }, { minRatio: 3.51, maxRatio: 3.75, pcb: 22.07, pia: 2.195 },
                { minRatio: 3.76, maxRatio: 4.00, pcb: 20.65, pia: 2.235 }, { minRatio: 4.01, maxRatio: 4.25, pcb: 19.39, pia: 2.271 },
                { minRatio: 4.26, maxRatio: 4.50, pcb: 18.29, pia: 2.302 }, { minRatio: 4.51, maxRatio: 4.75, pcb: 17.30, pia: 2.330 },
                { minRatio: 4.76, maxRatio: 5.00, pcb: 16.41, pia: 2.355 }, { minRatio: 5.01, maxRatio: 5.25, pcb: 15.61, pia: 2.377 },
                { minRatio: 5.26, maxRatio: 5.50, pcb: 14.88, pia: 2.398 }, { minRatio: 5.51, maxRatio: 5.75, pcb: 14.22, pia: 2.416 },
                { minRatio: 5.76, maxRatio: 6.00, pcb: 13.62, pia: 2.433 }, { minRatio: 6.01, maxRatio: Infinity, pcb: 13.00, pia: 2.450 }
            ]
        };

        // --- UTILITY & HELPER FUNCTIONS ---
        function formatNumber(num, decimals = 2) {
            if (typeof num !== 'number' || isNaN(num)) return (0).toFixed(decimals);
            return num.toLocaleString('es-MX', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        }
        function formatDateDDMMYYYY(date) {
            if (!date || !(date instanceof Date)) return '';
            const day = String(date.getUTCDate()).padStart(2, '0');
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const year = date.getUTCFullYear();
            return `${day}/${month}/${year}`;
        }
        function getNumeroInfo(id) { return parseFloat(document.getElementById(id).value.replace(/,/g, '')) || 0; }
        function getDiasEnMes(a, m) { return new Date(a, m, 0).getDate(); }
        
        // --- SESSION MANAGEMENT ---
        function startSessionTimer() {
            clearTimeout(AppState.session.timeout);
            clearInterval(AppState.session.interval);
            AppState.session.endTime = Date.now() + AppState.session.duration;
            AppState.session.timeout = setTimeout(() => logout(), AppState.session.duration);
            AppState.session.interval = setInterval(updateCountdown, 1000);
            showElement('sessionTimerContainer');
            updateCountdown();
        }
        function updateCountdown() {
            const remainingTime = AppState.session.endTime - Date.now();
            if (remainingTime <= 0) {
                logout();
                return;
            }
            const minutes = Math.floor((remainingTime / 1000) / 60);
            const seconds = Math.floor((remainingTime / 1000) % 60);
            const countdownEl = document.getElementById('sessionCountdown');
            const timerContainer = document.getElementById('sessionTimerContainer');
            countdownEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            timerContainer.style.color = (remainingTime < 2 * 60 * 1000) ? 'var(--danger-color)' : 'var(--text-dark)';
        }
        function logout(message = "Tu sesión ha expirado. Por favor, ingresa de nuevo.") {
            clearTimeout(AppState.session.timeout);
            clearInterval(AppState.session.interval);
            hideElement('appContainer');
            hideElement('sessionTimerContainer');
            showElement('loginContainer');
            document.getElementById('login_password').value = '';
            document.getElementById('login_asesor').value = '';
            showCustomAlert(message, "Sesión Finalizada");
        }
        
        // --- UI MANAGEMENT ---
        function showElement(id, displayType = 'block') {
            const el = document.getElementById(id);
            if (!el) return;
            if (id.includes('Modal') || id.includes('loginContainer')) {
                el.classList.add('active');
            } else {
                el.style.display = displayType;
            }
        }
        function hideElement(id) {
             const el = document.getElementById(id);
             if (!el) return;
            if (id.includes('Modal') || id.includes('loginContainer')) {
                el.classList.remove('active');
            } else {
                el.style.display = 'none';
            }
        }
        function showCustomAlert(message, title = "Atención") {
            document.getElementById('customAlertTitle').textContent = title;
            document.getElementById('customAlertMessage').textContent = message;
            document.getElementById('passwordPromptContainer').style.display = 'none';
            
            const confirmBtn = document.getElementById('customAlertButton');
            const cancelBtn = document.getElementById('customAlertCancelButton');
            
            confirmBtn.textContent = 'Aceptar';
            confirmBtn.className = 'btn btn-blue';
            confirmBtn.onclick = closeCustomAlert;
            cancelBtn.style.display = 'none';

            showElement('customAlertModal');
        }
        function closeCustomAlert() {
            hideElement('customAlertModal');
            // Reset buttons to default state after closing
            const confirmBtn = document.getElementById('customAlertButton');
            const cancelBtn = document.getElementById('customAlertCancelButton');
            confirmBtn.textContent = 'Aceptar';
            confirmBtn.className = 'btn btn-blue';
            confirmBtn.onclick = closeCustomAlert;
            cancelBtn.style.display = 'none';
            document.getElementById('passwordPromptContainer').style.display = 'none';
        }
        function acceptAgreement() {
            hideElement('confidentialityModal');
            showElement('loginContainer');
            document.getElementById('login_asesor').focus();
        }
        function showSection(sectionId) {
            ['mainMenuSection', 'calculatorSection', 'contractSection', 'crmSection', 'adminSection'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            const sectionToShow = document.getElementById(sectionId);
            if (sectionToShow) {
                sectionToShow.style.display = 'block';
                if (sectionId === 'adminSection') {
                    window.loadAdminPanelData();
                }
            }
        }

        // --- LOGIN & GEOLOCATION ---
        function getAdviserLocation(callback) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        AppState.adviserLocation = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude,
                            error: null
                        };
                        console.log("Location obtained:", AppState.adviserLocation);
                        callback(true);
                    },
                    (error) => {
                        let errorMessage = "Ocurrió un error al obtener la ubicación.";
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "Permiso de ubicación denegado. Es necesario para continuar.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "La información de ubicación no está disponible.";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "La solicitud de ubicación ha caducado.";
                                break;
                        }
                        AppState.adviserLocation = { lat: null, lon: null, error: errorMessage };
                        showCustomAlert(errorMessage, "Ubicación Requerida");
                        callback(false);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                const errorMessage = "La geolocalización no es soportada por este navegador.";
                AppState.adviserLocation = { lat: null, lon: null, error: errorMessage };
                showCustomAlert(errorMessage, "Error de Navegador");
                callback(false);
            }
        }
        
        async function handleLogin() {
            const loginButton = document.getElementById('loginButton');
            loginButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i>Verificando...`;
            loginButton.disabled = true;

            getAdviserLocation(async (isLocationGranted) => {
                if (!isLocationGranted) {
                    loginButton.innerHTML = `<i class="fas fa-sign-in-alt"></i> Ingresar`;
                    loginButton.disabled = false;
                    return;
                }

                const asesorInput = document.getElementById('login_asesor');
                const passwordInput = document.getElementById('login_password');
                const password = passwordInput.value.trim();
                const username = asesorInput.value.trim().toUpperCase();
                
                const validUser = await window.getUserByUsername(username);

                if (validUser && password === validUser.pass) {
                    if (validUser.status !== 'active') {
                        showCustomAlert("Tu acceso ha sido desactivado. Contacta al administrador.", "Acceso Denegado");
                        loginButton.innerHTML = `<i class="fas fa-sign-in-alt"></i> Ingresar`;
                        loginButton.disabled = false;
                        return;
                    }

                    AppState.nombreAsesorGlobal = validUser.user;
                    AppState.userRole = validUser.role;
                    AppState.isSpecialUser = AppState.nombreAsesorGlobal === 'ROBERTO ORTIZ';
                    AppState.session.pdfDownloadCount = 0;
                    AppState.pdfGenerated = false;
                    window.logLoginEvent(AppState.nombreAsesorGlobal);
                    hideElement('login_errorMessage');
                    hideElement('loginContainer');
                    showElement('appContainer');
                    document.getElementById('asesorNameDisplay').textContent = `Bienvenido, ${AppState.nombreAsesorGlobal}`;
                    if (validUser.role === 'admin') {
                        showSection('mainMenuSection');
                        showElement('adminMenuCard', 'block');
                    } else { 
                        showSection('calculatorSection');
                        hideElement('adminMenuCard');
                    }
                    startSessionTimer();
                } else {
                    const loginErrorTextEl = document.querySelector('#login_errorMessage p');
                    if (loginErrorTextEl) {
                        if (!validUser && username.length > 0) {
                            loginErrorTextEl.textContent = "Usuario no encontrado.";
                        } else {
                            loginErrorTextEl.textContent = "Usuario o contraseña incorrectos.";
                        }
                    }
                    showElement('login_errorMessage');
                }
                loginButton.innerHTML = `<i class="fas fa-sign-in-alt"></i> Ingresar`;
                loginButton.disabled = false;
            });
        }

        function initializeMainAppDisplay() {
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            const currentYear = new Date().getFullYear();
            for (let y = Math.max(...Object.keys(Constants.economicData.umas).map(Number)) + 1; y <= currentYear + 10; y++) {
                if (!Constants.economicData.umas[y]) Constants.economicData.umas[y] = parseFloat((Constants.economicData.umas[y - 1] * 1.045).toFixed(2));
            }
            for (let y = Math.max(...Object.keys(Constants.economicData.smgv_diario).map(Number)) + 1; y <= currentYear + 10; y++) {
                 if (!Constants.economicData.smgv_diario[y]) Constants.economicData.smgv_diario[y] = parseFloat((Constants.economicData.smgv_diario[y - 1] * 1.10).toFixed(2));
            }
            populateUmaTable();
        }

        // --- ECONOMIC DATA & DATE FUNCTIONS ---
        function getUMA(y, m = new Date().getMonth() + 1) { 
            let useYear = parseInt(y);
            if (m === 1 && Constants.economicData.umas[useYear - 1]) {
                useYear = parseInt(y) - 1;
            }
            return Constants.economicData.umas[useYear] || Constants.economicData.umas[Object.keys(Constants.economicData.umas).sort((a,b) => b-a)[0]] || 0;
        }
        function getINPC(year, month) {
            const key = `${year}-${String(month).padStart(2, '0')}`;
            if (Constants.economicData.inpc[key]) {
                return Constants.economicData.inpc[key];
            }
            const lastKnownKey = Object.keys(Constants.economicData.inpc).sort().pop();
            const [lastYear, lastMonth] = lastKnownKey.split('-').map(Number);
            const lastValue = Constants.economicData.inpc[lastKnownKey];
            const monthsDiff = (year - lastYear) * 12 + (month - lastMonth);
            if (monthsDiff > 0) {
                return lastValue * Math.pow(1 + (Constants.INPC_GROWTH_ESTIMATE / 12), monthsDiff);
            }
            return null;
        }
        function extraerFechaNacimientoCURP(curp) {
            if (typeof curp !== 'string' || curp.length !== 18) return null;
            const yearStr = curp.substring(4, 6);
            const monthStr = curp.substring(6, 8);
            const dayStr = curp.substring(8, 10);
            let year = parseInt(yearStr);
            const month = parseInt(monthStr);
            const day = parseInt(dayStr);
            if (isNaN(year) || isNaN(month) || isNaN(day) || month < 1 || month > 12 || day < 1 || day > 31) return null;
            
            const centuryIndicator = curp.charAt(16);
            let century = 1900;
            const currentYearLastTwoDigits = new Date().getFullYear() % 100;
            
            if (!isNaN(parseInt(centuryIndicator))) {
                century = (year > currentYearLastTwoDigits + 10) ? 1900 : 2000;
            } else if (centuryIndicator >= 'A' && centuryIndicator <= 'Z') {
                century = 2000;
            }
            year = century + year; 
            
            try {
                const date = new Date(Date.UTC(year, month - 1, day));
                if (date.getUTCFullYear() === year && date.getUTCMonth() === (month - 1) && date.getUTCDate() === day) {
                    return date;
                }
                return null;
            } catch (e) {
                return null;
            }
        }
        function calcularEdadExacta(startDate, endDate) {
            if (!startDate || !(startDate instanceof Date) || isNaN(startDate) || !endDate || !(endDate instanceof Date) || isNaN(endDate)) {
                return { anos: 0, meses: 0, dias: 0 };
            }
            let years = endDate.getUTCFullYear() - startDate.getUTCFullYear();
            let months = endDate.getUTCMonth() - startDate.getUTCMonth();
            let days = endDate.getUTCDate() - startDate.getUTCDate();
            if (days < 0) {
                months--;
                days += new Date(endDate.getUTCFullYear(), endDate.getUTCMonth(), 0).getUTCDate();
            }
            if (months < 0) {
                years--;
                months += 12;
            }
            return { anos: years, meses: months, dias: days };
        }
        function getTasaM40Porcentaje(year) {
            if (year <= 2022) return Constants.tasasPagoM40[2022];
            if (year >= 2030) return Constants.tasasPagoM40[2030];
            return Constants.tasasPagoM40[year] || Constants.tasasPagoM40[Object.keys(Constants.tasasPagoM40).sort((x, y) => y - x)[0]];
        }
        function calcularFechaFinDesdeMeses(fechaInicioStr, numMeses) {
            if (!fechaInicioStr || !numMeses || numMeses <= 0) return null;
            const [anioInicio, mesInicio, diaInicio] = fechaInicioStr.split('-').map(Number);
            if (isNaN(anioInicio) || isNaN(mesInicio)) return null;

            // Start from the first of the month for calculation consistency
            const fechaInicioObj = new Date(Date.UTC(anioInicio, mesInicio - 1, 1));
            // Add the number of months, and get the last day of that resulting month
            const fechaFinObj = new Date(Date.UTC(fechaInicioObj.getUTCFullYear(), fechaInicioObj.getUTCMonth() + Number(numMeses), 0));

            return fechaFinObj; // Return the date object
        }
        
        // --- CORE PENSION CALCULATION LOGIC ---
        function _calcularPensionDetallado(sbcPromedio, semanasCotizadas, edad) {
            if (sbcPromedio <= 0 || semanasCotizadas < 500 || edad < 60) {
                return { PENSION_MENSUAL_ESTIMADA: 0, AGUINALDO_ESTIMADO: 0 };
            }
            
            const ratioSBCvsSMGV = sbcPromedio / Constants.SMGV_DF_Global;
            let pcb = 0, pia = 0;
            
            const cuantias = Constants.tablaCuantiasGlobal.find(rg => ratioSBCvsSMGV >= rg.minRatio && ratioSBCvsSMGV <= rg.maxRatio);
            if (cuantias) {
                pcb = cuantias.pcb;
                pia = cuantias.pia;
            } else {
                const lastCuantia = Constants.tablaCuantiasGlobal[Constants.tablaCuantiasGlobal.length - 1];
                pcb = lastCuantia.pcb;
                pia = lastCuantia.pia;
            }

            const cuantiaBasicaAnual = (sbcPromedio * 365) * (pcb / 100);
            const cuantiaBasicaFinal = cuantiaBasicaAnual * Constants.FACTOR_FOX_Global;
            const semanasExcedentes = semanasCotizadas > 500 ? Math.floor((semanasCotizadas - 500) / 52) : 0;
            const incrementoAnualCuantia = (sbcPromedio * 365) * (pia / 100) * semanasExcedentes;
            const incrementoAnualFinal = incrementoAnualCuantia * Constants.FACTOR_FOX_Global;
            const pensionVejezAnualBase = cuantiaBasicaFinal + incrementoAnualFinal;
            
            let porcentajeEdad = 0;
            if (edad >= 65) porcentajeEdad = 1.00;
            else if (edad === 64) porcentajeEdad = 0.95;
            else if (edad === 63) porcentajeEdad = 0.90;
            else if (edad === 62) porcentajeEdad = 0.85;
            else if (edad === 61) porcentajeEdad = 0.80;
            else if (edad === 60) porcentajeEdad = 0.75;

            const pensionVejezAnualAplicadaEdad = pensionVejezAnualBase * porcentajeEdad;
            const pensionAnualConAsignaciones = pensionVejezAnualAplicadaEdad * 1.15;
            const pensionMensualEstimada = pensionAnualConAsignaciones / 12;
            const aguinaldoEstimado = pensionVejezAnualAplicadaEdad / 12;

            return { PENSION_MENSUAL_ESTIMADA: pensionMensualEstimada, AGUINALDO_ESTIMADO: aguinaldoEstimado };
        }
        
        // --- EVENT HANDLERS & DYNAMIC UI ---
        function addEmploymentCard(patron = '', regPatronal = '', movimientos = '') {
            AppState.employmentCardIdCounter++;
            const container = document.getElementById('employmentCardsContainer');
            const cardId = AppState.employmentCardIdCounter;
            const cardHTML = `
                <div class="employment-card" id="empCard_${cardId}">
                    <button onclick="removeEmploymentCard(this)" class="btn-danger-icon absolute top-4 right-4" title="Eliminar Empleo"><i class="fas fa-times"></i></button>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="input-group">
                            <label for="emp_name_${cardId}">Nombre o Razón Social del Patrón:</label>
                            <input type="text" id="emp_name_${cardId}" class="emp_name w-full" placeholder="Nombre del empleador" value="${patron}">
                        </div>
                        <div class="input-group">
                            <label for="emp_reg_${cardId}">Registro Patronal:</label>
                            <input type="text" id="emp_reg_${cardId}" class="emp_reg w-full" placeholder="Ej: Y6812345108" value="${regPatronal}">
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="emp_history_${cardId}">Historial de Movimientos para este Empleo:</label>
                        <textarea id="emp_history_${cardId}" class="emp_history_text w-full font-mono text-sm" rows="6" placeholder="Pegue aquí los movimientos (REINGRESO, MODIFICACION, BAJA) para este empleador.">${movimientos}</textarea>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', cardHTML);
            return `emp_history_${cardId}`;
        }
        function removeEmploymentCard(button) {
            button.closest('.employment-card').remove();
        }
        function updateM40StartDateClarification() {
            const m40Input = document.getElementById('info_m40_p1_inicio');
            const clarificationEl = document.getElementById('m40_start_date_clarification');
            
            if (m40Input.value && m40Input.valueAsDate) {
                const [year, month, day] = m40Input.value.split('-').map(Number);
                const dateObj = new Date(Date.UTC(year, month - 1, day));
                
                clarificationEl.innerHTML = `<i class="fas fa-info-circle mr-1"></i> Fecha seleccionada: <strong>${dateObj.toLocaleDateString('es-MX', { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'UTC' })}</strong>`;
            } else {
                clarificationEl.textContent = '';
            }
        }
        function handleM40StartDateChange() {
            actualizarSBCMaximoM40();
            actualizarFechaFinM40Display();
            updateM40StartDateClarification();
        }
        function actualizarSBCMaximoM40() {
            const inicioP1Str = document.getElementById('info_m40_p1_inicio').value;
            const sbcM40Input = document.getElementById('info_m40_p1_sbc');
            if (inicioP1Str) {
                const [anioInicioP1, mesInicioP1] = inicioP1Str.split('-').map(Number);
                const umaP1 = getUMA(anioInicioP1, mesInicioP1);
                const sbcMaxP1 = umaP1 * 25;
                sbcM40Input.value = sbcMaxP1.toFixed(2);
            } else {
                sbcM40Input.value = '';
            }
        }
        function actualizarFechaFinM40Display() {
            const fechaInicioStr = document.getElementById('info_m40_p1_inicio').value;
            const numMesesStr = document.getElementById('info_m40_p1_meses').value;
            const curp = document.getElementById('info_curpCliente').value;
            const bajaDisplayEl = document.getElementById('info_m40_baja_display');

            if (!fechaInicioStr || !numMesesStr || numMesesStr === '0' || curp.length !== 18) {
                bajaDisplayEl.innerHTML = '-- Ingrese fechas, meses y CURP para ver la edad de baja --';
                return;
            }
            
            const fechaNacimiento = extraerFechaNacimientoCURP(curp);
            if (!fechaNacimiento) {
                bajaDisplayEl.innerHTML = '<span class="text-red-600">CURP inválido, no se puede calcular la edad.</span>';
                return;
            }

            const numMeses = parseInt(numMesesStr);
            if (numMeses > 0) {
                const fechaFinObj = calcularFechaFinDesdeMeses(fechaInicioStr, numMeses);
                if (fechaFinObj) {
                    const edadFinM40 = calcularEdadExacta(fechaNacimiento, fechaFinObj);
                    
                    const fechaFinDisplay = formatDateDDMMYYYY(fechaFinObj);

                    bajaDisplayEl.innerHTML = `
                        <i class="fas fa-calendar-alt mr-2"></i>Fecha de Baja M40: <strong class="text-blue-900">${fechaFinDisplay}</strong><br>
                        <i class="fas fa-birthday-cake mr-2 mt-1"></i>Edad al finalizar: <strong class="text-blue-900">${edadFinM40.anos} años, ${edadFinM40.meses} meses y ${edadFinM40.dias} días</strong>
                    `;
                }
            }
        }
        function handleMesesDepositoChange(input) {
            let value = parseInt(input.value);
            const lastValidValue = input.getAttribute('data-last-valid');

            if (isNaN(value) || value < 6 || value > 12) {
                input.value = lastValidValue;
                showCustomAlert("El valor debe ser un número entre 6 y 12.", "Valor Inválido");
                return;
            }
            
            input.setAttribute('data-last-valid', value);
            recalculateAllScenarios();
        }
        
        // --- MAIN CALCULATION WORKFLOW ---
        function analizarYCalcularSBC() {
            const { nombre, curp, telefono, semanasManuales } = {
                nombre: document.getElementById('info_nombreCompleto').value.trim(),
                curp: document.getElementById('info_curpCliente').value.trim(),
                telefono: document.getElementById('info_telefonoCliente').value.trim(),
                semanasManuales: getNumeroInfo('info_semanasTotalesManual')
            };
            
            if (!nombre || !/^[A-ZÑ&]{4}\d{6}[HM][A-Z]{5}[A-Z\d]\d$/.test(curp) || semanasManuales <= 0) {
                 showCustomAlert("Por favor, complete los datos del cliente (Nombre, CURP válido, Semanas > 0).", "Error de Validación");
                 return;
            }
            if (!/^\d{10}$/.test(telefono)) {
                showCustomAlert("Análisis casi completo. Por favor, ingrese el número de teléfono de 10 dígitos del cliente para continuar.", "Dato Faltante");
                return;
            }
            
            const cards = document.querySelectorAll('.employment-card');
            if (cards.length === 0) {
                showCustomAlert("Por favor, agregue al menos un bloque de empleo.", "Datos Faltantes");
                return;
            }

            let allPeriods = [];
            let allMovementsForVigencia = [];
            let isValid = true;

            // This logic generates periods for each employer based on their movements.
            cards.forEach((card, index) => {
                if (!isValid) return;

                const nombrePatron = card.querySelector('.emp_name').value.trim();
                const regPatronal = card.querySelector('.emp_reg').value.trim();
                const texto = card.querySelector('.emp_history_text').value.trim();

                if (!nombrePatron || !regPatronal || !texto) {
                    showCustomAlert(`Por favor, complete todos los campos para el Empleo #${index + 1}.`, "Datos Faltantes");
                    isValid = false;
                    return;
                }

                const movementsOnCard = [];
                const lineas = texto.split('\n').filter(line => line.trim() !== '');
                const regex = /(.+?)\s+(\d{2}\/\d{2}\/\d{4})\s*(?:\$\s*([\d,]+\.?\d*))?/;
                
                lineas.forEach(linea => {
                    const match = linea.trim().match(regex);
                    if (match) {
                        const tipo = match[1].trim().toUpperCase();
                        const [dia, mes, anio] = match[2].split('/');
                        const fecha = new Date(Date.UTC(anio, mes - 1, dia));
                        const sbc = match[3] ? parseFloat(match[3].replace(/,/g, '')) : null;
                        movementsOnCard.push({ tipo, fecha, sbc, nombrePatron, regPatronal });
                    } else {
                        showCustomAlert(`En Empleo #${index + 1}, la línea "${linea}" no tiene un formato válido.`, "Error de Formato");
                        isValid = false;
                    }
                });
                if (!isValid) return;

                allMovementsForVigencia.push(...movementsOnCard);
                
                movementsOnCard.sort((a, b) => {
                    if (a.fecha.getTime() !== b.fecha.getTime()) {
                        return a.fecha - b.fecha;
                    }
                    if (a.tipo.includes('BAJA')) return 1;
                    if (b.tipo.includes('BAJA')) return -1;
                    return 0;
                });

                for (let i = 0; i < movementsOnCard.length; i++) {
                    const mov = movementsOnCard[i];
                    if (mov.tipo.includes('BAJA') || mov.sbc === null || mov.sbc <= 0) {
                        continue;
                    }

                    const fechaInicio = mov.fecha;
                    let fechaFin = null;

                    for (let j = i + 1; j < movementsOnCard.length; j++) {
                        const nextMov = movementsOnCard[j];
                        if (nextMov.tipo.includes('BAJA')) {
                            fechaFin = nextMov.fecha;
                            i = j; 
                            break;
                        } else if (nextMov.sbc !== null && nextMov.sbc > 0) {
                            fechaFin = new Date(nextMov.fecha);
                            fechaFin.setUTCDate(fechaFin.getUTCDate() - 1);
                            break;
                        }
                    }

                    if (fechaFin === null) {
                        const hoy = new Date();
                        fechaFin = new Date(Date.UTC(hoy.getUTCFullYear(), hoy.getUTCMonth() + 1, 0));
                    }
                    
                    if (fechaFin >= fechaInicio) {
                         allPeriods.push({
                             fechaInicio: fechaInicio,
                             fechaFin: fechaFin,
                             sbc: mov.sbc,
                             dias: Math.round((fechaFin - fechaInicio) / (1000 * 60 * 60 * 24)) + 1,
                             nombrePatron: nombrePatron,
                             regPatronal: regPatronal
                         });
                    }
                }
            });

            if (!isValid) return;
            
            AppState.fullHistoryPeriods = allPeriods;
            AppState.timelinePeriods = processOverlappingPeriods(allPeriods);
            
            let periodosParaSBC = [...AppState.timelinePeriods];
            periodosParaSBC.sort((a, b) => b.fechaFin - a.fechaFin);

            let diasAcumuladosSBC = 0;
            let sbcPonderadoTotal = 0;
            const periodosParaTabla = [];
            
            for (const p of periodosParaSBC) {
                if (diasAcumuladosSBC >= Constants.DIAS_PROMEDIO_PENSION) break;
                const diasDelPeriodo = Math.round((p.fechaFin - p.fechaInicio) / (1000 * 60 * 60 * 24)) + 1;
                const diasAUsar = Math.min(diasDelPeriodo, Constants.DIAS_PROMEDIO_PENSION - diasAcumuladosSBC);
                
                sbcPonderadoTotal += p.sbc * diasAUsar; 
                diasAcumuladosSBC += diasAUsar;
                
                periodosParaTabla.push({
                    ...p,
                    dias: diasAUsar,
                    ponderado: p.sbc * diasAUsar,
                });
            }
            
            AppState.sbcCalculationPeriods = periodosParaTabla;

            const sbcPromedioFinal = diasAcumuladosSBC > 0 ? sbcPonderadoTotal / diasAcumuladosSBC : 0;
            
            const fechaNacimiento = extraerFechaNacimientoCURP(curp);
            const edadObj = calcularEdadExacta(fechaNacimiento, new Date());
            const edadActual = edadObj.anos;
            let edadParaCalculoBase = edadActual;

            const ageWarningEl = document.getElementById('ageAdjustmentWarning');
            if (edadActual < 60) {
                edadParaCalculoBase = 60;
                ageWarningEl.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>La edad del cliente es ${edadActual} años. Para el cálculo de la pensión base, se ha ajustado la edad a 60 años (mínima de retiro).`;
                ageWarningEl.style.display = 'block';
            } else {
                ageWarningEl.style.display = 'none';
            }

            let ultimaFechaBaja = null;
            // CORRECCIÓN: Se unifica la lógica para obtener la última fecha de baja.
            // Ahora se utiliza la fecha final del último periodo laboral procesado,
            // que es más confiable que buscar un movimiento de 'BAJA' explícito.
            // Esto asegura consistencia con el cálculo de vigencia y soluciona el
            // problema del pre-llenado incorrecto de la fecha de M40.
            if (AppState.timelinePeriods && AppState.timelinePeriods.length > 0) {
                const sortedPeriods = [...AppState.timelinePeriods].sort((a, b) => b.fechaFin - a.fechaFin);
                if (sortedPeriods.length > 0) {
                    ultimaFechaBaja = sortedPeriods[0].fechaFin;
                }
            }
            
            // Fallback por si la lógica de periodos falla pero existen movimientos de baja
            if (!ultimaFechaBaja) {
                const movimientosDeBaja = allMovementsForVigencia.filter(m => m.tipo.includes('BAJA'));
                if (movimientosDeBaja.length > 0) {
                    movimientosDeBaja.sort((a, b) => b.fecha - a.fecha);
                    ultimaFechaBaja = movimientosDeBaja[0].fecha;
                }
            }

            AppState.datosClienteInfo = { 
                nombre, curp, telefono, 
                sbcPromedioBase: sbcPromedioFinal, 
                semanasCotizadasBase: semanasManuales, 
                edadBase: edadActual, 
                edadObjCompleta: edadObj,
                ultimaFechaBaja: ultimaFechaBaja
            };

            document.getElementById('res_sbcPromedio').textContent = '$' + formatNumber(sbcPromedioFinal);
            document.getElementById('res_edadActual').textContent = `${edadActual} años`;
            document.getElementById('res_telefonoCliente').textContent = telefono;
            
            renderSbcAnalysisTable(); 
            renderModalitySummary();
            drawScenarioTimeline('timeline-svg', 'timeline-legend', AppState.timelinePeriods);
            checkVigencia();

            document.getElementById('sbcAnalysisTableFooter').innerHTML = `
                <tr>
                    <td class="p-2" colspan="3">Total Días Usados para Cálculo:</td>
                    <td class="p-2 text-right">${formatNumber(diasAcumuladosSBC, 0)}</td>
                    <td class="p-2" colspan="2"></td>
                </tr>`;

            const daysWarningEl = document.getElementById('sbcDaysWarning');
            if (diasAcumuladosSBC < Constants.DIAS_PROMEDIO_PENSION) {
                daysWarningEl.innerHTML = `<i class="fas fa-exclamation-triangle mr-2 text-yellow-500"></i>Se han usado <strong>${formatNumber(diasAcumuladosSBC, 0)} de ${Constants.DIAS_PROMEDIO_PENSION}</strong> días para el cálculo. El sistema completará los días faltantes con el último salario registrado para el promedio.`;
                daysWarningEl.className = 'mt-4 p-3 rounded-lg text-sm bg-yellow-50 border border-yellow-200 text-yellow-800';
            } else {
                daysWarningEl.innerHTML = `<i class="fas fa-check-circle mr-2 text-green-500"></i>Se han recopilado los <strong>${Constants.DIAS_PROMEDIO_PENSION}</strong> días necesarios para el cálculo.`;
                daysWarningEl.className = 'mt-4 p-3 rounded-lg text-sm bg-green-50 border border-green-200 text-green-800';
            }
            daysWarningEl.style.display = 'block';
            
            // Auto-fill M40 strategy based on last known date
            const m40Input = document.getElementById('info_m40_p1_inicio');
            if (ultimaFechaBaja) {
                // CORRECCIÓN: Se asegura que la fecha de inicio de M40 se pre-llene automáticamente
                // con el día EXACTAMENTE posterior a la última fecha de baja del cliente,
                // para evitar errores manuales y agilizar el proceso.
                // Se utiliza UTC para prevenir inconsistencias por zona horaria.
                const fechaSiguienteALaBaja = new Date(Date.UTC(
                    ultimaFechaBaja.getUTCFullYear(),
                    ultimaFechaBaja.getUTCMonth(),
                    ultimaFechaBaja.getUTCDate() + 1 // Añade un día a la fecha de baja
                ));

                const year = fechaSiguienteALaBaja.getUTCFullYear();
                const month = String(fechaSiguienteALaBaja.getUTCMonth() + 1).padStart(2, '0');
                const day = String(fechaSiguienteALaBaja.getUTCDate()).padStart(2, '0');
                
                // El formato YYYY-MM-DD es el estándar requerido por el input type="date"
                const fechaFormateada = `${year}-${month}-${day}`;
            
                m40Input.value = fechaFormateada;
                m40Input.min = fechaFormateada; // También se establece como fecha mínima
            
                // Prefill months logic
                let targetAge = Math.max(60, edadObj.anos);
                if (edadObj.meses > 6) { targetAge++; }
                else if (edadObj.anos < 60) { targetAge = 60; }
            
                const targetRetirementDate = new Date(fechaNacimiento);
                targetRetirementDate.setUTCFullYear(fechaNacimiento.getUTCFullYear() + targetAge);
                targetRetirementDate.setUTCMonth(targetRetirementDate.getUTCMonth() + 7);
            
                // CORRECCIÓN: Se utiliza la variable correcta 'fechaSiguienteALaBaja' en lugar de 'm40MinDate' que no estaba definida.
                let monthsToInvest = (targetRetirementDate.getUTCFullYear() - fechaSiguienteALaBaja.getUTCFullYear()) * 12;
                monthsToInvest -= fechaSiguienteALaBaja.getUTCMonth();
                monthsToInvest += targetRetirementDate.getUTCMonth();
                
                document.getElementById('info_m40_p1_meses').value = Math.max(1, Math.min(60, Math.round(monthsToInvest)));
            
                actualizarSBCMaximoM40();
                actualizarFechaFinM40Display();
                updateM40StartDateClarification();
            } else {
                m40Input.value = ''; // Limpiar si no hay fecha de baja
                m40Input.min = '';
            }

            showElement('sbcAnalysisResultsContainer');
            showElement('timelineSection');

            const pensionData = _calcularPensionDetallado(sbcPromedioFinal, semanasManuales, edadParaCalculoBase);
            AppState.pensionBaseResultadosInfo = pensionData;

            document.getElementById('res_base_pensionMensual').textContent = '$' + formatNumber(pensionData.PENSION_MENSUAL_ESTIMADA);
            document.getElementById('res_base_aguinaldo').textContent = '$' + formatNumber(pensionData.AGUINALDO_ESTIMADO);
            document.getElementById('res_base_ingresoAnual').textContent = '$' + formatNumber((pensionData.PENSION_MENSUAL_ESTIMADA * 12) + pensionData.AGUINALDO_ESTIMADO);
            
            showElement('basePensionResultsContainer');
            // Se elimina la alerta bloqueante para que los resultados sean visibles inmediatamente.
            // showCustomAlert("Análisis completado. El SBC Promedio y la pensión base han sido calculados.", "Éxito");
        }

        // Renders the SBC analysis table based on checkbox states
        function renderSbcAnalysisTable() {
            const tableBody = document.getElementById('sbcAnalysisTableBody');
            tableBody.innerHTML = '';
            const showFullHistory = document.getElementById('showFullHistoryCheckbox').checked;
            const showBreakdown = document.getElementById('showSbcBreakdownCheckbox').checked;

            const sourceData = showFullHistory ? AppState.fullHistoryPeriods.slice().sort((a,b) => b.fechaFin - a.fechaFin) : AppState.sbcCalculationPeriods;

            if (!showBreakdown) {
                sourceData.forEach(p => {
                    const row = `<tr>
                        <td class="p-2 border-b">${p.regPatronal}</td>
                        <td class="p-2 border-b">${formatDateDDMMYYYY(p.fechaInicio)}</td>
                        <td class="p-2 border-b">${formatDateDDMMYYYY(p.fechaFin)}</td>
                        <td class="p-2 border-b text-right">${formatNumber(p.dias, 0)}</td>
                        <td class="p-2 border-b text-right">$${formatNumber(p.sbc)}</td>
                        <td class="p-2 border-b text-right">$${formatNumber(p.ponderado || 0)}</td>
                    </tr>`;
                    tableBody.innerHTML += row;
                });
            } else {
                const groupedByPatron = sourceData.reduce((acc, p) => {
                    const key = `${p.regPatronal} - ${p.nombrePatron}`;
                    if (!acc[key]) {
                        acc[key] = [];
                    }
                    acc[key].push(p);
                    return acc;
                }, {});

                for (const patronKey in groupedByPatron) {
                    const group = groupedByPatron[patronKey];
                    let subtotalDias = 0;
                    
                    tableBody.innerHTML += `<tr class="bg-blue-100 font-bold"><td colspan="6" class="p-2">${patronKey}</td></tr>`;
                    
                    group.forEach(p => {
                        subtotalDias += p.dias;
                        const row = `<tr>
                            <td class="p-2 border-b">${p.regPatronal}</td>
                            <td class="p-2 border-b">${formatDateDDMMYYYY(p.fechaInicio)}</td>
                            <td class="p-2 border-b">${formatDateDDMMYYYY(p.fechaFin)}</td>
                            <td class="p-2 border-b text-right">${formatNumber(p.dias, 0)}</td>
                            <td class="p-2 border-b text-right">$${formatNumber(p.sbc)}</td>
                            <td class="p-2 border-b text-right">$${formatNumber(p.ponderado || 0)}</td>
                        </tr>`;
                        tableBody.innerHTML += row;
                    });

                    tableBody.innerHTML += `<tr class="bg-gray-50 font-semibold">
                        <td colspan="3" class="p-2 text-right">Subtotal Días para ${group[0].nombrePatron}:</td>
                        <td class="p-2 text-right">${formatNumber(subtotalDias, 0)}</td>
                        <td colspan="2" class="p-2"></td>
                    </tr>`;
                }
            }
        }

        // Renders the modality summary table
        function renderModalitySummary() {
            const container = document.getElementById('modalitySummaryContainer');
            container.innerHTML = '';
            const uniquePatrones = [...new Set(AppState.fullHistoryPeriods.map(p => p.regPatronal))];
            
            let mod10Count = 0;
            let mod40Count = 0;
            let others = [];

            uniquePatrones.forEach(reg => {
                if (reg.endsWith('10')) {
                    mod10Count++;
                } else if (reg.endsWith('40')) {
                    mod40Count++;
                } else {
                    others.push(reg);
                }
            });

            let summaryHTML = `
                <h4 class="font-semibold text-gray-700 mt-4 mb-2">Resumen de Modalidades</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-100 p-3 rounded-lg">
                        <p class="text-sm">Periodos en Modalidad 10 (R.O.):</p>
                        <p class="font-bold text-lg">${mod10Count}</p>
                    </div>
                    <div class="bg-gray-100 p-3 rounded-lg">
                        <p class="text-sm">Periodos en Modalidad 40 (C.V.):</p>
                        <p class="font-bold text-lg">${mod40Count}</p>
                    </div>
                </div>
            `;

            if (others.length > 0) {
                summaryHTML += `
                    <div class="mt-4 p-3 rounded-lg text-sm bg-yellow-50 border border-yellow-200 text-yellow-800">
                        <i class="fas fa-exclamation-triangle mr-2"></i><strong>Atención:</strong> Se encontraron registros patronales con terminaciones diferentes a '10' o '40' (${others.join(', ')}). Se recomienda una revisión detallada del historial laboral (SISEC).
                    </div>
                `;
            }
            container.innerHTML = summaryHTML;
        }
        
        async function calcularEscenarioM40Infografia() {
            if (AppState.datosClienteInfo.sbcPromedioBase <= 0) {
                showCustomAlert("Primero debes analizar el historial en el Paso 1.", "Acción Requerida");
                return;
            }

            const inicioP1Str = document.getElementById('info_m40_p1_inicio').value;
            const numMesesP1 = parseInt(document.getElementById('info_m40_p1_meses').value) || 0;
            const sbcM40Ingresado = getNumeroInfo('info_m40_p1_sbc');
            const ultimaFechaBaja = AppState.datosClienteInfo.ultimaFechaBaja;

            if (!inicioP1Str || numMesesP1 <= 0 || sbcM40Ingresado <= 0) {
                showCustomAlert("Define el periodo M40: Fecha de Inicio, Meses y SBC M40 son obligatorios.", "Datos Faltantes");
                return;
            }

            if (ultimaFechaBaja) {
                const [year, month, day] = inicioP1Str.split('-').map(Number);
                const fechaInicioM40 = new Date(Date.UTC(year, month - 1, day));

                const cleanUltimaFechaBaja = new Date(Date.UTC(
                    ultimaFechaBaja.getUTCFullYear(),
                    ultimaFechaBaja.getUTCMonth(),
                    ultimaFechaBaja.getUTCDate()
                ));
                
                if (fechaInicioM40 <= cleanUltimaFechaBaja) {
                    showCustomAlert(`La fecha de inicio de M40 (${formatDateDDMMYYYY(fechaInicioM40)}) debe ser posterior a la última fecha de baja (${formatDateDDMMYYYY(cleanUltimaFechaBaja)}).`, "Fecha Inválida");
                    return;
                }
            }
            
            // Reset visibility flag
            AppState.pdfGenerated = false;
            
            // Clear existing scenarios and add the first two
            document.getElementById('scenariosContainer').innerHTML = '';
            AppState.activeScenarios = 0;
            AppState.scenarioData = {};
            addScenarioCard(1, numMesesP1);
            addScenarioCard(2, 0); 

            // Show sections
            showElement('infoSection4');
            showElement('infoSection3'); 
            showElement('infoSection5'); 
            document.getElementById('addScenarioBtn').disabled = false;

            // Conditional calculation and display
            if (AppState.isSpecialUser) {
                AppState.pdfGenerated = true; // Set to true to show results immediately
                await recalculateAllScenarios();
                showCustomAlert("Proyección calculada. Resultados visibles.", "Éxito");
            } else {
                // For regular users, just prepare the UI but hide results
                await recalculateAllScenarios(); // This will calculate but UI will be hidden due to pdfGenerated=false
                showCustomAlert("Proyección preparada. Genere un PDF para ver los resultados detallados.", "Proyección Lista");
            }
        }

        // --- SCENARIO MANAGEMENT ---
        function addScenarioCard(scenarioNum, meses = 0) {
            const isManualAdd = !scenarioNum;

            if (isManualAdd) {
                if (AppState.activeScenarios >= 4) {
                    showCustomAlert("Se ha alcanzado el límite de 4 escenarios.", "Límite Alcanzado");
                    return;
                }
                
                const userRole = AppState.userRole;
                if (userRole === 'admin' || userRole === 'special') {
                    addScenarioCardInternal();
                } else if (AppState.activeScenarios >= 2) {
                    promptForDirectorPassword(() => {
                        addScenarioCardInternal();
                    });
                } else {
                    addScenarioCardInternal();
                }
                return;
            }
            
            addScenarioCardInternal(scenarioNum, meses);
        }

        function addScenarioCardInternal(scenarioNum, meses = 0) {
            if (!scenarioNum) {
                AppState.activeScenarios++;
                scenarioNum = AppState.activeScenarios;
            } else if (scenarioNum > AppState.activeScenarios) {
                AppState.activeScenarios = scenarioNum;
            }

            const container = document.getElementById('scenariosContainer');
            const isFirstScenario = scenarioNum === 1;

            const cardHTML = `
                <div class="bg-white p-6 rounded-xl shadow border" id="scenario_card_${scenarioNum}">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-blue-800">Escenario ${scenarioNum}</h3>
                        ${!isFirstScenario ? `<button onclick="removeScenarioCard(${scenarioNum})" class="btn-danger-icon !w-8 !h-8"><i class="fas fa-times"></i></button>` : ''}
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="input-group">
                            <label for="scenario_${scenarioNum}_meses">Meses en M40:</label>
                            <input type="number" id="scenario_${scenarioNum}_meses" value="${meses}" oninput="recalculateScenario(${scenarioNum})" class="w-full" ${isFirstScenario ? 'readonly' : ''}>
                        </div>
                        <div class="input-group">
                            <label for="scenario_${scenarioNum}_semanas_ajuste">Ajuste de Semanas:</label>
                            <input type="number" id="scenario_${scenarioNum}_semanas_ajuste" value="0" oninput="recalculateScenario(${scenarioNum})" class="w-full" ${isFirstScenario ? 'readonly' : ''}>
                        </div>
                        <input type="hidden" id="scenario_${scenarioNum}_semanas" value="0">
                    </div>
                    
                    <div id="scenario_${scenarioNum}_results">
                        <div class="bg-gray-50 p-4 rounded-lg space-y-2 text-sm">
                            <h4 class="font-bold text-center mb-2">Resultados del Escenario</h4>
                            <p><strong>Fecha de Inicio M40:</strong> <span id="scenario_${scenarioNum}_fecha_inicio" class="float-right font-semibold">--</span></p>
                            <p><strong>Meses Pagados M40:</strong> <span id="scenario_${scenarioNum}_meses_pagados" class="float-right font-semibold">--</span></p>
                            <p><strong>Fecha de Baja:</strong> <span id="scenario_${scenarioNum}_fecha_baja" class="float-right font-semibold">--</span></p>
                            <p><strong>Edad al Finalizar:</strong> <span id="scenario_${scenarioNum}_edad_final" class="float-right font-semibold">--</span></p>
                            <p><strong>SBC Promedio Final:</strong> <span id="scenario_${scenarioNum}_sbc_final" class="float-right font-semibold">--</span></p>
                            <p><strong>Semanas Finales:</strong> <span id="scenario_${scenarioNum}_semanas_finales" class="float-right font-semibold">--</span></p>
                        </div>

                        <div class="mt-4 space-y-2 text-sm">
                            <p><strong>Pensión Mensual Bruta:</strong> <span id="scenario_${scenarioNum}_pension" class="float-right font-bold text-base">$0.00</span></p>
                            <p><strong>Aguinaldo:</strong> <span id="scenario_${scenarioNum}_aguinaldo" class="float-right font-semibold">$0.00</span></p>
                            <p><strong>Costo Total del Proyecto:</strong> <span id="scenario_${scenarioNum}_costo_total" class="float-right font-bold">$0.00</span></p>
                            <hr class="my-2">
                            <p>Cobertura AFORE: <span id="scenario_${scenarioNum}_cobertura_afore" class="float-right font-semibold">$0.00</span></p>
                            <p>Cobertura 1er Depósito: <span id="scenario_${scenarioNum}_cobertura_deposito" class="float-right font-semibold">$0.00</span></p>
                            <p>Cobertura Extra AFORE: <span id="scenario_${scenarioNum}_cobertura_extra" class="float-right font-semibold">$0.00</span></p>
                            <p>Préstamo Requerido: <span id="scenario_${scenarioNum}_prestamo" class="float-right font-semibold">$0.00</span></p>
                            <hr class="my-2">
                            <p><strong>Resultado Final:</strong> <span id="scenario_${scenarioNum}_resultado_final" class="float-right font-bold">$0.00</span></p>
                            <p class="relative">
                                <strong>Recuperación de Inversión (ROI):</strong>
                                <i class="fas fa-info-circle text-gray-400 ml-1 cursor-pointer" onmouseover="showTooltip('roi_tooltip_${scenarioNum}')" onmouseout="hideTooltip('roi_tooltip_${scenarioNum}')"></i>
                                <span id="scenario_${scenarioNum}_roi" class="float-right font-semibold">N/A</span>
                                <span id="roi_tooltip_${scenarioNum}" class="absolute hidden z-10 w-60 p-2 -mt-20 text-xs leading-tight text-white transform -translate-x-1/2 bg-gray-800 rounded-lg shadow-lg" style="left: 50%;">
                                    ROI (meses) = Costo Total / (Pensión Nueva - Pensión Base)
                                </span>
                            </p>
                        </div>
                        
                        <div class="mt-4">
                            <h4 class="font-bold text-center text-sm mb-1">Proyección de Pensión Neta</h4>
                            <div id="scenario_${scenarioNum}_proyeccion"></div>
                        </div>

                        <!-- NEW TIMELINE SECTION -->
                        <div class="mt-4 border-t pt-4">
                            <h4 class="font-bold text-center text-sm mb-1">Línea de Tiempo del Escenario</h4>
                            <div id="timeline-container-scenario-${scenarioNum}" class="w-full h-64 overflow-x-auto border rounded-lg bg-gray-50"><svg id="timeline-svg-scenario-${scenarioNum}"></svg></div>
                            <div id="timeline-legend-scenario-${scenarioNum}" class="flex flex-wrap items-center justify-center gap-x-3 gap-y-1 mt-2 p-1"></div>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', cardHTML);

            if (AppState.activeScenarios >= 4) {
                document.getElementById('addScenarioBtn').disabled = true;
            } else {
                document.getElementById('addScenarioBtn').disabled = false;
            }
        }

        function removeScenarioCard(scenarioNum) {
            const card = document.getElementById(`scenario_card_${scenarioNum}`);
            if (card) {
                card.remove();
            }
            delete AppState.scenarioData[scenarioNum];
            // Since a card was removed, we are no longer at the limit
            document.getElementById('addScenarioBtn').disabled = false;
        }

        async function recalculateAllScenarios() {
            const scenarioCards = document.querySelectorAll('[id^="scenario_card_"]');
            for (const card of scenarioCards) {
                const num = card.id.split('_')[2];
                if (num) {
                   await recalculateScenario(Number(num));
                }
            }
        }
        
        async function recalculateScenario(scenarioNum) {
            const inputs = getScenarioInputs(scenarioNum);
            
            if (inputs.meses < 0 || !inputs.semanas || inputs.semanas < 500) {
                clearScenarioUI(scenarioNum);
                AppState.scenarioData[scenarioNum] = {};
                return;
            }
            
            const pensionData = calculateScenarioPensionData(inputs);
            const financialData = calculateScenarioFinancials(pensionData, inputs);

            const completeScenarioData = {
                ...inputs,
                ...pensionData,
                ...financialData,
                proyeccion: generatePensionProjection(pensionData.pensionMensual, financialData.descuentoMensual, financialData.deficit > 0)
            };
            
            const folioId = await window.logCalculationEvent(scenarioNum, completeScenarioData);
            if (folioId) {
                completeScenarioData.folio = folioId;
            }
            
            AppState.scenarioData[scenarioNum] = completeScenarioData;
            
            updateScenarioUI(scenarioNum, completeScenarioData);

            if (scenarioNum === 1) {
                autoSaveClient();
            }
        }
        
        // --- RECALCULATE SCENARIO HELPER FUNCTIONS ---
        function getScenarioInputs(scenarioNum) {
            const meses = parseInt(document.getElementById(`scenario_${scenarioNum}_meses`).value) || 0;
            const semanasAjuste = (document.getElementById(`scenario_${scenarioNum}_semanas_ajuste`)) ? (parseInt(document.getElementById(`scenario_${scenarioNum}_semanas_ajuste`).value) || 0) : 0;
            const semanasBaseAjustadas = AppState.datosClienteInfo.semanasCotizadasBase + semanasAjuste;
            const semanas = Math.round(semanasBaseAjustadas + (meses * (52.1429 / 12)));
            
            // This hidden input is not strictly necessary but can be useful for debugging
            const semanasHiddenInput = document.getElementById(`scenario_${scenarioNum}_semanas`);
            if(semanasHiddenInput) semanasHiddenInput.value = semanas;

            return {
                meses,
                semanas,
                curp: document.getElementById('info_curpCliente').value,
                inicioM40Str: document.getElementById('info_m40_p1_inicio').value,
                sbcM40: getNumeroInfo('info_m40_p1_sbc'),
                aforeActual: getNumeroInfo('info_aforeActual'),
                mesesPrimerDeposito: parseInt(document.getElementById('info_mesesPrimerDeposito').value) || 6,
                comisionExcedente: getNumeroInfo('info_comisionExcedente'),
                comisionExcedenteConcepto: document.getElementById('info_comisionExcedente_concepto').value.trim()
            };
        }
        function calculateScenarioPensionData(inputs) {
            // Handle scenario with 0 months (base pension)
            if (inputs.meses === 0) {
                const edadParaCalculoBase = Math.max(60, AppState.datosClienteInfo.edadBase);
                const pensionResult = _calcularPensionDetallado(AppState.datosClienteInfo.sbcPromedioBase, inputs.semanas, edadParaCalculoBase);
                return {
                    pensionMensual: pensionResult.PENSION_MENSUAL_ESTIMADA,
                    aguinaldo: pensionResult.AGUINALDO_ESTIMADO,
                    sbcPromedio: AppState.datosClienteInfo.sbcPromedioBase,
                    edadFinM40: AppState.datosClienteInfo.edadObjCompleta,
                    fechaFinM40Obj: new Date(),
                    diasEnM40: 0,
                    finalTimelinePeriods: AppState.timelinePeriods // Use original timeline for base case
                };
            }

            const fechaNacimiento = extraerFechaNacimientoCURP(inputs.curp);
            const fechaFinM40Obj = calcularFechaFinDesdeMeses(inputs.inicioM40Str, inputs.meses);
            const edadFinM40 = calcularEdadExacta(fechaNacimiento, fechaFinM40Obj);
            
            let edadParaPorcentaje = edadFinM40.anos;
            if (edadFinM40.meses > 6 || (edadFinM40.meses === 6 && edadFinM40.dias >= 1)) {
                edadParaPorcentaje++;
            }

            const diasEnM40 = inputs.meses * (365.25 / 12);
            const diasASumarDeM40 = Math.min(diasEnM40, Constants.DIAS_PROMEDIO_PENSION);
            const diasBasePrevios = Constants.DIAS_PROMEDIO_PENSION - diasASumarDeM40;
            const sbcPromedio = ((inputs.sbcM40 * diasASumarDeM40) + (AppState.datosClienteInfo.sbcPromedioBase * diasBasePrevios)) / Constants.DIAS_PROMEDIO_PENSION;
            
            const pensionResult = _calcularPensionDetallado(sbcPromedio, inputs.semanas, edadParaPorcentaje);
            const pensionMensual = pensionResult.PENSION_MENSUAL_ESTIMADA + Constants.AJUSTE_PENSION_MENSUAL;
            
            // Generate timeline data for this scenario
            const [anioInicio, mesInicio, diaInicio] = inputs.inicioM40Str.split('-').map(Number);
            const fechaInicioM40Obj = new Date(Date.UTC(anioInicio, mesInicio - 1, diaInicio));
        
            const m40Period = {
                fechaInicio: fechaInicioM40Obj,
                fechaFin: fechaFinM40Obj,
                sbc: inputs.sbcM40,
                nombrePatron: "Modalidad 40",
                regPatronal: "Modalidad 40",
                isOverlapped: false,
                originalPeriods: []
            };
            m40Period.originalPeriods.push(m40Period);
        
            const combinedHistory = [...AppState.fullHistoryPeriods, m40Period];
            const finalTimelinePeriods = processOverlappingPeriods(combinedHistory);


            return { pensionMensual, aguinaldo: pensionResult.AGUINALDO_ESTIMADO, sbcPromedio, edadFinM40, fechaFinM40Obj, diasEnM40, finalTimelinePeriods };
        }
        function calculateScenarioFinancials(pensionData, inputs) {
             // Handle scenario with 0 months (no financial cost)
            if (inputs.meses === 0) {
                return {
                    costoM40: 0, totalActualizacion: 0, totalRecargos: 0, comision: 0, factorMultiplicador: 0,
                    costoTotalContrato: 0, coberturaAfore: inputs.aforeActual, coberturaDeposito: 0,
                    coberturaExtra: 0, prestamoRequerido: 0, resultadoFinalTexto: "Pensión Base",
                    resultadoFinalColor: 'text-gray-800', descuentoMensual: 0, deficit: 0,
                    desgloseM40: [], roiMonths: Infinity
                };
            }

            let costoM40 = 0;
            let totalActualizacion = 0;
            let totalRecargos = 0;
            const desgloseM40 = [];
            const [anioInicio, mesInicio] = inputs.inicioM40Str.split('-').map(Number);
            const fechaSimulacionPago = new Date(pensionData.fechaFinM40Obj);
            const mesActualizacion = new Date(fechaSimulacionPago);
            mesActualizacion.setUTCMonth(mesActualizacion.getUTCMonth() - 1);
            const inpcNumerador = getINPC(mesActualizacion.getUTCFullYear(), mesActualizacion.getUTCMonth() + 1);

            for (let m = 0; m < inputs.meses; m++) {
                const fechaCuota = new Date(Date.UTC(anioInicio, mesInicio - 1 + m, 1));
                const anioCuota = fechaCuota.getUTCFullYear();
                const mesCuota = fechaCuota.getUTCMonth() + 1;
                const tasaM40Anual = getTasaM40Porcentaje(anioCuota);
                const costoBaseMensual = inputs.sbcM40 * tasaM40Anual * getDiasEnMes(anioCuota, mesCuota);
                
                let actualizacion = 0;
                const inpcDenominador = getINPC(anioCuota, mesCuota);
                let factorActualizacion = 1;
                if (inpcNumerador && inpcDenominador && inpcNumerador > inpcDenominador) {
                    factorActualizacion = inpcNumerador / inpcDenominador;
                    actualizacion = costoBaseMensual * (factorActualizacion - 1);
                }
                const pagoBaseActualizado = costoBaseMensual + actualizacion;
                
                let montoRecargos = 0;
                let mesesRetraso = 0;
                const fechaVencimiento = new Date(Date.UTC(anioCuota, mesCuota, 17));
                if (fechaSimulacionPago > fechaVencimiento) {
                    mesesRetraso = (fechaSimulacionPago.getUTCFullYear() - fechaVencimiento.getUTCFullYear()) * 12 + (fechaSimulacionPago.getUTCMonth() - fechaVencimiento.getUTCMonth());
                    if (mesesRetraso > 0) montoRecargos = pagoBaseActualizado * Constants.RECARGO_M40_MENSUAL * mesesRetraso;
                }
                
                const costoTotalMes = pagoBaseActualizado + montoRecargos;
                costoM40 += costoTotalMes;
                totalActualizacion += actualizacion;
                totalRecargos += montoRecargos;

                desgloseM40.push({
                    mes: fechaCuota.toLocaleDateString('es-MX', { month: 'short', year: 'numeric', timeZone: 'UTC' }),
                    costoBase: costoBaseMensual,
                    factorAct: factorActualizacion > 1 ? factorActualizacion.toFixed(4) : 'N/A',
                    montoAct: actualizacion,
                    recargos: montoRecargos,
                    totalMes: costoTotalMes
                });
            }

            const comision = costoM40 * Constants.COMISION_BASE_M40;
            const factorMultiplicador = costoM40 * Constants.FACTOR_MULTIPLICADOR_COSTO;
            const costoTotalContrato = (costoM40 + factorMultiplicador + Constants.COSTO_FIJO_ADICIONAL + comision + inputs.comisionExcedente) + Constants.AJUSTE_FINAL_CONTRATO;
            
            const primerDeposito = pensionData.pensionMensual * inputs.mesesPrimerDeposito;
            const extraAfore = pensionData.diasEnM40 * inputs.sbcM40 * 0.02;
            const subtotalCobertura = inputs.aforeActual + primerDeposito + extraAfore;
            const deficit = costoTotalContrato - subtotalCobertura;
            
            const descuentoMaximoPermitido = pensionData.pensionMensual * 0.30;
            const slopePrestamo = (Constants.PRESTAMO_PUNTO_B_MONTO - Constants.PRESTAMO_PUNTO_A_MONTO) / (Constants.PRESTAMO_PUNTO_B_DESCUENTO - Constants.PRESTAMO_PUNTO_A_DESCUENTO);
            let prestamoAlcanzable = slopePrestamo * (descuentoMaximoPermitido - Constants.PRESTAMO_PUNTO_A_DESCUENTO) + Constants.PRESTAMO_PUNTO_A_MONTO;
            prestamoAlcanzable = Math.max(0, prestamoAlcanzable);
            
            let prestamoRequerido = 0;
            let descuentoMensual = 0;
            if (deficit > 0) {
                prestamoRequerido = Math.min(deficit, prestamoAlcanzable);
                if (prestamoRequerido > 0) {
                    const slopeDescuento = (Constants.PRESTAMO_PUNTO_B_DESCUENTO - Constants.PRESTAMO_PUNTO_A_DESCUENTO) / (Constants.PRESTAMO_PUNTO_B_MONTO - Constants.PRESTAMO_PUNTO_A_MONTO);
                    descuentoMensual = slopeDescuento * (prestamoRequerido - Constants.PRESTAMO_PUNTO_A_MONTO) + Constants.PRESTAMO_PUNTO_A_DESCUENTO;
                }
            }
            
            const saldoFinal = subtotalCobertura + prestamoRequerido - costoTotalContrato;
            let resultadoFinalTexto = '';
            let resultadoFinalColor = 'text-gray-800';

            if (saldoFinal > 0.01) {
                resultadoFinalTexto = `SALDO A FAVOR: $${formatNumber(saldoFinal)}`;
                resultadoFinalColor = 'text-green-600';
            } else if (saldoFinal >= -0.01) {
                resultadoFinalTexto = "PROYECTO VIABLE";
                resultadoFinalColor = 'text-blue-600';
            } else {
                resultadoFinalTexto = `DÉFICIT: $${formatNumber(Math.abs(saldoFinal))}`;
                resultadoFinalColor = 'text-red-600';
            }

            // ROI Calculation
            const pensionIncrease = pensionData.pensionMensual - AppState.pensionBaseResultadosInfo.PENSION_MENSUAL_ESTIMADA;
            const roiMonths = (pensionIncrease > 0) ? (costoTotalContrato / pensionIncrease) : Infinity;


            return {
                costoM40, totalActualizacion, totalRecargos, comision, factorMultiplicador,
                costoTotalContrato,
                coberturaAfore: inputs.aforeActual,
                coberturaDeposito: primerDeposito,
                coberturaExtra: extraAfore,
                prestamoRequerido,
                resultadoFinalTexto,
                resultadoFinalColor,
                descuentoMensual,
                deficit,
                desgloseM40,
                roiMonths
            };
        }
        function generatePensionProjection(pensionMensual, descuentoMensual, hasDeficit) {
            const projection = [];
            for (let i = 1; i <= 10; i++) {
                const pensionBruta = pensionMensual * Math.pow(1 + Constants.INPC_GROWTH_ESTIMATE, i - 1);
                const descuentoAplicado = (i <= 5 && hasDeficit) ? descuentoMensual : 0;
                const pensionNeta = pensionBruta - descuentoAplicado;
                projection.push([i, `$${formatNumber(pensionBruta)}`, `-$${formatNumber(descuentoAplicado)}`, `$${formatNumber(pensionNeta)}`]);
            }
            return projection;
        }
        function updateScenarioUI(scenarioNum, data) {
            const getEl = (suffix) => document.getElementById(`scenario_${scenarioNum}_${suffix}`);
            
            const whiteColor = 'var(--white)';
            
            // Update data content
            getEl('pension').textContent = '$' + formatNumber(data.pensionMensual);
            getEl('aguinaldo').textContent = '$' + formatNumber(data.aguinaldo);
            getEl('costo_total').textContent = '$' + formatNumber(data.costoTotalContrato);
            getEl('cobertura_afore').textContent = '$' + formatNumber(data.coberturaAfore);
            getEl('cobertura_deposito').textContent = '$' + formatNumber(data.coberturaDeposito);
            getEl('cobertura_extra').textContent = '$' + formatNumber(data.coberturaExtra);
            getEl('prestamo').textContent = '$' + formatNumber(data.prestamoRequerido);
            getEl('resultado_final').textContent = data.resultadoFinalTexto;
            getEl('roi').textContent = isFinite(data.roiMonths) ? `${Math.ceil(data.roiMonths)} meses` : 'N/A';
            
            // Update colors based on pdfGenerated flag
            const elementsToColor = [
                { el: getEl('pension'), color: 'text-green-600', class: 'float-right font-bold text-base' },
                { el: getEl('aguinaldo'), color: 'text-gray-800', class: 'float-right font-semibold' },
                { el: getEl('costo_total'), color: 'text-red-600', class: 'float-right font-bold' },
                { el: getEl('cobertura_afore'), color: 'text-gray-800', class: 'float-right font-semibold' },
                { el: getEl('cobertura_deposito'), color: 'text-gray-800', class: 'float-right font-semibold' },
                { el: getEl('cobertura_extra'), color: 'text-gray-800', class: 'float-right font-semibold' },
                { el: getEl('prestamo'), color: 'text-gray-800', class: 'float-right font-semibold' },
                { el: getEl('resultado_final'), color: data.resultadoFinalColor, class: 'float-right font-bold' },
                { el: getEl('roi'), color: 'text-gray-800', class: 'float-right font-semibold' },
            ];

            elementsToColor.forEach(item => {
                if (AppState.pdfGenerated) {
                    item.el.style.color = ''; // Remove inline style to use CSS class
                    item.el.className = `${item.class} ${item.color}`;
                } else {
                    item.el.style.color = whiteColor;
                }
            });

            const fechaBajaFormatted = data.meses > 0 ? formatDateDDMMYYYY(data.fechaFinM40Obj) : 'N/A';
            let fechaInicioFormatted = 'N/A';
            if (data.meses > 0 && data.inicioM40Str) {
                const [year, month, day] = data.inicioM40Str.split('-').map(Number);
                const fechaInicioObj = new Date(Date.UTC(year, month - 1, day));
                fechaInicioFormatted = formatDateDDMMYYYY(fechaInicioObj);
            }

            getEl('fecha_inicio').textContent = fechaInicioFormatted;
            getEl('meses_pagados').textContent = `${data.meses} meses`;
            getEl('fecha_baja').textContent = fechaBajaFormatted;
            getEl('edad_final').textContent = `${data.edadFinM40.anos}a, ${data.edadFinM40.meses}m, ${data.edadFinM40.dias}d`;
            getEl('sbc_final').textContent = '$' + formatNumber(data.sbcPromedio);
            getEl('semanas_finales').textContent = formatNumber(data.semanas, 0);

            let projectionHtml = `<table class="w-full text-xs mt-2"><thead class="bg-gray-200" style="${AppState.pdfGenerated ? '' : 'color: var(--text-dark);'}"><tr><th class="p-1 text-left">Año</th><th class="p-1 text-right">P. Bruta</th><th class="p-1 text-right">Desc.</th><th class="p-1 text-right">P. Neta</th></tr></thead><tbody>`;
            data.proyeccion.forEach(row => {
                 const rowStyle = AppState.pdfGenerated ? '' : `style="color: ${whiteColor};"`;
                 const netaColorClass = AppState.pdfGenerated ? 'text-green-700' : '';
                 const descColorClass = AppState.pdfGenerated ? 'text-red-600' : '';
                 projectionHtml += `<tr ${rowStyle}><td class="p-1 border-b text-left">${row[0]}</td><td class="p-1 border-b text-right">${row[1]}</td><td class="p-1 border-b text-right ${descColorClass}">${row[2]}</td><td class="p-1 border-b text-right font-bold ${netaColorClass}">${row[3]}</td></tr>`;
            });
            projectionHtml += `</tbody></table>`;
            getEl('proyeccion').innerHTML = projectionHtml;

            const resultsDiv = document.getElementById(`scenario_${scenarioNum}_results`);
             if(data.meses !== undefined) {
                  resultsDiv.style.display = 'block';
             } else {
                  resultsDiv.style.display = 'none';
             }
            
            // Render the new timeline for the scenario
            if (data.finalTimelinePeriods && data.finalTimelinePeriods.length > 0) {
                const svgId = `timeline-svg-scenario-${scenarioNum}`;
                const legendId = `timeline-legend-scenario-${scenarioNum}`;
                showElement(`timeline-container-scenario-${scenarioNum}`, 'block');
                drawScenarioTimeline(svgId, legendId, data.finalTimelinePeriods, `Línea de Tiempo - Escenario ${scenarioNum}`);
            } else {
                hideElement(`timeline-container-scenario-${scenarioNum}`);
            }
        }
        function clearScenarioUI(scenarioNum) {
            const scenarioCard = document.getElementById(`scenario_card_${scenarioNum}`);
            if (!scenarioCard) return;

            hideElement(`scenario_${scenarioNum}_results`);
            const getEl = (suffix) => document.getElementById(`scenario_${scenarioNum}_${suffix}`);
            const fieldsToClear = ['pension', 'aguinaldo', 'costo_total', 'cobertura_afore', 'cobertura_deposito', 'cobertura_extra', 'prestamo'];
            fieldsToClear.forEach(field => getEl(field).textContent = '$0.00');
            
            getEl('resultado_final').textContent = '$0.00';
            getEl('resultado_final').className = 'float-right font-bold';
            getEl('proyeccion').innerHTML = '';
            getEl('roi').textContent = 'N/A';
            
            const infoFields = ['fecha_inicio', 'meses_pagados', 'fecha_baja', 'edad_final', 'sbc_final', 'semanas_finales'];
            infoFields.forEach(field => getEl(field).textContent = '--');
        }
        
        function populateUmaTable() {
            const tableBody = document.getElementById('umaReferenceTableBody');
            tableBody.innerHTML = '';
            const years = Object.keys(Constants.economicData.umas).sort((a,b) => b-a);
            years.forEach(year => {
                const uma = Constants.economicData.umas[year];
                const sbcTope = uma * 25;
                const row = `
                    <tr class="border-b">
                        <td class="p-2 font-semibold">${year}</td>
                        <td class="p-2 text-right">$${formatNumber(uma)}</td>
                        <td class="p-2 text-right font-bold">$${formatNumber(sbcTope)}</td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        // --- PDF GENERATION ---
        async function promptForClientPDF() {
            if (!AppState.isSpecialUser && AppState.session.pdfDownloadCount >= 2) {
                showCustomAlert("Ha alcanzado el límite de 2 descargas de PDF por sesión. La sesión se cerrará.", "Límite Alcanzado");
                setTimeout(logout, 3000);
                return;
            }
            AppState.pdfGenerated = true;
            await recalculateAllScenarios(); // This will now make results visible for regular users
            
            await generateFullReportPDF(false);
            if (!AppState.isSpecialUser) {
                AppState.session.pdfDownloadCount++;
            }
        }

        async function promptForDirectorPDF() {
            if (!AppState.isSpecialUser && AppState.session.pdfDownloadCount >= 2) {
                showCustomAlert("Ha alcanzado el límite de 2 descargas de PDF por sesión. La sesión se cerrará.", "Límite Alcanzado");
                setTimeout(logout, 3000);
                return;
            }
            AppState.pdfGenerated = true;
            await recalculateAllScenarios(); // Recalculate to make text visible

            document.getElementById('customAlertTitle').textContent = "Confirmación de Administrador";
            document.getElementById('customAlertMessage').textContent = `Descarga #${AppState.session.pdfDownloadCount + 1} de 2. Ingrese la contraseña para generar el reporte de Dirección.`;
            document.getElementById('passwordPromptContainer').style.display = 'block';
            document.getElementById('pdfPasswordInput').value = '';
            const btn = document.getElementById('customAlertButton');
            btn.textContent = 'Generar PDF';
            btn.onclick = async () => {
                const password = document.getElementById('pdfPasswordInput').value;
                if (password === 'oici010503120566') {
                    await generateFullReportPDF(true);
                     if (!AppState.isSpecialUser) {
                        AppState.session.pdfDownloadCount++;
                    }
                    closeCustomAlert();
                } else {
                    showCustomAlert('Contraseña incorrecta.', 'Error');
                }
            };
            showElement('customAlertModal');
        }

        function promptForDirectorPassword(onSuccess) {
            document.getElementById('customAlertTitle').textContent = "Confirmación de Administrador";
            document.getElementById('customAlertMessage').textContent = `Para agregar más de 2 escenarios, ingrese la contraseña de Dirección.`;
            document.getElementById('passwordPromptContainer').style.display = 'block';
            document.getElementById('pdfPasswordInput').value = '';
            const btn = document.getElementById('customAlertButton');
            btn.textContent = 'Confirmar';
            btn.onclick = () => {
                const password = document.getElementById('pdfPasswordInput').value;
                if (password === 'oici010503120566') {
                    closeCustomAlert();
                    if (onSuccess && typeof onSuccess === 'function') {
                        onSuccess();
                    }
                } else {
                    document.getElementById('customAlertMessage').textContent = 'Contraseña incorrecta. Intente de nuevo.';
                    document.getElementById('pdfPasswordInput').value = '';
                    btn.textContent = 'Aceptar';
                    btn.onclick = () => {
                        closeCustomAlert();
                    };
                }
            };
            showElement('customAlertModal');
        }

        // --- DETAILED PDF GENERATION FUNCTION ---
        async function generateFullReportPDF(isDirector) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'letter');
            const pageHeight = doc.internal.pageSize.height;
            let finalY = 0; // Keep track of the last Y position

            const cliente = AppState.datosClienteInfo;
            
            // --- PDF STYLES ---
            const styles = {
                header: { font: "helvetica", fontStyle: 'bold', fontSize: 16, textColor: '#003366' },
                subHeader: { font: "helvetica", fontStyle: 'bold', fontSize: 12, textColor: '#1A202C' },
                body: { font: "helvetica", fontStyle: 'normal', fontSize: 10, textColor: '#4A5568' },
                tableHeader: { fillColor: '#003366', textColor: '#FFFFFF', fontStyle: 'bold' },
                tableBody: { textColor: '#4A5568' },
                highlightGreen: { textColor: [22, 163, 74], fontStyle: 'bold' },
                highlightRed: { textColor: [220, 38, 38], fontStyle: 'bold' },
                highlightBlue: { textColor: [0, 51, 102], fontStyle: 'bold' },
            };

            const addFooter = () => {
                const pageCount = doc.internal.getNumberOfPages();
                const now = new Date();
                const pad = (num) => String(num).padStart(2, '0');
                const folio = AppState.scenarioData[1]?.folio || `${pad(now.getMonth() + 1)}${pad(now.getDate())}${pad(now.getHours())}${pad(now.getMinutes())}${now.getFullYear()}`;

                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150);
                    const footerStartY = pageHeight - 50;
                    doc.setLineWidth(0.5);
                    doc.setDrawColor(180);
                    doc.line(40, footerStartY, doc.internal.pageSize.width - 40, footerStartY);
                    const address = 'Eje Central Lázaro Cárdenas 555, Narvarte Poniente, Benito Juárez, 03023 Ciudad de México, CDMX';
                    const copyright = `© ${now.getFullYear()} Ivan Roberto Ortiz Cano. Derechos Reservados.`;
                    doc.text(address, 40, footerStartY + 15);
                    doc.text(copyright, 40, footerStartY + 27);
                    doc.text(`Folio: ${folio}`, 40, footerStartY + 39);
                    doc.text(`Página ${i} de ${pageCount}`, doc.internal.pageSize.width - 40, footerStartY + 39, { align: 'right' });
                }
            };
            
            const checkPageBreak = (currentY, requiredSpace) => {
                if (currentY + requiredSpace > pageHeight - 70) { // 70 for footer margin
                    doc.addPage();
                    return 50; // Start Y for new page
                }
                return currentY;
            };

            // --- PDF CONTENT GENERATION ---
            doc.setFont(styles.header.font, styles.header.fontStyle);
            doc.setFontSize(styles.header.fontSize);
            doc.setTextColor(styles.header.textColor);
            doc.text("Reporte de Proyección de Pensión", 40, 50);
            doc.setFontSize(12);
            doc.text("RGC Pensiones y Seguros", 40, 70);
            doc.setLineWidth(1.5);
            doc.setDrawColor(0, 51, 102);
            doc.line(40, 75, 572, 75);

            finalY = 100;

            // Section: Client Data
            doc.setFont(styles.subHeader.font, styles.subHeader.fontStyle);
            doc.setFontSize(styles.subHeader.fontSize);
            doc.setTextColor(styles.subHeader.textColor);
            doc.text("1. Datos del Cliente", 40, finalY);
            doc.autoTable({
                startY: finalY + 10,
                body: [
                    ['Nombre Completo:', cliente.nombre],
                    ['CURP:', cliente.curp],
                    ['Teléfono:', cliente.telefono],
                    ['Asesor a Cargo:', AppState.nombreAsesorGlobal],
                    ['Semanas Totales (Antes de Estrategia):', formatNumber(cliente.semanasCotizadasBase, 0)],
                ],
                theme: 'grid', styles: { fontSize: 10 }, columnStyles: { 0: { fontStyle: 'bold', cellWidth: 180 } }
            });
            finalY = doc.autoTable.previous.finalY;

            // Section: Base SBC
            finalY = checkPageBreak(finalY, 100);
            finalY += 20;
            doc.text("2. Cálculo del Salario Promedio (Últimos 1750 Días)", 40, finalY);
            doc.autoTable({
                startY: finalY + 10,
                head: [['Registro Patronal', 'Fecha Inicio', 'Fecha Fin', 'Días', 'SBC Diario', 'SBC Ponderado']],
                body: AppState.sbcCalculationPeriods.map(p => [p.regPatronal, formatDateDDMMYYYY(p.fechaInicio), formatDateDDMMYYYY(p.fechaFin), formatNumber(p.dias, 0), `$${formatNumber(p.sbc)}`, `$${formatNumber(p.ponderado)}`]),
                theme: 'striped', headStyles: styles.tableHeader, styles: { fontSize: 8 },
            });
            finalY = doc.autoTable.previous.finalY;

            // Section: Base Pension
            finalY = checkPageBreak(finalY, 100);
            finalY += 20;
            doc.text("3. Resultados de Pensión Base (Sin Estrategia M40)", 40, finalY);
             doc.autoTable({
                startY: finalY + 10,
                body: [
                    ['SBC Promedio Base:', `$${formatNumber(cliente.sbcPromedioBase)}`],
                    ['Pensión Mensual Estimada:', `$${formatNumber(AppState.pensionBaseResultadosInfo.PENSION_MENSUAL_ESTIMADA)}`],
                    ['Aguinaldo Estimado:', `$${formatNumber(AppState.pensionBaseResultadosInfo.AGUINALDO_ESTIMADO)}`],
                ],
                theme: 'grid', styles: { fontSize: 10 }, columnStyles: { 0: { fontStyle: 'bold' } }
            });
            finalY = doc.autoTable.previous.finalY;

            // Section: Timeline
            finalY = checkPageBreak(finalY, 300);
            finalY += 20;
            doc.text("4. Línea de Tiempo del Historial Laboral (Últimos 10 Años)", 40, finalY);
            const svgElement = document.getElementById('timeline-svg');
            if (svgElement) {
                const svgString = new XMLSerializer().serializeToString(svgElement);
                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");
                canvas.width = svgElement.width.baseVal.value;
                canvas.height = svgElement.height.baseVal.value;
                const img = new Image();
                img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString)));
                await new Promise(resolve => {
                    img.onload = () => {
                        ctx.drawImage(img, 0, 0);
                        const dataUrl = canvas.toDataURL('image/png');
                        doc.addImage(dataUrl, 'PNG', 40, finalY + 10, 532, 288);
                        resolve();
                    };
                });
                finalY += 310;
                 // Add Legend
                const legendItems = d3.select("#timeline-legend").selectAll(".legend-item");
                const legendBody = [];
                legendItems.each(function() {
                    const item = d3.select(this);
                    const color = item.select("div").style("background-color");
                    const text = item.select("span").text();
                    legendBody.push([{ content: '', styles: { fillColor: color, cellWidth: 20 } }, { content: text, styles: { valign: 'middle' } }]);
                });
                if (legendBody.length > 0) {
                    finalY = checkPageBreak(finalY, 50);
                    doc.autoTable({
                        startY: finalY + 5,
                        body: legendBody,
                        theme: 'plain',
                        styles: { fontSize: 8, cellPadding: 2 },
                    });
                    finalY = doc.autoTable.previous.finalY;
                }
            }
            
            // --- SCENARIO ANALYSIS PAGE ---
            doc.addPage();
            finalY = 50;
            doc.text("5. Análisis Comparativo de Escenarios", 40, finalY);

            const activeScenarios = Object.values(AppState.scenarioData).filter(s => s && s.costoTotalContrato !== undefined && s.meses >= 0).slice(0, 2); // Take first two scenarios
            
            if (activeScenarios.length > 0) {
                const startX_sc1 = 40;
                const startX_sc2 = 310;
                const tableWidth = 262;
                let finalY_sc1 = finalY;
                let finalY_sc2 = finalY;

                // Headers for both scenarios
                doc.setFontSize(11);
                doc.text("Escenario 1", startX_sc1, finalY + 25);
                if(activeScenarios[1]) doc.text("Escenario 2", startX_sc2, finalY + 25);

                finalY += 40;
                finalY_sc1 = finalY;
                finalY_sc2 = finalY;

                // Table for Scenario 1
                const sc1 = activeScenarios[0];
                doc.autoTable({
                    startY: finalY_sc1,
                    head: [['Resultados del Escenario 1', '']],
                    body: [
                        ['Fecha Inicio M40:', sc1.meses > 0 ? formatDateDDMMYYYY(new Date(sc1.inicioM40Str.replace(/-/g, '/'))) : 'N/A'],
                        ['Meses Pagados M40:', `${sc1.meses} meses`],
                        ['Fecha de Baja:', sc1.meses > 0 ? formatDateDDMMYYYY(sc1.fechaFinM40Obj) : 'N/A'],
                        ['Edad al Finalizar:', `${sc1.edadFinM40.anos}a, ${sc1.edadFinM40.meses}m, ${sc1.edadFinM40.dias}d`],
                        ['SBC Promedio Final:', `$${formatNumber(sc1.sbcPromedio)}`],
                        ['Semanas Finales:', formatNumber(sc1.semanas, 0)]
                    ],
                    theme: 'striped', headStyles: styles.tableHeader, styles: { fontSize: 8, cellPadding: 3 },
                    tableWidth: tableWidth, margin: { left: startX_sc1 }
                });
                finalY_sc1 = doc.autoTable.previous.finalY + 15;

                // Table for Scenario 2 if it exists
                if(activeScenarios[1]) {
                    const sc2 = activeScenarios[1];
                     doc.autoTable({
                        startY: finalY_sc2,
                        head: [['Resultados del Escenario 2', '']],
                        body: [
                            ['Fecha Inicio M40:', sc2.meses > 0 ? formatDateDDMMYYYY(new Date(sc2.inicioM40Str.replace(/-/g, '/'))) : 'N/A'],
                            ['Meses Pagados M40:', `${sc2.meses} meses`],
                            ['Fecha de Baja:', sc2.meses > 0 ? formatDateDDMMYYYY(sc2.fechaFinM40Obj) : 'N/A'],
                            ['Edad al Finalizar:', `${sc2.edadFinM40.anos}a, ${sc2.edadFinM40.meses}m, ${sc2.edadFinM40.dias}d`],
                            ['SBC Promedio Final:', `$${formatNumber(sc2.sbcPromedio)}`],
                            ['Semanas Finales:', formatNumber(sc2.semanas, 0)]
                        ],
                        theme: 'striped', headStyles: styles.tableHeader, styles: { fontSize: 8, cellPadding: 3 },
                        tableWidth: tableWidth, margin: { left: startX_sc2 }
                    });
                    finalY_sc2 = doc.autoTable.previous.finalY + 15;
                }
                
                finalY = Math.max(finalY_sc1, finalY_sc2);

                // Financial Analysis
                doc.autoTable({
                    startY: finalY,
                    head: [['Análisis Financiero y Cobertura', '']],
                    body: [
                        ['Pensión Mensual Bruta:', `$${formatNumber(sc1.pensionMensual)}`],
                        ['Aguinaldo:', `$${formatNumber(sc1.aguinaldo)}`],
                        [{content: 'Costo Total del Proyecto:', styles: {fontStyle: 'bold', textColor: [220, 38, 38]} }, {content: `$${formatNumber(sc1.costoTotalContrato)}`, styles: {fontStyle: 'bold', textColor: [220, 38, 38]}}],
                        ['Cobertura AFORE:', `$${formatNumber(sc1.coberturaAfore)}`],
                        ['Cobertura 1er Depósito:', `$${formatNumber(sc1.coberturaDeposito)}`],
                        ['Cobertura Extra AFORE:', `$${formatNumber(sc1.coberturaExtra)}`],
                        ['Préstamo Requerido:', `$${formatNumber(sc1.prestamoRequerido)}`],
                        ['Resultado Final:', {content: sc1.resultadoFinalTexto, styles: {fontStyle: 'bold', textColor: sc1.resultadoFinalColor === 'text-green-600' ? [22,163,74] : [0,51,102]}}],
                        ['Recuperación de Inversión (ROI):', isFinite(sc1.roiMonths) ? `${Math.ceil(sc1.roiMonths)} meses` : 'N/A'],
                    ],
                    theme: 'grid', headStyles: styles.tableHeader, styles: { fontSize: 8, cellPadding: 3 },
                    columnStyles: { 0: { fontStyle: 'bold' } },
                    tableWidth: tableWidth, margin: { left: startX_sc1 }
                });
                finalY_sc1 = doc.autoTable.previous.finalY + 15;

                if (activeScenarios[1]) {
                    const sc2 = activeScenarios[1];
                    doc.autoTable({
                        startY: finalY,
                        head: [['Análisis Financiero y Cobertura', '']],
                        body: [
                            ['Pensión Mensual Bruta:', `$${formatNumber(sc2.pensionMensual)}`],
                            ['Aguinaldo:', `$${formatNumber(sc2.aguinaldo)}`],
                            [{content: 'Costo Total del Proyecto:', styles: {fontStyle: 'bold', textColor: [220, 38, 38]} }, {content: `$${formatNumber(sc2.costoTotalContrato)}`, styles: {fontStyle: 'bold', textColor: [220, 38, 38]}}],
                            ['Cobertura AFORE:', `$${formatNumber(sc2.coberturaAfore)}`],
                            ['Cobertura 1er Depósito:', `$${formatNumber(sc2.coberturaDeposito)}`],
                            ['Cobertura Extra AFORE:', `$${formatNumber(sc2.coberturaExtra)}`],
                            ['Préstamo Requerido:', `$${formatNumber(sc2.prestamoRequerido)}`],
                            ['Resultado Final:', {content: sc2.resultadoFinalTexto, styles: {fontStyle: 'bold', textColor: sc2.resultadoFinalColor === 'text-green-600' ? [22,163,74] : [0,51,102]}}],
                            ['Recuperación de Inversión (ROI):', isFinite(sc2.roiMonths) ? `${Math.ceil(sc2.roiMonths)} meses` : 'N/A'],
                        ],
                        theme: 'grid', headStyles: styles.tableHeader, styles: { fontSize: 8, cellPadding: 3 },
                        columnStyles: { 0: { fontStyle: 'bold' } },
                        tableWidth: tableWidth, margin: { left: startX_sc2 }
                    });
                    finalY_sc2 = doc.autoTable.previous.finalY + 15;
                }
                
                finalY = Math.max(finalY_sc1, finalY_sc2);

                // --- Director Only: Act & Recargos ---
                if (isDirector) {
                    for (let j = 0; j < activeScenarios.length; j++) {
                        const scenario = activeScenarios[j];
                        if (scenario.meses > 0) {
                            finalY = checkPageBreak(finalY, 150);
                            finalY += 20;
                            doc.text(`Desglose de Actualizaciones y Recargos (Escenario ${j + 1})`, 40, finalY);
                            doc.autoTable({
                                startY: finalY + 10,
                                head: [['Mes', 'Costo Base', 'Factor Act.', 'Monto Act.', 'Recargos', 'Costo Total Mes']],
                                body: scenario.desgloseM40.map(d => [d.mes, `$${formatNumber(d.costoBase)}`, d.factorAct, `$${formatNumber(d.montoAct)}`, `$${formatNumber(d.recargos)}`, `$${formatNumber(d.totalMes)}`]),
                                theme: 'striped', headStyles: styles.tableHeader, styles: { fontSize: 8 }
                            });
                            finalY = doc.autoTable.previous.finalY;
                        }
                    }
                }
            }
            
            // --- ADD FOOTER AND SAVE ---
            addFooter();
            const fileName = `Reporte_RGC_${cliente.nombre.replace(/\s/g, '_')}_${isDirector ? 'DIR' : 'CLI'}.pdf`;
            doc.save(fileName);
            showCustomAlert(`El reporte PDF "${fileName}" se ha generado y descargado.`, "Éxito");
        }
        
        function generateContractPDF() {
            console.log("Generating contract PDF...");
            showCustomAlert("La función para generar el contrato PDF aún no está implementada.", "Función no Disponible");
        }

        function validarNombreCURP(nombreCompleto, curp) {
            if (!nombreCompleto || !curp || curp.length < 4) return false;

            const articulos = ["DA", "DAS", "DE", "DEL", "DER", "DI", "DIE", "DD", "EL", "LA", "LOS", "LAS", "LE", "LES", "MAC", "MC", "VAN", "VON", "Y"];
            const nombreNormalizado = nombreCompleto.trim().toUpperCase().replace(/\s+/g, ' ');
            
            let partes = nombreNormalizado.split(' ');
            partes = partes.filter(p => !articulos.includes(p));

            if (partes.length < 2) return false;

            let apPaterno = partes[0];
            let apMaterno = partes.length > 2 ? partes[1] : 'X';
            let nombre = partes.length > 2 ? partes.slice(2).join(' ') : partes[1];
            
            if (['MARIA', 'JOSE'].includes(partes[2]) && partes.length > 3) {
                nombre = partes[3];
            } else if (partes.length > 2) {
                nombre = partes[2];
            }

            apPaterno = apPaterno.replace(/Ñ/g, 'X');
            apMaterno = apMaterno.replace(/Ñ/g, 'X');

            let iniciales = apPaterno.charAt(0);
            
            let vocalEncontrada = false;
            for (let i = 1; i < apPaterno.length; i++) {
                if ('AEIOU'.includes(apPaterno.charAt(i))) {
                    iniciales += apPaterno.charAt(i);
                    vocalEncontrada = true;
                    break;
                }
            }
            if (!vocalEncontrada) iniciales += 'X';

            iniciales += apMaterno.charAt(0);
            iniciales += nombre.charAt(0);

            const curpIniciales = curp.substring(0, 4).toUpperCase();
            
            return curpIniciales === iniciales;
        }

        // --- AUTOMATIC TEXT PARSING FUNCTION ---
        function analizarTextoCompleto() {
            const textoCompleto = document.getElementById('info_textoCompleto').value;
            if (!textoCompleto.trim()) {
                showCustomAlert("El área de texto está vacía. Por favor, pegue el contenido de la constancia.", "Error");
                return;
            }

            const analyzeButton = document.querySelector('button[onclick="analizarTextoCompleto()"]');
            const originalButtonText = analyzeButton.innerHTML;
            analyzeButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Analizando...`;
            analyzeButton.disabled = true;

            // Use a short timeout to allow the UI to update with the loading state
            setTimeout(() => {
                try {
                    document.getElementById('employmentCardsContainer').innerHTML = '';
                    AppState.employmentCardIdCounter = 0;

                    const datosPersonalesRegex = /Estimado\(a\),\s*([A-Z\s,ÑÁÉÍÓÚ]+)\s*NSS:\s*[\w\d]+\s*CURP:\s*(\w{18})/i;
                    const datosPersonalesMatch = textoCompleto.match(datosPersonalesRegex);

                    if (datosPersonalesMatch && datosPersonalesMatch[1] && datosPersonalesMatch[2]) {
                        document.getElementById('info_nombreCompleto').value = datosPersonalesMatch[1].trim();
                        document.getElementById('info_curpCliente').value = datosPersonalesMatch[2].trim();
                    } else {
                        // Use throw to be caught by the catch block
                        throw new Error("No se pudo encontrar el Nombre y CURP en el formato esperado.");
                    }

                    const semanasCompuestasRegex = /Semanas\s+Reintegradas\s*\(\+\)[\s\S]*?(\d+)\s+(\d+)\s+(\d+)/i;
                    const semanasCompuestasMatch = textoCompleto.match(semanasCompuestasRegex);

                    if (semanasCompuestasMatch && semanasCompuestasMatch.length === 4) {
                        const imss = parseInt(semanasCompuestasMatch[1], 10);
                        const descontadas = parseInt(semanasCompuestasMatch[2], 10);
                        const reintegradas = parseInt(semanasCompuestasMatch[3], 10);
                        const totalSemanasCalculadas = imss - descontadas + reintegradas;
                        document.getElementById('info_semanasTotalesManual').value = totalSemanasCalculadas;
                    } else {
                        const semanasTotalRegex = /Total de semanas cotizadas\s+(\d+)/i;
                        const semanasTotalMatch = textoCompleto.match(semanasTotalRegex);
                        if (semanasTotalMatch && semanasTotalMatch[1]) {
                            document.getElementById('info_semanasTotalesManual').value = semanasTotalMatch[1].trim();
                        } else {
                            throw new Error("No se pudieron encontrar las semanas totales en el texto.");
                        }
                    }

                    const employerBlocks = textoCompleto.split(/Nombre\s+del\s+patrón/gi).slice(1);
                    if (employerBlocks.length === 0) {
                         throw new Error("No se encontraron bloques de empleadores. Verifique que el texto contenga 'Nombre del patrón'.");
                    }

                    employerBlocks.forEach(block => {
                        const lines = block.trim().split('\n').map(l => l.trim()).filter(l => l);
                        const nombrePatron = lines[0] || 'No Encontrado';
                        
                        let regPatronal = 'No Encontrado';
                        const regPatronalMatch = block.match(/Registro\s+Patronal\s+([A-Z0-9]+)/i);
                        if(regPatronalMatch && regPatronalMatch[1]) {
                            regPatronal = regPatronalMatch[1];
                        }

                        const movimientoRegex = /(REINGRESO|MODIFICACION\s*DE\s*SALARIO|BAJA|ALTA)\s+(\d{2}\/\d{2}\/\d{4})(?:\s*\$\s*([\d,]+\.?\d*))?/i;
                        let movimientosEncontrados = [];
                        
                        for (const linea of lines) {
                            const lineaLimpia = linea.trim().replace(/\s+/g, ' ');
                            if (movimientoRegex.test(lineaLimpia)) {
                                movimientosEncontrados.push(lineaLimpia);
                            }
                        }
                        
                        if (movimientosEncontrados.length > 0) {
                            addEmploymentCard(nombrePatron, regPatronal, movimientosEncontrados.join('\n'));
                        }
                    });

                    showElement('toggleCardsBtn', 'inline-flex');
                    // Call the main analysis function directly
                    analizarYCalcularSBC();

                } catch (error) {
                    console.error("Error durante el análisis del texto:", error);
                    showCustomAlert(error.message || "Ocurrió un error inesperado al procesar el texto.", "Error de Análisis");
                } finally {
                    // Restore button state in all cases
                    analyzeButton.innerHTML = originalButtonText;
                    analyzeButton.disabled = false;
                }
            }, 100);
        }

        function toggleAutoCards() {
            const container = document.getElementById('employmentCardsContainer');
            container.style.display = container.style.display === 'none' ? 'block' : 'none';
        }
        
        // --- TIMELINE & OVERLAP LOGIC ---
        function processOverlappingPeriods(periods) {
            if (!periods || periods.length === 0) {
                return [];
            }

            const datePoints = new Set();
            periods.forEach(p => {
                datePoints.add(p.fechaInicio.getTime());
                const nextDay = new Date(p.fechaFin);
                nextDay.setUTCDate(nextDay.getUTCDate() + 1);
                datePoints.add(nextDay.getTime());
            });

            const sortedDates = Array.from(datePoints).sort((a, b) => a - b);

            const microPeriods = [];
            for (let i = 0; i < sortedDates.length - 1; i++) {
                const start = new Date(sortedDates[i]);
                const end = new Date(sortedDates[i + 1]);
                end.setUTCDate(end.getUTCDate() - 1);

                if (start > end) continue;

                const activePeriods = periods.filter(p => start >= p.fechaInicio && end <= p.fechaFin);

                if (activePeriods.length > 0) {
                    const totalSBC = activePeriods.reduce((sum, p) => sum + p.sbc, 0);
                    const employers = activePeriods.map(p => p.nombrePatron).join(' + ');
                    const regPatronales = activePeriods.map(p => p.regPatronal).join(', ');
                    
                    microPeriods.push({
                        fechaInicio: start,
                        fechaFin: end,
                        sbc: totalSBC,
                        nombrePatron: employers,
                        regPatronal: regPatronales,
                        isOverlapped: activePeriods.length > 1,
                        originalPeriods: activePeriods
                    });
                }
            }

            if (microPeriods.length === 0) return [];

            const mergedPeriods = [microPeriods[0]];
            for (let i = 1; i < microPeriods.length; i++) {
                const lastMerged = mergedPeriods[mergedPeriods.length - 1];
                const current = microPeriods[i];
                const nextDayOfLast = new Date(lastMerged.fechaFin);
                nextDayOfLast.setUTCDate(nextDayOfLast.getUTCDate() + 1);

                if (
                    nextDayOfLast.getTime() === current.fechaInicio.getTime() &&
                    lastMerged.sbc === current.sbc &&
                    lastMerged.nombrePatron === current.nombrePatron
                ) {
                    lastMerged.fechaFin = current.fechaFin; // Extend the end date
                } else {
                    mergedPeriods.push(current); // Add as a new period
                }
            }
            return mergedPeriods;
        }

        function drawScenarioTimeline(svgId, legendId, timelineData) {
            const container = d3.select(`#${svgId}`).node() ? d3.select(`#${svgId}`).node().parentNode : null;
            if (!container) return;
        
            const svg = d3.select(`#${svgId}`);
            svg.selectAll("*").remove();
        
            const timelineTooltip = d3.select("#timeline-tooltip");
        
            if (!timelineData || timelineData.length === 0) return;
        
            const tenYearsAgo = new Date();
            tenYearsAgo.setFullYear(tenYearsAgo.getFullYear() - 10);
        
            const filteredData = timelineData.filter(p => p.fechaFin >= tenYearsAgo);
            if (filteredData.length === 0) return;
        
            const containerWidth = container.getBoundingClientRect().width;
            const containerHeight = container.getBoundingClientRect().height;
            const margin = { top: 20, right: 20, bottom: 40, left: 60 };
            const width = Math.max(containerWidth, 600) - margin.left - margin.right;
            const height = Math.max(containerHeight, 200) - margin.top - margin.bottom;
        
            svg.attr("width", width + margin.left + margin.right).attr("height", height + margin.top + margin.bottom);
            const chart = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);
        
            const x = d3.scaleTime()
                .domain([d3.min(filteredData, d => d.fechaInicio), d3.max(filteredData, d => d.fechaFin)])
                .range([0, width]);
        
            const y = d3.scaleLinear()
                .domain([0, 4000])
                .range([height, 0]).nice();
        
            chart.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(d3.timeYear.every(1)).tickFormat(d3.timeFormat("%Y")));
        
            chart.append("g")
                .call(d3.axisLeft(y).tickFormat(d => `$${d.toLocaleString('es-MX')}`));
        
            const uniqueEmployers = [...new Map(filteredData.flatMap(d => d.originalPeriods || [d]).map(p => [p.regPatronal, p])).values()];
            const color = d3.scaleOrdinal(d3.schemeTableau10).domain(uniqueEmployers.map(e => e.regPatronal));
            color("Modalidad 40");
            color("Traslape");
        
            chart.selectAll(".bar")
                .data(filteredData)
                .enter()
                .append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.fechaInicio))
                .attr("y", d => y(d.sbc))
                .attr("width", d => Math.max(1, x(d.fechaFin) - x(d.fechaInicio)))
                .attr("height", d => height - y(d.sbc))
                .attr("fill", d => {
                    if (d.nombrePatron === 'Modalidad 40') return '#f97316';
                    if (d.isOverlapped) return "#A855F7";
                    return color((d.originalPeriods || [d])[0].regPatronal);
                })
                .style("opacity", 0.8)
                .on("mouseover", (event, d) => {
                    timelineTooltip.style("opacity", 1);
                    d3.select(event.currentTarget).style('opacity', 1).style('stroke', 'black').style('stroke-width', '1.5px');
                })
                .on("mousemove", (event, d) => {
                    const employerList = (d.originalPeriods && d.originalPeriods.length > 0) ? d.originalPeriods.map(e => e.nombrePatron).join(' + ') : d.nombrePatron;
                    timelineTooltip.html(`<strong>${employerList}</strong><br/>Salario: ${d.sbc.toLocaleString('es-MX', { style: 'currency', currency: 'MXN' })}<br/>Inicio: ${formatDateDDMMYYYY(d.fechaInicio)}<br/>Fin: ${formatDateDDMMYYYY(d.fechaFin)}`)
                        .style("left", (event.pageX + 15) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", (event, d) => {
                    timelineTooltip.style("opacity", 0);
                    d3.select(event.currentTarget).style('opacity', 0.8).style('stroke', 'none');
                });
        
            const legendContainer = d3.select(`#${legendId}`);
            legendContainer.html("");
        
            let legendSource = [...uniqueEmployers];
            if (filteredData.some(d => d.nombrePatron === 'Modalidad 40') && !legendSource.some(e => e.regPatronal === 'Modalidad 40')) {
                legendSource.unshift({ nombrePatron: 'Modalidad 40', regPatronal: 'Modalidad 40' });
            }
            if (filteredData.some(d => d.isOverlapped) && !legendSource.some(e => e.regPatronal === 'Traslape')) {
                legendSource.unshift({ nombrePatron: 'Traslape de Empleos', regPatronal: 'Traslape' });
            }
        
            const legendData = [...new Map(legendSource.map(item => [item.regPatronal, item])).values()];
             
            const legend = legendContainer.selectAll(".legend-item").data(legendData).enter().append("div").attr("class", "legend-item flex items-center");
            legend.append("div").style("width", "12px").style("height", "12px").style("background-color", d => {
                    if (d.regPatronal === 'Modalidad 40') return '#f97316';
                    if (d.regPatronal === 'Traslape') return '#A855F7';
                    return color(d.regPatronal);
                }).attr("class", "mr-1 rounded-sm flex-shrink-0");
            legend.append("span").text(d => d.nombrePatron).attr("class", "text-xs text-gray-700");
        }

        // --- NEW VIGENCIA LOGIC ---
        function checkVigencia() {
            const resultBox = document.getElementById('vigenciaResultBox');
            const resultText = document.getElementById('vigenciaResultText');
            const resultSubText = document.getElementById('vigenciaResultSubText');

            if (AppState.timelinePeriods.length === 0) {
                resultBox.className = 'p-4 rounded-lg md:col-span-3 bg-gray-100 text-gray-800';
                resultText.textContent = 'Información Insuficiente';
                resultSubText.textContent = 'No se puede determinar la vigencia sin un historial laboral.';
                return;
            }

            const lastPeriod = [...AppState.timelinePeriods].sort((a, b) => b.fechaFin - a.fechaFin)[0];
            const fechaReferenciaBaja = lastPeriod.fechaFin;

            // Condition 1: Check for 365 days in the 5 years prior to the reference date
            const fechaInicioPeriodoRevision = new Date(fechaReferenciaBaja);
            fechaInicioPeriodoRevision.setUTCFullYear(fechaInicioPeriodoRevision.getUTCFullYear() - 5);

            let diasCotizadosUltimos5Anos = 0;
            AppState.fullHistoryPeriods.forEach(period => {
                const startOverlap = Math.max(period.fechaInicio.getTime(), fechaInicioPeriodoRevision.getTime());
                const endOverlap = Math.min(period.fechaFin.getTime(), fechaReferenciaBaja.getTime());

                if (startOverlap <= endOverlap) {
                    const overlapDays = (endOverlap - startOverlap) / (1000 * 60 * 60 * 24) + 1;
                    diasCotizadosUltimos5Anos += overlapDays;
                }
            });
            
            diasCotizadosUltimos5Anos = Math.round(diasCotizadosUltimos5Anos);

            if (diasCotizadosUltimos5Anos < 365) {
                resultBox.className = 'p-4 rounded-lg md:col-span-3 bg-red-100 text-red-800';
                resultText.textContent = 'NO VIGENTE';
                resultSubText.textContent = `No se cumplen los 365 días cotizados en los 5 años previos a la baja (${formatDateDDMMYYYY(fechaReferenciaBaja)}). Días cotizados: ${diasCotizadosUltimos5Anos}.`;
                return;
            }

            // Condition 2: Check the 5-year conservation period from the reference date
            const expirationDate = new Date(fechaReferenciaBaja);
            expirationDate.setUTCFullYear(expirationDate.getUTCFullYear() + 5);

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const formattedReferenciaBaja = formatDateDDMMYYYY(fechaReferenciaBaja);
            const formattedExpirationDate = formatDateDDMMYYYY(expirationDate);

            if (today <= expirationDate) {
                resultBox.className = 'p-4 rounded-lg md:col-span-3 bg-green-100 text-green-800';
                resultText.textContent = 'VIGENTE';
                resultSubText.textContent = `La conservación de derechos vence el ${formattedExpirationDate}. Calculado 5 años desde la última baja (real o proyectada): ${formattedReferenciaBaja}.`;
            } else {
                resultBox.className = 'p-4 rounded-lg md:col-span-3 bg-red-100 text-red-800';
                resultText.textContent = 'NO VIGENTE';
                resultSubText.textContent = `La conservación de derechos venció el ${formattedExpirationDate}. Calculado 5 años desde la última baja (real o proyectada): ${formattedReferenciaBaja}.`;
            }
        }
        
        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeMainAppDisplay();
            document.getElementById('agreementCheckbox').addEventListener('change', (e) => {
                document.getElementById('acceptAgreementButton').disabled = !e.target.checked;
            });
            document.getElementById('login_password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            document.getElementById('agreementDate').textContent = new Date().toLocaleDateString('es-MX', { day: 'numeric', month: 'long', year: 'numeric' });
            
            // Admin button listeners
            document.getElementById('downloadLoginLogsBtn').addEventListener('click', () => window.downloadLogs('login_logs'));
            document.getElementById('resetLoginLogsBtn').addEventListener('click', () => window.resetLogs('login_logs', 'de inicio de sesión'));
            document.getElementById('downloadCalcLogsBtn').addEventListener('click', () => window.downloadLogs('calculation_logs'));
            document.getElementById('resetCalcLogsBtn').addEventListener('click', () => window.resetLogs('calculation_logs', 'de cálculos'));

            showElement('confidentialityModal');
        });

        // --- Make functions globally accessible ---
        window.handleLogin = handleLogin;
        window.acceptAgreement = acceptAgreement;
        window.showSection = showSection;
        window.addEmploymentCard = addEmploymentCard;
        window.removeEmploymentCard = removeEmploymentCard;
        window.analizarYCalcularSBC = analizarYCalcularSBC;
        window.actualizarSBCMaximoM40 = actualizarSBCMaximoM40;
        window.actualizarFechaFinM40Display = actualizarFechaFinM40Display;
        window.handleM40StartDateChange = handleM40StartDateChange;
        window.calcularEscenarioM40Infografia = calcularEscenarioM40Infografia;
        window.handleMesesDepositoChange = handleMesesDepositoChange;
        window.recalculateScenario = recalculateScenario;
        window.promptForClientPDF = promptForClientPDF;
        window.promptForDirectorPDF = promptForDirectorPDF;
        window.generateFullReportPDF = generateFullReportPDF;
        window.generateContractPDF = generateContractPDF;
        window.closeCustomAlert = closeCustomAlert;
        window.analizarTextoCompleto = analizarTextoCompleto;
        window.renderSbcAnalysisTable = renderSbcAnalysisTable;
        window.addScenarioCard = addScenarioCard;
        window.recalculateAllScenarios = recalculateAllScenarios;
        window.removeScenarioCard = removeScenarioCard;
        window.checkVigencia = checkVigencia;
        window.toggleAutoCards = toggleAutoCards;
        window.logout = logout;
        window.showTooltip = (id) => { const el = document.getElementById(id); if(el) el.style.display = 'block'; };
        window.hideTooltip = (id) => { const el = document.getElementById(id); if(el) el.style.display = 'none'; };

    </script>
    
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, getDocs, query, orderBy, setDoc, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- THIS IS YOUR PERSONAL FIREBASE CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyAXybwS6HP7TUoNtvFZLo6_dDFCP6EHbC0",
          authDomain: "rgc-pensiones-y-seguros.firebaseapp.com",
          projectId: "rgc-pensiones-y-seguros",
          storageBucket: "rgc-pensiones-y-seguros.firebasestorage.app",
          messagingSenderId: "1022012486807",
          appId: "1:1022012486807:web:443f9114ad5a4d809fa5d2",
          measurementId: "G-EFQ3EP0GYN"
        };
        window.firebaseConfig = firebaseConfig; // Make it globally accessible for the console script

        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---
        let db;
        const appId = firebaseConfig.appId;

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            db = getFirestore(app);
            await signInAnonymously(auth);
            console.log("Firebase initialized and user authenticated.");
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            if (error.code === 'auth/network-request-failed') {
                showCustomAlert("No se pudo conectar con la base de datos. Las funciones de guardado de clientes y registros estarán desactivadas.", "Error de Conexión");
            }
            db = null; // Disable DB functionalities on error
        }

        // --- USER & AUTH MANAGEMENT (from Firestore) ---
        window.getUserByUsername = async (username) => {
            if (!db) return null;
            try {
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, username);
                const userSnap = await getDoc(userDocRef);
                if (userSnap.exists()) {
                    return userSnap.data();
                } else {
                    console.log("No such user!");
                    return null;
                }
            } catch (error) {
                console.error("Error getting user:", error);
                return null;
            }
        };


        // --- Logging Functions ---
        window.logLoginEvent = async (asesorName) => {
            if (!db) return console.error("Firestore DB not initialized. Cannot log login event.");
            try {
                const loginLogsCollection = collection(db, `artifacts/${appId}/public/data/login_logs`);
                await addDoc(loginLogsCollection, {
                    asesor: asesorName,
                    timestamp: serverTimestamp(),
                    location: AppState.adviserLocation // Log the location
                });
                console.log("Login event logged for:", asesorName);
            } catch (error) {
                console.error("Error logging login event:", error);
            }
        };

        window.logCalculationEvent = async (scenarioNumber, data) => {
            if (!db || !data || Object.keys(data).length === 0) {
                 console.error("Firestore DB not initialized or no data to log. Cannot log calculation.");
               return null;
            }
            try {
                // Remove large/unnecessary data before logging
                const logData = { ...data };
                delete logData.proyeccion; 
                delete logData.desgloseM40;
                delete logData.finalTimelinePeriods;

                const calcLogsCollection = collection(db, `artifacts/${appId}/public/data/calculation_logs`);
                const docRef = await addDoc(calcLogsCollection, {
                    asesor: AppState.nombreAsesorGlobal,
                    cliente: AppState.datosClienteInfo.nombre || 'No especificado',
                    curp: AppState.datosClienteInfo.curp || 'No especificado',
                    telefono: AppState.datosClienteInfo.telefono || 'No especificado',
                    timestamp: serverTimestamp(),
                    scenarioNumber: scenarioNumber,
                    calculationData: JSON.stringify(logData) 
                });
                console.log(`Calculation logged for scenario ${scenarioNumber} with ID: ${docRef.id}`);
                return docRef.id;
            } catch (error) {
                console.error("Error logging calculation event:", error);
                return null;
            }
        };
        
        // --- CRM Functions ---
        window.autoSaveClient = async () => {
            if (!db) return;
            const { nombre, curp, telefono } = AppState.datosClienteInfo;
            const scenario1 = AppState.scenarioData[1];
            if (!nombre || !curp || !scenario1 || !scenario1.costoTotalContrato) {
                return;
            }
            
            const clientData = {
                nombre: nombre,
                telefono: telefono,
                curp: curp,
                precioVenta: scenario1.costoTotalContrato,
                pensionBruta: scenario1.pensionMensual,
                pensionNeta: parseFloat(scenario1.proyeccion[0][3].replace(/[$,]/g, '')),
                mesesM40: scenario1.meses,
                fechaRegistro: serverTimestamp(),
                estatus: "Prospecto",
                asesor: AppState.nombreAsesorGlobal,
            };

            try {
                const clientDocRef = doc(db, `artifacts/${appId}/public/data/clients`, clientData.curp);
                await setDoc(clientDocRef, clientData, { merge: true });
                console.log(`Client ${clientData.nombre} auto-saved/updated in CRM.`);
            } catch (error) {
                console.error("Error auto-saving client:", error);
            }
        };

        window.loadClients = async () => {
            if (!db) return;
            const tableBody = document.getElementById('clientsTableBody');
            tableBody.innerHTML = '<tr><td colspan="8" class="text-center p-4">Cargando clientes...</td></tr>';
            
            try {
                const clientsCollection = collection(db, `artifacts/${appId}/public/data/clients`);
                const q = query(clientsCollection, orderBy("nombre", "asc"));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="8" class="text-center p-4">No hay clientes en la cartera.</td></tr>';
                    return;
                }

                let rowsHtml = '';
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    rowsHtml += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-2">${data.nombre}</td>
                            <td class="p-2">${data.telefono || 'N/A'}</td>
                            <td class="p-2">${data.curp}</td>
                            <td class="p-2 text-right">$${formatNumber(data.precioVenta || 0)}</td>
                            <td class="p-2 text-right">$${formatNumber(data.pensionBruta || 0)}</td>
                            <td class="p-2 text-right">$${formatNumber(data.pensionNeta || 0)}</td>
                            <td class="p-2 text-center">${data.mesesM40 || 'N/A'}</td>
                            <td class="p-2 text-center">
                                <button onclick="showClientDetails('${doc.id}')" class="btn btn-blue btn-sm !p-2 text-xs">
                                    <i class="fas fa-eye"></i> Ver Detalles
                                </button>
                            </td>
                        </tr>
                    `;
                });
                tableBody.innerHTML = rowsHtml;
            } catch (error) {
                console.error("Error loading clients:", error);
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center p-4 text-red-500">Error al cargar clientes. Verifique la consola.</td></tr>';
            }
        };

        window.showClientDetails = async (clientId) => {
            if (!db) return;
            try {
                const clientDocRef = doc(db, `artifacts/${appId}/public/data/clients`, clientId);
                const clientSnap = await getDoc(clientDocRef);

                if (!clientSnap.exists()) {
                    showCustomAlert("No se pudo encontrar al cliente.", "Error");
                    return;
                }
                const clientData = clientSnap.data();
                
                document.getElementById('clientDetailsName').textContent = `Detalles de: ${clientData.nombre}`;
                const infoPanel = document.getElementById('clientInfoPanel');
                infoPanel.innerHTML = `
                    <p><strong>Teléfono:</strong> ${clientData.telefono}</p>
                    <p><strong>CURP:</strong> ${clientData.curp}</p>
                    <p><strong>Asesor:</strong> ${clientData.asesor}</p>
                    <p><strong>Estatus:</strong> <span class="font-bold text-blue-600">${clientData.estatus}</span></p>
                    <hr class="my-2">
                    <p><strong>Última Pensión Bruta Calculada:</strong> $${formatNumber(clientData.pensionBruta)}</p>
                    <p><strong>Última Pensión Neta Calculada:</strong> $${formatNumber(clientData.pensionNeta)}</p>
                `;

                const saveNoteButton = document.getElementById('saveNoteButton');
                saveNoteButton.onclick = () => saveNoteForClient(clientId);

                await loadClientNotes(clientId);
                showElement('clientDetailsModal');

            } catch(error) {
                console.error("Error fetching client details:", error);
                showCustomAlert("Error al cargar los detalles del cliente.", "Error");
            }
        };

        async function loadClientNotes(clientId) {
            const notesContainer = document.getElementById('clientNotesContainer');
            notesContainer.innerHTML = '<p>Cargando notas...</p>';
            try {
                const notesCollection = collection(db, `artifacts/${appId}/public/data/clients/${clientId}/notes`);
                const q = query(notesCollection, orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    notesContainer.innerHTML = '<p class="text-gray-500">No hay notas para este cliente.</p>';
                    return;
                }

                let rowsHtml = '';
                querySnapshot.forEach(doc => {
                    const note = doc.data();
                    const date = note.timestamp ? note.timestamp.toDate().toLocaleString('es-MX') : 'Fecha no disponible';
                    rowsHtml += `
                        <div class="bg-white p-2 rounded border">
                            <p class="text-xs text-gray-500">${date} - ${note.asesor}</p>
                            <p class="text-sm">${note.text}</p>
                        </div>
                    `;
                });
                notesContainer.innerHTML = rowsHtml;
            } catch (error) {
                console.error("Error loading notes:", error);
                notesContainer.innerHTML = '<p class="text-red-500">Error al cargar las notas.</p>';
            }
        }

        async function saveNoteForClient(clientId) {
            const noteText = document.getElementById('newNoteText').value.trim();
            if (!noteText) {
                showCustomAlert("Por favor, escribe una nota.", "Campo Vacío");
                return;
            }

            try {
                const notesCollection = collection(db, `artifacts/${appId}/public/data/clients/${clientId}/notes`);
                await addDoc(notesCollection, {
                    text: noteText,
                    asesor: AppState.nombreAsesorGlobal,
                    timestamp: serverTimestamp()
                });
                document.getElementById('newNoteText').value = '';
                await loadClientNotes(clientId);
            } catch (error) {
                console.error("Error saving note:", error);
                showCustomAlert("No se pudo guardar la nota.", "Error");
            }
        }
        
        // --- Admin Panel Functions ---
        async function loadAdminPanelData() {
            await loadLoginLogs();
            await loadCalcLogs();
            await loadAdvisorsForAdmin();
        }
        window.loadAdminPanelData = loadAdminPanelData;
        
        async function loadLoginLogs() {
            if (!db) return;
            const tableBody = document.getElementById('loginLogsTableBody');
            tableBody.innerHTML = '<tr><td colspan="2" class="text-center p-4">Cargando registros...</td></tr>';
            
            try {
                const logsCollection = collection(db, `artifacts/${appId}/public/data/login_logs`);
                const q = query(logsCollection, orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="2" class="text-center p-4">No hay registros de inicio de sesión.</td></tr>';
                    return;
                }

                let rowsHtml = '';
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const fecha = data.timestamp ? data.timestamp.toDate().toLocaleString('es-MX') : 'N/A';
                    rowsHtml += `
                        <tr class="border-b">
                            <td class="p-2">${data.asesor}</td>
                            <td class="p-2">${fecha}</td>
                        </tr>
                    `;
                });
                tableBody.innerHTML = rowsHtml;
            } catch (error) {
                console.error("Error loading login logs:", error);
                tableBody.innerHTML = '<tr><td colspan="2" class="text-center p-4 text-red-500">Error al cargar registros.</td></tr>';
            }
        };

        async function loadCalcLogs() {
            if (!db) return;
            const tableBody = document.getElementById('calcLogsTableBody');
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Cargando registros...</td></tr>';
            
            try {
                const logsCollection = collection(db, `artifacts/${appId}/public/data/calculation_logs`);
                const q = query(logsCollection, orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4">No hay registros de cálculos.</td></tr>';
                    return;
                }

                let rowsHtml = '';
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const calcData = JSON.parse(data.calculationData);
                    const fecha = data.timestamp ? data.timestamp.toDate().toLocaleString('es-MX') : 'N/A';
                    const details = `
                        Semanas: ${calcData.semanas}<br>
                        SBC Final: $${formatNumber(calcData.sbcPromedio)}<br>
                        Edad: ${calcData.edadFinM40.anos}a, ${calcData.edadFinM40.meses}m<br>
                        Costo: $${formatNumber(calcData.costoTotalContrato)}<br>
                        AFORE: $${formatNumber(calcData.coberturaAfore)}<br>
                        1er Dep: $${formatNumber(calcData.coberturaDeposito)}<br>
                        Extra: $${formatNumber(calcData.coberturaExtra)}<br>
                        Préstamo: $${formatNumber(calcData.prestamoRequerido)}
                    `;

                    rowsHtml += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-2 text-xs">${fecha}</td>
                            <td class="p-2">${data.asesor}</td>
                            <td class="p-2">${data.cliente}</td>
                            <td class="p-2">${data.curp}</td>
                            <td class="p-2">${data.telefono}</td>
                            <td class="p-2 text-xs">${details}</td>
                        </tr>
                    `;
                });
                tableBody.innerHTML = rowsHtml;
            } catch (error) {
                console.error("Error loading calculation logs:", error);
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-red-500">Error al cargar registros.</td></tr>';
            }
        };

        async function loadAdvisorsForAdmin() {
            if (!db) return;
            const tableBody = document.getElementById('advisorsTableBody');
            tableBody.innerHTML = '<tr><td colspan="2" class="text-center p-4">Cargando asesores...</td></tr>';

            try {
                const usersCollection = collection(db, `artifacts/${appId}/public/data/users`);
                const q = query(usersCollection, orderBy("user", "asc"));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="2" class="text-center p-4">No se encontraron asesores. Ejecuta el script de carga.</td></tr>';
                    return;
                }
                
                let rowsHtml = '';
                querySnapshot.forEach(doc => {
                    const advisor = doc.data();
                    if(advisor.role === 'admin') return;
                    const isChecked = advisor.status === 'active' ? 'checked' : '';
                    rowsHtml += `
                        <tr class="border-b">
                            <td class="p-2">${advisor.user}</td>
                            <td class="p-2 text-center">
                                <label class="switch">
                                    <input type="checkbox" onchange="toggleAdvisorStatus('${advisor.user}', this.checked)" ${isChecked}>
                                    <span class="slider"></span>
                                </label>
                            </td>
                        </tr>
                    `;
                });
                tableBody.innerHTML = rowsHtml;

            } catch (error) {
                console.error("Error loading advisors:", error);
                tableBody.innerHTML = '<tr><td colspan="2" class="text-center p-4 text-red-500">Error al cargar asesores.</td></tr>';
            }
        }

        window.toggleAdvisorStatus = async (username, isChecked) => {
            if (!db) return;
            const newStatus = isChecked ? 'active' : 'inactive';
            try {
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, username);
                await updateDoc(userDocRef, {
                    status: newStatus
                });
                console.log(`Set status for ${username} to ${newStatus}`);
                showCustomAlert(`El estado de ${username} ha sido actualizado a '${newStatus}'.`, "Éxito");
            } catch (error) {
                console.error("Error updating advisor status:", error);
                showCustomAlert("No se pudo actualizar el estado del asesor.", "Error");
            }
        };
        
        function flattenObject(ob) {
            var toReturn = {};
            for (var i in ob) {
                if (!ob.hasOwnProperty(i)) continue;

                if ((typeof ob[i]) == 'object' && ob[i] !== null && !Array.isArray(ob[i])) {
                    var flatObject = flattenObject(ob[i]);
                    for (var x in flatObject) {
                        if (!flatObject.hasOwnProperty(x)) continue;
                        toReturn[i + '.' + x] = flatObject[x];
                    }
                } else {
                    toReturn[i] = ob[i];
                }
            }
            return toReturn;
        }

        window.downloadLogs = async (logType) => {
            if (!db) {
                showCustomAlert("La base de datos no está disponible.", "Error");
                return;
            }
            const logsCollection = collection(db, `artifacts/${appId}/public/data/${logType}`);
            const querySnapshot = await getDocs(logsCollection);

            if (querySnapshot.empty) {
                showCustomAlert("No hay registros para descargar.", "Información");
                return;
            }

            let csvContent = "";
            const headers = new Set();
            const dataRows = [];

            querySnapshot.forEach(doc => {
                const data = doc.data();
                let rowData = {};

                if (logType === 'login_logs') {
                    rowData = {
                        asesor: data.asesor,
                        timestamp: data.timestamp ? data.timestamp.toDate().toISOString() : '',
                        'location.lat': data.location?.lat,
                        'location.lon': data.location?.lon,
                        'location.error': data.location?.error
                    };
                } else if (logType === 'calculation_logs') {
                    const calcData = JSON.parse(data.calculationData || '{}');
                    const flatCalcData = flattenObject(calcData);
                    rowData = {
                        asesor: data.asesor,
                        cliente: data.cliente,
                        curp: data.curp,
                        telefono: data.telefono,
                        timestamp: data.timestamp ? data.timestamp.toDate().toISOString() : '',
                        scenarioNumber: data.scenarioNumber,
                        ...flatCalcData
                    };
                }
                
                Object.keys(rowData).forEach(key => headers.add(key));
                dataRows.push(rowData);
            });

            const headerArray = Array.from(headers);
            csvContent += headerArray.join(',') + '\r\n';

            dataRows.forEach(row => {
                const rowValues = headerArray.map(header => {
                    let val = row[header];
                    if (val === null || val === undefined) val = '';
                    let stringVal = String(val);
                    if (stringVal.includes(',')) stringVal = `"${stringVal}"`;
                    return stringVal;
                });
                csvContent += rowValues.join(',') + '\r\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `${logType}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        window.resetLogs = (logType, logTypeName) => {
            document.getElementById('customAlertTitle').textContent = `Confirmar Reseteo`;
            document.getElementById('customAlertMessage').textContent = `¿Estás seguro de que quieres borrar TODOS los registros ${logTypeName}? Esta acción no se puede deshacer. Se recomienda descargar los datos primero.`;
            
            const confirmBtn = document.getElementById('customAlertButton');
            const cancelBtn = document.getElementById('customAlertCancelButton');
            
            confirmBtn.textContent = 'Sí, Borrar';
            confirmBtn.className = 'btn !bg-red-600 hover:!bg-red-700 !text-white';
            cancelBtn.style.display = 'inline-flex';

            cancelBtn.onclick = closeCustomAlert;

            confirmBtn.onclick = async () => {
                if (!db) {
                    showCustomAlert("La base de datos no está disponible.", "Error");
                    return;
                }
                try {
                    const logsCollection = collection(db, `artifacts/${appId}/public/data/${logType}`);
                    const querySnapshot = await getDocs(logsCollection);
                    const deletePromises = [];
                    querySnapshot.forEach(doc => {
                        deletePromises.push(deleteDoc(doc.ref));
                    });
                    await Promise.all(deletePromises);
                    showCustomAlert(`Se han borrado todos los registros ${logTypeName}.`, 'Éxito');
                    loadAdminPanelData(); // Refresh panel
                } catch(error) {
                    console.error(`Error reseting ${logType}:`, error);
                    showCustomAlert(`Ocurrió un error al borrar los registros.`, 'Error');
                } finally {
                    closeCustomAlert();
                }
            };
            showElement('customAlertModal');
        };

    </script>
</body>
</html>






