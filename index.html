<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RGC Pensiones - Calculadora de Proyección</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js" type="module"></script>

    <style>
        :root {
            --dark-blue: #003366; /* Azul marino profundo */
            --gold: #D4AF37;      /* Oro metálico */
            --dark-gold: #B8860B; /* Oro oscuro para hover */
            --text-dark: #1A202C;  /* Casi negro */
            --text-medium: #4A5568;/* Gris oscuro */
            --bg-light: #F8F9FA;  /* Gris muy claro */
            --white: #FFFFFF;
            --border-color: #E2E8F0;
            --success-color: #16A34A;
            --danger-color: #DC2626;
        }
        body {  
            font-family: 'Lato', sans-serif;  
            background-color: var(--bg-light);
            color: var(--text-medium);
        }
        /* ... (el resto de tus estilos CSS permanecen aquí sin cambios) ... */
        .main-header { background: linear-gradient(135deg, var(--dark-blue) 0%, #002244 100%); color: var(--white); padding: 2.5rem 1rem; text-align: center; border-radius: 0 0 40px 40px; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); margin-bottom: 3rem; position: relative; }
        .logo-text-elegant { font-family: 'Playfair Display', serif; font-weight: 700; font-size: 2.5rem; color: var(--gold); text-shadow: 1px 1px 2px rgba(0,0,0,0.4); letter-spacing: 1px; }
        .main-header .logo-text-elegant { font-size: 2rem; margin-bottom: 1rem; }
        .main-header h1 { font-family: 'Lato', sans-serif; font-weight: 900; font-size: 2.25rem; letter-spacing: -0.5px; }
        .main-header p { font-size: 1.125rem; opacity: 0.85; font-weight: 400; }
        .infographic-section { background-color: var(--white); border-radius: 20px; padding: 2rem 2.5rem; margin-bottom: 2.5rem; box-shadow: 0 8px 30px rgba(0, 51, 102, 0.08); border: 1px solid var(--border-color); border-top: 6px solid var(--dark-blue); position: relative; }
        .infographic-section h2 { font-family: 'Lato', sans-serif; font-weight: 900; font-size: 1.75rem; margin-bottom: 2rem; color: var(--dark-blue); display: flex; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
        .infographic-section h2 i { margin-right: 1rem; font-size: 1.5rem; color: var(--gold); }
        .infographic-section h3.subsection-title { font-family: 'Lato', sans-serif; font-weight: 700; font-size: 1.25rem; color: var(--dark-blue); margin-top: 2rem; margin-bottom: 1.5rem; }
        .input-group label { font-weight: 700; margin-bottom: 0.75rem; color: var(--text-medium); font-size: 0.875rem; display: block; }
        .input-group input[type="text"], .input-group input[type="password"], .input-group input[type="number"], .input-group input[type="month"], .input-group input[type="date"], .input-group select, .input-group textarea { padding: 0.8rem 1rem; border: 1px solid #CBD5E0; border-radius: 0.5rem; font-size: 1rem; width: 100%; transition: all 0.2s ease-in-out; background-color: #FDFDFD; }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus { border-color: var(--gold); box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2); outline: none; }
        .input-group input[readonly] { background-color: #E9ECEF; cursor: not-allowed; }
        .btn { font-family: 'Lato', sans-serif; font-weight: 700; padding: 0.8rem 2rem; border-radius: 0.5rem; transition: all 0.25s ease-out; border: none; cursor: pointer; text-transform: uppercase; letter-spacing: 0.8px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn:disabled { background: #A0AEC0; color: #E2E8F0; cursor: not-allowed; box-shadow: none; transform: none; }
        .btn-gold { background: linear-gradient(135deg, var(--gold), var(--dark-gold)); color: var(--dark-blue); }
        .btn-gold:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(212, 175, 55, 0.3); }
        .btn-blue { background: linear-gradient(135deg, var(--dark-blue), #004488); color: var(--white); }
        .btn-blue:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0, 51, 102, 0.3); }
        .btn-secondary { background-color: var(--white); color: var(--dark-blue); border: 2px solid var(--dark-blue); padding: 0.7rem 1.5rem; }
        .btn-secondary:hover:not(:disabled) { background-color: var(--dark-blue); color: var(--white); }
        .btn-danger-icon { background-color: #FFF1F2; color: #E53E3E; border: 1px solid #E53E3E; padding: 0.5rem; width: 32px; height: 32px; border-radius: 50%; }
        .btn-danger-icon:hover { background-color: #E53E3E; color: var(--white); }
        .employment-card { background-color: #F8F9FA; border: 1px solid #E2E8F0; border-left: 5px solid var(--dark-blue); border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem; position: relative; }
        #loginContainer { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background-color: var(--bg-light); z-index: 40; opacity: 0; transition: opacity 0.5s ease-in-out; pointer-events: none; }
        #loginContainer.active { opacity: 1; pointer-events: auto; }
        .login-box { background-color: var(--white); padding: 3rem; border-radius: 20px; box-shadow: 0 10px 40px rgba(0, 51, 102, 0.15); width: 100%; max-width: 450px; border-top: 6px solid var(--gold); }
        .login-box h2 { font-family: 'Lato', sans-serif; font-weight: 900; font-size: 2rem; color: var(--dark-blue); text-align: center; margin-bottom: 2.5rem; }
        .modal-overlay { position: fixed; inset: 0; background-color: rgba(0, 34, 68, 0.7); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: var(--white); padding: 2.5rem; border-radius: 20px; box-shadow: 0 10px 40px rgba(0, 51, 102, 0.2); max-width: 90%; width: 650px; border-top: 6px solid var(--gold); transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-content-alert { text-align: center; width: 400px; }
        .modal-content h2 { font-family: 'Lato', sans-serif; color: var(--dark-blue); font-size: 1.5rem; font-weight: 700; text-align: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        .privacy-text-container { border: 1px solid var(--border-color); padding: 1rem 1.5rem; border-radius: 0.75rem; background-color: var(--bg-light); max-height: 55vh; overflow-y: auto; margin-bottom: 1.5rem; }
        .privacy-text-container p { font-size: 0.875rem; line-height: 1.6; margin-bottom: 1rem; }
        .privacy-text-container::-webkit-scrollbar { width: 8px; }
        .privacy-text-container::-webkit-scrollbar-track { background: var(--border-color); border-radius: 10px; }
        .privacy-text-container::-webkit-scrollbar-thumb { background-color: var(--gold); border-radius: 10px; }
        .app-footer { text-align: center; margin-top: 4rem; padding: 2.5rem 1rem; background-color: var(--dark-blue); color: var(--white); border-radius: 40px 40px 0 0; }
        .app-footer .logo-text-footer { font-family: 'Playfair Display', serif; color: var(--gold); font-weight: 700; font-size: 1.25rem; margin-bottom: 1rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
        .app-footer p { opacity: 0.8; }
        #sessionTimerContainer { position: fixed; top: 1rem; right: 1rem; background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); padding: 0.5rem 1rem; border-radius: 0.5rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-family: 'Lato', sans-serif; font-weight: 700; color: var(--text-dark); z-index: 100; transition: color 0.3s; }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; }
        .menu-card { background: var(--white); border-radius: 1rem; padding: 2rem; text-align: center; box-shadow: 0 8px 30px rgba(0, 51, 102, 0.08); border: 1px solid var(--border-color); transition: transform 0.3s ease, box-shadow 0.3s ease; cursor: pointer; }
        .menu-card:hover { transform: translateY(-8px); box-shadow: 0 12px 40px rgba(0, 51, 102, 0.12); }
        .menu-card i { font-size: 3rem; color: var(--gold); margin-bottom: 1.5rem; }
        .menu-card h3 { font-size: 1.25rem; font-weight: 700; color: var(--dark-blue); margin-bottom: 0.5rem; }
        .menu-card p { font-size: 0.875rem; color: var(--text-medium); }
        #timeline-tooltip { position: absolute; text-align: left; padding: 8px 12px; font-size: 12px; background: #2d3748; color: white; border: 0px; border-radius: 8px; pointer-events: none; opacity: 0; transition: opacity 0.2s; z-index: 10; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--dark-blue); }
        input:checked + .slider:before { transform: translateX(26px); }
    </style>
</head>
<body>
    
    <div id="confidentialityModal" class="modal-overlay">
        <div class="modal-content">
            <h2>CARTA COMPROMISO DE CONFIDENCIALIDAD</h2>
            <div class="privacy-text-container">
                 <p><strong>Fecha:</strong> <span id="agreementDate"></span><br><strong>Lugar:</strong> Ciudad de México, México</p>
                 <p>En mi calidad de Asesor para RGC Pensiones y Seguros, manifiesto y acepto de manera voluntaria los siguientes términos y condiciones:</p>
                 <p><strong>1. ANTECEDENTES</strong><br>Reconozco que, en virtud de mi relación profesional con RGC Pensiones, se me ha proporcionado acceso a una herramienta de software especializada (en adelante, "la Herramienta"), la cual es fundamental para el desempeño de mis funciones.</p>
                 <p><strong>2. PROPIEDAD INTELECTUAL</strong><br>Declaro tener pleno conocimiento de que la Herramienta es propiedad intelectual exclusiva del C. Ivan Roberto Ortiz Cano, y que RGC Pensiones cuenta con la licencia y autorización para su uso con fines corporativos específicos. Entiendo que mi acceso a la misma es una concesión temporal y está estrictamente limitado al ejercicio de mis responsabilidades dentro de esta empresa.</p>
                 <p><strong>3. COMPROMISO DE USO EXCLUSIVO</strong><br>Me comprometo de manera irrevocable a utilizar la Herramienta única y exclusivamente para los fines y objetivos de negocio de RGC Pensiones. Me doy por enterado de que existe un límite de dos (2) descargas de reportes en formato PDF por cada inicio de sesión.</p>
                 <p><strong>4. PROHIBICIONES ESPECÍFICAS</strong><br>Queda estrictamente prohibido y me obligo a abstenerme de:<br>
                 a) Utilizar la Herramienta, sus funciones, datos, metodologías o resultados para obtener cualquier tipo de lucro o beneficio personal, directo o indirecto.<br>
                 b) Emplear la Herramienta para prestar servicios, asesorías o realizar actividades para terceros, ya sean personas físicas o morales, ajenos a RGC Pensiones.<br>
                 c) Copiar, reproducir, modificar, distribuir, vender, sublicenciar, descompilar o realizar ingeniería inversa de la Herramienta o cualquiera de sus componentes.<br>
                 d) Compartir mis credenciales de acceso (contraseña o cualquier otra forma de acceso) con cualquier otra persona, dentro o fuera de la organización.<br>
                 e) Utilizar la Herramienta fuera de las instalaciones y oficinas de RGC Pensiones.</p>
                 <p><strong>5. CONSECUENCIAS DEL INCUMPLIMIENTO</strong><br>Entiendo y acepto que el incumplimiento de cualquiera de los puntos estipulados en esta carta será considerado una falta grave y se podrá dar lugar a:<br>
                 a) Concluir la relación profesional y comercial con RGC Pensiones, sin responsabilidad para la empresa.<br>
                 b) El inicio de acciones legales en mi contra por parte de RGC Pensiones y/o del Sr. Ivan Roberto Ortiz Cano, titular de la propiedad intelectual, para reclamar la reparación de los daños y perjuicios ocasionados.</p>
                 <p>Este compromiso mantendrá su vigencia durante toda mi relación con RGC Pensiones y subsistirá incluso después de su terminación, por tiempo indefinido.</p>
                 <p>Habiendo leído y comprendido en su totalidad el presente documento, lo acepto de conformidad.</p>
            </div>
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <input type="checkbox" id="agreementCheckbox" class="h-5 w-5 text-blue-600 border-gray-400 rounded focus:ring-gold-500">
                    <label for="agreementCheckbox" class="ml-3 block text-sm text-gray-700 font-medium">
                        He leído, comprendido y acepto los términos.
                    </label>
                </div>
                <button id="acceptAgreementButton" onclick="acceptAgreement()" class="btn btn-gold" disabled>
                    Aceptar y Continuar
                </button>
            </div>
        </div>
    </div>

    <div id="sessionTimerContainer" style="display: none;">
        <i class="fas fa-clock mr-2"></i>Tiempo restante: <span id="sessionCountdown">15:00</span>
    </div>

    
    <div id="loginContainer">
        <div class="login-box">
            <div class="logo-text-elegant text-center mb-8">RGC Pensiones y Seguros</div>
            <h2>Acceso de Asesor</h2>
            <div class="input-group mb-4">
                <label for="login_asesor"><i class="fas fa-user-tie mr-2 opacity-70"></i>Usuario:</label>
                <input type="text" id="login_asesor" placeholder="Usuario" class="w-full">
            </div>
            <div class="input-group">
                <label for="login_password"><i class="fas fa-lock mr-2 opacity-70"></i>Contraseña:</label>
                <input type="password" id="login_password" placeholder="••••••••••" class="w-full">
            </div>
            <div class="text-center mt-8">
                <button id="loginButton" onclick="handleLogin()" class="btn btn-blue w-full">
                    <i class="fas fa-sign-in-alt"></i>Ingresar
                </button>
            </div>
            <div id="login_errorMessage" class="error-message-infographic" style="display: none; margin-top: 1.5rem;"><p></p></div>
        </div>
    </div>

    
    <div id="appContainer" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-6xl" style="display: none;">
        
        <div id="vigenciaAlertContainer" class="hidden mb-6"></div>
        
        <div id="mainMenuSection" style="display: none;">
            <header class="main-header">
                <div class="logo-text-elegant">RGC Pensiones y Seguros</div>
                <h1>Panel de Asesor</h1>
                <p>Selecciona una herramienta para comenzar.</p>
                <p id="asesorNameDisplay" class="text-lg font-semibold mt-2 opacity-90"></p>
                <button onclick="logout('Has cerrado sesión correctamente.')" class="btn !py-2 !px-4 text-sm absolute top-4 right-4 bg-red-100 !border-red-500 !text-red-600 hover:!bg-red-500 hover:!text-white">
                    <i class="fas fa-sign-out-alt"></i>Cerrar Sesión
                </button>
            </header>
            <div class="menu-grid">
                <div class="menu-card" id="menuCardCalculator" onclick="showSection('calculatorSection')">
                    <i class="fas fa-calculator"></i>
                    <h3>Cálculo de Pensión y Crédito</h3>
                    <p>Realiza proyecciones detalladas de pensión y financiamiento para clientes.</p>
                </div>
                <div class="menu-card" id="menuCardReverseCalculator" onclick="showSection('reverseCalcSection')">
                    <i class="fas fa-undo-alt"></i>
                    <h3>Cálculo Inverso</h3>
                    <p>Determina los meses de M40 necesarios para alcanzar una pensión objetivo.</p>
                </div>
                <div class="menu-card" id="menuCardCrm" onclick="showSection('crmSection')">
                    <i class="fas fa-users"></i>
                    <h3>Cartera de Clientes</h3>
                    <p>Gestiona y consulta la información de tus clientes.</p>
                </div>
                <div class="menu-card" id="menuCardQuickCalculator" onclick="showSection('quickCalcSection')">
                    <i class="fas fa-bolt"></i>
                    <h3>Cálculo Rápido</h3>
                    <p>Obtén una estimación de pensión al instante con datos básicos.</p>
                </div>
                <div id="adminMenuCard" class="menu-card md:col-span-2" onclick="showSection('adminSection')" style="display: none;">
                    <i class="fas fa-user-shield"></i>
                    <h3>Panel de Administrador</h3>
                    <p>Ver registros de actividad y gestionar asesores.</p>
                </div>
            </div>
        </div>

        <div id="quickCalcSection" style="display: none;">
            <div class="flex justify-between items-center mb-6">
                <button onclick="showSection('mainMenuSection')" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i>Volver al Menú</button>
            </div>
            <section class="infographic-section max-w-2xl mx-auto">
                <h2><i class="fas fa-bolt"></i>Herramienta de Cálculo Rápido</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="input-group">
                        <label for="quick_calc_age">Edad Actual (años):</label>
                        <input type="number" id="quick_calc_age" placeholder="Ej: 60">
                    </div>
                    <div class="input-group">
                        <label for="quick_calc_weeks">Semanas Totales:</label>
                        <input type="number" id="quick_calc_weeks" placeholder="Ej: 1500">
                    </div>
                    <div class="input-group">
                        <label for="quick_calc_sbc">SBC Promedio:</label>
                        <input type="number" id="quick_calc_sbc" placeholder="Ej: 1800">
                    </div>
                </div>
                <div class="text-center mt-8">
                    <button onclick="handleQuickCalc()" class="btn btn-gold"><i class="fas fa-play-circle mr-2"></i>Calcular Pensión</button>
                </div>
                <div id="quickCalcResult" class="mt-8 text-center" style="display: none;">
                    </div>
            </section>
        </div>

        <div id="reverseCalcSection" style="display: none;">
             <div class="flex justify-between items-center mb-6">
                <button onclick="showSection('mainMenuSection')" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i>Volver al Menú</button>
            </div>
            <section class="infographic-section max-w-3xl mx-auto">
                <h2><i class="fas fa-undo-alt"></i>Herramienta de Cálculo Inverso</h2>
                <div class="bg-blue-50 p-6 rounded-lg border border-blue-200">
                    <h3 class="subsection-title !mt-0">1. Ingrese los datos base del cliente:</h3>
                    <p class="text-sm text-gray-600 mb-6">Estos son los datos del cliente *antes* de iniciar la estrategia de Modalidad 40.</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="input-group">
                            <label for="reverse_calc_age">Edad Actual (años):</label>
                            <input type="number" id="reverse_calc_age" placeholder="Ej: 58">
                        </div>
                        <div class="input-group">
                            <label for="reverse_calc_weeks">Semanas Actuales:</label>
                            <input type="number" id="reverse_calc_weeks" placeholder="Ej: 1200">
                        </div>
                        <div class="input-group">
                            <label for="reverse_calc_sbc">SBC Promedio Actual:</label>
                            <input type="number" id="reverse_calc_sbc" placeholder="Ej: 550">
                        </div>
                    </div>
                </div>
                 <div class="mt-8">
                    <h3 class="subsection-title">2. Ingrese la pensión mensual deseada:</h3>
                     <div class="input-group max-w-sm mx-auto">
                         <label for="reverse_calc_target_pension">Pensión Mensual Objetivo ($):</label>
                         <input type="number" id="reverse_calc_target_pension" placeholder="Ej: 45000">
                     </div>
                </div>
                <div class="text-center mt-8">
                    <button onclick="handleReverseCalc()" class="btn btn-gold"><i class="fas fa-search-dollar mr-2"></i>Encontrar Meses Necesarios</button>
                </div>
                <div id="reverseCalcResult" class="mt-8 text-center bg-gray-50 p-6 rounded-lg" style="display: none;">
                    </div>
            </section>
        </div>

        
        <div id="calculatorSection" style="display: none;">
            <div class="flex justify-between items-center mb-6">
                <button onclick="showSection('mainMenuSection')" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i>Volver al Menú</button>
                <button onclick="logout('Has cerrado sesión correctamente.')" class="btn !py-2 !px-3 bg-red-100 !border-red-500 !text-red-600 hover:!bg-red-500 hover:!text-white text-sm">
                    <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesión
                </button>
            </div>
            
            <section id="infoSection1" class="infographic-section">
                <h2><i class="fas fa-user-edit"></i>Paso 1: Datos y Análisis de Historial</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-12 gap-y-8">
                    <div>
                        <h3 class="subsection-title !mt-0">Datos del Cliente</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 mb-8">
                            <div class="input-group">
                                <label for="info_nombreCompleto">Nombre Completo (Apellidos Nombre):</label>
                                <input type="text" id="info_nombreCompleto" placeholder="Se llena automático o manual" class="w-full">
                            </div>
                            <div class="input-group">
                                <label for="info_curpCliente">CURP:</label>
                                <input type="text" id="info_curpCliente" placeholder="Se llena automático o manual" maxlength="18" oninput="this.value = this.value.toUpperCase();" class="w-full">
                            </div>
                             <div class="input-group">
                                 <label for="info_telefonoCliente">Teléfono (10 dígitos):</label>
                                 <input type="text" id="info_telefonoCliente" placeholder="5512345678" maxlength="10" class="w-full">
                             </div>
                            <div class="input-group">
                                <label for="info_semanasTotalesManual">Semanas Totales Cotizadas:</label>
                                <input type="number" id="info_semanasTotalesManual" placeholder="Se llena automático o manual" class="w-full">
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="subsection-title !mt-0">Fuente de Datos del Historial</h3>
                        <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-6">
                             <div class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-700 p-4 rounded-md mb-6" role="alert">
                                 <p class="font-bold">¡Importante!</p>
                                 <p class="text-sm">Para el análisis automático, convierte el PDF de la constancia del IMSS a Word, copia todo el texto y pégalo abajo.</p>
                                 <a href="https://www.ilovepdf.com/es/pdf_a_word" target="_blank" class="btn btn-gold mt-4 text-sm !py-2">
                                     <i class="fas fa-file-word"></i> Ir al Conversor PDF a Word
                                 </a>
                             </div>

                        <div class="input-group">
                            <label for="info_textoCompleto">Pegue aquí el texto convertido:</label>
                            <textarea id="info_textoCompleto" class="w-full font-mono text-sm" rows="8" placeholder="Pegue todo el texto, desde el nombre del cliente hasta el último movimiento..."></textarea>
                        </div>
                        <div class="text-center mt-4">
                            <button onclick="analizarTextoCompleto()" class="btn btn-blue">
                                <i class="fas fa-magic"></i> Extraer y Analizar Texto
                            </button>
                        </div>
                        </div>
                        
                        <div>
                            <h3 class="subsection-title">... O ingrese los datos manualmente:</h3>
                             <div id="employmentCardsContainerWrapper">
                                 <button id="toggleCardsBtn" onclick="toggleAutoCards()" class="btn btn-secondary mb-4" style="display: none;">Mostrar/Ocultar Tarjetas Automáticas</button>
                                 <div id="employmentCardsContainer" style="display: none;"></div>
                             </div>
                            <button onclick="addEmploymentCard()" class="btn btn-secondary mt-4"><i class="fas fa-plus mr-2"></i>Agregar Empleo Manualmente</button>
                        </div>
                    </div>
                </div>


                <div id="sbcAnalysisResultsContainer" class="mt-12 pt-8 border-t" style="display: none;">
                    <h3 class="subsection-title">Resultados del Análisis</h3>
                    <div id="ageAdjustmentWarning" class="mb-4 p-3 rounded-lg text-sm bg-yellow-50 border border-yellow-200 text-yellow-800" style="display: none;"></div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="text-sm text-blue-800">SBC Promedio</p>
                            <p id="res_sbcPromedio" class="text-2xl font-bold text-blue-900">$0.00</p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="text-sm text-blue-800">Edad Actual</p>
                            <p id="res_edadActual" class="text-2xl font-bold text-blue-900">0 años</p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="text-sm text-blue-800">Teléfono</p>
                            <p id="res_telefonoCliente" class="text-2xl font-bold text-blue-900">--</p>
                        </div>
                        <div id="vigenciaResultBox" class="p-4 rounded-lg md:col-span-3">
                            <p id="vigenciaResultText" class="text-2xl font-bold">--</p>
                            <p id="vigenciaResultSubText" class="text-sm">--</p>
                        </div>
                    </div>
                     <div class="mt-6 overflow-x-auto">
                         <div class="flex justify-between items-center mb-2 flex-wrap gap-4">
                             <h4 class="font-semibold text-gray-700">Periodos del Historial Laboral</h4>
                             <div class="flex items-center space-x-4">
                                 <div class="flex items-center">
                                     <input type="checkbox" id="showFullHistoryCheckbox" onchange="renderSbcAnalysisTable()" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                     <label for="showFullHistoryCheckbox" class="ml-2 text-sm text-gray-600">Mostrar historial completo</label>
                                 </div>
                                 <div class="flex items-center">
                                     <input type="checkbox" id="showSbcBreakdownCheckbox" onchange="renderSbcAnalysisTable()" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                     <label for="showSbcBreakdownCheckbox" class="ml-2 text-sm text-gray-600">Desglose por empleador</label>
                                 </div>
                             </div>
                         </div>
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-2">Registro Patronal</th>
                                    <th class="p-2">Fecha Inicio</th>
                                    <th class="p-2">Fecha Fin</th>
                                    <th class="p-2 text-right">Días</th>
                                    <th class="p-2 text-right">SBC Diario</th>
                                    <th class="p-2 text-right">SBC Ponderado (para cálculo)</th>
                                </tr>
                            </thead>
                            <tbody id="sbcAnalysisTableBody">
                            </tbody>
                            <tfoot id="sbcAnalysisTableFooter" class="font-bold bg-gray-100">
                            </tfoot>
                        </table>
                         <div id="sbcDaysWarning" class="mt-4 p-3 rounded-lg text-sm" style="display: none;"></div>
                         <div id="modalitySummaryContainer" class="mt-6"></div>
                    </div>
                </div>

                <div id="timelineSection" class="mt-12 pt-8 border-t" style="display: none;">
                    <h3 class="subsection-title">Línea de Tiempo del Historial Laboral (Últimos 10 Años)</h3>
                    <div id="timeline-container" class="w-full h-96 overflow-x-auto"><svg id="timeline-svg"></svg></div>
                    <div id="timeline-legend" class="flex flex-wrap gap-x-4 gap-y-2 mt-4 p-2 border-t"></div>
                </div>

                <div id="basePensionResultsContainer" class="mt-8" style="display: none;">
                    <h3 class="subsection-title">Resultados de Pensión Base (Sin M40)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <p class="text-sm text-green-800">Pensión Mensual Estimada</p>
                            <p id="res_base_pensionMensual" class="text-2xl font-bold text-green-900">$0.00</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <p class="text-sm text-green-800">Aguinaldo Estimado</p>
                            <p id="res_base_aguinaldo" class="text-2xl font-bold text-green-900">$0.00</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <p class="text-sm text-green-800">Ingreso Anual Total</p>
                            <p id="res_base_ingresoAnual" class="text-2xl font-bold text-green-900">$0.00</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="infoSection2" class="infographic-section">
                <h2><i class="fas fa-chart-line"></i>Paso 2: Estrategia Modalidad 40</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div>
                        <h3 class="subsection-title">Definir Periodo de Inversión en M40</h3>
                        <div id="lastBajaDateHint" class="text-sm text-gray-600 mb-2 font-semibold"></div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-6">
                            <div class="input-group sm:col-span-2">
                                <label>Fecha Inicio M40:</label>
                                <div class="flex gap-2">
                                    <select id="m40_day" class="w-full">
                                        <option value="">Día</option>
                                    </select>
                                    <select id="m40_month" class="w-full">
                                        <option value="">Mes</option>
                                    </select>
                                    <select id="m40_year" class="w-full">
                                        <option value="">Año</option>
                                    </select>
                                </div>
                            </div>
                            <div class="input-group">
                                <label for="info_m40_p1_meses">Meses a Invertir:</label>
                                <input type="number" id="info_m40_p1_meses" placeholder="Ej: 60" max="60" oninput="actualizarFechaFinM40Display()" class="w-full">
                            </div>
                            <div class="input-group">
                                <label for="info_m40_p1_sbc">SBC Diario M40 (Tope):</label>
                                <input type="number" id="info_m40_p1_sbc" placeholder="Automático" class="w-full">
                            </div>
                        </div>
                         <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-center">
                             <div id="info_m40_baja_display" class="text-sm font-semibold text-blue-800 leading-relaxed">
                                 -- Ingrese fechas para ver la edad de baja --
                             </div>
                         </div>
                    </div>
                    <div>
                        <h3 class="subsection-title">Tabla de Referencia UMA</h3>
                        <div class="overflow-x-auto max-h-64">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-100 sticky top-0">
                                    <tr>
                                        <th class="p-2">Año</th>
                                        <th class="p-2 text-right">Valor UMA Diario</th>
                                        <th class="p-2 text-right">SBC Tope (25 UMAs)</th>
                                    </tr>
                                </thead>
                                <tbody id="umaReferenceTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-10">
                    <button id="btnCalcularEscenarioM40" onclick="calcularEscenarioM40Infografia()" class="btn btn-gold">
                        <i class="fas fa-cogs"></i>Calcular Proyección M40
                    </button>
                </div>
            </section>

            <section id="infoSection3" class="infographic-section" style="display: none;">
                <h2><i class="fas fa-hand-holding-usd"></i>Paso 3: Análisis Financiero</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div class="input-group">
                        <label for="info_aforeActual">AFORE Actual ($):</label>
                        <input type="number" id="info_aforeActual" placeholder="0.00" oninput="recalculateAllScenarios();">
                    </div>
                    <div class="input-group">
                        <label for="info_mesesPrimerDeposito">Meses para Primer Depósito (6-12):</label>
                        <input type="number" id="info_mesesPrimerDeposito" value="6" min="6" max="12" onchange="handleMesesDepositoChange(this)" data-last-valid="6">
                    </div>
                     <div class="input-group md:col-span-2">
                         <label for="info_comisionExcedente">Comisión por Excedente ($) y Concepto:</label>
                         <div class="flex gap-4">
                             <input type="number" id="info_comisionExcedente" placeholder="0.00" oninput="recalculateAllScenarios();" class="w-1/2">
                             <input type="text" id="info_comisionExcedente_concepto" placeholder="Concepto para reporte" class="w-1/2">
                         </div>
                     </div>
                </div>
            </section>
            
            <section id="infoSection4" class="infographic-section" style="display: none;">
                <h2><i class="fas fa-balance-scale-right"></i>Paso 4: Comparador de Escenarios</h2>
                <div id="scenariosContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 </div>
                <div class="text-center mt-8">
                     <button id="addScenarioBtn" onclick="addScenarioCard()" class="btn btn-secondary"><i class="fas fa-plus mr-2"></i>Agregar Escenario</button>
                </div>
            </section>

            <section id="infoSection5" class="infographic-section" style="display: none;">
                <div class="text-center">
                    <h2><i class="fas fa-file-export"></i>Paso 5: Exportar y Resumir</h2>
                     <p class="mb-8 text-gray-600 text-lg max-w-2xl mx-auto">Genera reportes detallados y resúmenes rápidos para compartir.</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
                    <div>
                        <h3 class="subsection-title">Generar Reportes PDF</h3>
                        <div class="flex flex-col gap-6">
                            <button onclick="promptForClientPDF()" class="btn btn-blue text-lg">
                                <i class="fas fa-user"></i> Reporte PDF para Cliente
                            </button>
                            <button onclick="promptForDirectorPDF()" class="btn btn-gold text-lg">
                                <i class="fas fa-user-shield"></i> Reporte PDF para Dirección
                            </button>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="subsection-title">Resumen para WhatsApp</h3>
                        <div class="bg-gray-50 p-6 rounded-lg border">
                            <p class="text-sm text-gray-600 mb-4">Selecciona un tono para generar un resumen listo para copiar y pegar.</p>
                            <div class="flex flex-wrap gap-3 mb-4">
                                <button onclick="generateWhatsappSummary('amigable')" class="btn btn-secondary !text-xs !py-2">Amigable</button>
                                <button onclick="generateWhatsappSummary('sencillo')" class="btn btn-secondary !text-xs !py-2">Sencillo</button>
                                <button onclick="generateWhatsappSummary('formal')" class="btn btn-secondary !text-xs !py-2">Formal</button>
                                <button onclick="generateWhatsappSummary('numerico')" class="btn btn-secondary !text-xs !py-2">Numérico</button>
                            </div>
                            <div id="whatsappSummaryContainer" style="display: none;">
                                <textarea id="whatsappSummaryText" rows="10" class="w-full text-sm"></textarea>
                                <button onclick="copyWhatsappSummary()" class="btn btn-blue w-full mt-3">
                                    <i class="fas fa-copy"></i> Copiar al Portapapeles
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        
        <div id="contractSection" style="display: none;">
            <div class="flex justify-between items-center mb-6">
                <button onclick="showSection('mainMenuSection')" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i>Volver al Menú</button>
                <button onclick="logout('Has cerrado sesión correctamente.')" class="btn !py-2 !px-3 bg-red-100 !border-red-500 !text-red-600 hover:!bg-red-500 hover:!text-white text-sm">
                    <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesión
                </button>
            </div>
            <section class="infographic-section">
                <h2><i class="fas fa-file-signature"></i>Generador de Contrato de Servicios</h2>
                <div class="input-group mb-6">
                    <label for="contract_monto">Monto del Contrato (Automático desde Escenario 1)</label>
                    <input type="number" id="contract_monto" placeholder="Se llena al calcular escenario 1" class="w-full" readonly>
                </div>

                <h3 class="subsection-title">Datos del Cliente (Contratante)</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div class="input-group">
                        <label for="contract_cliente_nombre">Nombre Completo:</label>
                        <input type="text" id="contract_cliente_nombre" placeholder="Nombre(s) Apellido Paterno Apellido Materno" class="w-full">
                    </div>
                    <div class="input-group">
                        <label for="contract_cliente_telefono">Teléfono (10 dígitos):</label>
                        <input type="text" id="contract_cliente_telefono" placeholder="5512345678" maxlength="10" class="w-full">
                    </div>
                    <div class="input-group">
                        <label for="contract_cliente_email">Correo Electrónico:</label>
                        <input type="text" id="contract_cliente_email" placeholder="cliente@email.com" class="w-full">
                    </div>
                    <div class="input-group">
                        <label for="contract_cliente_direccion">Dirección Completa:</label>
                        <input type="text" id="contract_cliente_direccion" placeholder="Calle, Número, Colonia, Alcaldía, C.P., Ciudad" class="w-full">
                    </div>
                </div>

                <h3 class="subsection-title mt-8">Datos del Co-Contratante / Responsable Solidario</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div class="input-group">
                        <label for="contract_rs_nombre">Nombre Completo:</label>
                        <input type="text" id="contract_rs_nombre" placeholder="Nombre(s) Apellido Paterno Apellido Materno" class="w-full">
                    </div>
                    <div class="input-group">
                        <label for="contract_rs_telefono">Teléfono (10 dígitos):</label>
                        <input type="text" id="contract_rs_telefono" placeholder="5587654321" maxlength="10" class="w-full">
                    </div>
                     <div class="input-group">
                         <label for="contract_rs_email">Correo Electrónico:</label>
                         <input type="text" id="contract_rs_email" placeholder="responsable@email.com" class="w-full">
                     </div>
                    <div class="input-group">
                        <label for="contract_rs_direccion">Dirección Completa:</label>
                        <input type="text" id="contract_rs_direccion" placeholder="Calle, Número, Colonia, Alcaldía, C.P., Ciudad" class="w-full">
                    </div>
                </div>

                <div class="text-center mt-10">
                    <button onclick="generateContractPDF()" class="btn btn-gold text-lg">
                        <i class="fas fa-file-pdf"></i>Generar y Descargar Contrato
                    </button>
                </div>
            </section>
        </div>

        <div id="crmSection" style="display: none;">
            <div class="flex justify-between items-center mb-6">
                <button onclick="showSection('mainMenuSection')" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i>Volver al Menú</button>
                <button onclick="logout('Has cerrado sesión correctamente.')" class="btn !py-2 !px-3 bg-red-100 !border-red-500 !text-red-600 hover:!bg-red-500 hover:!text-white text-sm">
                    <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesión
                </button>
            </div>
            <section class="infographic-section">
                <h2><i class="fas fa-users"></i>Cartera de Clientes</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2">Nombre Cliente</th>
                                <th class="p-2">Teléfono</th>
                                <th class="p-2">CURP</th>
                                <th class="p-2">Precio Venta</th>
                                <th class="p-2">Pensión Bruta</th>
                                <th class="p-2">Pensión Neta</th>
                                <th class="p-2">Meses M40</th>
                                <th class="p-2">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTableBody">
                            <tr><td colspan="8" class="text-center p-4">Cargando clientes...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <div id="adminSection" style="display: none;">
            <div class="flex justify-between items-center mb-6">
                <button onclick="showSection('mainMenuSection')" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i>Volver al Menú</button>
                <button onclick="logout('Has cerrado sesión correctamente.')" class="btn !py-2 !px-3 bg-red-100 !border-red-500 !text-red-600 hover:!bg-red-500 hover:!text-white text-sm">
                    <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesión
                </button>
            </div>
            <section class="infographic-section">
                <h2><i class="fas fa-user-shield"></i>Panel de Administrador</h2>
                
                <h3 class="subsection-title">Gestión de Acceso de Asesores</h3>
                <div class="overflow-x-auto max-h-96">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="p-2">Asesor</th>
                                <th class="p-2 text-center">Acceso</th>
                            </tr>
                        </thead>
                        <tbody id="advisorsTableBody">
                           </tbody>
                    </table>
                </div>

                <h3 class="subsection-title mt-8">Registros de Inicio de Sesión</h3>
                <div class="overflow-x-auto max-h-96">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="p-2">Asesor</th>
                                <th class="p-2">Fecha y Hora</th>
                            </tr>
                        </thead>
                        <tbody id="loginLogsTableBody">
                           <tr><td colspan="2" class="text-center p-4">Cargando registros...</td></tr>
                        </tbody>
                    </table>
                </div>

                <h3 class="subsection-title mt-8">Registros de Cálculos</h3>
                <div class="overflow-x-auto max-h-96">
                     <table class="w-full text-sm text-left">
                         <thead class="bg-gray-100 sticky top-0">
                             <tr>
                                 <th class="p-2">Fecha</th>
                                 <th class="p-2">Asesor</th>
                                 <th class="p-2">Cliente</th>
                                 <th class="p-2">CURP</th>
                                 <th class="p-2">Teléfono</th>
                                 <th class="p-2">Detalles Escenario 1</th>
                             </tr>
                         </thead>
                         <tbody id="calcLogsTableBody">
                             <tr><td colspan="6" class="text-center p-4">Cargando registros...</td></tr>
                         </tbody>
                     </table>
                </div>

                <h3 class="subsection-title mt-8">Acciones de Administrador</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                    <div class="bg-gray-50 p-4 rounded-lg border">
                        <h4 class="font-bold mb-2">Registros de Inicio de Sesión</h4>
                        <div class="flex gap-4">
                            <button id="downloadLoginLogsBtn" class="btn btn-secondary text-sm flex-1"><i class="fas fa-download mr-2"></i>Descargar CSV</button>
                            <button id="resetLoginLogsBtn" class="btn btn-danger-icon !rounded-lg !w-auto !h-auto !px-4"><i class="fas fa-trash-alt"></i> Resetear</button>
                        </div>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg border">
                        <h4 class="font-bold mb-2">Registros de Cálculos</h4>
                        <div class="flex gap-4">
                            <button id="downloadCalcLogsBtn" class="btn btn-secondary text-sm flex-1"><i class="fas fa-download mr-2"></i>Descargar CSV</button>
                            <button id="resetCalcLogsBtn" class="btn btn-danger-icon !rounded-lg !w-auto !h-auto !px-4"><i class="fas fa-trash-alt"></i> Resetear</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        
        <footer class="app-footer">
            <div class="logo-text-footer">RGC PENSIONES Y SEGUROS</div>
            <p>&copy; <span id="currentYear"></span> RGC Pensiones y Seguros. Todos los derechos reservados.</p>
            <p class="text-xs mt-2 opacity-60">Versión 2.5.1</p>
            <p class="text-xs mt-1 opacity-70">Esta es una simulación y los resultados pueden variar. Consulta a un asesor para una evaluación detallada.</p>
        </footer>
    </div>
    
    <div id="customAlertModal" class="modal-overlay">
        <div class="modal-content modal-content-alert">
            <h2 id="customAlertTitle" class="text-xl">Alerta</h2>
            <p id="customAlertMessage" class="text-base my-6"></p>
            <div id="passwordPromptContainer" style="display: none;" class="mt-4">
                <input type="password" id="pdfPasswordInput" class="w-full p-2 border rounded" placeholder="Contraseña de Dirección">
            </div>
            <div class="flex justify-center gap-4 mt-4">
                <button id="customAlertCancelButton" style="display: none;" class="btn btn-secondary">Cancelar</button>
                <button id="customAlertButton" class="btn btn-blue">Aceptar</button>
            </div>
        </div>
    </div>

    <div id="clientDetailsModal" class="modal-overlay">
        <div class="modal-content" style="width: 800px; max-width: 95%;">
            <h2 id="clientDetailsName">Detalles del Cliente</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="subsection-title !mt-0">Información General</h3>
                    <div id="clientInfoPanel" class="text-sm space-y-2"></div>
                </div>
                <div>
                    <h3 class="subsection-title !mt-0">Notas de Seguimiento</h3>
                    <div id="clientNotesContainer" class="space-y-3 max-h-48 overflow-y-auto bg-gray-50 p-3 rounded-lg">
                    </div>
                    <div class="mt-4">
                        <textarea id="newNoteText" class="w-full" rows="3" placeholder="Escribir nueva nota..."></textarea>
                        <button id="saveNoteButton" class="btn btn-gold mt-2 float-right">Guardar Nota</button>
                    </div>
                </div>
            </div>
             <div class="text-center mt-8">
                 <button onclick="hideElement('clientDetailsModal')" class="btn btn-secondary">Cerrar</button>
             </div>
        </div>
    </div>
    
    <div id="timeline-tooltip"></div>

    <script>
        // --- APPLICATION SCOPE & STATE ---
        const AppState = {
            nombreAsesorGlobal: "",
            userRole: "asesor",
            isSpecialUser: false,
            adviserLocation: { lat: null, lon: null, error: null },
            employmentCardIdCounter: 0,
            scenarioData: {},
            activeScenarios: 0,
            datosClienteInfo: { 
                nombre: '', curp: '', telefono: '', 
                semanasCotizadasBase: 0, edadBase: 0, sbcPromedioBase: 0,
                ultimaFechaBaja: null 
            },
            sbcCalculationPeriods: [],
            fullHistoryPeriods: [],
            timelinePeriods: [], // Holds processed periods for the timeline
            pensionBaseResultadosInfo: { PENSION_MENSUAL_ESTIMADA: 0, AGUINALDO_ESTIMADO: 0 },
            session: { timeout: null, interval: null, duration: 15 * 60 * 1000, endTime: null, pdfDownloadCount: 0 },
            pdfGenerated: false // Flag to control scenario visibility
        };

        // --- FINANCIAL & ECONOMIC CONSTANTS ---
        const Constants = {
            DIAS_PROMEDIO_PENSION: 1750,
            SMGV_DF_Global: 88.36,
            FACTOR_FOX_Global: 1.11,
            PRESTAMO_PUNTO_A_DESCUENTO: 1115.61,
            PRESTAMO_PUNTO_A_MONTO: 31000,
            PRESTAMO_PUNTO_B_DESCUENTO: 33450.42,
            PRESTAMO_PUNTO_B_MONTO: 929500,
            COSTO_FIJO_ADICIONAL: 140000,
            COMISION_BASE_M40: 0.16,
            FACTOR_MULTIPLICADOR_COSTO: 0.5,
            AJUSTE_FINAL_CONTRATO: -35000,
            AJUSTE_PENSION_MENSUAL: -250,
            INPC_GROWTH_ESTIMATE: 0.06,
            RECARGO_M40_MENSUAL: 0.0147,
            economicData: {
                umas: { 2016: 73.04, 2017: 75.49, 2018: 80.60, 2019: 84.49, 2020: 86.88, 2021: 89.62, 2022: 96.22, 2023: 103.74, 2024: 108.57, 2025: 113.14 },
                smgv_diario: { 2018: 88.36, 2019: 102.68, 2020: 123.22, 2021: 141.70, 2022: 172.87, 2023: 207.44, 2024: 248.93 },
                inpc: { "2018-12": 101.355, "2019-12": 104.236, "2020-12": 107.608, "2021-12": 115.499, "2022-12": 124.507, "2023-12": 130.036, "2024-01": 131.396, "2024-02": 131.500, "2024-03": 131.650, "2024-04": 131.800, "2024-05": 132.000, "2024-06": 132.660, "2024-07": 133.323 }
            },
            tasasPagoM40: { 2022: 0.10075, 2023: 0.11166, 2024: 0.12256, 2025: 0.13347, 2026: 0.14438, 2027: 0.15528, 2028: 0.16619, 2029: 0.17709, 2030: 0.18800 },
            tablaCuantiasGlobal: [
                { minRatio: 0,    maxRatio: 1.00, pcb: 80.00, pia: 0.563 }, { minRatio: 1.01, maxRatio: 1.25, pcb: 77.11, pia: 0.814 },
                { minRatio: 1.26, maxRatio: 1.50, pcb: 58.18, pia: 1.178 }, { minRatio: 1.51, maxRatio: 1.75, pcb: 49.23, pia: 1.430 },
                { minRatio: 1.76, maxRatio: 2.00, pcb: 42.67, pia: 1.615 }, { minRatio: 2.01, maxRatio: 2.25, pcb: 37.65, pia: 1.756 },
                { minRatio: 2.26, maxRatio: 2.50, pcb: 33.68, pia: 1.868 }, { minRatio: 2.51, maxRatio: 2.75, pcb: 30.48, pia: 1.958 },
                { minRatio: 2.76, maxRatio: 3.00, pcb: 27.83, pia: 2.033 }, { minRatio: 3.01, maxRatio: 3.25, pcb: 25.60, pia: 2.096 },
                { minRatio: 3.26, maxRatio: 3.50, pcb: 23.70, pia: 2.149 }, { minRatio: 3.51, maxRatio: 3.75, pcb: 22.07, pia: 2.195 },
                { minRatio: 3.76, maxRatio: 4.00, pcb: 20.65, pia: 2.235 }, { minRatio: 4.01, maxRatio: 4.25, pcb: 19.39, pia: 2.271 },
                { minRatio: 4.26, maxRatio: 4.50, pcb: 18.29, pia: 2.302 }, { minRatio: 4.51, maxRatio: 4.75, pcb: 17.30, pia: 2.330 },
                { minRatio: 4.76, maxRatio: 5.00, pcb: 16.41, pia: 2.355 }, { minRatio: 5.01, maxRatio: 5.25, pcb: 15.61, pia: 2.377 },
                { minRatio: 5.26, maxRatio: 5.50, pcb: 14.88, pia: 2.398 }, { minRatio: 5.51, maxRatio: 5.75, pcb: 14.22, pia: 2.416 },
                { minRatio: 5.76, maxRatio: 6.00, pcb: 13.62, pia: 2.433 }, { minRatio: 6.01, maxRatio: Infinity, pcb: 13.00, pia: 2.450 }
            ]
        };

        // --- UTILITY & HELPER FUNCTIONS ---
        function formatNumber(num, decimals = 2) {
            if (typeof num !== 'number' || isNaN(num)) return (0).toFixed(decimals);
            return num.toLocaleString('es-MX', { style: 'currency', currency: 'MXN' });
        }
        function formatNumberRaw(num, decimals = 2) {
            if (typeof num !== 'number' || isNaN(num)) return (0).toFixed(decimals);
            return num.toLocaleString('es-MX', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        }
        function formatDateDDMMYYYY(date) {
            if (!date || !(date instanceof Date)) return '';
            const day = String(date.getUTCDate()).padStart(2, '0');
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const year = date.getUTCFullYear();
            return `${day}/${month}/${year}`;
        }
        function getNumeroInfo(id) { return parseFloat(document.getElementById(id).value.replace(/,/g, '')) || 0; }
        function getDiasEnMes(a, m) { return new Date(a, m, 0).getDate(); }
        
        // --- SESSION MANAGEMENT ---
        function startSessionTimer() {
            clearTimeout(AppState.session.timeout);
            clearInterval(AppState.session.interval);
            AppState.session.endTime = Date.now() + AppState.session.duration;
            AppState.session.timeout = setTimeout(() => logout(), AppState.session.duration);
            AppState.session.interval = setInterval(updateCountdown, 1000);
            showElement('sessionTimerContainer');
            updateCountdown();
        }
        function updateCountdown() {
            const remainingTime = AppState.session.endTime - Date.now();
            if (remainingTime <= 0) {
                logout();
                return;
            }
            const minutes = Math.floor((remainingTime / 1000) / 60);
            const seconds = Math.floor((remainingTime / 1000) % 60);
            const countdownEl = document.getElementById('sessionCountdown');
            const timerContainer = document.getElementById('sessionTimerContainer');
            countdownEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            timerContainer.style.color = (remainingTime < 2 * 60 * 1000) ? 'var(--danger-color)' : 'var(--text-dark)';
        }
        function logout(message = "Tu sesión ha expirado. Por favor, ingresa de nuevo.") {
            clearTimeout(AppState.session.timeout);
            clearInterval(AppState.session.interval);
            hideElement('appContainer');
            hideElement('sessionTimerContainer');
            showElement('loginContainer');
            document.getElementById('login_password').value = '';
            document.getElementById('login_asesor').value = '';
            showCustomAlert(message, "Sesión Finalizada");
        }
        
        // --- UI MANAGEMENT ---
        function showElement(id, displayType = 'block') {
            const el = document.getElementById(id);
            if (!el) return;
            if (id.includes('Modal') || id.includes('loginContainer')) {
                el.classList.add('active');
            } else {
                el.style.display = displayType;
            }
        }
        function hideElement(id) {
             const el = document.getElementById(id);
             if (!el) return;
            if (id.includes('Modal') || id.includes('loginContainer')) {
                el.classList.remove('active');
            } else {
                el.style.display = 'none';
            }
        }
        function showCustomAlert(message, title = "Atención") {
            document.getElementById('customAlertTitle').textContent = title;
            document.getElementById('customAlertMessage').textContent = message;
            document.getElementById('passwordPromptContainer').style.display = 'none';
            
            const confirmBtn = document.getElementById('customAlertButton');
            const cancelBtn = document.getElementById('customAlertCancelButton');
            
            confirmBtn.textContent = 'Aceptar';
            confirmBtn.className = 'btn btn-blue';
            confirmBtn.onclick = closeCustomAlert;
            cancelBtn.style.display = 'none';

            showElement('customAlertModal');
        }
        function closeCustomAlert() {
            hideElement('customAlertModal');
            const confirmBtn = document.getElementById('customAlertButton');
            const cancelBtn = document.getElementById('customAlertCancelButton');
            confirmBtn.textContent = 'Aceptar';
            confirmBtn.className = 'btn btn-blue';
            confirmBtn.onclick = closeCustomAlert;
            cancelBtn.style.display = 'none';
            document.getElementById('passwordPromptContainer').style.display = 'none';
        }
        function acceptAgreement() {
            hideElement('confidentialityModal');
            showElement('loginContainer');
            document.getElementById('login_asesor').focus();
        }
        function showSection(sectionId) {
            ['mainMenuSection', 'calculatorSection', 'contractSection', 'crmSection', 'adminSection', 'quickCalcSection', 'reverseCalcSection'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            const sectionToShow = document.getElementById(sectionId);
            if (sectionToShow) {
                sectionToShow.style.display = 'block';
                if (sectionId === 'adminSection' && window.loadAdminPanelData) {
                    window.loadAdminPanelData();
                } else if (sectionId === 'crmSection' && window.loadClients) {
                    window.loadClients();
                }
            }
        }

        // --- LOGIN & GEOLOCATION ---
        function getAdviserLocation(callback) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        AppState.adviserLocation = {
                            lat: position.coords.latitude,
                            lon: position.coords.longitude,
                            error: null
                        };
                        console.log("Location obtained:", AppState.adviserLocation);
                        callback();
                    },
                    (error) => {
                        let errorMessage = "No se pudo obtener la ubicación. ";
                        switch(error.code) {
                            case error.PERMISSION_DENIED: errorMessage += "El permiso fue denegado."; break;
                            case error.POSITION_UNAVAILABLE: errorMessage += "La información no está disponible."; break;
                            case error.TIMEOUT: errorMessage += "La solicitud ha caducado."; break;
                        }
                        AppState.adviserLocation = { lat: null, lon: null, error: errorMessage };
                        console.warn("Advertencia de ubicación:", errorMessage);
                        callback();
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                const errorMessage = "La geolocalización no es soportada por este navegador.";
                AppState.adviserLocation = { lat: null, lon: null, error: errorMessage };
                console.warn("Advertencia de ubicación:", errorMessage);
                callback();
            }
        }
        
        async function handleLogin() {
            const loginButton = document.getElementById('loginButton');
            loginButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i>Verificando...`;
            loginButton.disabled = true;

            getAdviserLocation(async () => {
                const asesorInput = document.getElementById('login_asesor');
                const passwordInput = document.getElementById('login_password');
                const password = passwordInput.value.trim();
                const username = asesorInput.value.trim().toUpperCase();
                
                const validUser = await window.getUserByUsername(username);

                if (validUser && password === validUser.pass) {
                    if (validUser.status !== 'active') {
                        showCustomAlert("Tu acceso ha sido desactivado. Contacta al administrador.", "Acceso Denegado");
                        loginButton.innerHTML = `<i class="fas fa-sign-in-alt"></i> Ingresar`;
                        loginButton.disabled = false;
                        return;
                    }

                    AppState.nombreAsesorGlobal = validUser.user;
                    AppState.userRole = validUser.role;
                    AppState.isSpecialUser = AppState.nombreAsesorGlobal === 'ROBERTO ORTIZ';
                    AppState.session.pdfDownloadCount = 0;
                    AppState.pdfGenerated = false;
                    window.logLoginEvent(AppState.nombreAsesorGlobal);
                    hideElement('login_errorMessage');
                    hideElement('loginContainer');
                    showElement('appContainer');
                    document.getElementById('asesorNameDisplay').textContent = `Bienvenido, ${AppState.nombreAsesorGlobal}`;
                    
                    showElement('mainMenuSection');
                    if (validUser.role === 'admin') {
                        showElement('adminMenuCard');
                    } else { 
                        hideElement('adminMenuCard');
                    }
                    startSessionTimer();
                } else {
                    const loginErrorTextEl = document.querySelector('#login_errorMessage p');
                    if(loginErrorTextEl) loginErrorTextEl.textContent = "Usuario o contraseña incorrectos.";
                    showElement('login_errorMessage');
                }
                loginButton.innerHTML = `<i class="fas fa-sign-in-alt"></i> Ingresar`;
                loginButton.disabled = false;
            });
        }

        function initializeMainAppDisplay() {
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            const currentYear = new Date().getFullYear();
            for (let y = Math.max(...Object.keys(Constants.economicData.umas).map(Number)) + 1; y <= currentYear + 10; y++) {
                if (!Constants.economicData.umas[y]) Constants.economicData.umas[y] = parseFloat((Constants.economicData.umas[y - 1] * 1.045).toFixed(2));
            }
            populateUmaTable();
        }
        
        function populateUmaTable() {
            const body = document.getElementById('umaReferenceTableBody');
            if(!body) return;
            body.innerHTML = '';
            const sortedYears = Object.keys(Constants.economicData.umas).sort((a,b) => b-a);
            sortedYears.forEach(year => {
                const uma = Constants.economicData.umas[year];
                const sbcTope = uma * 25;
                const row = `<tr><td class="p-2">${year}</td><td class="p-2 text-right">${formatNumber(uma)}</td><td class="p-2 text-right">${formatNumber(sbcTope)}</td></tr>`;
                body.insertAdjacentHTML('beforeend', row);
            });
        }

        function initDateSelectors() {
            const daySelect = document.getElementById('m40_day');
            const monthSelect = document.getElementById('m40_month');
            const yearSelect = document.getElementById('m40_year');
            
            daySelect.innerHTML = '<option value="">Día</option>';
            for (let i = 1; i <= 31; i++) daySelect.innerHTML += `<option value="${i}">${i}</option>`;
            
            const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            monthSelect.innerHTML = '<option value="">Mes</option>';
            meses.forEach((mes, i) => monthSelect.innerHTML += `<option value="${i + 1}">${mes}</option>`);
            
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '<option value="">Año</option>';
            for (let i = currentYear - 5; i <= currentYear + 10; i++) yearSelect.innerHTML += `<option value="${i}">${i}</option>`;
        }
        
        function updateDaySelector() {
            const month = parseInt(document.getElementById('m40_month').value);
            const year = parseInt(document.getElementById('m40_year').value);
            const daySelect = document.getElementById('m40_day');
            const currentDay = daySelect.value;
            if (!month || !year) return;
            const daysInMonth = getDiasEnMes(year, month);
            daySelect.innerHTML = '<option value="">Día</option>';
            for (let i = 1; i <= daysInMonth; i++) daySelect.innerHTML += `<option value="${i}">${i}</option>`;
            if (currentDay && currentDay <= daysInMonth) daySelect.value = currentDay;
        };

        function actualizarSBCMaximoM40() {
            const year = document.getElementById('m40_year').value;
            if (!year) return;
            document.getElementById('info_m40_p1_sbc').value = (getUMA(year) * 25).toFixed(2);
        }

        function actualizarFechaFinM40Display() {
            const displayEl = document.getElementById('info_m40_baja_display');
            const meses = getNumeroInfo('info_m40_p1_meses');
            const day = document.getElementById('m40_day').value;
            const month = document.getElementById('m40_month').value;
            const year = document.getElementById('m40_year').value;
            const curp = document.getElementById('info_curpCliente').value;
            
            if (!meses || !day || !month || !year || !curp) {
                displayEl.innerHTML = '-- Ingrese fechas y CURP para ver la edad de baja --';
                return;
            }
            const fechaNacimiento = extraerFechaNacimientoCURP(curp);
            if(!fechaNacimiento) {
                displayEl.innerHTML = '-- CURP inválido --';
                return;
            }
            const fechaInicio = new Date(Date.UTC(year, month - 1, day));
            const fechaFin = new Date(fechaInicio);
            fechaFin.setUTCMonth(fechaFin.getUTCMonth() + meses);
            const edadAlFinalizar = calcularEdadExacta(fechaNacimiento, fechaFin);
            displayEl.innerHTML = `Edad al finalizar M40: <strong>${edadAlFinalizar.anos} años, ${edadAlFinalizar.meses} meses</strong><br>Fecha de Baja Estimada: <strong>${formatDateDDMMYYYY(fechaFin)}</strong>`;
        }

        function getUMA(y, m = new Date().getMonth() + 1) { 
            let useYear = parseInt(y);
            if (m === 1 && Constants.economicData.umas[useYear - 1]) useYear = parseInt(y) - 1;
            return Constants.economicData.umas[useYear] || Constants.economicData.umas[Object.keys(Constants.economicData.umas).sort((a,b) => b-a)[0]] || 0;
        }

        function extraerFechaNacimientoCURP(curp) {
            if (typeof curp !== 'string' || curp.length !== 18) return null;
            const yearStr = curp.substring(4, 6);
            const monthStr = curp.substring(6, 8);
            const dayStr = curp.substring(8, 10);
            let year = parseInt(yearStr);
            const month = parseInt(monthStr);
            const day = parseInt(dayStr);
            if (isNaN(year) || isNaN(month) || isNaN(day)) return null;
            const centuryIndicator = curp.charAt(16);
            let century = 1900;
            const currentYearLastTwoDigits = new Date().getFullYear() % 100;
            if (!isNaN(parseInt(centuryIndicator))) century = (year > currentYearLastTwoDigits + 10) ? 1900 : 2000;
            else if (centuryIndicator >= 'A' && centuryIndicator <= 'Z') century = 2000;
            year += century;
            try {
                const date = new Date(Date.UTC(year, month - 1, day));
                if (date.getUTCFullYear() === year && date.getUTCMonth() === (month - 1) && date.getUTCDate() === day) return date;
                return null;
            } catch (e) { return null; }
        }

        function calcularEdadExacta(startDate, endDate) {
            if (!startDate || !endDate) return { anos: 0, meses: 0, dias: 0 };
            let years = endDate.getUTCFullYear() - startDate.getUTCFullYear();
            let months = endDate.getUTCMonth() - startDate.getUTCMonth();
            let days = endDate.getUTCDate() - startDate.getUTCDate();
            if (days < 0) { months--; days += new Date(endDate.getUTCFullYear(), endDate.getUTCMonth(), 0).getUTCDate(); }
            if (months < 0) { years--; months += 12; }
            return { anos: years, meses: months, dias: days };
        }

        function _calcularPensionDetallado(sbcPromedio, semanasCotizadas, edad) {
            if (sbcPromedio <= 0 || semanasCotizadas < 500 || edad < 60) return { PENSION_MENSUAL_ESTIMADA: 0, AGUINALDO_ESTIMADO: 0 };
            const ratio = sbcPromedio / Constants.SMGV_DF_Global;
            const cuantias = Constants.tablaCuantiasGlobal.find(rg => ratio >= rg.minRatio && ratio <= rg.maxRatio) || Constants.tablaCuantiasGlobal[Constants.tablaCuantiasGlobal.length - 1];
            const { pcb, pia } = cuantias;
            const cuantiaBasicaAnual = (sbcPromedio * 365) * (pcb / 100) * Constants.FACTOR_FOX_Global;
            const semanasExcedentes = Math.floor((semanasCotizadas - 500) / 52);
            const incrementoAnual = (sbcPromedio * 365) * (pia / 100) * semanasExcedentes * Constants.FACTOR_FOX_Global;
            const pensionAnualBase = cuantiaBasicaAnual + incrementoAnual;
            let porcentajeEdad = 0;
            if (edad >= 65) porcentajeEdad = 1.00;
            else if (edad >= 64) porcentajeEdad = 0.95;
            else if (edad >= 63) porcentajeEdad = 0.90;
            else if (edad >= 62) porcentajeEdad = 0.85;
            else if (edad >= 61) porcentajeEdad = 0.80;
            else if (edad >= 60) porcentajeEdad = 0.75;
            const pensionAnualAplicada = pensionAnualBase * porcentajeEdad;
            return {
                PENSION_MENSUAL_ESTIMADA: (pensionAnualAplicada * 1.15) / 12,
                AGUINALDO_ESTIMADO: pensionAnualAplicada / 12
            };
        }
        
        function handleQuickCalc() {
            const age = getNumeroInfo('quick_calc_age');
            const weeks = getNumeroInfo('quick_calc_weeks');
            const sbc = getNumeroInfo('quick_calc_sbc');
            const resultEl = document.getElementById('quickCalcResult');
            if (!age || !weeks || !sbc) {
                resultEl.innerHTML = `<p class="text-red-600 font-semibold">Por favor, complete todos los campos.</p>`;
                showElement(resultEl.id);
                return;
            }
            const ageForCalc = Math.max(60, age);
            const pensionData = _calcularPensionDetallado(sbc, weeks, ageForCalc);
            let resultText = `<p class="text-gray-600">Pensión Mensual Estimada:</p><p class="text-4xl font-bold text-green-600 my-2">${formatNumber(pensionData.PENSION_MENSUAL_ESTIMADA)}</p>`;
            if (age < 60) resultText += `<p class="text-sm text-gray-500">(Cálculo realizado a 60 años)</p>`;
            resultEl.innerHTML = resultText;
            showElement(resultEl.id);
        }

        function handleReverseCalc() {
            const baseAge = getNumeroInfo('reverse_calc_age');
            const baseWeeks = getNumeroInfo('reverse_calc_weeks');
            const baseSBC = getNumeroInfo('reverse_calc_sbc');
            const targetPension = getNumeroInfo('reverse_calc_target_pension');
            const resultEl = document.getElementById('reverseCalcResult');
            if (!baseAge || !baseWeeks || !baseSBC || !targetPension) {
                resultEl.innerHTML = `<p class="text-red-600 font-semibold">Por favor, complete todos los campos.</p>`;
                showElement(resultEl.id);
                return;
            }
            showElement(resultEl.id);
            resultEl.innerHTML = `<p class="flex items-center justify-center"><i class="fas fa-spinner fa-spin mr-3"></i>Calculando, por favor espere...</p>`;
            setTimeout(() => {
                const sbcM40 = getUMA(new Date().getFullYear()) * 25;
                let found = false, lastCalculatedPension = 0;
                for (let meses = 1; meses <= 60; meses++) {
                    const semanasProyectadas = Math.round(baseWeeks + (meses * 4.345));
                    const dummyBirth = new Date(); dummyBirth.setFullYear(dummyBirth.getFullYear() - baseAge);
                    const dummyEnd = new Date(); dummyEnd.setMonth(dummyEnd.getMonth() + meses);
                    const edadFinM40 = calcularEdadExacta(dummyBirth, dummyEnd);
                    let edadParaPorcentaje = edadFinM40.anos;
                    if (edadFinM40.meses > 6 || (edadFinM40.meses === 6 && edadFinM40.dias >= 1)) edadParaPorcentaje++;
                    edadParaPorcentaje = Math.max(60, edadParaPorcentaje);
                    const diasEnM40 = meses * 30.4375;
                    const diasASumarDeM40 = Math.min(diasEnM40, Constants.DIAS_PROMEDIO_PENSION);
                    const diasBasePrevios = Constants.DIAS_PROMEDIO_PENSION - diasASumarDeM40;
                    const sbcPromedioProyectado = ((sbcM40 * diasASumarDeM40) + (baseSBC * diasBasePrevios)) / Constants.DIAS_PROMEDIO_PENSION;
                    const pensionResult = _calcularPensionDetallado(sbcPromedioProyectado, semanasProyectadas, edadParaPorcentaje);
                    lastCalculatedPension = pensionResult.PENSION_MENSUAL_ESTIMADA;
                    if (pensionResult.PENSION_MENSUAL_ESTIMADA >= targetPension) {
                        resultEl.innerHTML = `<p class="text-lg">Para alcanzar una pensión de <strong>${formatNumber(targetPension)}</strong>, se necesitan aproximadamente:</p><p class="text-5xl font-bold text-green-600 my-4">${meses} meses</p><p class="text-base">de inversión en Modalidad 40 con el SBC topado.</p><p class="text-sm mt-4 text-gray-600">Pensión final estimada: <strong>${formatNumber(pensionResult.PENSION_MENSUAL_ESTIMADA)}</strong></p>`;
                        found = true;
                        break;
                    }
                }
                if (!found) resultEl.innerHTML = `<p class="text-lg text-red-600 font-semibold">Incluso con 60 meses de inversión, no se alcanza la pensión deseada.</p><p class="mt-2">La pensión máxima proyectada sería de aproximadamente <strong>${formatNumber(lastCalculatedPension)}</strong>.</p>`;
            }, 100);
        }

        function generateWhatsappSummary(tone) {
            const scenario = AppState.scenarioData[1];
            if (!scenario) { showCustomAlert("Primero debe calcular un escenario.", "Cálculo Requerido"); return; }
            const basePension = AppState.pensionBaseResultadosInfo.PENSION_MENSUAL_ESTIMADA;
            const { nombre } = AppState.datosClienteInfo;
            const nl = '\n', divider = '------------------------------------';
            let summary = "";
            switch(tone) {
                case 'amigable': summary = `¡Hola ${nombre}! 👋 Te preparé un resumen de tu proyecto de pensión:${nl}${nl}Con una inversión en Modalidad 40 por *${scenario.meses} meses*, tu pensión mensual podría aumentar a: *${formatNumber(scenario.pensionMensual)}* 🤩.${nl}${nl}Esto representa un gran salto desde tu pensión base de ${formatNumber(basePension)}.${nl}${nl}El costo total del proyecto es de *${formatNumber(scenario.costoTotalContrato)}* y lo recuperarías en unos *${isFinite(scenario.roiMonths) ? Math.ceil(scenario.roiMonths) : 'N/A'} meses*.${nl}${nl}¡Es una excelente oportunidad para asegurar tu futuro! ¿Platicamos más a detalle?`; break;
                case 'sencillo': summary = `*Resumen de Proyección de Pensión*${nl}Cliente: ${nombre}${nl}${nl}*Pensión SIN proyecto:* ${formatNumber(basePension)}${nl}*Pensión CON proyecto:* ${formatNumber(scenario.pensionMensual)}${nl}*Inversión M40:* ${scenario.meses} meses${nl}*Costo Total:* ${formatNumber(scenario.costoTotalContrato)}${nl}*Recuperación (ROI):* ${isFinite(scenario.roiMonths) ? Math.ceil(scenario.roiMonths) : 'N/A'} meses`; break;
                case 'formal': summary = `Estimado(a) ${nombre},${nl}${nl}Adjunto un resumen de la proyección de pensión elaborada para usted:${nl}${nl}*I. Pensión Base (Sin Inversión):*${nl}   - Monto Mensual: ${formatNumber(basePension)}${nl}${nl}*II. Pensión Proyectada (Con Estrategia M40):*${nl}   - Duración de Inversión: ${scenario.meses} meses.${nl}   - Pensión Mensual Bruta: *${formatNumber(scenario.pensionMensual)}*.${nl}${nl}*III. Análisis Financiero:*${nl}   - Costo Total del Proyecto: ${formatNumber(scenario.costoTotalContrato)}.${nl}   - Tiempo de Recuperación de Inversión (ROI): ${isFinite(scenario.roiMonths) ? Math.ceil(scenario.roiMonths) : 'N/A'} meses.${nl}${nl}Quedo a su disposición para cualquier aclaración.`; break;
                case 'numerico': summary = `*Resumen Numérico - ${nombre}*${nl}${divider}${nl}Semanas Base: ${formatNumberRaw(AppState.datosClienteInfo.semanasCotizadasBase, 0)}${nl}SBC Base: ${formatNumber(AppState.datosClienteInfo.sbcPromedioBase)}${nl}Pensión Base: ${formatNumber(basePension)}${nl}${divider}${nl}*Proyección M40*${nl}Meses Inversión: ${scenario.meses}${nl}SBC Proyectado: ${formatNumber(scenario.sbcPromedio)}${nl}Semanas Finales: ${formatNumberRaw(scenario.semanas, 0)}${nl}Pensión Proyectada: ${formatNumber(scenario.pensionMensual)}${nl}${divider}${nl}*Financiero*${nl}Costo M40: ${formatNumber(scenario.costoM40)}${nl}Costo Total: ${formatNumber(scenario.costoTotalContrato)}${nl}Préstamo: ${formatNumber(scenario.prestamoRequerido)}${nl}ROI (meses): ${isFinite(scenario.roiMonths) ? Math.ceil(scenario.roiMonths) : 'N/A'}`; break;
            }
            document.getElementById('whatsappSummaryText').value = summary;
            showElement('whatsappSummaryContainer');
        }

        function copyWhatsappSummary() {
            const textarea = document.getElementById('whatsappSummaryText');
            textarea.select();
            document.execCommand('copy');
            showCustomAlert('¡Resumen copiado al portapapeles!', 'Éxito');
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeMainAppDisplay();
            initDateSelectors();
            document.getElementById('agreementCheckbox').addEventListener('change', (e) => { document.getElementById('acceptAgreementButton').disabled = !e.target.checked; });
            document.getElementById('login_password').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
            document.getElementById('agreementDate').textContent = new Date().toLocaleDateString('es-MX', { day: 'numeric', month: 'long', year: 'numeric' });
            ['m40_day', 'm40_month', 'm40_year'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    actualizarSBCMaximoM40();
                    actualizarFechaFinM40Display();
                });
            });
            document.getElementById('m40_year').addEventListener('change', updateDaySelector);
            document.getElementById('m40_month').addEventListener('change', updateDaySelector);
            const downloadLoginBtn = document.getElementById('downloadLoginLogsBtn'); if (downloadLoginBtn) downloadLoginBtn.addEventListener('click', () => window.downloadLogs('login_logs'));
            const resetLoginBtn = document.getElementById('resetLoginLogsBtn'); if(resetLoginBtn) resetLoginBtn.addEventListener('click', () => window.resetLogs('login_logs', 'de inicio de sesión'));
            const downloadCalcBtn = document.getElementById('downloadCalcLogsBtn'); if (downloadCalcBtn) downloadCalcBtn.addEventListener('click', () => window.downloadLogs('calculation_logs'));
            const resetCalcBtn = document.getElementById('resetCalcLogsBtn'); if (resetCalcBtn) resetCalcBtn.addEventListener('click', () => window.resetLogs('calculation_logs', 'de cálculos'));
            showElement('confidentialityModal');
        });

        // Make functions globally accessible for HTML onclick
        window.handleQuickCalc = handleQuickCalc;
        window.handleReverseCalc = handleReverseCalc;
        window.generateWhatsappSummary = generateWhatsappSummary;
        window.copyWhatsappSummary = copyWhatsappSummary;
        window.showSection = showSection;
        window.logout = logout;
        window.handleLogin = handleLogin;
        window.acceptAgreement = acceptAgreement;
        // ... (Other functions called from HTML need to be here too)
    </script>
    
    <script type="module">
        const MOCK_DB = {
            users: {
                "ROBERTO ORTIZ": { pass: "9192", role: "admin", status: "active", user: "ROBERTO ORTIZ" },
                "ALMA CANO": { pass: "1251", role: "asesor", status: "active", user: "ALMA CANO" },
                "DANA SALAZAR": { pass: "8712", role: "asesor", status: "active", user: "DANA SALAZAR" },
                "JAVIER BAUTISTA": { pass: "5217", role: "asesor", status: "active", user: "JAVIER BAUTISTA" },
                "FRANCISCO PARGA": { pass: "5332", role: "asesor", status: "active", user: "FRANCISCO PARGA" },
                "CAMILA SANCHEZ": { pass: "0992", role: "asesor", status: "active", user: "CAMILA SANCHEZ" },
                "ROGELIO MUÑOZ": { pass: "5346", role: "asesor", status: "active", user: "ROGELIO MUÑOZ" },
                "MONSERRATH SANTILLAN": { pass: "1039", role: "asesor", status: "active", user: "MONSERRATH SANTILLAN" },
                "CESAR HERNANDEZ": { pass: "5771", role: "asesor", status: "active", user: "CESAR HERNANDEZ" },
                "MARIANO GODINEZ": { pass: "0091", role: "asesor", status: "active", user: "MARIANO GODINEZ" },
                "MIGUEL ROSEMBERG": { pass: "9180", role: "asesor", status: "active", user: "MIGUEL ROSEMBERG" },
                "ZAIRA HERNANDEZ": { pass: "5320", role: "asesor", status: "active", user: "ZAIRA HERNANDEZ" },
                "JOAQUIN MONTAÑEZ": { pass: "7810", role: "asesor", status: "active", user: "JOAQUIN MONTAÑEZ" }
            },
            login_logs: [],
            calculation_logs: [],
            clients: {}
        };
        window.getUserByUsername = async (username) => MOCK_DB.users[username];
        window.logLoginEvent = async (asesor) => { MOCK_DB.login_logs.push({ asesor, timestamp: new Date() }); };
        window.loadAdminPanelData = () => { console.log("Admin data loaded (mock)."); };
        window.loadClients = () => { console.log("Clients loaded (mock)."); };
    </script>
</body>
</html>
