<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Acceso - RGC Pensiones</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the toggle switch */
        body {
            font-family: 'Inter', sans-serif;
        }
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4ade80; /* green-400 */
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4ade80; /* green-400 */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div class="container mx-auto p-4 max-w-md">

        <!-- Login View -->
        <div id="login-view" class="bg-white p-8 rounded-xl shadow-lg transition-opacity duration-500">
            <div class="text-center mb-8">
                <img src="https://placehold.co/150x50/000000/FFFFFF?text=RGC+Pensiones" alt="Logo RGC Pensiones" class="mx-auto mb-4">
                <h1 class="text-2xl font-bold text-gray-800">Control de Acceso</h1>
                <p class="text-gray-500">Por favor, inicia sesión para continuar.</p>
            </div>
            
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-gray-700 font-medium mb-2">Usuario</label>
                    <input type="text" id="username" name="username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej. RGC1" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-700 font-medium mb-2">Contraseña</label>
                    <input type="password" id="password" name="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="••••••••" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out">
                    Acceder
                </button>
            </form>
            <div id="error-message" class="mt-4 text-center text-red-600 font-medium hidden"></div>
        </div>

        <!-- Admin Dashboard View -->
        <div id="admin-view" class="bg-white p-8 rounded-xl shadow-lg hidden transition-opacity duration-500">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Panel de Administrador</h1>
                    <p class="text-gray-500">Bienvenido, <span id="admin-name" class="font-semibold"></span>.</p>
                </div>
                <button id="logout-button-admin" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition">Salir</button>
            </div>
            <p class="mb-4 text-sm text-gray-600">Desde aquí puedes activar o desactivar el acceso de los usuarios.</p>
            <div id="user-list" class="space-y-3">
                <!-- User list will be populated here by JavaScript -->
            </div>
        </div>
        
        <!-- Standard User View -->
        <div id="user-view" class="bg-white p-8 rounded-xl shadow-lg hidden text-center transition-opacity duration-500">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">¡Bienvenido!</h1>
            <p class="text-gray-600 mb-6">Has iniciado sesión correctamente, <span id="user-name" class="font-semibold"></span>.</p>
            <button id="logout-button-user" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition">Salir</button>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Firebase Configuration (Provided by you) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAZqmTm06xpK0p-Is2yVkP-Li1C2147OPI",
            authDomain: "roberto-ortiz.firebaseapp.com",
            projectId: "roberto-ortiz",
            storageBucket: "roberto-ortiz.firebasestorage.app",
            messagingSenderId: "687545235901",
            appId: "1:687545235901:web:f166f8b908d4915e3e3ad4",
            measurementId: "G-2C952803EL"
        };
        
        // --- App Initialization ---
        let db;
        let auth;
        let loggedInUser = null;
        let unsubscribeUserList = null;
        
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            await signInAnonymously(auth);
            console.log("Firebase initialized and user signed in anonymously.");
            seedInitialData();
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            document.getElementById('error-message').textContent = 'Error al conectar con el servidor. Inténtalo más tarde.';
            document.getElementById('error-message').classList.remove('hidden');
        }


        // --- Initial User Data ---
        const initialUsers = {
            'roberto ortiz': { password: '9192', role: 'admin', active: true },
            'alma cano': { password: '9192', role: 'admin', active: true },
            'mariano godinez': { password: '9090', role: 'user', active: true },
            // --- Usuarios RGC añadidos (en mayúsculas) ---
            'RGC1': { password: '4729', role: 'user', active: true },
            'RGC2': { password: '8315', role: 'user', active: true },
            'RGC3': { password: '6092', role: 'user', active: true },
            'RGC4': { password: '1578', role: 'user', active: true },
            'RGC5': { password: '9234', role: 'user', active: true },
            'RGC6': { password: '5801', role: 'user', active: true },
            'RGC7': { password: '2468', role: 'user', active: true },
            'RGC8': { password: '7139', role: 'user', active: true }
        };

        // --- DOM Elements ---
        const loginView = document.getElementById('login-view');
        const adminView = document.getElementById('admin-view');
        const userView = document.getElementById('user-view');
        const loginForm = document.getElementById('login-form');
        const errorMessage = document.getElementById('error-message');
        const userListContainer = document.getElementById('user-list');

        // --- Functions ---

        /**
         * Seeds the database with initial user data if the collection is empty.
         */
        async function seedInitialData() {
            try {
                const usersCollectionRef = collection(db, "users");
                const snapshot = await getDocs(usersCollectionRef);
                if (snapshot.empty) {
                    console.log("No users found. Seeding initial data...");
                    for (const username in initialUsers) {
                        const user = initialUsers[username];
                        await setDoc(doc(db, "users", username), user);
                    }
                    console.log("Database seeded successfully.");
                } else {
                    console.log("Users collection already exists. Skipping seed.");
                }
            } catch (error) {
                console.error("Error seeding data: ", error);
            }
        }
        
        /**
         * Handles the login process.
         * @param {Event} e - The form submission event.
         */
        async function handleLogin(e) {
            e.preventDefault();
            errorMessage.classList.add('hidden');
            const usernameInput = loginForm.username.value.trim();
            const password = loginForm.password.value;

            if (!usernameInput || !password) {
                showError("Por favor, ingresa usuario y contraseña.");
                return;
            }

            try {
                // CORREGIDO: Lógica de mayúsculas/minúsculas mejorada
                let usernameToSearch;
                if (usernameInput.toLowerCase().startsWith('rgc')) {
                    usernameToSearch = usernameInput.toUpperCase();
                } else {
                    usernameToSearch = usernameInput.toLowerCase();
                }
                
                const userDocRef = doc(db, "users", usernameToSearch);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    
                    if (userData.password === password) {
                        if (userData.active) {
                            loggedInUser = { username: userDoc.id, ...userData };
                            showDashboard();
                        } else {
                            showError("Tu cuenta está desactivada. Contacta a un administrador.");
                        }
                    } else {
                        showError("Usuario o contraseña incorrectos.");
                    }
                } else {
                    showError("Usuario o contraseña incorrectos.");
                }
            } catch (error) {
                console.error("Login error:", error);
                showError("Ocurrió un error al intentar iniciar sesión.");
            }
        }
        
        async function toggleUserStatus(username, newStatus) {
             try {
                const userDocRef = doc(db, "users", username);
                await updateDoc(userDocRef, { active: newStatus });
             } catch (error) {
                console.error("Error updating user status:", error);
            }
        }

        /**
         * Renders the list of users for the admin dashboard.
         */
        function renderAdminDashboard() {
            document.getElementById('admin-name').textContent = loggedInUser.username;
            const usersCollectionRef = collection(db, "users");
            
            unsubscribeUserList = onSnapshot(usersCollectionRef, (snapshot) => {
                userListContainer.innerHTML = ''; 
                snapshot.docs.forEach(doc => {
                    const user = doc.data();
                    const username = doc.id;
                    const isCurrentUser = username === loggedInUser.username;
                    
                    // CORREGIDO: Crear un ID seguro para elementos HTML, reemplazando espacios
                    const safeUsernameId = username.replace(/\s+/g, '-');

                    const userElement = document.createElement('div');
                    userElement.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg border';
                    
                    let roleText = user.role === 'admin' ? 'Administrador' : 'Usuario';
                    
                    userElement.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-800">${username}</p>
                            <p class="text-xs text-gray-500">${roleText}</p>
                            <p class="text-xs text-gray-400 mt-1">Contraseña: <span class="font-mono font-semibold text-gray-600">${user.password}</span></p>
                        </div>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="toggle-${safeUsernameId}" 
                                   class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" 
                                   ${user.active ? 'checked' : ''} 
                                   ${isCurrentUser ? 'disabled' : ''} />
                            <label for="toggle-${safeUsernameId}" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                        </div>
                    `;
                    
                    userListContainer.appendChild(userElement);

                    if (!isCurrentUser) {
                        const toggle = userElement.querySelector(`#toggle-${safeUsernameId}`);
                        toggle.addEventListener('change', (e) => {
                            toggleUserStatus(username, e.target.checked);
                        });
                    }
                });
            }, (error) => {
                console.error("Error listening to user list:", error);
            });
        }

        function showDashboard() {
            loginView.classList.add('hidden');
            loginForm.reset();
            
            if (loggedInUser.role === 'admin') {
                renderAdminDashboard();
                adminView.classList.remove('hidden');
            } else {
                document.getElementById('user-name').textContent = loggedInUser.username;
                userView.classList.remove('hidden');
            }
        }
        
        function handleLogout() {
            loggedInUser = null;
            if(unsubscribeUserList) {
                unsubscribeUserList();
                unsubscribeUserList = null;
            }
            adminView.classList.add('hidden');
            userView.classList.add('hidden');
            loginView.classList.remove('hidden');
            errorMessage.classList.add('hidden');
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        // --- Event Listeners ---
        loginForm.addEventListener('submit', handleLogin);
        document.getElementById('logout-button-admin').addEventListener('click', handleLogout);
        document.getElementById('logout-button-user').addEventListener('click', handleLogout);

    </script>
</body>
</html>

