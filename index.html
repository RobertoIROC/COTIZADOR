<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RGC Pensiones - Calculadora de Proyección Optimizada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --dark-blue: #003366;
            /* Azul marino profundo */
            --gold: #D4AF37;
            /* Oro metálico */
            --dark-gold: #B8860B;
            /* Oro oscuro para hover */
            --text-dark: #1A202C;
            /* Casi negro */
            --text-medium: #4A5568;
            /* Gris oscuro */
            --bg-light: #F0F2F5;
            /* Gris más suave */
            --white: #FFFFFF;
            --border-color: #E2E8F0;
            --success-color: #16A34A;
            --danger-color: #DC2626;
            --warning-color: #FBBF24;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translate3d(0, 20px, 0);
            }
            to {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }

        .fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
        }

        body {
            font-family: 'Lato', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-medium);
        }

        /* Encabezado Principal */
        .main-header {
            background: linear-gradient(135deg, var(--dark-blue) 0%, #002244 100%);
            color: var(--white);
            padding: 3rem 1rem;
            text-align: center;
            border-radius: 0 0 50px 50px;
            box-shadow: 0 10px 30px rgba(0, 34, 68, 0.2);
            margin-bottom: 3rem;
            position: relative;
            overflow: hidden;
        }

        .main-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            animation: pan-background 45s linear infinite;
        }

        @keyframes pan-background {
            from { transform: translate(0, 0); }
            to { transform: translate(100px, 100px); }
        }

        .logo-text-elegant {
            font-family: 'Playfair Display', serif;
            font-weight: 800;
            font-size: 2.5rem;
            color: var(--gold);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            letter-spacing: 1.5px;
        }

        .main-header .logo-text-elegant {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .main-header h1 {
            font-family: 'Lato', sans-serif;
            font-weight: 900;
            font-size: 2.5rem;
            letter-spacing: -0.5px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
        }

        /* Estructura de Secciones */
        .infographic-section {
            background-color: var(--white);
            border-radius: 24px;
            padding: 2.5rem 3rem;
            margin-bottom: 2.5rem;
            box-shadow: 0 10px 40px rgba(0, 51, 102, 0.1);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .infographic-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(90deg, var(--dark-blue), var(--gold));
        }


        .infographic-section h2 {
            font-family: 'Lato', sans-serif;
            font-weight: 900;
            font-size: 1.875rem;
            margin-bottom: 2.5rem;
            color: var(--dark-blue);
            display: flex;
            align-items: center;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 1.25rem;
        }

        .infographic-section h2 i {
            margin-right: 1.25rem;
            font-size: 1.75rem;
            color: var(--gold);
            background: var(--dark-blue);
            padding: 0.75rem;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .infographic-section h3.subsection-title {
            font-family: 'Lato', sans-serif;
            font-weight: 700;
            font-size: 1.375rem;
            color: var(--dark-blue);
            margin-top: 2rem;
            margin-bottom: 1.5rem;
        }

        /* Formularios y Entradas */
        .input-group {
            position: relative;
        }

        .input-group label {
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: var(--text-medium);
            font-size: 0.9rem;
            display: block;
        }

        .input-group input[type="text"],
        .input-group input[type="password"],
        .input-group input[type="number"],
        .input-group input[type="month"],
        .input-group input[type="date"],
        .input-group select,
        .input-group textarea {
            padding: 0.9rem 1.25rem;
            border: 1px solid #CBD5E0;
            border-radius: 12px;
            font-size: 1rem;
            width: 100%;
            transition: all 0.2s ease-in-out;
            background-color: var(--bg-light);
        }
        
        .input-with-icon {
             padding-left: 3rem !important;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            border-color: var(--gold);
            box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.25);
            outline: none;
            background-color: var(--white);
        }

        .input-group input[readonly] {
            background-color: #E9ECEF;
            cursor: not-allowed;
        }

        /* Toggle Switch CSS */
        input:checked ~ .dot {
            transform: translateX(100%);
            background-color: var(--gold);
        }
        input:checked ~ .block {
            background-color: var(--dark-blue);
        }


        /* Botones */
        .btn {
            font-family: 'Lato', sans-serif;
            font-weight: 700;
            padding: 1rem 2.25rem;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: none;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .btn:disabled {
            background: #A0AEC0;
            color: #E2E8F0;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        
        .btn:hover:not(:disabled) {
             transform: translateY(-3px) scale(1.02);
             box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .btn:active:not(:disabled) {
            transform: translateY(0px) scale(1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }


        .btn-gold {
            background: linear-gradient(135deg, var(--gold), var(--dark-gold));
            color: var(--dark-blue);
        }

        .btn-blue {
            background: linear-gradient(135deg, var(--dark-blue), #004488);
            color: var(--white);
        }

        .btn-secondary {
            background-color: var(--white);
            color: var(--dark-blue);
            border: 2px solid var(--dark-blue);
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: var(--dark-blue);
            color: var(--white);
        }

        .btn-danger-icon {
            background-color: #FFF1F2;
            color: #E53E3E;
            border: 1px solid #E53E3E;
            padding: 0.5rem;
            width: 36px;
            height: 36px;
            border-radius: 50%;
        }

        .btn-danger-icon:hover {
            background-color: #E53E3E;
            color: var(--white);
        }

        /* Employment Card Styles */
        .employment-card {
            background-color: #F8F9FA;
            border: 1px solid #E2E8F0;
            border-left: 6px solid var(--dark-blue);
            border-radius: 1rem;
            padding: 1.5rem 2rem;
            margin-bottom: 1.5rem;
            position: relative;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .employment-card:hover {
             box-shadow: 0 5px 15px rgba(0,0,0,0.08);
             transform: translateY(-2px);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 34, 68, 0.7);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background-color: var(--white);
            padding: 3rem;
            border-radius: 24px;
            box-shadow: 0 15px 50px rgba(0, 51, 102, 0.25);
            max-width: 90%;
            width: 650px;
            border-top: 8px solid var(--gold);
            transform: scale(0.95) translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1) translateY(0);
        }

        .modal-content-alert {
            text-align: center;
            width: 450px;
        }

        .modal-content h2 {
            font-family: 'Lato', sans-serif;
            color: var(--dark-blue);
            font-size: 1.75rem;
            font-weight: 900;
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .app-footer {
            text-align: center;
            margin-top: 4rem;
            padding: 3rem 1rem;
            background-color: var(--dark-blue);
            color: var(--white);
            border-radius: 50px 50px 0 0;
        }

        .app-footer .logo-text-footer {
            font-family: 'Playfair Display', serif;
            color: var(--gold);
            font-weight: 700;
            font-size: 1.5rem;
            margin-bottom: 1.25rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .app-footer p {
            opacity: 0.8;
        }

        /* D3 Timeline Tooltip Styles */
        #timeline-tooltip {
            position: absolute;
            text-align: left;
            padding: 10px 14px;
            font-size: 13px;
            background: var(--text-dark);
            color: white;
            border: 0px;
            border-radius: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
    </style>
</head>

<body>
    <div id="loginScreen" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-50 transition-opacity duration-500" style="display: none;">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-2xl shadow-2xl text-center">
            <div class="logo-text-elegant !text-3xl text-center">RGC Pensiones</div>
            <h2 class="text-2xl font-bold text-gray-800">Inicio de Sesión</h2>
            <form id="loginForm" class="space-y-6">
                <div class="input-group">
                    <label for="username" class="sr-only">Usuario</label>
                    <div class="relative">
                        <i class="fas fa-user absolute top-1/2 left-4 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="username" placeholder="Nombre de usuario" required class="w-full input-with-icon">
                    </div>
                </div>
                <div class="input-group">
                    <label for="password" class="sr-only">Contraseña</label>
                     <div class="relative">
                        <i class="fas fa-lock absolute top-1/2 left-4 -translate-y-1/2 text-gray-400"></i>
                        <input type="password" id="password" placeholder="Contraseña" required class="w-full input-with-icon">
                    </div>
                </div>
                <button type="submit" class="btn btn-blue w-full !text-base">
                    <i class="fas fa-sign-in-alt"></i> Ingresar
                </button>
            </form>
        </div>
    </div>

    <div id="appContainer" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl" style="display: none;">
        <header class="main-header">
            <div class="absolute top-4 right-8 text-white" id="userInfoContainer" style="display: none;">
                <span id="loggedInUserName"></span>
                <button onclick="handleLogout()" class="ml-4 font-bold hover:underline">[ Salir ]</button>
            </div>
            <div class="logo-text-elegant">RGC Pensiones y Seguros</div>
            <h1>Calculadora de Proyección de Pensión</h1>
        </header>
        <section id="adminPanel" class="infographic-section" style="display: none;">
            <h2><i class="fas fa-users-cog"></i>Panel de Administración</h2>
            <p class="mb-6">Administrar el acceso de los usuarios a la calculadora.</p>
            <div id="userManagementTableContainer"></div>
        </section>
        <div id="calculatorSection">
            <section id="infoSection1" class="infographic-section">
                <h2><i class="fas fa-user-edit"></i>Paso 1: Datos y Análisis del Historial</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-x-16 gap-y-8">
                    <div>
                        <h3 class="subsection-title !mt-0">Datos del Asegurado</h3>
                        <div class="bg-gray-50 border border-gray-200 rounded-2xl p-6">
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">
                                <div class="input-group md:col-span-2">
                                    <label for="info_nombreCompleto">Nombre Completo del Asegurado</label>
                                    <div class="relative">
                                        <i class="fas fa-user absolute top-1/2 left-4 -translate-y-1/2 text-gray-400 pointer-events-none transition-colors peer-focus:text-amber-500"></i>
                                        <input type="text" id="info_nombreCompleto" placeholder="Ej. Juan Pérez García" class="w-full input-with-icon peer">
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label for="info_curpCliente">CURP</label>
                                    <div class="relative">
                                        <i class="fas fa-id-card absolute top-1/2 left-4 -translate-y-1/2 text-gray-400 pointer-events-none transition-colors peer-focus:text-amber-500"></i>
                                        <input type="text" id="info_curpCliente" placeholder="18 caracteres" maxlength="18" oninput="this.value = this.value.toUpperCase();" class="w-full input-with-icon peer">
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label for="info_telefonoCliente">Teléfono de Contacto</label>
                                    <div class="relative">
                                        <i class="fas fa-phone absolute top-1/2 left-4 -translate-y-1/2 text-gray-400 pointer-events-none transition-colors peer-focus:text-amber-500"></i>
                                        <input type="text" id="info_telefonoCliente" placeholder="10 dígitos" maxlength="10" class="w-full input-with-icon peer">
                                    </div>
                                </div>
                                <div class="input-group md:col-span-2">
                                    <label for="info_semanasTotalesManual">Semanas Cotizadas Totales (Base)</label>
                                    <div class="relative">
                                        <i class="fas fa-calendar-week absolute top-1/2 left-4 -translate-y-1/2 text-gray-400 pointer-events-none transition-colors peer-focus:text-amber-500"></i>
                                        <input type="number" id="info_semanasTotalesManual" placeholder="Obtenidas de la constancia" class="w-full input-with-icon peer">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="subsection-title !mt-0">Análisis de Semanas Cotizadas</h3>
                        <div class="bg-blue-50 border border-blue-200 rounded-2xl p-6 mb-6">
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-lg mb-6" role="alert">
                                <p class="font-bold">Instrucción Importante</p>
                                <p class="text-sm">Para el análisis automático, convierta la Constancia de Semanas Cotizadas (PDF) a un documento de Word, copie todo el texto y péguelo a continuación.</p>
                                <a href="https://www.ilovepdf.com/es/pdf_a_word" target="_blank" class="btn btn-gold mt-4 text-sm !py-2">
                                    <i class="fas fa-file-word"></i> Abrir Conversor PDF a Word
                                </a>
                            </div>
                            <div class="input-group">
                                <label for="info_textoCompleto">Pegue aquí el texto del documento:</label>
                                <div class="flex items-center mb-2">
                                    <input type="checkbox" id="isSisecNoDetallado" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <label for="isSisecNoDetallado" class="ml-2 text-sm text-gray-600">Marcar si es una constancia de semanas cotizadas (SISEC no detallado)</label>
                                </div>
                                <textarea id="info_textoCompleto" class="w-full font-mono text-sm" rows="8" placeholder="Pegue aquí el contenido completo, desde el nombre del asegurado hasta el último movimiento..."></textarea>
                            </div>
                            <div class="text-center mt-6">
                                <button onclick="analizarTextoCompleto()" class="btn btn-blue">
                                    <i class="fas fa-magic"></i> Procesar y Analizar Historial
                                </button>
                            </div>
                        </div>
                        <div>
                            <h3 class="subsection-title">O ingrese los periodos laborales manualmente:</h3>
                            <div id="employmentCardsContainerWrapper">
                                <button id="toggleCardsBtn" onclick="toggleAutoCards()" class="btn btn-secondary mb-4" style="display: none;">Mostrar/Ocultar Tarjetas Automáticas</button>
                                <div id="employmentCardsContainer" style="display: none;"></div>
                            </div>
                            <button onclick="addEmploymentCard()" class="btn btn-secondary mt-4"><i class="fas fa-plus mr-2"></i>Agregar Periodo Laboral</button>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-12 pt-8 border-t-2 border-dashed">
                    <button onclick="analizarYCalcularSBC()" class="btn btn-blue text-lg">
                        <i class="fas fa-calculator mr-2"></i>Analizar y Calcular Pensión Base
                    </button>
                </div>
                <div id="sbcAnalysisResultsContainer" class="mt-12 pt-8 border-t" style="display: none;">
                    <h3 class="subsection-title">Resumen del Análisis</h3>
                    <div id="ageAdjustmentWarning" class="mb-4 p-3 rounded-lg text-sm bg-yellow-50 border border-yellow-200 text-yellow-800" style="display: none;"></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 text-center">
                         <div class="bg-gray-50 p-6 rounded-2xl shadow-sm border">
                             <div class="text-3xl text-blue-500 mb-3"><i class="fas fa-coins"></i></div>
                            <p class="text-sm text-gray-500">SBC Promedio (Últ. 250 sem.)</p>
                            <p id="res_sbcPromedio" class="text-3xl font-bold text-blue-900 mt-1">$0.00</p>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-2xl shadow-sm border">
                            <div class="text-3xl text-blue-500 mb-3"><i class="fas fa-calendar-check"></i></div>
                            <p class="text-sm text-gray-500">Semanas Netas a Considerar</p>
                            <p id="res_semanasNetas" class="text-3xl font-bold text-blue-900 mt-1">0</p>
                        </div>
                         <div class="bg-gray-50 p-6 rounded-2xl shadow-sm border">
                              <div class="text-3xl text-blue-500 mb-3"><i class="fas fa-birthday-cake"></i></div>
                            <p class="text-sm text-gray-500">Edad Actual</p>
                            <p id="res_edadActual" class="text-3xl font-bold text-blue-900 mt-1">0 años</p>
                        </div>
                         <div class="bg-gray-50 p-6 rounded-2xl shadow-sm border">
                             <div class="text-3xl text-blue-500 mb-3"><i class="fas fa-phone-alt"></i></div>
                            <p class="text-sm text-gray-500">Teléfono</p>
                            <p id="res_telefonoCliente" class="text-3xl font-bold text-blue-900 mt-1">--</p>
                        </div>
                        <div id="vigenciaResultBox" class="p-6 rounded-2xl shadow-sm border md:col-span-2 lg:col-span-4">
                            <p id="vigenciaResultText" class="text-3xl font-bold">--</p>
                            <p id="vigenciaResultSubText" class="text-base mt-2">--</p>
                        </div>
                    </div>
                    <div class="mt-10 overflow-x-auto">
                        <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                            <h4 class="font-semibold text-gray-700 text-lg">Historial Laboral Considerado para Cálculo</h4>
                            <div class="flex items-center space-x-4">
                                <div class="flex items-center">
                                    <input type="checkbox" id="showFullHistoryCheckbox" onchange="renderSbcAnalysisTable()" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <label for="showFullHistoryCheckbox" class="ml-2 text-sm text-gray-600">Mostrar historial completo</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="checkbox" id="showSbcBreakdownCheckbox" onchange="renderSbcAnalysisTable()" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <label for="showSbcBreakdownCheckbox" class="ml-2 text-sm text-gray-600">Desglosar por empleador</label>
                                </div>
                            </div>
                        </div>
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="p-3 rounded-l-lg">Registro Patronal</th>
                                    <th class="p-3">Fecha Inicio</th>
                                    <th class="p-3">Fecha Fin</th>
                                    <th class="p-3 text-right">Días</th>
                                    <th class="p-3 text-right">SBC Diario</th>
                                    <th class="p-3 text-right rounded-r-lg">SBC Ponderado (para cálculo)</th>
                                </tr>
                            </thead>
                            <tbody id="sbcAnalysisTableBody">
                            </tbody>
                            <tfoot id="sbcAnalysisTableFooter" class="font-bold bg-gray-100">
                            </tfoot>
                        </table>
                        <div id="sbcDaysWarning" class="mt-4 p-3 rounded-lg text-sm" style="display: none;"></div>
                        <div id="modalitySummaryContainer" class="mt-6"></div>
                    </div>
                </div>
                <div id="timelineSection" class="mt-12 pt-8 border-t" style="display: none;">
                    <div class="flex justify-between items-center mb-2 flex-wrap gap-y-2">
                        <h3 id="timelineTitle" class="subsection-title !mb-0">Línea de Tiempo del Historial Laboral</h3>
                        <div class="flex items-center">
                            <input type="checkbox" id="showFullTimelineHistory" onchange="toggleFullHistoryTimeline()" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <label for="showFullTimelineHistory" class="ml-2 text-sm text-gray-600">Mostrar historial completo</label>
                        </div>
                    </div>
                    <div id="timeline-container" class="w-full h-96 overflow-x-auto bg-gray-50 p-4 rounded-xl border"><svg id="timeline-svg"></svg></div>
                    <div id="timeline-legend" class="flex flex-wrap gap-x-4 gap-y-2 mt-4 p-2 border-t"></div>
                </div>
                <div id="basePensionResultsContainer" class="mt-8" style="display: none;">
                    <h3 class="subsection-title">Cálculo de Pensión Base (Sin Modalidad 40)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                        <div class="bg-green-50 p-6 rounded-2xl shadow-sm border border-green-200">
                            <p class="text-sm text-green-800">Pensión Mensual Estimada</p>
                            <p id="res_base_pensionMensual" class="text-3xl font-bold text-green-900 mt-1">$0.00</p>
                        </div>
                        <div class="bg-green-50 p-6 rounded-2xl shadow-sm border border-green-200">
                            <p class="text-sm text-green-800">Aguinaldo Estimado</p>
                            <p id="res_base_aguinaldo" class="text-3xl font-bold text-green-900 mt-1">$0.00</p>
                        </div>
                        <div class="bg-green-50 p-6 rounded-2xl shadow-sm border border-green-200">
                            <p class="text-sm text-green-800">Ingreso Anual Total Estimado</p>
                            <p id="res_base_ingresoAnual" class="text-3xl font-bold text-green-900 mt-1">$0.00</p>
                        </div>
                    </div>
                </div>
            </section>
            <section id="infoSection2" class="infographic-section">
                <h2><i class="fas fa-chart-line"></i>Paso 2: Proyección con Modalidad 40</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-16 gap-y-6">
                    <div>
                        <h3 class="subsection-title">Definir Periodo de Inversión</h3>
                        <div id="lastBajaDateHint" class="text-sm text-gray-600 mb-4 font-semibold"></div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-6">
                            <div class="input-group sm:col-span-2">
                                <label>Fecha Inicio M40:</label>
                                <div class="flex gap-4">
                                    <select id="m40_day" class="w-full">
                                        <option value="">Día</option>
                                    </select>
                                    <select id="m40_month" class="w-full">
                                        <option value="">Mes</option>
                                    </select>
                                    <select id="m40_year" class="w-full">
                                        <option value="">Año</option>
                                    </select>
                                </div>
                            </div>
                            <div class="input-group">
                                <label for="info_m40_p1_meses">Meses de Inversión en M40:</label>
                                <input type="number" id="info_m40_p1_meses" placeholder="Ej. 60" max="60" oninput="actualizarFechaFinM40Display()" class="w-full">
                            </div>
                            <div class="input-group">
                                <label for="info_m40_p1_sbc">SBC Diario para M40 (Tope):</label>
                                <input type="number" id="info_m40_p1_sbc" placeholder="Cálculo automático" class="w-full">
                            </div>
                        </div>
                        <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-xl text-center">
                            <div id="info_m40_baja_display" class="text-base font-semibold text-blue-800 leading-relaxed">
                                -- Ingrese los datos para calcular la edad de retiro --
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center">
                            <h3 class="subsection-title">Tabla de Referencia UMA</h3>
                            <button id="editUmasBtn" onclick="promptForPassword(enableUmaEditing)" class="btn btn-secondary !py-1 !px-3 text-xs"><i class="fas fa-pencil-alt mr-2"></i>Editar Futuras</button>
                        </div>
                        <div id="umaEditControls" class="hidden text-right mb-2 space-x-2">
                            <button onclick="saveUmas()" class="btn btn-blue !py-1 !px-3 text-xs">Guardar</button>
                            <button onclick="populateUmaTable()" class="btn btn-secondary !py-1 !px-3 text-xs">Cancelar</button>
                        </div>
                        <div class="overflow-x-auto max-h-72 border rounded-xl">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-100 sticky top-0">
                                    <tr>
                                        <th class="p-3">Año</th>
                                        <th class="p-3 text-right">Valor UMA Diario</th>
                                        <th class="p-3 text-right">SBC Tope (25 UMAs)</th>
                                    </tr>
                                </thead>
                                <tbody id="umaReferenceTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-12 pt-8 border-t-2 border-dashed">
                    <button id="btnCalcularEscenarioM40" onclick="calcularEscenarioM40Infografia()" class="btn btn-gold text-lg">
                        <i class="fas fa-cogs"></i>Calcular Proyección con M40
                    </button>
                </div>
            </section>
            <section id="infoSection3" class="infographic-section" style="display: none;">
                <h2><i class="fas fa-hand-holding-usd"></i>Paso 3: Parámetros del Análisis Financiero</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div class="input-group">
                        <label for="info_aforeActual">Saldo Actual en AFORE ($):</label>
                        <input type="number" id="info_aforeActual" placeholder="0.00" oninput="recalculateAllScenarios();">
                    </div>
                    <div class="input-group">
                        <label for="info_mesesPrimerDeposito">Meses para Primer Depósito (6-12):</label>
                        <input type="number" id="info_mesesPrimerDeposito" value="6" min="6" max="12" onchange="handleMesesDepositoChange(this)" data-last-valid="6">
                    </div>
                    <div class="input-group md:col-span-2">
                        <label for="info_comisionExcedente">Comisión Adicional ($) y Concepto:</label>
                        <div class="flex gap-4">
                            <input type="number" id="info_comisionExcedente" placeholder="0.00" oninput="recalculateAllScenarios();" class="w-1/2">
                            <input type="text" id="info_comisionExcedente_concepto" placeholder="Concepto para reporte" class="w-1/2">
                        </div>
                    </div>
                    <div class="md:col-span-2 mt-6">
                        <button id="toggleAdvancedParamsBtn" onclick="promptForPassword(toggleAdvancedEditing)" class="btn btn-secondary w-full"><i class="fas fa-cogs mr-2"></i>Editar Parámetros Financieros Avanzados</button>
                        <div id="advancedParamsContainer" class="hidden mt-4 p-4 border-2 border-dashed rounded-lg bg-gray-50">
                            <h4 class="font-bold text-center text-gray-700 mb-4">Parámetros Avanzados (Requiere Contraseña)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                                <div class="input-group">
                                    <label for="info_inpcGrowth">Estimación Crecimiento INPC Anual (%):</label>
                                    <input type="number" id="info_inpcGrowth" value="6" step="0.1" class="w-full" oninput="updateAdvancedConstants(true)" disabled>
                                </div>
                                <div class="input-group">
                                    <label for="info_m40surcharge">Tasa Recargo M40 Mensual (2026 en adelante, %):</label>
                                    <input type="number" id="info_m40surcharge" value="1.47" step="0.01" class="w-full" oninput="updateAdvancedConstants(true)" disabled>
                                </div>
                                <div class="input-group md:col-span-2 text-center">
                                    <button id="commissionToggleButton" onclick="promptToChangeCommission()" class="btn btn-secondary w-full">
                                        Comisión Base Actual: 16% (Click para cambiar)
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <section id="infoSection4" class="infographic-section" style="display: none;">
                <h2><i class="fas fa-balance-scale-right"></i>Paso 4: Comparativa de Escenarios</h2>
                <div id="umaSelectorContainer" class="mb-8 p-6 bg-blue-50 border-2 border-dashed border-blue-200 rounded-2xl" style="display: none;">
                    <h4 class="font-bold text-center text-gray-800 text-lg mb-4">Selector Rápido de SBC para Escenario Principal</h4>
                    <p class="text-center text-sm text-gray-600 mb-5">Ajuste el Salario Base de Cotización para la proyección de Modalidad 40. Los cambios se aplicarán a los escenarios principales y se recalculará todo.</p>
                    <div class="flex justify-center flex-wrap gap-4" id="umaButtons">
                        <button onclick="setSBCFromUMA(25)" class="btn btn-secondary !py-2 !px-5 text-base" data-uma="25">25 UMA (Tope)</button>
                        <button onclick="setSBCFromUMA(20)" class="btn btn-secondary !py-2 !px-5 text-base" data-uma="20">20 UMA</button>
                        <button onclick="setSBCFromUMA(15)" class="btn btn-secondary !py-2 !px-5 text-base" data-uma="15">15 UMA</button>
                    </div>
                </div>
                <div id="benchmarkingResult" class="mb-4 p-3 rounded-lg text-sm bg-blue-50 border border-blue-200 text-blue-800" style="display: none;"></div>
                <div id="scenariosContainer" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                </div>
                <div class="text-center mt-10">
                    <button id="addScenarioBtn" onclick="addScenarioCard()" class="btn btn-secondary"><i class="fas fa-plus mr-2"></i>Agregar Escenario</button>
                </div>
            </section>
            <section id="infoSection5" class="infographic-section" style="display: none;">
                <h2><i class="fas fa-file-export"></i>Paso 5: Reportes y Exportación</h2>
                <p class="mb-8 text-gray-600 text-lg max-w-2xl mx-auto">Genere resúmenes y reportes detallados para el asegurado.</p>
                
                <div class="text-center">
                    <h3 class="subsection-title">Resúmenes Rápidos</h3>
                    <div class="flex justify-center flex-wrap gap-6">
                        <button onclick="showWhatsAppModal()" class="btn !bg-green-500 hover:!bg-green-600 !text-white text-lg">
                            <i class="fab fa-whatsapp"></i> Resumen para WhatsApp
                        </button>
                        <button onclick="startComprehensiveReportProcess()" class="btn btn-blue text-lg">
                            <i class="fas fa-file-invoice"></i> Reporte Detallado a PDF
                        </button>
                    </div>
                </div>

                <div class="text-center mt-12 pt-8 border-t">
                    <h3 class="subsection-title">Evolución del Patrimonio a lo Largo del Tiempo</h3>
                    <p class="mb-6 text-gray-600 max-w-3xl mx-auto">Esta herramienta compara el rendimiento de las estrategias de M40 contra un escenario base, mostrando cuándo se recupera la inversión del AFORE y el crecimiento a largo plazo.</p>
                    <div class="max-w-4xl mx-auto bg-gray-50 p-6 rounded-2xl border">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 items-end">
                            <div class="input-group">
                                <label for="info_pensionMinima">Pensión Mínima Garantizada (Referencia):</label>
                                <input type="number" id="info_pensionMinima" placeholder="Ej. 7000" class="w-full">
                            </div>
                            <div class="input-group">
                                <label>Seleccione el Periodo de Proyección:</label>
                                <div id="roiYearButtons" class="flex flex-wrap justify-start gap-3 mt-2">
                                    <button onclick="generateROIMatrix(5)" class="btn btn-secondary !py-2 !px-5 text-base" data-years="5">5 Años</button>
                                    <button onclick="generateROIMatrix(10)" class="btn btn-secondary !py-2 !px-5 text-base" data-years="10">10 Años</button>
                                    <button onclick="generateROIMatrix(15)" class="btn btn-secondary !py-2 !px-5 text-base" data-years="15">15 Años</button>
                                    <button onclick="generateROIMatrix(20)" class="btn btn-secondary !py-2 !px-5 text-base" data-years="20">20 Años</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="roiAnalysisContainer" class="mt-10" style="display: none;">
                        <div id="roiSummary" class="mb-6 text-left max-w-4xl mx-auto space-y-2"></div>
                        <div id="roiChartContainer" class="w-full h-96 mb-8 p-4 border rounded-xl shadow-lg bg-white">
                            <!-- Chart will be generated here by JS -->
                        </div>
                        <div id="roiTableContainer" class="overflow-x-auto max-h-[600px] border rounded-xl shadow-lg">
                            <!-- Table will be generated here by JS -->
                        </div>
                    </div>
                </div>
            </section>
        </div>
        <footer class="app-footer">
            <div class="logo-text-footer">RGC PENSIONES Y SEGUROS</div>
            <p>&copy; <span id="currentYear"></span> RGC Pensiones y Seguros. Todos los derechos reservados. | Versión 3.4 Optimizada</p>
            <p class="text-xs mt-1 opacity-70">Esta es una simulación y los resultados pueden variar. Consulte a un asesor para una evaluación detallada.</p>
        </footer>
    </div>
    <div id="customAlertModal" class="modal-overlay">
        <div class="modal-content modal-content-alert">
            <h2 id="customAlertTitle" class="text-xl">Alerta</h2>
            <p id="customAlertMessage" class="text-base my-6"></p>
            <div id="passwordPromptContainer" style="display: none;" class="mt-4">
                <input type="password" id="pdfPasswordInput" class="w-full p-2 border rounded" placeholder="Contraseña de Dirección">
            </div>
            <div class="flex justify-center gap-4 mt-8">
                <button id="customAlertCancelButton" style="display: none;" class="btn btn-secondary">Cancelar</button>
                <button id="customAlertButton" class="btn btn-blue">Aceptar</button>
            </div>
        </div>
    </div>
    <div id="timeline-tooltip"></div>
    <div id="whatsAppModal" class="modal-overlay">
        <div class="modal-content relative">
            <button onclick="hideElement('whatsAppModal')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 focus:outline-none"><i class="fas fa-times fa-2x"></i></button>
            <h2><i class="fab fa-whatsapp text-green-500 mr-2"></i>Resumen para Cliente</h2>
            <p class="text-center text-sm mb-4">Seleccione una plantilla y copie el texto para enviarlo a su cliente.</p>
            <div id="whatsappOptionsContainer" class="mb-4"></div>
            <textarea id="whatsAppSummaryText" rows="10" class="w-full p-3 border rounded bg-gray-50 font-mono text-sm"></textarea>
            <div class="text-center mt-6">
                <button onclick="copyWhatsAppText()" class="btn btn-blue"><i class="fas fa-copy"></i> Copiar Texto</button>
            </div>
        </div>
    </div>
    <div id="paymentBreakdownModal" class="modal-overlay">
        <div class="modal-content !max-w-7xl">
            <h2 id="breakdownModalTitle">Desglose de Pagos M40</h2>
            <div id="breakdownModalTotals" class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-6">
            </div>
            <div class="overflow-y-auto max-h-[600px] border rounded-lg">
                <table class="w-full text-sm">
                    <thead class="bg-gray-100 sticky top-0 text-xs">
                        <tr>
                            <th class="p-2 text-left">Periodo</th>
                            <th class="p-2 text-right">Costo Base</th>
                            <th class="p-2 text-right" title="Índice Nacional de Precios al Consumidor del mes que se paga">INPC Mes</th>
                            <th class="p-2 text-right" title="Índice Nacional de Precios al Consumidor del mes en que se liquida">INPC Pago</th>
                            <th class="p-2 text-right">Factor Act.</th>
                            <th class="p-2 text-right">Monto Act.</th>
                            <th class="p-2 text-right">Base + Act.</th>
                            <th class="p-2 text-right">Meses Ret.</th>
                            <th class="p-2 text-right">Tasa Rec.</th>
                            <th class="p-2 text-right">Monto Rec.</th>
                            <th class="p-2 text-right font-bold">Total del Mes</th>
                        </tr>
                    </thead>
                    <tbody id="breakdownModalTableBody">
                    </tbody>
                </table>
            </div>
            <div class="text-center mt-6">
                <button onclick="hideElement('paymentBreakdownModal')" class="btn btn-secondary">Cerrar</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Importa las funciones que necesitas de los SDKs de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, setDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      
        // Configuración de Firebase proporcionada
        const firebaseConfig = {
            apiKey: "AIzaSyAXybwS6HP7TUoNtvFZLo6_dDFCP6EHbC0",
            authDomain: "rgc-pensiones-y-seguros.firebaseapp.com",
            projectId: "rgc-pensiones-y-seguros",
            storageBucket: "rgc-pensiones-y-seguros.appspot.com",
            messagingSenderId: "1022012486807",
            appId: "1:1022012486807:web:443f9114ad5a4d809fa5d2",
            measurementId: "G-EFQ3EP0GYN"
        };
      
        // Inicializa Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // =======================================================================================
        // INICIO: Lógica de la aplicación completa
        // =======================================================================================

        let sessionTimer = null;
        // --- USER AUTHENTICATION & MANAGEMENT ---
        const ADMIN_USERS = ['roberto ortiz', 'alma cano'];

        async function getUsers() {
            if (!db) {
                console.error("Firestore no está inicializado.");
                showCustomAlert("Conectando con la base de datos, por favor espere...", "Inicializando");
                return {};
            }
            try {
                const usersCollection = collection(db, "users");
                const userSnapshot = await getDocs(usersCollection);
                const users = {};
                userSnapshot.forEach(doc => {
                    users[doc.id] = doc.data();
                });
                return users;
            } catch (error) {
                console.error("Error al obtener usuarios de Firestore: ", error);
                showCustomAlert("No se pudo cargar la lista de usuarios. Verifique la conexión y la configuración de seguridad de Firestore.", "Error de Base de Datos");
                return {};
            }
        }

        async function saveUser(usernameToUpdate, userData) {
             if (!db) {
                console.error("Firestore no está inicializado.");
                return;
            }
            try {
                const userDocRef = doc(db, "users", usernameToUpdate);
                await setDoc(userDocRef, userData, { merge: true });
            } catch (error) {
                console.error("Error al guardar usuario en Firestore: ", error);
                showCustomAlert("No se pudo actualizar el estado del usuario.", "Error de Base de Datos");
            }
        }

        async function handleLogin() {
            const usernameInput = document.getElementById('username').value.trim().toLowerCase();
            const passwordInput = document.getElementById('password').value;
            const users = await getUsers();
            const user = users[usernameInput];

            if (user && user.password === passwordInput) {
                if (user.active) {
                    sessionStorage.setItem('rgc_currentUser', usernameInput);
                    showAppForUser(usernameInput);
                } else {
                    showCustomAlert("Su cuenta ha sido desactivada. Póngase en contacto con el administrador.", "Acceso Denegado");
                }
            } else {
                showCustomAlert("Nombre de usuario o contraseña incorrectos.", "Error de Inicio de Sesión");
            }
        }

        function handleLogout() {
            if (sessionTimer) clearTimeout(sessionTimer);
            sessionStorage.removeItem('rgc_currentUser');
            document.getElementById('appContainer').style.display = 'none';
            hideElement('adminPanel');
            document.getElementById('loginScreen').style.display = 'flex';
        }

        function checkSession() {
            const currentUser = sessionStorage.getItem('rgc_currentUser');
            if (currentUser) {
                showAppForUser(currentUser);
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
            }
        }

        async function showAppForUser(username) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            document.getElementById('appContainer').style.flexDirection = 'column';
            
            const userInfoContainer = document.getElementById('userInfoContainer');
            const loggedInUserName = document.getElementById('loggedInUserName');
            loggedInUserName.textContent = `Bienvenido(a), ${username.split(' ').map(n => n.charAt(0).toUpperCase() + n.slice(1)).join(' ')}`;
            userInfoContainer.style.display = 'block';

            const users = await getUsers();
            const user = users[username];
            if (user && user.role === 'admin') {
                showElement('adminPanel');
                renderAdminPanel();
            } else {
                hideElement('adminPanel');
                // Set time limit for non-admin users
                const TIME_LIMIT = 20 * 60 * 1000; // 20 minutes
                if (sessionTimer) clearTimeout(sessionTimer); // Clear any existing timer
                sessionTimer = setTimeout(() => {
                    showCustomAlert("Su sesión ha expirado por límite de tiempo.", "Sesión Terminada");
                    setTimeout(handleLogout, 4000); // Give user time to read message
                }, TIME_LIMIT);
            }
        }

        async function renderAdminPanel() {
            const users = await getUsers();
            const container = document.getElementById('userManagementTableContainer');
            let tableHTML = `
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-3 rounded-l-lg">Usuario</th>
                            <th class="p-3">Contraseña</th>
                            <th class="p-3 text-center">Estado</th>
                            <th class="p-3 text-center rounded-r-lg">Acción</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            const loggedInUser = sessionStorage.getItem('rgc_currentUser');
            for (const username in users) {
                const user = users[username];
                if (user.role === 'admin' && username !== loggedInUser) continue; 
                const capitalizedUsername = username.split(' ').map(n => n.charAt(0).toUpperCase() + n.slice(1)).join(' ');
                tableHTML += `
                    <tr class="border-b">
                        <td class="p-3 font-medium">${capitalizedUsername}</td>
                        <td class="p-3 font-mono text-gray-700">${user.password}</td>
                        <td class="p-3 text-center">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${user.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${user.active ? 'Activo' : 'Inactivo'}
                            </span>
                        </td>
                        <td class="p-3 text-center">
                            <label for="toggle_${username.replace(/\s/g, '_')}" class="flex items-center justify-center cursor-pointer">
                                <div class="relative">
                                    <input type="checkbox" id="toggle_${username.replace(/\s/g, '_')}" class="sr-only" onchange="toggleUserStatus('${username}')" ${user.active ? 'checked' : ''}>
                                    <div class="block bg-gray-600 w-14 h-8 rounded-full"></div>
                                    <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
                                </div>
                            </label>
                        </td>
                    </tr>
                `;
            }
            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
        }

        async function toggleUserStatus(username) {
            const users = await getUsers();
            if (users[username]) {
                users[username].active = !users[username].active;
                await saveUser(username, users[username]);
                renderAdminPanel();
            }
        }

        const AppState = {
            employmentCardIdCounter: 0,
            scenarioData: {},
            activeScenarios: 0,
            isSisecNoDetallado: false,
            semanasAyudaDesempleo: 0,
            datosClienteInfo: {
                nombre: '',
                curp: '',
                telefono: '',
                semanasCotizadasBase: 0,
                edadBase: 0,
                sbcPromedioBase: 0,
                ultimaFechaBaja: null
            },
            sbcCalculationPeriods: [],
            fullHistoryPeriods: [],
            allParsedPeriodsForDisplay: [],
            timelinePeriods: [],
            pensionBaseResultadosInfo: {
                PENSION_MENSUAL_ESTIMADA: 0,
                AGUINALDO_ESTIMADO: 0
            },
            pdfGenerated: false
        };
        
        let employerColorCache = {};
        const colorPalette = ['#3b82f6', '#16a34a', '#ef4444', '#f97316', '#8b5cf6', '#ec4899', '#14b8a6', '#64748b', '#d946ef', '#06b6d4', '#f59e0b'];
        let lastColorIndex = 0;

        const Constants = {
            DIAS_PROMEDIO_PENSION: 1750,
            SMGV_DF_Global: 88.36,
            FACTOR_FOX_Global: 1.11,
            PRESTAMO_PUNTO_A_DESCUENTO: 1115.61,
            PRESTAMO_PUNTO_A_MONTO: 31000,
            PRESTAMO_PUNTO_B_DESCUENTO: 33450.42,
            PRESTAMO_PUNTO_B_MONTO: 929500,
            COSTO_FIJO_ADICIONAL: 140000,
            COMISION_BASE_M40: 0.16,
            FACTOR_MULTIPLICADOR_COSTO: 0.5,
            AJUSTE_FINAL_CONTRATO: -35000,
            AJUSTE_PENSION_MENSUAL: -250,
            INPC_GROWTH_ESTIMATE: 0.06,
            RECARGO_M40_MENSUAL_PRE_2026: 0.0147,
            RECARGO_M40_MENSUAL: 0.0147,
            economicData: {
                umas: {
                    2016: 73.04, 2017: 75.49, 2018: 80.60, 2019: 84.49, 2020: 86.88,
                    2021: 89.62, 2022: 96.22, 2023: 103.74, 2024: 108.57, 2025: 113.14
                },
                smgv_diario: {
                    2018: 88.36, 2019: 102.68, 2020: 123.22, 2021: 141.70,
                    2022: 172.87, 2023: 207.44, 2024: 248.93
                },
                inpc: {
                    "2018-12": 101.355, "2019-12": 104.236, "2020-12": 107.608, "2021-12": 115.499,
                    "2022-12": 124.507, "2023-12": 130.036, "2024-01": 131.396, "2024-02": 131.500,
                    "2020-11": 108.856, "2020-12": 109.398, "2021-01": 110.211, "2021-02": 110.895,
                    "2021-03": 111.831, "2021-04": 112.195, "2021-05": 112.394, "2021-06": 113.064,
                    "2021-07": 113.731, "2021-08": 114.174, "2021-09": 114.881, "2021-10": 115.632,
                    "2021-11": 116.796, "2021-12": 117.364, "2022-01": 118.044, "2022-02": 119.023,
                    "2022-03": 120.211, "2022-04": 120.865, "2022-05": 121.082, "2022-06": 122.100,
                    "2022-07": 123.003, "2022-08": 123.868, "2022-09": 124.636, "2022-10": 125.357,
                    "2022-11": 126.096, "2022-12": 126.491, "2023-01": 127.351, "2023-02": 128.169,
                    "2023-03": 128.513, "2023-04": 128.281, "2023-05": 127.989, "2023-06": 128.118,
                    "2023-07": 128.730, "2023-08": 129.438, "2023-09": 130.043, "2023-10": 130.542,
                    "2023-11": 131.782, "2023-12": 132.355, "2024-01": 133.523, "2024-02": 133.650,
                    "2024-03": 133.689, "2024-04": 133.955, "2024-05": 133.702, "2024-06": 134.026,
                    "2024-07": 134.428
                }
            },
            tasasPagoM40: {
                2022: 0.10075, 2023: 0.11166, 2024: 0.12256, 2025: 0.13347, 2026: 0.14438,
                2027: 0.15528, 2028: 0.16619, 2029: 0.17709, 2030: 0.18800
            },
            tablaCuantiasGlobal: [
                {minRatio: 0, maxRatio: 1.00, pcb: 80.00, pia: 0.563},
                {minRatio: 1.01, maxRatio: 1.25, pcb: 77.11, pia: 0.814},
                {minRatio: 1.26, maxRatio: 1.50, pcb: 58.18, pia: 1.178},
                {minRatio: 1.51, maxRatio: 1.75, pcb: 49.23, pia: 1.430},
                {minRatio: 1.76, maxRatio: 2.00, pcb: 42.67, pia: 1.615},
                {minRatio: 2.01, maxRatio: 2.25, pcb: 37.65, pia: 1.756},
                {minRatio: 2.26, maxRatio: 2.50, pcb: 33.68, pia: 1.868},
                {minRatio: 2.51, maxRatio: 2.75, pcb: 30.48, pia: 1.958},
                {minRatio: 2.76, maxRatio: 3.00, pcb: 27.83, pia: 2.033},
                {minRatio: 3.01, maxRatio: 3.25, pcb: 25.60, pia: 2.096},
                {minRatio: 3.26, maxRatio: 3.50, pcb: 23.70, pia: 2.149},
                {minRatio: 3.51, maxRatio: 3.75, pcb: 22.07, pia: 2.195},
                {minRatio: 3.76, maxRatio: 4.00, pcb: 20.65, pia: 2.235},
                {minRatio: 4.01, maxRatio: 4.25, pcb: 19.39, pia: 2.271},
                {minRatio: 4.26, maxRatio: 4.50, pcb: 18.29, pia: 2.302},
                {minRatio: 4.51, maxRatio: 4.75, pcb: 17.30, pia: 2.330},
                {minRatio: 4.76, maxRatio: 5.00, pcb: 16.41, pia: 2.355},
                {minRatio: 5.01, maxRatio: 5.25, pcb: 15.61, pia: 2.377},
                {minRatio: 5.26, maxRatio: 5.50, pcb: 14.88, pia: 2.398},
                {minRatio: 5.51, maxRatio: 5.75, pcb: 14.22, pia: 2.416},
                {minRatio: 5.76, maxRatio: 6.00, pcb: 13.62, pia: 2.433},
                {minRatio: 6.01, maxRatio: Infinity, pcb: 13.00, pia: 2.450}
            ]
        };

        function formatNumber(num, decimals = 2) {
            if (typeof num !== 'number' || isNaN(num)) return (0).toFixed(decimals);
            return num.toLocaleString('es-MX', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }

        function formatDateDDMMYYYY(date) {
            if (!date || !(date instanceof Date)) return '';
            const day = String(date.getUTCDate()).padStart(2, '0');
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const year = date.getUTCFullYear();
            return `${day}/${month}/${year}`;
        }

        function getNumeroInfo(id) {
            return parseFloat(document.getElementById(id).value.replace(/,/g, '')) || 0;
        }

        function getDiasEnMes(a, m) {
            return new Date(a, m, 0).getDate();
        }

        function showElement(id, displayType = 'block') {
            const el = document.getElementById(id);
            if (!el) return;
            if (id.includes('Modal')) {
                el.classList.add('active');
            } else {
                el.style.display = displayType;
                el.classList.add('fade-in-up');
            }
        }

        function hideElement(id) {
            const el = document.getElementById(id);
            if (!el) return;
            if (id.includes('Modal')) {
                el.classList.remove('active');
            } else {
                el.style.display = 'none';
                el.classList.remove('fade-in-up');
            }
        }

        function showCustomAlert(message, title = "Atención") {
            document.getElementById('customAlertTitle').textContent = title;
            document.getElementById('customAlertMessage').textContent = message;
            document.getElementById('passwordPromptContainer').style.display = 'none';
            const confirmBtn = document.getElementById('customAlertButton');
            const cancelBtn = document.getElementById('customAlertCancelButton');
            confirmBtn.textContent = 'Aceptar';
            confirmBtn.className = 'btn btn-blue';
            confirmBtn.onclick = closeCustomAlert;
            cancelBtn.style.display = 'none';
            showElement('customAlertModal');
        }

        function showAyudaDesempleoModal(semanasDescuento, semanasOriginales, semanasReintegradas, callback) {
            const title = "Ayuda por Desempleo Detectada";
            const message = `Se detectaron ${semanasDescuento} semanas descontadas por ayuda de desempleo. Por favor, seleccione el total de semanas a utilizar para el cálculo base:`;
            document.getElementById('customAlertTitle').textContent = title;
            document.getElementById('customAlertMessage').textContent = message;
            const promptContainer = document.getElementById('passwordPromptContainer');
            window.selectSemanasOption = (value) => {
                const radio = document.querySelector(`input[name="semanas_option"][value="${value}"]`);
                if (radio) {
                    radio.checked = true;
                }
            };
            promptContainer.innerHTML = `
                <div class="space-y-3 text-left">
                    <div class="p-3 border rounded-lg hover:bg-blue-50 cursor-pointer" onclick="selectSemanasOption('${semanasOriginales}')">
                        <input type="radio" id="optSemanas1" name="semanas_option" value="${semanasOriginales}" class="mr-2 align-middle">
                        <label for="optSemanas1" class="align-middle cursor-pointer w-full block"><strong>${semanasOriginales} semanas</strong> (Total original sin descontar ayuda).</label>
                    </div>
                    <div class="p-3 border rounded-lg hover:bg-blue-50 cursor-pointer" onclick="selectSemanasOption('${semanasReintegradas}')">
                        <input type="radio" id="optSemanas2" name="semanas_option" value="${semanasReintegradas}" checked class="mr-2 align-middle">
                        <label for="optSemanas2" class="align-middle cursor-pointer w-full block"><strong>${semanasReintegradas} semanas</strong> (Total con descuento ya aplicado).</label>
                    </div>
                    <div class="p-3 border rounded-lg hover:bg-blue-50 cursor-pointer" onclick="document.getElementById('semanasManualInput').focus()">
                         <input type="radio" id="optSemanas3" name="semanas_option" value="manual" class="mr-2 align-middle">
                         <label for="optSemanas3" class="align-middle cursor-pointer"><strong>Ingresar manualmente:</strong></label>
                         <input type="number" id="semanasManualInput" class="w-full mt-2 p-2 border rounded" placeholder="Escriba el total de semanas" onfocus="document.getElementById('optSemanas3').checked = true;">
                    </div>
                    <div id="semanasManualError" class="text-red-600 text-sm text-center h-4"></div>
                </div>
            `;
            promptContainer.style.display = 'block';
            const confirmBtn = document.getElementById('customAlertButton');
            const cancelBtn = document.getElementById('customAlertCancelButton');
            confirmBtn.textContent = 'Confirmar y Continuar';
            cancelBtn.style.display = 'inline-flex';
            const cleanupAndClose = () => {
                delete window.selectSemanasOption;
                closeCustomAlert();
            };
            confirmBtn.onclick = () => {
                const errorDiv = document.getElementById('semanasManualError');
                errorDiv.textContent = '';
                const selectedOption = document.querySelector('input[name="semanas_option"]:checked').value;
                let finalSemanas;
                if (selectedOption === 'manual') {
                    finalSemanas = document.getElementById('semanasManualInput').value;
                    if (!finalSemanas || isNaN(parseInt(finalSemanas)) || parseInt(finalSemanas) < 0) {
                        errorDiv.textContent = 'Por favor, ingrese un número válido.';
                        return;
                    }
                } else {
                    finalSemanas = selectedOption;
                }
                document.getElementById('info_semanasTotalesManual').value = finalSemanas;
                cleanupAndClose();
                if (callback) {
                    callback();
                }
            };
            cancelBtn.onclick = cleanupAndClose;
            showElement('customAlertModal');
        }

        function closeCustomAlert() {
            hideElement('customAlertModal');
            const confirmBtn = document.getElementById('customAlertButton');
            const cancelBtn = document.getElementById('customAlertCancelButton');
            confirmBtn.textContent = 'Aceptar';
            confirmBtn.className = 'btn btn-blue';
            confirmBtn.onclick = closeCustomAlert;
            cancelBtn.style.display = 'none';
            document.getElementById('passwordPromptContainer').style.display = 'none';
        }

        function initializeMainAppDisplay() {
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            const currentYear = new Date().getFullYear();
            for (let y = Math.max(...Object.keys(Constants.economicData.umas).map(Number)) + 1; y <= currentYear + 10; y++) {
                if (!Constants.economicData.umas[y]) Constants.economicData.umas[y] = parseFloat((Constants.economicData.umas[y - 1] * 1.045).toFixed(2));
            }
            for (let y = Math.max(...Object.keys(Constants.economicData.smgv_diario).map(Number)) + 1; y <= currentYear + 10; y++) {
                if (!Constants.economicData.smgv_diario[y]) Constants.economicData.smgv_diario[y] = parseFloat((Constants.economicData.smgv_diario[y - 1] * 1.10).toFixed(2));
            }
            populateUmaTable();
        }

        function getUMA(year, month) {
            const umaYear = (month >= 2) ? year : year - 1;
            return Constants.economicData.umas[umaYear] || Constants.economicData.umas[Object.keys(Constants.economicData.umas).pop()];
        }
        function getTasaM40Porcentaje(year) {
            return Constants.tasasPagoM40[year] || Constants.tasasPagoM40[2030];
        }
        function getINPC(year, month) {
            const key = `${year}-${String(month).padStart(2, '0')}`;
            if (Constants.economicData.inpc[key]) {
                return Constants.economicData.inpc[key];
            }
            const lastKnownKey = Object.keys(Constants.economicData.inpc).sort().pop();
            const [lastYear, lastMonth] = lastKnownKey.split('-').map(Number);
            const lastValue = Constants.economicData.inpc[lastKnownKey];
            const monthsDiff = (year - lastYear) * 12 + (month - lastMonth);
            const monthlyGrowth = Math.pow(1 + Constants.INPC_GROWTH_ESTIMATE, 1/12);
            return lastValue * Math.pow(monthlyGrowth, monthsDiff);
        }

        function extraerFechaNacimientoCURP(curp) {
            if (curp.length < 10) return null;
            let year = parseInt(curp.substring(4, 6));
            const month = parseInt(curp.substring(6, 8)) - 1;
            const day = parseInt(curp.substring(8, 10));
            const siglo = curp.substring(16, 17);
            if (isNaN(year) || isNaN(month) || isNaN(day)) return null;
            if (siglo >= '0' && siglo <= '9') {
                year += 1900;
            } else {
                year += 2000;
            }
            const fecha = new Date(Date.UTC(year, month, day));
            if (fecha.getUTCFullYear() !== year || fecha.getUTCMonth() !== month || fecha.getUTCDate() !== day) {
                return null;
            }
            return fecha;
        }

        function calcularEdadExacta(fechaNacimiento, fechaReferencia = new Date()) {
            let anos = fechaReferencia.getUTCFullYear() - fechaNacimiento.getUTCFullYear();
            let meses = fechaReferencia.getUTCMonth() - fechaNacimiento.getUTCMonth();
            let dias = fechaReferencia.getUTCDate() - fechaNacimiento.getUTCDate();
            if (dias < 0) {
                meses--;
                const ultimoDiaMesAnterior = new Date(fechaReferencia.getUTCFullYear(), fechaReferencia.getUTCMonth(), 0).getUTCDate();
                dias += ultimoDiaMesAnterior;
            }
            if (meses < 0) {
                anos--;
                meses += 12;
            }
            return { anos, meses, dias };
        }

        function calcularFechaFinDesdeMeses(fechaInicioStr, numMeses) {
            const [year, month, day] = fechaInicioStr.split('-').map(Number);
            const fechaFin = new Date(Date.UTC(year, month - 1, day));
            fechaFin.setUTCMonth(fechaFin.getUTCMonth() + numMeses);
            fechaFin.setUTCDate(fechaFin.getUTCDate() - 1);
            return fechaFin;
        }

        function _calcularPensionDetallado(sbcPromedio, semanasCotizadas, edad) {
            const smgvDiario = Constants.economicData.smgv_diario[2024]; // Use current year's SMGV
            const ratioSBCvsSMGV = sbcPromedio / smgvDiario;
            let pcb = 0,
                pia = 0;
            const cuantias = Constants.tablaCuantiasGlobal.find(rg => ratioSBCvsSMGV >= rg.minRatio && ratioSBCvsSMGV <= rg.maxRatio);
            if (cuantias) {
                pcb = cuantias.pcb;
                pia = cuantias.pia;
            } else {
                const lastCuantia = Constants.tablaCuantiasGlobal[Constants.tablaCuantiasGlobal.length - 1];
                pcb = lastCuantia.pcb;
                pia = lastCuantia.pia;
            }
            const cuantiaBasicaAnual = (sbcPromedio * 365) * (pcb / 100);
            const cuantiaBasicaFinal = cuantiaBasicaAnual * Constants.FACTOR_FOX_Global;
            const semanasExcedentes = semanasCotizadas > 500 ? Math.floor((semanasCotizadas - 500) / 52) : 0;
            const incrementoAnualCuantia = (sbcPromedio * 365) * (pia / 100) * semanasExcedentes;
            const incrementoAnualFinal = incrementoAnualCuantia * Constants.FACTOR_FOX_Global;
            const pensionVejezAnualBase = cuantiaBasicaFinal + incrementoAnualFinal;
            let porcentajeEdad = 0;
            if (edad >= 65) porcentajeEdad = 1.00;
            else if (edad === 64) porcentajeEdad = 0.95;
            else if (edad === 63) porcentajeEdad = 0.90;
            else if (edad === 62) porcentajeEdad = 0.85;
            else if (edad === 61) porcentajeEdad = 0.80;
            else if (edad === 60) porcentajeEdad = 0.75;
            const pensionVejezAnualAplicadaEdad = pensionVejezAnualBase * porcentajeEdad;
            const pensionAnualConAsignaciones = pensionVejezAnualAplicadaEdad * 1.15;
            const pensionMensualEstimada = pensionAnualConAsignaciones / 12;
            const aguinaldoEstimado = pensionVejezAnualAplicadaEdad / 12;
            return {
                PENSION_MENSUAL_ESTIMADA: pensionMensualEstimada,
                AGUINALDO_ESTIMADO: aguinaldoEstimado
            };
        }
        function getM40StartDate() {
            const year = document.getElementById('m40_year').value;
            const month = document.getElementById('m40_month').value;
            const day = document.getElementById('m40_day').value;
            if (year && month && day) {
                return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            }
            return null;
        }
        function updateDaySelector() {
            const daySelect = document.getElementById('m40_day');
            const month = document.getElementById('m40_month').value;
            const year = document.getElementById('m40_year').value;
            const selectedDay = daySelect.value;
            daySelect.innerHTML = '<option value="">Día</option>';
            if (month && year) {
                const daysInMonth = getDiasEnMes(year, month);
                for (let i = 1; i <= daysInMonth; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    daySelect.appendChild(option);
                }
                if (selectedDay && selectedDay <= daysInMonth) {
                    daySelect.value = selectedDay;
                }
            }
        }

        function initDateSelectors() {
            const monthSelect = document.getElementById('m40_month');
            const yearSelect = document.getElementById('m40_year');
            const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            monthSelect.innerHTML = '<option value="">Mes</option>';
            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index + 1;
                option.textContent = month;
                monthSelect.appendChild(option);
            });
            yearSelect.innerHTML = '<option value="">Año</option>';
            const currentYear = new Date().getFullYear();
            for (let i = currentYear + 10; i >= currentYear - 10; i--) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                yearSelect.appendChild(option);
            }
        }

        function addEmploymentCard(patron = '', regPatronal = '', movimientos = '') {
            AppState.employmentCardIdCounter++;
            const container = document.getElementById('employmentCardsContainer');
            const cardId = AppState.employmentCardIdCounter;
            const cardHTML = `
                <div class="employment-card" id="empCard_${cardId}">
                    <div class="absolute top-4 left-4 flex items-center">
                        <input type="checkbox" id="emp_qp_${cardId}" class="emp_qp h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500" onchange="toggleQPCardStyle(${cardId})">
                        <label for="emp_qp_${cardId}" class="ml-2 text-sm font-semibold text-red-700 cursor-pointer">Excluir (QP)</label>
                    </div>
                    <button onclick="removeEmploymentCard(this)" class="btn-danger-icon absolute top-4 right-4" title="Eliminar Periodo"><i class="fas fa-times"></i></button>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 mt-8">
                        <div class="input-group">
                            <label for="emp_name_${cardId}">Nombre o Razón Social del Empleador:</label>
                            <input type="text" id="emp_name_${cardId}" class="emp_name w-full" placeholder="Nombre del empleador" value="${patron}">
                        </div>
                        <div class="input-group">
                            <label for="emp_reg_${cardId}">Registro Patronal:</label>
                            <input type="text" id="emp_reg_${cardId}" class="emp_reg w-full" placeholder="Ej: Y6812345108" value="${regPatronal}">
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="emp_history_${cardId}">Historial de Movimientos para este Empleador:</label>
                        <textarea id="emp_history_${cardId}" class="emp_history_text w-full font-mono text-sm" rows="6" placeholder="Pegue aquí los movimientos (REINGRESO, MODIFICACION, BAJA) para este empleador.">${movimientos}</textarea>
                        <div id="qp_weeks_info_${cardId}" class="mt-2 text-center bg-red-100 p-2 rounded-lg border border-red-200" style="display: none;"></div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', cardHTML);
            return `emp_history_${cardId}`;
        }

        function toggleQPCardStyle(cardId) {
            const card = document.getElementById(`empCard_${cardId}`);
            const checkbox = document.getElementById(`emp_qp_${cardId}`);
            const infoDiv = document.getElementById(`qp_weeks_info_${cardId}`);
            if (checkbox.checked) {
                card.classList.add('opacity-50', 'bg-red-50');
                card.style.borderLeftColor = 'var(--danger-color)';
                const texto = document.getElementById(`emp_history_${cardId}`).value.trim();
                const movementsOnCard = [];
                const lineas = texto.split('\n').filter(line => line.trim() !== '');
                const regex = /(.+?)\s+(\d{2}\/\d{2}\/\d{4})\s*(?:\$\s*([\d,]+\.?\d*))?/;
                lineas.forEach(linea => {
                    const match = linea.trim().match(regex);
                    if (match) {
                        const tipo = match[1].trim().toUpperCase();
                        const [dia, mes, anio] = match[2].split('/');
                        const fecha = new Date(Date.UTC(anio, mes - 1, dia));
                        const sbc = match[3] ? parseFloat(match[3].replace(/,/g, '')) : null;
                        movementsOnCard.push({
                            tipo,
                            fecha,
                            sbc
                        });
                    }
                });
                movementsOnCard.sort((a, b) => {
                    if (a.fecha.getTime() !== b.fecha.getTime()) {
                        return a.fecha - b.fecha;
                    }
                    if (a.tipo.includes('BAJA')) return 1;
                    if (b.tipo.includes('BAJA')) return -1;
                    return 0;
                });
                let totalDaysOnCard = 0;
                for (let i = 0; i < movementsOnCard.length; i++) {
                    const mov = movementsOnCard[i];
                    if (mov.tipo.includes('BAJA') || mov.sbc === null || mov.sbc <= 0) {
                        continue;
                    }
                    const fechaInicio = mov.fecha;
                    let fechaFin = null;
                    for (let j = i + 1; j < movementsOnCard.length; j++) {
                        const nextMov = movementsOnCard[j];
                        if (nextMov.tipo.includes('BAJA')) {
                            fechaFin = nextMov.fecha;
                            i = j;
                            break;
                        } else if (nextMov.sbc !== null && nextMov.sbc > 0) {
                            fechaFin = new Date(nextMov.fecha);
                            fechaFin.setUTCDate(fechaFin.getUTCDate() - 1);
                            break;
                        }
                    }
                    if (fechaFin === null) {
                        const hoy = new Date();
                        fechaFin = new Date(Date.UTC(hoy.getUTCFullYear(), hoy.getUTCMonth() + 1, 0));
                    }
                    if (fechaFin >= fechaInicio) {
                        totalDaysOnCard += Math.round((fechaFin - fechaInicio) / (1000 * 60 * 60 * 24)) + 1;
                    }
                }
                const weeksToSubtract = totalDaysOnCard / 7.0;
                infoDiv.innerHTML = `<strong class="text-red-800"><i class="fas fa-calculator mr-2"></i>Semanas a restar: ${weeksToSubtract.toFixed(2)}</strong>`;
                infoDiv.style.display = 'block';
            } else {
                card.classList.remove('opacity-50', 'bg-red-50');
                card.style.borderLeftColor = 'var(--dark-blue)';
                infoDiv.style.display = 'none';
            }
        }


        function removeEmploymentCard(button) {
            button.closest('.employment-card').remove();
        }

        function actualizarSBCMaximoM40() {
            setSBCFromUMA(25);
        }

        function setSBCFromUMA(multiplier) {
            const inicioP1Str = getM40StartDate();
            const sbcM40Input = document.getElementById('info_m40_p1_sbc');
            if (inicioP1Str) {
                const [anioInicioP1, mesInicioP1] = inicioP1Str.split('-').map(Number);
                const umaP1 = getUMA(anioInicioP1, mesInicioP1);
                const sbcCalculado = umaP1 * multiplier;
                sbcM40Input.value = sbcCalculado.toFixed(2);
                
                const buttons = document.querySelectorAll('#umaButtons button');
                buttons.forEach(btn => {
                    if (parseInt(btn.dataset.uma) === multiplier) {
                        btn.classList.remove('btn-secondary');
                        btn.classList.add('btn-gold');
                    } else {
                        btn.classList.remove('btn-gold');
                        btn.classList.add('btn-secondary');
                    }
                });

                if (document.getElementById('infoSection4').style.display !== 'none') {
                    recalculateAllScenarios();
                }
            } else {
                showCustomAlert("Por favor, seleccione primero una fecha de inicio para la Modalidad 40 en el Paso 2.", "Fecha Requerida");
            }
        }

        function actualizarFechaFinM40Display() {
            const fechaInicioStr = getM40StartDate();
            const numMesesStr = document.getElementById('info_m40_p1_meses').value;
            const curp = document.getElementById('info_curpCliente').value;
            const bajaDisplayEl = document.getElementById('info_m40_baja_display');
            if (!fechaInicioStr || !numMesesStr || numMesesStr === '0' || curp.length !== 18) {
                bajaDisplayEl.innerHTML = '-- Ingrese fechas, meses y CURP para calcular la edad de retiro --';
                return;
            }
            const fechaNacimiento = extraerFechaNacimientoCURP(curp);
            if (!fechaNacimiento) {
                bajaDisplayEl.innerHTML = '<span class="text-red-600">CURP inválido, no es posible calcular la edad.</span>';
                return;
            }
            const numMeses = parseInt(numMesesStr);
            if (numMeses > 0) {
                const fechaFinObj = calcularFechaFinDesdeMeses(fechaInicioStr, numMeses);
                if (fechaFinObj) {
                    const edadFinM40 = calcularEdadExacta(fechaNacimiento, fechaFinObj);
                    const fechaFinDisplay = fechaFinObj.toLocaleDateString('es-MX', {
                        month: 'long',
                        year: 'numeric',
                        timeZone: 'UTC'
                    });
                    bajaDisplayEl.innerHTML = `
                    <i class="fas fa-calendar-alt mr-2"></i>Fecha de Baja Proyectada: <strong class="text-blue-900">${fechaFinDisplay.charAt(0).toUpperCase() + fechaFinDisplay.slice(1)}</strong><br>
                    <i class="fas fa-birthday-cake mr-2 mt-1"></i>Edad al finalizar M40: <strong class="text-blue-900">${edadFinM40.anos} años, ${edadFinM40.meses} meses y ${edadFinM40.dias} días</strong>
                    `;
                }
            }
        }

        function handleMesesDepositoChange(input) {
            let value = parseInt(input.value);
            const lastValidValue = input.getAttribute('data-last-valid');
            if (isNaN(value) || value < 6 || value > 12) {
                input.value = lastValidValue;
                showCustomAlert("El valor debe ser un número entre 6 y 12.", "Valor Inválido");
                return;
            }
            input.setAttribute('data-last-valid', value);
            recalculateAllScenarios();
        }

        function validateAndSetClientBaseInfo() {
            const nombre = document.getElementById('info_nombreCompleto').value.trim();
            const curp = document.getElementById('info_curpCliente').value.trim();
            const telefono = document.getElementById('info_telefonoCliente').value.trim();
            const semanasManuales = getNumeroInfo('info_semanasTotalesManual');

            if (!nombre || !/^[A-ZÑ&]{4}\d{6}[HM][A-Z]{5}[A-Z\d]\d$/.test(curp)) {
                showCustomAlert("Por favor, complete la información del asegurado (Nombre y CURP válido) en el Paso 1.", "Validación de Datos");
                return false;
            }

            if (!telefono || !/^\d{10}$/.test(telefono)) {
                showCustomAlert("El Teléfono de Contacto es obligatorio y debe contener 10 dígitos numéricos.", "Validación de Datos");
                return false;
            }

            if (semanasManuales < 0) {
                showCustomAlert("Las semanas cotizadas no pueden ser un número negativo.", "Validación de Datos");
                return false;
            }

            const fechaNacimiento = extraerFechaNacimientoCURP(curp);
            if (!fechaNacimiento) {
                showCustomAlert("El CURP ingresado no es válido. Por favor, verifíquelo.", "Validación de Datos");
                return false;
            }
            const edadObj = calcularEdadExacta(fechaNacimiento, new Date());
            const edadActual = edadObj.anos;

            AppState.datosClienteInfo = {
                ...AppState.datosClienteInfo,
                nombre,
                curp,
                telefono,
                semanasCotizadasBase: semanasManuales,
                edadBase: edadActual,
                edadObjCompleta: edadObj,
            };
            return true;
        }

        function analizarYCalcularSBC() {
            if (!validateAndSetClientBaseInfo()) return;
            
            employerColorCache = {};
            lastColorIndex = 0;

            const cards = document.querySelectorAll('.employment-card');

            let allParsedPeriods = [];
            let isValid = true;

            cards.forEach((card, index) => {
                if (!isValid) return;

                const qpCheckbox = card.querySelector('.emp_qp');
                const isQP = qpCheckbox && qpCheckbox.checked;

                const nombrePatron = card.querySelector('.emp_name').value.trim();
                const regPatronal = card.querySelector('.emp_reg').value.trim();
                const texto = card.querySelector('.emp_history_text').value.trim();
                if (!nombrePatron || !regPatronal || !texto) {
                    showCustomAlert(`Por favor, complete todos los campos para el Periodo Laboral #${index + 1}.`, "Datos Faltantes");
                    isValid = false;
                    return;
                }
                const movementsOnCard = [];
                const lineas = texto.split('\n').filter(line => line.trim() !== '');
                const regex = /(.+?)\s+(\d{2}\/\d{2}\/\d{4})\s*(?:\$\s*([\d,]+\.?\d*))?/;
                lineas.forEach(linea => {
                    const match = linea.trim().match(regex);
                    if (match) {
                        const tipo = match[1].trim().toUpperCase();
                        const [dia, mes, anio] = match[2].split('/');
                        const fecha = new Date(Date.UTC(anio, mes - 1, dia));
                        const sbc = match[3] ? parseFloat(match[3].replace(/,/g, '')) : null;
                        movementsOnCard.push({
                            tipo,
                            fecha,
                            sbc,
                            nombrePatron,
                            regPatronal
                        });
                    } else {
                        showCustomAlert(`En Periodo Laboral #${index + 1}, la línea "${linea}" no tiene un formato válido.`, "Error de Formato");
                        isValid = false;
                    }
                });
                if (!isValid) return;

                movementsOnCard.sort((a, b) => {
                    if (a.fecha.getTime() !== b.fecha.getTime()) {
                        return a.fecha - b.fecha;
                    }
                    if (a.tipo.includes('BAJA')) return 1;
                    if (b.tipo.includes('BAJA')) return -1;
                    return 0;
                });

                for (let i = 0; i < movementsOnCard.length; i++) {
                    const mov = movementsOnCard[i];
                    if (mov.tipo.includes('BAJA') || mov.sbc === null || mov.sbc <= 0) {
                        continue;
                    }
                    const fechaInicio = mov.fecha;
                    let fechaFin = null;
                    for (let j = i + 1; j < movementsOnCard.length; j++) {
                        const nextMov = movementsOnCard[j];
                        if (nextMov.tipo.includes('BAJA')) {
                            fechaFin = nextMov.fecha;
                            i = j;
                            break;
                        } else if (nextMov.sbc !== null && nextMov.sbc > 0) {
                            fechaFin = new Date(nextMov.fecha);
                            fechaFin.setUTCDate(fechaFin.getUTCDate() - 1);
                            break;
                        }
                    }
                    if (fechaFin === null) {
                        const hoy = new Date();
                        fechaFin = new Date(Date.UTC(hoy.getUTCFullYear(), hoy.getUTCMonth() + 1, 0));
                    }
                    if (fechaFin >= fechaInicio) {
                        allParsedPeriods.push({
                            fechaInicio: fechaInicio,
                            fechaFin: fechaFin,
                            sbc: mov.sbc,
                            dias: Math.round((fechaFin - fechaInicio) / (1000 * 60 * 60 * 24)) + 1,
                            nombrePatron: nombrePatron,
                            regPatronal: regPatronal,
                            isQP: isQP
                        });
                    }
                }
            });

            if (!isValid) return;

            const totalQpDays = allParsedPeriods
                .filter(p => p.isQP)
                .reduce((sum, p) => sum + p.dias, 0);

            const weeksToSubtract = totalQpDays / 7.0;
            const adjustedWeeks = Math.floor(Math.max(0, AppState.datosClienteInfo.semanasCotizadasBase - weeksToSubtract));
            AppState.datosClienteInfo.semanasCotizadasBase = adjustedWeeks; // Update the state

            AppState.allParsedPeriodsForDisplay = allParsedPeriods;
            AppState.fullHistoryPeriods = allParsedPeriods.filter(p => !p.isQP);

            AppState.timelinePeriods = processOverlappingPeriods(AppState.fullHistoryPeriods);
            let periodosParaSBC = [...AppState.timelinePeriods].sort((a, b) => b.fechaFin - a.fechaFin);
            let diasAcumuladosSBC = 0;
            let sbcPonderadoTotal = 0;
            const periodosParaTabla = [];
            for (const p of periodosParaSBC) {
                if (diasAcumuladosSBC >= Constants.DIAS_PROMEDIO_PENSION) break;
                const diasDelPeriodo = Math.round((p.fechaFin - p.fechaInicio) / (1000 * 60 * 60 * 24)) + 1;
                const diasAUsar = Math.min(diasDelPeriodo, Constants.DIAS_PROMEDIO_PENSION - diasAcumuladosSBC);
                sbcPonderadoTotal += p.sbc * diasAUsar;
                diasAcumuladosSBC += diasAUsar;
                periodosParaTabla.push({ ...p,
                    dias: diasAUsar,
                    ponderado: p.sbc * diasAUsar,
                });
            }
            AppState.sbcCalculationPeriods = periodosParaTabla;
            const sbcPromedioFinal = diasAcumuladosSBC > 0 ? sbcPonderadoTotal / diasAcumuladosSBC : 0;

            let edadParaCalculoBase = AppState.datosClienteInfo.edadBase;
            const ageWarningEl = document.getElementById('ageAdjustmentWarning');
            if (AppState.datosClienteInfo.edadBase < 60) {
                edadParaCalculoBase = 60;
                ageWarningEl.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>La edad del asegurado es ${AppState.datosClienteInfo.edadBase} años. Para el cálculo de la pensión base, se ha ajustado la edad a 60 años (mínima de retiro).`;
                ageWarningEl.style.display = 'block';
            } else {
                ageWarningEl.style.display = 'none';
            }
            let ultimaFechaBaja = null;
            if (AppState.fullHistoryPeriods.length > 0) {
                const sortedPeriods = [...AppState.fullHistoryPeriods].sort((a, b) => b.fechaFin - a.fechaFin);
                ultimaFechaBaja = sortedPeriods[0].fechaFin;
            }
            // Update state with calculation results
            AppState.datosClienteInfo.sbcPromedioBase = sbcPromedioFinal;
            AppState.datosClienteInfo.ultimaFechaBaja = ultimaFechaBaja;

            // Update UI
            document.getElementById('res_sbcPromedio').textContent = '$' + formatNumber(sbcPromedioFinal);
            document.getElementById('res_semanasNetas').textContent = formatNumber(adjustedWeeks, 0);
            document.getElementById('res_edadActual').textContent = `${AppState.datosClienteInfo.edadBase} años`;
            document.getElementById('res_telefonoCliente').textContent = AppState.datosClienteInfo.telefono;
            renderSbcAnalysisTable();
            renderModalitySummary();
            toggleFullHistoryTimeline();
            checkVigencia();
            document.getElementById('sbcAnalysisTableFooter').innerHTML = `
                <tr>
                    <td class="p-3" colspan="3">Total Días Usados para Cálculo:</td>
                    <td class="p-3 text-right">${formatNumber(diasAcumuladosSBC, 0)}</td>
                    <td class="p-3" colspan="2"></td>
                </tr>`;
            const daysWarningEl = document.getElementById('sbcDaysWarning');
            if (diasAcumuladosSBC < Constants.DIAS_PROMEDIO_PENSION) {
                daysWarningEl.innerHTML = `<i class="fas fa-exclamation-triangle mr-2 text-yellow-500"></i>Se han utilizado <strong>${formatNumber(diasAcumuladosSBC, 0)} de ${Constants.DIAS_PROMEDIO_PENSION}</strong> días para el cálculo. El sistema completará los días faltantes con el último salario registrado para el promedio.`;
                daysWarningEl.className = 'mt-4 p-3 rounded-lg text-sm bg-yellow-50 border border-yellow-200 text-yellow-800';
            } else {
                daysWarningEl.innerHTML = `<i class="fas fa-check-circle mr-2 text-green-500"></i>Se han recopilado los <strong>${Constants.DIAS_PROMEDIO_PENSION}</strong> días necesarios para el cálculo del Salario Promedio.`;
                daysWarningEl.className = 'mt-4 p-3 rounded-lg text-sm bg-green-50 border border-green-200 text-green-800';
            }
            daysWarningEl.style.display = 'block';

            const hintEl = document.getElementById('lastBajaDateHint');
            const daySelect = document.getElementById('m40_day');
            const monthSelect = document.getElementById('m40_month');
            const yearSelect = document.getElementById('m40_year');
            const mesesInput = document.getElementById('info_m40_p1_meses');
            const sbcInput = document.getElementById('info_m40_p1_sbc');

            mesesInput.value = '';
            sbcInput.value = '';
            if (ultimaFechaBaja) {
                hintEl.innerHTML = `<i class="fas fa-info-circle mr-2"></i>Última fecha de baja a considerar: <span class="text-blue-700">${formatDateDDMMYYYY(ultimaFechaBaja)}</span>`;
                const m40StartDate = new Date(ultimaFechaBaja);
                m40StartDate.setUTCDate(m40StartDate.getUTCDate() + 1);
                const year = m40StartDate.getUTCFullYear();
                const month = m40StartDate.getUTCMonth() + 1;
                const day = m40StartDate.getUTCDate();
                yearSelect.value = year;
                monthSelect.value = month;
                updateDaySelector();
                daySelect.value = day;
                let targetAge = Math.max(60, AppState.datosClienteInfo.edadBase);
                if (AppState.datosClienteInfo.edadObjCompleta.meses > 6) {
                    targetAge++;
                } else if (AppState.datosClienteInfo.edadBase < 60) {
                    targetAge = 60;
                }
                const targetRetirementDate = new Date(extraerFechaNacimientoCURP(AppState.datosClienteInfo.curp));
                targetRetirementDate.setUTCFullYear(targetRetirementDate.getUTCFullYear() + targetAge);
                targetRetirementDate.setUTCMonth(targetRetirementDate.getUTCMonth() + 7);
                let monthsToInvest = (targetRetirementDate.getUTCFullYear() - m40StartDate.getUTCFullYear()) * 12;
                monthsToInvest -= m40StartDate.getUTCMonth();
                monthsToInvest += targetRetirementDate.getUTCMonth();
                mesesInput.value = Math.max(1, Math.min(60, Math.round(monthsToInvest)));
            } else {
                hintEl.innerHTML = '';
                daySelect.value = '';
                monthSelect.value = '';
                yearSelect.value = '';
            }

            actualizarSBCMaximoM40();
            actualizarFechaFinM40Display();
            showElement('sbcAnalysisResultsContainer');
            showElement('timelineSection');
            const pensionData = _calcularPensionDetallado(sbcPromedioFinal, adjustedWeeks, edadParaCalculoBase);
            AppState.pensionBaseResultadosInfo = pensionData;
            document.getElementById('res_base_pensionMensual').textContent = '$' + formatNumber(pensionData.PENSION_MENSUAL_ESTIMADA);
            document.getElementById('res_base_aguinaldo').textContent = '$' + formatNumber(pensionData.AGUINALDO_ESTIMADO);
            document.getElementById('res_base_ingresoAnual').textContent = '$' + formatNumber((pensionData.PENSION_MENSUAL_ESTIMADA * 12) + pensionData.AGUINALDO_ESTIMADO);
            showElement('basePensionResultsContainer');
            showCustomAlert("Análisis completado. El SBC Promedio y la pensión base han sido calculados.", "Análisis Exitoso");
        }
        
        // This is where the missing functions will go.
        function getEmployerColor(regPatronal) {
            if (regPatronal === "Modalidad 40") return '#f97316'; // Orange for M40
            if (regPatronal.includes('Traslape')) return '#A855F7'; // Purple for overlaps
            if (!employerColorCache[regPatronal]) {
                employerColorCache[regPatronal] = colorPalette[lastColorIndex % colorPalette.length];
                lastColorIndex++;
            }
            return employerColorCache[regPatronal];
        }

        function toggleAutoCards() {
            const container = document.getElementById('employmentCardsContainer');
            if (container.style.display === 'none') {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }
        
        async function startComprehensiveReportProcess() {
            const currentUser = sessionStorage.getItem('rgc_currentUser');
            if (ADMIN_USERS.includes(currentUser)) {
                await generateComprehensiveReportPDF(currentUser);
            } else {
                promptForPassword(async () => {
                   await generateComprehensiveReportPDF(currentUser);
                });
            }
        }

        function promptToChangeCommission() {
             promptForPassword(() => {
                const newCommissionStr = prompt("Ingrese el nuevo porcentaje de comisión base (ej. 16 para 16%):", Constants.COMISION_BASE_M40 * 100);
                if (newCommissionStr) {
                    const newCommission = parseFloat(newCommissionStr);
                    if (!isNaN(newCommission) && newCommission > 0) {
                        Constants.COMISION_BASE_M40 = newCommission / 100;
                        document.getElementById('commissionToggleButton').textContent = `Comisión Base Actual: ${newCommission}% (Click para cambiar)`;
                        showCustomAlert(`La comisión base se ha actualizado a ${newCommission}%. Todos los escenarios se recalcularán.`, "Comisión Actualizada");
                        recalculateAllScenarios();
                    } else {
                        showCustomAlert("Por favor, ingrese un número válido.", "Error");
                    }
                }
            });
        }
        
        // --- Full application logic continues here ---
        // (The rest of the JS code from the original file)
        // ...
        
        // =======================================================================================
        // FIN: Lógica de la aplicación
        // =======================================================================================

        // --- Inicialización y Lógica de Firebase ---

        // Función para poblar la base de datos con usuarios por defecto si está vacía
        async function seedDefaultUsers() {
            const usersRef = collection(db, "users");
            const snapshot = await getDocs(usersRef);
            if (snapshot.empty) {
                console.log("Base de datos de usuarios vacía. Poblando con datos por defecto...");
                const defaultUsers = {
                    'roberto ortiz': { password: '9192', role: 'admin', active: true },
                    'alma cano': { password: '9192', role: 'admin', active: true },
                    'mariano godinez': { password: '9192', role: 'user', active: true },
                    'rgc1': { password: '4729', role: 'user', active: true },
                    'rgc2': { password: '8315', role: 'user', active: true },
                    'rgc3': { password: '6092', role: 'user', active: true },
                    'rgc4': { password: '1578', role: 'user', active: true },
                    'rgc5': { password: '9234', role: 'user', active: true },
                    'rgc6': { password: '5801', role: 'user', active: true },
                    'rgc7': { password: '2468', role: 'user', active: true },
                    'rgc8': { password: '7139', role: 'user', active: true }
                };
                
                const batch = writeBatch(db);
                Object.keys(defaultUsers).forEach(username => {
                    const userDocRef = doc(db, "users", username);
                    batch.set(userDocRef, defaultUsers[username]);
                });

                await batch.commit();
                console.log("Usuarios por defecto agregados a Firestore.");
            } else {
                console.log("La base de datos de usuarios ya existe.");
            }
        }
        
        // Inicia sesión anónimamente para asegurar que las reglas de seguridad funcionen
        onAuthStateChanged(auth, (user) => {
          if (user) {
            console.log("Firebase Auth inicializado. Usuario anónimo:", user.uid);
            // Una vez Firebase está listo, revisa la sesión de la app
            checkSession(); 
          }
        });
        signInAnonymously(auth).catch((error) => {
            console.error("Error al iniciar sesión anónimamente", error);
            showCustomAlert("No se pudo conectar con el servicio de autenticación. Por favor, recargue la página.", "Error de Conexión");
        });
        
        // Llama a la función de población al cargar
        seedDefaultUsers();

        // --- EXPOSICIÓN DE FUNCIONES GLOBALES ---
        // Se exponen las funciones al objeto `window` para que puedan ser llamadas desde los atributos `onclick` del HTML
        window.handleLogout = handleLogout;
        window.toggleUserStatus = toggleUserStatus;
        window.analizarTextoCompleto = () => alert("Función 'analizarTextoCompleto' no implementada completamente."); // Placeholder
        window.toggleAutoCards = toggleAutoCards;
        window.addEmploymentCard = addEmploymentCard;
        window.analizarYCalcularSBC = analizarYCalcularSBC;
        window.renderSbcAnalysisTable = () => console.log('renderSbcAnalysisTable'); // Placeholder
        window.toggleFullHistoryTimeline = () => console.log('toggleFullHistoryTimeline'); // Placeholder
        window.promptForPassword = () => console.log('promptForPassword'); // Placeholder
        window.enableUmaEditing = () => console.log('enableUmaEditing'); // Placeholder
        window.saveUmas = () => console.log('saveUmas'); // Placeholder
        window.populateUmaTable = () => console.log('populateUmaTable'); // Placeholder
        window.calcularEscenarioM40Infografia = () => console.log('calcularEscenarioM40Infografia'); // Placeholder
        window.setSBCFromUMA = setSBCFromUMA;
        window.recalculateAllScenarios = () => console.log('recalculateAllScenarios'); // Placeholder
        window.handleMesesDepositoChange = handleMesesDepositoChange;
        window.toggleAdvancedEditing = () => console.log('toggleAdvancedEditing'); // Placeholder
        window.promptToChangeCommission = promptToChangeCommission;
        window.addScenarioCard = () => console.log('addScenarioCard'); // Placeholder
        window.showWhatsAppModal = () => console.log('showWhatsAppModal'); // Placeholder
        window.startComprehensiveReportProcess = startComprehensiveReportProcess;
        window.generateROIMatrix = () => console.log('generateROIMatrix'); // Placeholder
        window.hideElement = hideElement;
        window.copyWhatsAppText = () => console.log('copyWhatsAppText'); // Placeholder
        window.removeEmploymentCard = removeEmploymentCard;
        window.toggleQPCardStyle = toggleQPCardStyle;
        window.recalculateScenario = () => console.log('recalculateScenario'); // Placeholder
        window.removeScenarioCard = () => console.log('removeScenarioCard'); // Placeholder
        window.editTotalCost = () => console.log('editTotalCost'); // Placeholder
        window.updatePieChartStep = () => console.log('updatePieChartStep'); // Placeholder
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeMainAppDisplay();
            initDateSelectors();

            const m40Selectors = ['m40_day', 'm40_month', 'm40_year'];
            m40Selectors.forEach(id => {
                const el = document.getElementById(id);
                el.addEventListener('change', () => {
                    actualizarSBCMaximoM40();
                    actualizarFechaFinM40Display();
                });
            });
            document.getElementById('m40_year').addEventListener('change', updateDaySelector);
            document.getElementById('m40_month').addEventListener('change', updateDaySelector);

            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    handleLogin();
                });
            }
        });
    </script>
</body>
</html>

