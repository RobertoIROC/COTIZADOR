<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RGC Pensiones - Calculadora de Lujo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Playfair+Display:wght@700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-dark-blue: #0D1B2A; /* Un azul casi negro, muy elegante */
            --color-strong-blue: #1B263B; /* Azul intermedio */
            --color-medium-blue: #415A77; /* Azul grisáceo */
            --color-gold: #D4AF37; /* Oro clásico */
            --color-light-gold: #F0E68C; /* Oro pálido */
            --color-background: #F8F9FA; /* Fondo casi blanco */
            --color-text-dark: #0D1B2A;
            --color-text-medium: #415A77;
            --color-success: #28a745;
            --color-danger: #dc3545;
        }

        body { 
            font-family: 'Open Sans', sans-serif; 
            background-color: var(--color-background);
            color: var(--color-text-medium);
        }
        .main-header {
            background: linear-gradient(135deg, var(--color-strong-blue) 0%, var(--color-dark-blue) 100%);
            color: white;
            padding: 2.5rem 1rem;
            border-radius: 0 0 40px 40px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        .main-header img {
            max-height: 70px;
            filter: drop-shadow(0 4px 5px rgba(0,0,0,0.3));
        }
        .main-header h1 {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            font-size: 3rem; /* 48px */
            letter-spacing: 0.5px;
            color: var(--color-gold);
            text-shadow: 1px 1px 3px rgba(0,0,0,0.4);
        }
        .main-header p {
            font-family: 'Poppins', sans-serif;
            font-size: 1.125rem; /* 18px */
            opacity: 0.8;
            color: #E0E1DD; /* Un gris claro para el subtítulo */
        }

        .infographic-section {
            background-color: #ffffff;
            border-radius: 20px;
            padding: 2.5rem;
            margin-bottom: 2.5rem;
            box-shadow: 0 10px 30px rgba(27, 38, 59, 0.08);
            border-top: 6px solid;
            border-left: none;
        }
        .section-1-border { border-top-color: var(--color-medium-blue); }
        .section-2-border { border-top-color: var(--color-gold); }
        .section-3-border { border-top-color: var(--color-success); }
        .section-4-border { border-top-color: #6F42C1; }
        .section-5-border { border-top-color: var(--color-danger); }

        .infographic-section h2 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.875rem; /* 30px */
            font-weight: 600;
            margin-bottom: 2rem;
            color: var(--color-text-dark);
            display: flex;
            align-items: center;
        }
        .infographic-section h2 i {
            margin-right: 1rem;
            font-size: 1.75rem;
            width: 45px;
            height: 45px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: var(--section-icon-bg, #E0E7FF);
            color: var(--section-icon-color, #3B82F6);
        }
        .section-1-border h2 i { --section-icon-bg: #EBF0F6; --section-icon-color: var(--color-medium-blue); }
        .section-2-border h2 i { --section-icon-bg: #FFFBEB; --section-icon-color: var(--color-gold); }
        .section-3-border h2 i { --section-icon-bg: #F0FFF4; --section-icon-color: var(--color-success); }
        .section-4-border h2 i { --section-icon-bg: #F3E8FF; --section-icon-color: #6F42C1; }
        .section-5-border h2 i { --section-icon-bg: #FEF2F2; --section-icon-color: var(--color-danger); }
        
        .infographic-section h3.subsection-title {
            font-family: 'Poppins', sans-serif;
            font-size: 1.375rem;
            font-weight: 600;
            color: var(--color-strong-blue);
            margin-top: 2rem;
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #E2E8F0;
        }
        
        .input-group label {
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            margin-bottom: 0.6rem;
            color: var(--color-text-medium); 
            font-size: 0.9rem;
        }
        .input-group input[type="text"],
        .input-group input[type="password"],
        .input-group input[type="number"],
        .input-group input[type="month"],
        .input-group select {
            padding: 0.85rem 1rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            font-size: 0.95rem;
            transition: all 0.2s ease-in-out;
            background-color: #FCFCFC;
        }
        .input-group input:focus, .input-group select:focus {
            border-color: var(--color-gold); 
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.25);
        }
        
        .btn-calculate, .btn-primary-small, .btn-export, .btn-info-small, .btn-login {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            padding: 0.9rem 2.2rem;
            border-radius: 0.5rem;
            transition: all 0.25s ease-out;
            border: none;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .btn-calculate:disabled, .btn-calculate.bg-amber-500:disabled, .btn-export:disabled, .btn-login:disabled, .btn-primary-small:disabled {
            background: #A0AEC0;
            background-image: none;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        .btn-calculate { background: linear-gradient(135deg, var(--color-medium-blue), var(--color-strong-blue)); color: white; }
        .btn-calculate:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(65, 90, 119, 0.4); }
        
        .btn-calculate.bg-amber-500 { background: linear-gradient(135deg, #FBBF24, #D97706); color: var(--color-dark-blue);}
        .btn-calculate.bg-amber-500:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(217, 119, 6, 0.3); }

        .btn-export { background: linear-gradient(135deg, var(--color-gold), #b89b72); color: var(--color-dark-blue); }
        .btn-export:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(212, 175, 55, 0.4); }
        
        .btn-primary-small { padding: 0.6rem 1.2rem; font-size: 0.8rem; background: linear-gradient(135deg, var(--color-strong-blue), var(--color-dark-blue)); color: white; }
        .btn-primary-small:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(27, 38, 59, 0.3); }

        .btn-login { background: linear-gradient(135deg, var(--color-gold), #b89b72); color: var(--color-dark-blue); }
        .btn-login:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(212, 175, 55, 0.4); }
        
        .results-card {
            background-color: #FFFFFF;
            padding: 2rem;
            border-radius: 0.75rem;
            margin-top: 2rem;
            border: 1px solid #E9ECEF;
            box-shadow: 0 4px 15px rgba(27, 38, 59, 0.05);
        }
        .results-card p { margin-bottom: 0.75rem; font-size: 1rem; color: var(--color-text-medium); }
        .results-card .highlight { font-size: 1.375rem; font-weight: 700; }
        .results-card .highlight-green { color: var(--color-success); }
        .results-card .highlight-amber { color: var(--color-gold); }
        .results-card .highlight-red { color: var(--color-danger); }

        .comparison-item .value { font-family: 'Poppins', sans-serif; font-size: 1.75rem; font-weight: 600; }
        .value.text-blue-600 { color: var(--color-medium-blue); }
        .value.text-amber-600 { color: var(--color-gold); }

        .app-footer {
            text-align: center;
            margin-top: 3rem;
            padding: 2rem 1rem;
            background-color: var(--color-dark-blue);
            color: #A9B4C2;
            border-top: 4px solid var(--color-gold);
        }
        .app-footer p { color: #A9B4C2; }
        .app-footer .logo-footer { max-height: 40px; margin-bottom: 0.5rem; opacity: 0.8; }
        
        /* Login Styles */
        #loginContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80vh;
            padding: 2rem;
        }
        .login-box {
            background-color: #ffffff;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(13, 27, 42, 0.15);
            width: 100%;
            max-width: 450px;
            border-top: 6px solid var(--color-gold);
        }
        .login-box h2 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--color-dark-blue);
            text-align: center;
            margin-bottom: 2.5rem;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed; inset: 0;
            background-color: rgba(13, 27, 42, 0.7);
            backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center; z-index: 50;
        }
        .modal-content {
            background-color: white; padding: 2.5rem; border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
            max-width: 90%; width: 450px;
        }
        .modal-content-alert { text-align: center; }
        .modal-content-privacy { width: 650px; text-align: left; }
        .modal-content-privacy h2 {
             font-family: 'Poppins', sans-serif; color: var(--color-dark-blue);
             font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem;
        }
        .modal-content-privacy .privacy-text-container {
            border: 1px solid #e2e8f0; padding: 1rem; border-radius: 0.5rem;
            background-color: var(--color-background); max-height: 60vh; overflow-y: auto;
        }
        #sessionTimerContainer {
            position: fixed; top: 1rem; right: 1rem;
            background-color: rgba(13, 27, 42, 0.8);
            backdrop-filter: blur(5px);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            z-index: 100;
            color: white;
            border: 1px solid var(--color-gold);
        }
        #sessionTimerContainer.warning {
            color: var(--color-gold);
            border-color: var(--color-danger);
        }

        /* Other inherited styles from the original file - simplified for brevity */
        .comparison-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }
        .comparison-item { background-color: #fff; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 6px 12px rgba(0,0,0,0.06); border: 1px solid #E9ECEF; }
        .comparison-item h4 { font-family: 'Poppins', sans-serif; font-weight: 500; margin-bottom: 0.75rem; color: #343A40; font-size: 0.95rem; }
        .m40-period-infographic { background-color: #FFFBEB; border: 1px solid var(--color-light-gold); padding: 1.5rem; border-radius: 0.75rem; }
        .m40-date-display { font-size: 0.8rem; color: var(--color-text-medium); margin-top: 0.25rem; height: 1.2rem; }
        .m40-date-warning { font-size: 0.8rem; color: var(--color-danger); font-weight: 500; }
        .error-message-infographic { background-color: #F8D7DA; border-left: 5px solid #D9534F; color: #721C24; padding: 1.25rem; border-radius: 0.5rem; }
        .sbc-detalle-table th { background-color: #E9ECEF; font-family: 'Poppins', sans-serif; font-weight: 500; }
        .toggle-switch-container { display: flex; align-items: center; background-color: #e9ecef; padding: 0.75rem 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; }
        .toggle-switch-container label { margin-right: 0.75rem; font-weight: 600; color: var(--color-strong-blue); font-size: 0.95rem; }
        .precision-mode-info { background-color: #EBF0F6; border-left: 4px solid var(--color-medium-blue); color: var(--color-strong-blue); padding: 1rem; margin-top: 0.5rem; margin-bottom: 1.5rem; border-radius: 0.375rem; font-size: 0.875rem; }
        .btn-secondary-small { background-color: #6C757D; color: white; padding: 0.5rem 1rem; font-size: 0.8rem; border-radius: 0.375rem; }
        .btn-secondary-small:hover { background-color: #5A6268; transform: translateY(-1px); }
        .btn-danger-small { background-color: #DC3545; color: white; padding: 0.5rem 1rem; font-size: 0.8rem; border-radius: 0.375rem; }
        .btn-danger-small:hover { background-color: #C82333; transform: translateY(-1px); }
        .btn-info-small { background: linear-gradient(135deg, #17A2B8, #117A8B); color: white; padding: 0.6rem 1.2rem; font-size: 0.8rem; border-radius: 0.5rem; }
        .btn-info-small:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(23,162,184,0.25); }
        .btn-toggle-costo { background-color: #6C757D; color: white; padding: 0.6rem 1rem; font-size: 0.8rem; border-radius: 0.375rem; transition: background-color 0.2s, border-color 0.2s; border: 2px solid transparent; }
        .btn-toggle-costo:hover { background-color: #5A6268; }
        .btn-toggle-costo.active { background-color: var(--color-success); color: white; border-color: #1e7e34; }
    </style>
</head>
<body>
    <!-- Confidentiality Agreement Modal -->
    <div id="confidentialityModal" class="modal-overlay">
        <div class="modal-content modal-content-privacy">
            <h2>CARTA COMPROMISO DE CONFIDENCIALIDAD Y USO ADECUADO DE HERRAMIENTAS</h2>
            <div class="privacy-text-container pr-4 my-4">
                <p><strong>Fecha:</strong> <span id="agreementDate"></span><br><strong>Lugar:</strong> Ciudad de México, México</p>
                <p>En mi calidad de Asesor para RGC Pensiones y Seguros, manifiesto y acepto de manera voluntaria los siguientes términos y condiciones:</p>
                <p><strong>1. ANTECEDENTES</strong><br>Reconozco que, en virtud de mi relación profesional con RGC Pensiones, se me ha proporcionado acceso a una herramienta de software especializada (en adelante, "la Herramienta"), la cual es fundamental para el desempeño de mis funciones.</p>
                <p><strong>2. PROPIEDAD INTELECTUAL</strong><br>Declaro tener pleno conocimiento de que la Herramienta es propiedad intelectual exclusiva del C. Ivan Roberto Ortiz Cano, y que RGC Pensiones cuenta con la licencia y autorización para su uso con fines corporativos específicos. Entiendo que mi acceso a la misma es una concesión temporal y está estrictamente limitado al ejercicio de mis responsabilidades dentro de esta empresa.</p>
                <p><strong>3. COMPROMISO DE USO EXCLUSIVO</strong><br>Me comprometo de manera irrevocable a utilizar la Herramienta única y exclusivamente para los fines y objetivos de negocio de RGC Pensiones.</p>
                <p><strong>4. PROHIBICIONES ESPECÍFICAS</strong><br>Queda estrictamente prohibido y me obligo a abstenerme de:<br>
                a) Utilizar la Herramienta, sus funciones, datos, metodologías o resultados para obtener cualquier tipo de lucro o beneficio personal, directo o indirecto.<br>
                b) Emplear la Herramienta para prestar servicios, asesorías o realizar actividades para terceros, ya sean personas físicas o morales, ajenos a RGC Pensiones.<br>
                c) Copiar, reproducir, modificar, distribuir, vender, sublicenciar, descompilar o realizar ingeniería inversa de la Herramienta o cualquiera de sus componentes.<br>
                d) Compartir mis credenciales de acceso (contraseña o cualquier otra forma de acceso) con cualquier otra persona, dentro o fuera de la organización.</p>
                <p><strong>5. CONSECUENCIAS DEL INCUMPLIMIENTO</strong><br>Entiendo y acepto que el incumplimiento de cualquiera de los puntos estipulados en esta carta será considerado una falta grave y se podrá dar lugar a:<br>
                a) Concluir la relación profesional y comercial con RGC Pensiones, sin responsabilidad para la empresa.<br>
                b) El inicio de acciones legales en mi contra por parte de RGC Pensiones y/o del Sr. Ivan Roberto Ortiz Cano, titular de la propiedad intelectual, para reclamar la reparación de los daños y perjuicios ocasionados.</p>
                <p>Este compromiso mantendrá su vigencia durante toda mi relación con RGC Pensiones y subsistirá incluso después de su terminación, por tiempo indefinido.</p>
                <p>Habiendo leído y comprendido en su totalidad el presente documento, lo acepto de conformidad.</p>
            </div>
            <div class="flex items-center mb-6">
                <input type="checkbox" id="agreementCheckbox" class="h-4 w-4 text-yellow-600 border-gray-300 rounded focus:ring-yellow-500">
                <label for="agreementCheckbox" class="ml-2 block text-sm text-gray-900">
                    He leído, comprendido y acepto los términos de esta carta compromiso.
                </label>
            </div>
            <div class="text-right">
                <button id="acceptAgreementButton" onclick="acceptAgreement()" class="btn-primary-small" disabled>
                    Aceptar y Continuar
                </button>
            </div>
        </div>
    </div>

    <div id="sessionTimerContainer" style="display: none;">
        <i class="fas fa-clock mr-2"></i>Tiempo restante: <span id="sessionCountdown">10:00</span>
    </div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl">

        <!-- Login Section (Initially Hidden) -->
        <div id="loginContainer" style="display: none;">
            <div class="login-box">
                <img src="https://placehold.co/200x80/FFFFFF/0D1B2A?text=RGC&font=playfair+display" alt="Logo RGC Pensiones" class="mx-auto mb-8" onerror="this.onerror=null; this.src='https://placehold.co/200x80/CCCCCC/000000?text=Logo+no+disponible';">
                <h2>Acceso Exclusivo</h2>
                <div class="input-group">
                    <label for="login_password"><i class="fas fa-lock mr-2 opacity-70"></i>Contraseña:</label>
                    <input type="password" id="login_password" placeholder="••••••••••" class="w-full">
                </div>
                <div class="text-center mt-8">
                    <button id="loginButton" onclick="handleLogin()" class="btn-login w-full">
                        <i class="fas fa-sign-in-alt mr-2"></i>Ingresar
                    </button>
                </div>
                <div id="login_errorMessage" class="error-message-infographic" style="display: none;"><p></p></div>
            </div>
        </div>

        <!-- Main Application Content (Initially Hidden) -->
        <div id="mainContentContainer" style="display: none;">
            <header class="main-header text-center mb-12">
                <img src="https://placehold.co/280x100/transparent/FFFFFF?text=RGC+PENSIONES&font=playfair+display" alt="Logo RGC Pensiones" class="mx-auto mb-6" onerror="this.onerror=null; this.src='https://placehold.co/280x100/CCCCCC/000000?text=Logo+no+disponible';"> 
                <h1 class="text-white">Tu Proyección de Pensión y Crédito</h1>
                <p>Descubre cómo Modalidad 40 puede transformar tu futuro.</p>
            </header>

            <section id="infoSection1" class="infographic-section section-1-border">
                <h2><i class="fas fa-user-edit"></i>Paso 1: Tus Datos Actuales</h2>

                <div class="toggle-switch-container mb-6">
                    <label for="info_modoPrecisionContrato" class="flex items-center cursor-pointer">
                        <span class="text-base font-semibold" style="color: var(--color-strong-blue);">Modo Precisión (Firma de Contrato):</span>
                        <div class="relative ml-3">
                            <input type="checkbox" id="info_modoPrecisionContrato" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-500"></div>
                        </div>
                    </label>
                </div>
                <div id="info_mensajeModoPrecision" class="precision-mode-info" style="display: none;">
                    <p><i class="fas fa-info-circle mr-2"></i><strong>Modo de Precisión Activado:</strong> Para la estrategia de "Firma de Contrato", es crucial completar su historial salarial detallado de los últimos 1750 días (5 años) en la tabla de abajo. Este dato asegura la máxima precisión en los cálculos.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div class="input-group">
                        <label for="info_nombreCompleto"><i class="fas fa-user mr-2 opacity-70"></i>Nombre Completo:</label>
                        <input type="text" id="info_nombreCompleto" placeholder="Tu nombre aquí" class="w-full">
                    </div>
                    <div class="input-group">
                        <label for="info_semanasCotizadas"><i class="fas fa-calendar-check mr-2 opacity-70"></i>Semanas Cotizadas Netas:</label>
                        <input type="number" id="info_semanasCotizadas" placeholder="Ej: 1250" class="w-full">
                    </div>
                    <div class="input-group">
                        <label for="info_edadCliente"><i class="fas fa-birthday-cake mr-2 opacity-70"></i>Edad Actual:</label>
                        <input type="number" id="info_edadCliente" placeholder="Ej: 60" class="w-full">
                    </div>
                    <div class="input-group">
                        <label for="info_sbcPromedio"><i class="fas fa-money-bill-wave mr-2 opacity-70"></i>SBC Promedio Base (250 sem):</label>
                        <input type="number" id="info_sbcPromedio" placeholder="Ingresa o calcula detalladamente" class="w-full">
                    </div>
                </div>

                <div class="mt-6 mb-4">
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="info_usarSBCDetallado" class="form-checkbox h-5 w-5 text-yellow-600 rounded focus:ring-yellow-500" onchange="toggleSBCDetalladoSeccion()">
                        <span class="ml-3 text-gray-700 font-medium">Usar Cálculo de SBC Detallado</span>
                    </label>
                </div>

                <div id="info_seccionSBCDetallado" class="mt-6 p-6 border border-gray-200 rounded-xl bg-gray-50" style="display: none;">
                    <h3 class="subsection-title">Cálculo Detallado de SBC Promedio (Últimos 1750 días)</h3>
                    <p class="text-sm text-gray-600 mb-4">Ingresa tus movimientos salariales de los últimos 5 años (o hasta 1750 días cotizados). El sistema considerará los más recientes hasta completar 1750 días para el promedio.</p>
                    <div class="overflow-x-auto mb-4">
                        <table id="info_tablaHistorialLaboral" class="sbc-detalle-table w-full text-sm text-left">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                                <tr>
                                    <th scope="col" class="px-4 py-3">Fecha Mov.</th>
                                    <th scope="col" class="px-4 py-3">Tipo Mov.</th>
                                    <th scope="col" class="px-4 py-3">Nombre Patrón</th>
                                    <th scope="col" class="px-4 py-3">SBC Diario ($)</th>
                                    <th scope="col" class="px-4 py-3 w-24">Acción</th>
                                </tr>
                            </thead>
                            <tbody id="info_tablaHistorialLaboralBody"></tbody>
                        </table>
                    </div>
                    <button type="button" onclick="agregarMovimientoHistorialInfografia()" class="btn-secondary-small mb-4"><i class="fas fa-plus mr-1"></i>Agregar Movimiento</button>
                    
                    <div class="text-right">
                        <button type="button" onclick="calcularYUsarSBCDetalladoInfografia()" class="btn-primary-small">
                            <i class="fas fa-check-circle mr-1"></i>Calcular y Usar SBC Detallado
                        </button>
                    </div>
                     <div id="info_resultadosSBCDetalladoCalc" class="mt-4 text-sm">
                         <p>Total Días Considerados para Promedio: <span id="info_histTotalDiasConsiderados" class="font-semibold text-gray-800">0</span></p>
                         <p>SBC Promedio Detallado Calculado: <span id="info_histSBCDetalladoCalculado" class="font-semibold text-blue-700 text-lg">$0.00</span></p>
                     </div>
                </div>

                <div class="text-center mt-8">
                    <button onclick="calcularPensionBaseInfografia()" class="btn-calculate">
                        <i class="fas fa-calculator mr-2"></i>Calcular Pensión Base
                    </button>
                </div>
                <div id="info_resultadosPensionBase" class="results-card" style="display: none;">
                    <h3 class="text-lg font-semibold mb-3" style="color: var(--color-strong-blue);">Tu Pensión Base Estimada:</h3>
                    <p>Pensión Mensual: <span id="info_resPensionMensual" class="highlight" style="color: var(--color-strong-blue);"></span> MXN</p>
                    <p>Aguinaldo Estimado: <span id="info_resAguinaldo" class="highlight" style="color: var(--color-strong-blue);"></span> MXN</p>
                    <p class="text-sm mt-2 text-gray-600">SBC Promedio Base Usado: <span id="info_sbcBaseUsadoDisplay" class="font-semibold"></span></p>
                </div>
                <div id="info_mensajeErrorBase" class="error-message-infographic" style="display: none;"><p></p></div>
            </section>

            <section id="infoSection2" class="infographic-section section-2-border" style="display: none;">
                <h2><i class="fas fa-chart-area"></i>Paso 2: Explora Modalidad 40</h2>
                <div class="input-group">
                    <label for="info_curpCliente"><i class="fas fa-id-card mr-2 opacity-70"></i>CURP:</label>
                    <input type="text" id="info_curpCliente" placeholder="Tu CURP (18 caracteres)" maxlength="18" oninput="this.value = this.value.toUpperCase()" class="w-full">
                </div>
                
                <h3 class="subsection-title">Define tu Periodo Principal de M40:</h3>
                <div class="m40-period-infographic">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4">
                        <div class="input-group">
                            <label for="info_m40_p1_inicio">Fecha Inicio M40:</label>
                            <input type="month" id="info_m40_p1_inicio" onchange="actualizarSBCMaximoM40(); actualizarFechaFinM40Display();" class="w-full">
                        </div>
                        <div class="input-group">
                            <label for="info_m40_p1_meses">Meses en M40:</label>
                            <input type="number" id="info_m40_p1_meses" placeholder="Ej: 60" max="60" oninput="actualizarFechaFinM40Display()" class="w-full">
                            <div id="info_m40_fecha_fin_display_container" class="m40-date-display">
                                <span id="info_m40_fecha_fin_display"></span>
                                <span id="info_m40_fecha_fin_warning" class="m40-date-warning"></span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="info_m40_p1_sbc">SBC Diario M40 (Editable):</label>
                            <input type="number" id="info_m40_p1_sbc" placeholder="Se calculará" class="w-full">
                        </div>
                    </div>
                </div>
                 <p class="text-xs text-gray-500 mt-2 mb-6">Nota: El SBC Diario M40 se establecerá al tope de 25 UMAs del año de inicio seleccionado, pero puede editarlo.</p>

                <div class="text-center mt-8">
                    <button id="btnCalcularEscenarioM40" onclick="calcularEscenarioM40Infografia()" class="btn-calculate bg-amber-500">
                        <i class="fas fa-cogs mr-2"></i>Calcular Escenario M40
                    </button>
                </div>

                <div id="info_resultadosEscenarioM40" class="results-card" style="display: none;">
                    <h3 class="text-lg font-semibold mb-4" style="color: var(--color-gold);">Resultados con Modalidad 40:</h3>
                    <div class="comparison-grid mb-6">
                        <div class="comparison-item">
                            <h4>Pensión Base Mensual</h4>
                            <p id="info_compPensionBase" class="value text-blue-600">$0.00</p>
                        </div>
                        <div class="comparison-item">
                            <h4>Pensión M40 Mensual</h4>
                            <p id="info_compPensionM40" class="value text-amber-600">$0.00</p>
                        </div>
                    </div>
                    <p class="text-center text-2xl font-bold mb-6"><span class="text-green-600">¡Incremento Mensual de: <span id="info_compIncrementoNetoM40" class="highlight-green">$0.00</span>!</span> 🚀</p>
                    <hr class="my-6 border-gray-300">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                        <p>SBC Promedio M40 (p/cálculo): <span id="info_nuevoSBCPromedioM40" class="font-semibold text-gray-800"></span> MXN</p>
                        <p>Nuevas Semanas Cotizadas: <span id="info_nuevasSemanasM40" class="font-semibold text-gray-800"></span></p>
                        <p>Edad para % Pensión (Fin M40): <span id="info_nuevaEdadM40" class="font-semibold text-gray-800"></span> años</p>
                        <p>Costo Total M40 (P1 c/Act+Rec): <span id="info_costoTotalM40Simulacion" class="font-semibold highlight-red"></span> MXN</p>
                    </div>
                    <div class="text-center mt-6">
                         <button id="info_btnDescargarActRec" onclick="exportarActRecM40PDFInfografia()" class="btn-info-small" style="display: none;">
                             <i class="fas fa-file-invoice-dollar mr-2"></i>Descargar Desglose Act. y Rec.
                         </button>
                    </div>
                </div>
                 <div id="info_sbcWarningM40" class="error-message-infographic bg-yellow-100 border-yellow-500 text-yellow-700" style="display: none;"><p></p></div>
                <div id="info_mensajeErrorM40" class="error-message-infographic" style="display: none;"><p></p></div>
            </section>

            <section id="infoSection3" class="infographic-section section-3-border" style="display: none;">
                <h2><i class="fas fa-coins"></i>Paso 3: ¿Cómo se Cubre el Costo?</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                    <div class="input-group">
                        <label for="info_aforeActual"><i class="fas fa-piggy-bank mr-2 opacity-70"></i>AFORE Actual ($):</label>
                        <input type="number" id="info_aforeActual" placeholder="0.00" oninput="recalcularCoberturaTrasCambio()" class="w-full">
                    </div>
                    <div class="input-group">
                        <label for="info_tasaAfore"><i class="fas fa-percentage mr-2 opacity-70"></i>Tasa Anual AFORE (%):</label>
                        <input type="number" id="info_tasaAfore" placeholder="Ej: 6" oninput="recalcularCoberturaTrasCambio()" class="w-full">
                    </div>
                     <div class="input-group">
                        <label for="info_mesesInversionAfore"><i class="fas fa-calendar-alt mr-2 opacity-70"></i>Meses a Invertir AFORE (proyección):</label>
                        <input type="number" id="info_mesesInversionAfore" placeholder="Ej: 60" oninput="recalcularCoberturaTrasCambio()" class="w-full">
                    </div>
                    <div class="input-group">
                        <label for="info_mesesPrimerDeposito"><i class="fas fa-hand-holding-usd mr-2 opacity-70"></i>Meses para Primer Depósito (6-10):</label>
                        <input type="number" id="info_mesesPrimerDeposito" value="6" min="6" max="10" oninput="recalcularCoberturaTrasCambio()" class="w-full">
                    </div>
                </div>

                <div class="mt-8 pt-6 border-t border-gray-300">
                    <h3 class="subsection-title mb-6">Ajustes Adicionales al Costo del Contrato</h3>
                    
                    <div class="mb-6">
                        <h4 class="text-md font-semibold text-gray-700 mb-3">Costos Adicionales Opcionales:</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-2">
                            <button id="btn_ro_retro" type="button" onclick="toggleCostoAdicional('ro_retro', this)" class="btn-toggle-costo w-full">R.O. RETRO (+260,000)</button>
                            <button id="btn_qp" type="button" onclick="toggleCostoAdicional('qp', this)" class="btn-toggle-costo w-full">Q.P. (+60,000)</button>
                            <button id="btn_correccion" type="button" onclick="toggleCostoAdicional('correccion', this)" class="btn-toggle-costo w-full">CORRECCION (+15,000)</button>
                        </div>
                        <p class="text-sm text-gray-600">Total Adicional por Botones: <span id="info_totalAdicionalBotones" class="font-semibold">$0.00</span></p>
                    </div>

                    <div class="input-group">
                        <label for="info_comisionExcedente"><i class="fas fa-plus-circle mr-2 opacity-70"></i>Comisión por Excedente ($):</label>
                        <input type="number" id="info_comisionExcedente" placeholder="0.00" oninput="recalcularCoberturaTrasCambio()" class="w-full">
                    </div>
                </div>

                <div class="results-card bg-green-50 mt-8 border-green-200">
                    <h3 class="text-lg font-semibold mb-3 text-green-800">Fuentes de Cobertura:</h3>
                    <p>1. AFORE Proyectada: <span id="info_coberturaAfore" class="font-semibold highlight-green">$0.00</span></p>
                    <p>2. Primer Depósito (<span id="display_mesesPrimerDeposito">6</span> meses de pensión M40): <span id="info_coberturaPrimerDeposito" class="font-semibold highlight-green">$0.00</span></p>
                    <p>3. Extra AFORE (Retiro M40 P1): <span id="info_coberturaExtraAfore" class="font-semibold highlight-green">$0.00</span></p>
                    <hr class="my-3 border-green-200">
                    <p class="font-bold">Subtotal Cobertura (sin préstamo): <span id="info_coberturaSubtotalSinPrestamo" class="font-semibold text-green-800">$0.00</span></p>
                     <hr class="my-3 border-green-200">
                    <p>Costo Total del Contrato (Bruto Estimado): <span id="info_costoTotalContratoBruto" class="font-semibold highlight-red">$0.00</span></p>
                    
                    <div id="info_prestamoInfo" class="mt-4 border-t border-green-200 pt-4" style="display: none;">
                        <p class="text-red-700 font-medium">Déficit antes de préstamo: <span id="info_deficitAntesPrestamo" class="font-semibold">$0.00</span></p>
                        <p class="text-blue-700 font-medium">Capacidad Máxima de Préstamo (30% Pensión M40): <span id="info_prestamoMaximoCapacidad" class="font-semibold">$0.00</span></p>
                        <p class="text-red-700 font-medium">Préstamo Necesario (Estimado): <span id="info_prestamoNecesario" class="font-semibold">$0.00</span></p>
                        <p class="text-red-700 font-medium">Descuento Mensual Préstamo (aprox.): <span id="info_descuentoMensualPrestamo" class="font-semibold">$0.00</span></p>
                        <p id="info_detalleUsoPrestamo" class="text-sm text-gray-600 mt-1"></p>
                    </div>
                     <p class="mt-4 text-xl font-bold text-center"><span id="info_resultadoAnalisisCredito" class="text-green-800">Calculando...</span></p>
                     <p class="text-center text-lg"><span id="info_etiquetaSaldoFinal" class="font-semibold"></span> <span id="info_montoSaldoFinal" class="font-bold">$0.00</span></p>
                </div>
            </section>

            <section id="infoSection4" class="infographic-section section-4-border" style="display: none;">
                <h2><i class="fas fa-rocket"></i>Paso 4: ¡Tu Futuro Mejorado!</h2>
                <div class="results-card bg-purple-50 border-purple-200">
                    <p class="text-center text-2xl font-bold text-purple-800 mb-6">
                        Incremento Neto Mensual (Año 1 M40): <span id="info_ventajaIncrementoNeto" class="highlight-green">$0.00</span>
                    </p>
                    <div class="text-center mb-6">
                        <i class="fas fa-home fa-4x text-purple-400 mb-2"></i>
                        <p class="mt-2 text-lg text-gray-700">Tu pensión M40 (Año 1) podría equivaler a tener un inmueble de:</p>
                        <p class="text-3xl font-bold text-purple-600" id="info_ventajaValorInmueble">$0.00 MXN</p>
                        <p class="text-sm text-gray-500">(Generando rentas vitalicias, cap. 0.4% mensual)</p>
                    </div>
                     <hr class="my-6 border-purple-200">
                    <h4 class="text-lg font-semibold text-purple-800 mb-3">Proyección de Pensión Neta Anual:</h4>
                    <div id="info_proyeccionPensionNetaAnual" class="space-y-1 text-sm overflow-x-auto">
                         </div>
                     <p id="info_notaProyeccionInflacion" class="text-xs text-gray-500 mt-2"></p>
                </div>
            </section>
            
            <section id="infoSection5" class="infographic-section section-5-border" style="display: none;">
                <h2><i class="fas fa-file-pdf"></i>Paso 5: Guarda tu Proyección</h2>
                <p class="mb-8 text-gray-600 text-lg">Conserva esta información detallada para tu referencia o para discutirla con nosotros.</p>
                <button id="exportPdfButton" onclick="exportarPropuestaPDFInfografia()" class="btn-export text-lg">
                    <i class="fas fa-download mr-2"></i>Exportar Propuesta a PDF
                </button>
            </section>

            <footer class="app-footer">
                <img src="https://placehold.co/150x60/0D1B2A/D4AF37?text=RGC&font=playfair+display" alt="Logo RGC Pensiones Footer" class="logo-footer mx-auto" onerror="this.onerror=null; this.src='https://placehold.co/150x60/CCCCCC/000000?text=Logo';">
                <p>&copy; <span id="currentYear"></span> RGC Pensiones - Todos los derechos reservados.</p>
                <p class="text-xs mt-1">Esta es una simulación y los resultados pueden variar. Consulta a un asesor.</p>
            </footer>
        </div> <!-- End of mainContentContainer -->
    </div>

    <!-- Custom Alert Modal -->
    <div id="customAlertModal" class="modal-overlay" style="display: none;">
        <div class="modal-content modal-content-alert">
            <p id="customAlertMessage"></p>
            <button onclick="closeCustomAlert()" class="btn-primary-small">Aceptar</button>
        </div>
    </div>
    
    <!-- Hidden containers for PDF charts -->
    <div id="pdfChartContainer" style="position: absolute; left: -9999px; top: -9999px; width: 800px; background-color: white; padding: 20px;">
        <div style="margin-top: 40px; width: 750px; height: 500px;">
            <canvas id="pdfLineChartCanvas"></canvas>
        </div>
    </div>


    <script>
        // --- Session Timer Logic ---
        let sessionTimeout;
        let sessionInterval;
        const sessionDuration = 10 * 60 * 1000; // 10 minutes
        let sessionEndTime;

        function startSessionTimer() {
            clearTimeout(sessionTimeout);
            clearInterval(sessionInterval);
            
            sessionEndTime = Date.now() + sessionDuration;
            
            sessionTimeout = setTimeout(logout, sessionDuration);
            sessionInterval = setInterval(updateCountdown, 1000);
            
            showElement('sessionTimerContainer');
            updateCountdown();
        }

        function updateCountdown() {
            const remainingTime = sessionEndTime - Date.now();
            if (remainingTime <= 0) {
                logout();
                return;
            }
            
            const minutes = Math.floor((remainingTime / 1000) / 60);
            const seconds = Math.floor((remainingTime / 1000) % 60);
            const countdownEl = document.getElementById('sessionCountdown');
            const timerContainer = document.getElementById('sessionTimerContainer');

            countdownEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            if (remainingTime < 2 * 60 * 1000) { // Less than 2 minutes
                timerContainer.classList.add('warning');
            } else {
                timerContainer.classList.remove('warning');
            }
        }

        function logout() {
            clearTimeout(sessionTimeout);
            clearInterval(sessionInterval);

            hideElement('mainContentContainer');
            hideElement('sessionTimerContainer');
            showElement('loginContainer', 'flex');
            
            document.getElementById('login_password').value = '';
            
            showCustomAlert("Tu sesión ha expirado. Por favor, ingresa de nuevo.");
        }


        // --- Robust Show/Hide Logic ---
        function showElement(id, displayType = 'block') {
            const el = document.getElementById(id);
            if (el) el.style.display = displayType;
        }

        function hideElement(id) {
            const el = document.getElementById(id);
            if (el) el.style.display = 'none';
        }

        // --- Custom Alert Functionality ---
        function showCustomAlert(message) {
            const messageEl = document.getElementById('customAlertMessage');
            if (messageEl) {
                messageEl.textContent = message;
                showElement('customAlertModal', 'flex');
            }
        }

        function closeCustomAlert() {
            hideElement('customAlertModal');
        }
        
        // --- Confidentiality and Geolocation Logic ---
        function acceptAgreement() {
            hideElement('confidentialityModal');
            showElement('loginContainer', 'flex');
            document.getElementById('login_password').focus();
        }

        // --- LOGIN FUNCTIONALITY ---
        function handleLogin() {
            const loginButton = document.getElementById('loginButton');
            const originalButtonContent = loginButton.innerHTML;
            loginButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Ingresando...`;
            loginButton.disabled = true;

            setTimeout(() => {
                const passwordInput = document.getElementById('login_password');
                const password = passwordInput.value.trim();

                // UPDATED PASSWORD
                if (password === "RGC*") { 
                    hideElement('loginContainer');
                    showElement('mainContentContainer');
                    initializeMainAppDisplay();
                    startSessionTimer(); 
                } else {
                    const loginErrorTextEl = document.querySelector('#login_errorMessage p');
                    if (loginErrorTextEl) loginErrorTextEl.textContent = "Contraseña incorrecta. Inténtalo de nuevo.";
                    showElement('login_errorMessage');
                    hideElement('mainContentContainer'); 
                    loginButton.innerHTML = originalButtonContent;
                    loginButton.disabled = false;
                }
            }, 500);
        }
        
        function initializeMainAppDisplay() {
            hideElement('infoSection2'); 
            hideElement('infoSection3'); 
            hideElement('infoSection4'); 
            hideElement('infoSection5');
            hideElement('info_resultadosPensionBase'); 
            hideElement('info_resultadosEscenarioM40');
            document.getElementById('currentYear').textContent = new Date().getFullYear();
        }


        // --- LÓGICA DE CÁLCULO Y DATOS ECONÓMICOS ---
        let pensionBaseResultadosInfo = { PENSION_MENSUAL_ESTIMADA: 0, AGUINALDO_ESTIMADO: 0 };
        let datosClienteInfo = { nombre: '', semanasCotizadasBase: 0, edadBase: 0, sbcPromedioBase: 0, sbcDetalladoUsado: false };
        let aforeProyectadaGlobalInfo = 0;
        let m40ResultadosInfo = { 
            pensionMensualInicial: 0, 
            aguinaldo: 0, costoTotalP1: 0, 
            sbcPromedioParaCalculoPensionM40: 0, 
            sbcM40Ingresado: 0, 
            nuevasSemanas: 0, nuevaEdad: 0 
        };
        let datosCompletosParaPDFInfo = {};
        let desgloseDetalladoMensualM40Global = []; 

        let costosAdicionalesActivos = { ro_retro: false, qp: false, correccion: false };
        const valoresCostosAdicionales = { ro_retro: 260000, qp: 60000, correccion: 15000 };
        let totalizadorCostosAdicionalesBotones = 0;

        let economicData = {
            umas: { 2018: 80.60, 2019: 84.49, 2020: 86.88, 2021: 89.62, 2022: 96.22, 2023: 103.74, 2024: 108.57, 2025: 113.14, 2026: 118.64, 2027: 124.00, 2028: 129.68, 2029: 135.61, 2030: 141.81 },
            smgv_diario: { 2018: 88.36, 2019: 102.68, 2020: 123.22, 2021: 141.70, 2022: 172.87, 2023: 207.44, 2024: 248.93 },
            pmg_historica_mensual: { 2023: 7000.00, 2024: 8500.00, 2025: 9400.00 }
        };
        const currentFullYear = new Date().getFullYear();
        for (let y = Math.max(...Object.keys(economicData.umas).map(Number)) + 1; y <= currentFullYear + 10; y++) {
            if (!economicData.umas[y]) economicData.umas[y] = parseFloat((economicData.umas[y-1] * 1.045).toFixed(2));
        }
        for (let y = Math.max(...Object.keys(economicData.smgv_diario).map(Number)) + 1; y <= currentFullYear + 10; y++) {
             if (!economicData.smgv_diario[y]) economicData.smgv_diario[y] = parseFloat((economicData.smgv_diario[y-1] * 1.10).toFixed(2));
        }
        for (let y = Math.max(...Object.keys(economicData.pmg_historica_mensual).map(Number)) + 1; y <= currentFullYear + 10; y++) {
            if (!economicData.pmg_historica_mensual[y]) {
                economicData.pmg_historica_mensual[y] = parseFloat((economicData.pmg_historica_mensual[y-1] * 1.08).toFixed(2));
            }
        }

        const averageAnnualINPCGrowth = 0.045; 
        const SMGV_DF_Global = 88.36; 
        const FACTOR_FOX_Global = 1.11;
        const tablaCuantiasGlobal = [ 
            { minRatio: 0,    maxRatio: 1.00, pcb: 80.00, pia: 0.563 }, { minRatio: 1.01, maxRatio: 1.25, pcb: 77.11, pia: 0.814 },
            { minRatio: 1.26, maxRatio: 1.50, pcb: 58.18, pia: 1.178 }, { minRatio: 1.51, maxRatio: 1.75, pcb: 49.23, pia: 1.430 },
            { minRatio: 1.76, maxRatio: 2.00, pcb: 42.67, pia: 1.615 }, { minRatio: 2.01, maxRatio: 2.25, pcb: 37.65, pia: 1.756 },
            { minRatio: 2.26, maxRatio: 2.50, pcb: 33.68, pia: 1.868 }, { minRatio: 2.51, maxRatio: 2.75, pcb: 30.48, pia: 1.958 },
            { minRatio: 2.76, maxRatio: 3.00, pcb: 27.83, pia: 2.033 }, { minRatio: 3.01, maxRatio: 3.25, pcb: 25.60, pia: 2.096 },
            { minRatio: 3.26, maxRatio: 3.50, pcb: 23.70, pia: 2.149 }, { minRatio: 3.51, maxRatio: 3.75, pcb: 22.07, pia: 2.195 },
            { minRatio: 3.76, maxRatio: 4.00, pcb: 20.65, pia: 2.235 }, { minRatio: 4.01, maxRatio: 4.25, pcb: 19.39, pia: 2.271 },
            { minRatio: 4.26, maxRatio: 4.50, pcb: 18.29, pia: 2.302 }, { minRatio: 4.51, maxRatio: 4.75, pcb: 17.30, pia: 2.330 },
            { minRatio: 4.76, maxRatio: 5.00, pcb: 16.41, pia: 2.355 }, { minRatio: 5.01, maxRatio: 5.25, pcb: 15.61, pia: 2.377 },
            { minRatio: 5.26, maxRatio: 5.50, pcb: 14.88, pia: 2.398 }, { minRatio: 5.51, maxRatio: 5.75, pcb: 14.22, pia: 2.416 },
            { minRatio: 5.76, maxRatio: 6.00, pcb: 13.62, pia: 2.433 }, { minRatio: 6.01, maxRatio: Infinity, pcb: 13.00, pia: 2.450 }
        ];
        const tasasPagoM40 = { 
            2022: 0.10075, 2023: 0.11166, 2024: 0.12256, 2025: 0.13347,
            2026: 0.14438, 2027: 0.15528, 2028: 0.16619, 2029: 0.17709, 2030: 0.18800
        };
        const historicalINPC_December = { 2018: 101.355, 2019: 104.236, 2020: 107.608, 2021: 115.499, 2022: 124.507, 2023: 130.036,};
        const actualINPC_Monthly = { "2024-01": 131.396, "2024-02":131.500, "2024-03":131.650, "2024-04":131.800, "2024-05":132.000 };
        const BASE_PROJECTION_INPC_YEAR = 2024; 
        const BASE_PROJECTION_INPC_MONTH = 5;
        const BASE_PROJECTION_INPC_VALUE = actualINPC_Monthly[`${BASE_PROJECTION_INPC_YEAR}-${String(BASE_PROJECTION_INPC_MONTH).padStart(2,'0')}`] || 132.000;
        
        const PRESTAMO_PUNTO_A_DESCUENTO = 1115.61; 
        const PRESTAMO_PUNTO_A_MONTO = 31000;
        const PRESTAMO_PUNTO_B_DESCUENTO = 33450.42; 
        const PRESTAMO_PUNTO_B_MONTO = 929500;
        const DIAS_PROMEDIO_PENSION = 1750; 

        function formatNumber(num, decimals = 2) {
            if (typeof num !== 'number' || isNaN(num)) return (0).toFixed(decimals);
            return num.toLocaleString('es-MX', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        }
        function truncar(n, d) { return Math.floor(n * Math.pow(10, d)) / Math.pow(10, d); }
        function getNumeroInfo(id) { return parseFloat(document.getElementById(id).value.replace(/,/g, '')) || 0; }
        function getDiasEnMes(a, m) { return new Date(a, m, 0).getDate(); }
        
        function getUMA(y, m = new Date().getMonth() + 1) { 
            let uY = parseInt(y);
            if (m === 1 && economicData.umas[uY-1]) uY = parseInt(y)-1; 
            return economicData.umas[uY] || economicData.umas[Object.keys(economicData.umas).sort((a,b) => b-a)[0]] || 0;
        }
        
        function _calcularPensionDetallado(sbcP, semC, edadC, smgv, fFox, tC) {
            if (sbcP <= 0 || semC < 500 || edadC < 60) return { PENSION_MENSUAL_ESTIMADA: 0, AGUINALDO_ESTIMADO: 0, Pension_Anual_Con_Asignacion: 0 };
            const rSBCvsSMGV = sbcP / smgv; let pcb = 0, pia = 0;
            for (const rg of tC) { if (rSBCvsSMGV >= rg.minRatio && rSBCvsSMGV <= rg.maxRatio) { pcb = rg.pcb; pia = rg.pia; break; } }
            if (pcb === 0 && pia === 0 && rSBCvsSMGV > tC[tC.length-1].maxRatio && tC[tC.length-1].maxRatio !== Infinity) { const u = tC[tC.length-1]; pcb = u.pcb; pia = u.pia; }
            const cBAP = (sbcP * 365) * (pcb / 100); const CBF = cBAP * fFox;
            let fNIF = 0; if (semC > 500) fNIF = truncar((semC - 500) / 52, 2); 
            const iACP = (sbcP * 365) * (pia / 100) * fNIF; const IAVF = iACP * fFox;
            const pVAB = CBF + IAVF; let pE = 0;
            if (edadC >= 65) pE = 1.00; else if (edadC === 64) pE = 0.95; else if (edadC === 63) pE = 0.90;
            else if (edadC === 62) pE = 0.85; else if (edadC === 61) pE = 0.80; else if (edadC === 60) pE = 0.75;
            const pVAAE = pVAB * pE; const pACA = pVAAE * 1.15;
            const PME = pACA / 12; 
            const aguinaldoEstimado = (PME / 1.15);
            return { PENSION_MENSUAL_ESTIMADA: PME, AGUINALDO_ESTIMADO: aguinaldoEstimado, Pension_Anual_Con_Asignacion: pACA };
        }
        function extraerFechaNacimientoCURP(curp) {
            if (typeof curp !== 'string' || curp.length !== 18) return null;
            const aS = curp.substring(4,6); const mS = curp.substring(6,8); const dS = curp.substring(8,10);
            let anio = parseInt(aS); const mes = parseInt(mS); const dia = parseInt(dS);
            if (isNaN(anio) || isNaN(mes) || isNaN(dia) || mes < 1 || mes > 12 || dia < 1 || dia > 31 ) return null;
            const cIS = curp.charAt(16); let siglo = 1900; const cYLT = new Date().getFullYear() % 100;
            if (!isNaN(parseInt(cIS))) siglo = (anio > cYLT + 10) ? 1900 : 2000;
            else if (cIS >= 'A' && cIS <= 'Z') siglo = 2000;
            anio = siglo + anio; 
            try { const f = new Date(anio, mes-1, dia); if (f.getFullYear() === anio && f.getMonth() === (mes-1) && f.getDate() === dia) return f; return null; } catch (e) { return null; }
        }
        function calcularEdadExacta(fN, fR) {
            if (!fN || !(fN instanceof Date) || isNaN(fN) || !fR || !(fR instanceof Date) || isNaN(fR)) return { anos: 0, meses: 0, dias: 0, texto: "N/A" };
            let a = fR.getFullYear() - fN.getFullYear(); let m = fR.getMonth() - fN.getMonth(); let d = fR.getDate() - fN.getDate();
            if (d < 0) { m--; d += new Date(fR.getFullYear(), fR.getMonth(), 0).getDate(); }
            if (m < 0) { a--; m += 12; }
            return { anos: a, meses: m, dias: d, texto: `${a} años, ${m} meses, ${d} días` };
        }
        function calcularINPCProyectado(tM, tY) {
            const dK = `${tY}-${String(tM).padStart(2,'0')}`; if (actualINPC_Monthly[dK]) return actualINPC_Monthly[dK];
            if (tY < BASE_PROJECTION_INPC_YEAR || (tY === BASE_PROJECTION_INPC_YEAR && tM < BASE_PROJECTION_INPC_MONTH)) {
                 if(historicalINPC_December[tY] && tM === 12) return historicalINPC_December[tY]; 
            }
            const mO = (tY - BASE_PROJECTION_INPC_YEAR) * 12 + (tM - BASE_PROJECTION_INPC_MONTH);
            return BASE_PROJECTION_INPC_VALUE * Math.pow(1 + (averageAnnualINPCGrowth/12), mO);
        }
        function getTasaM40Porcentaje(a) {
            if (a <= 2022) return tasasPagoM40[2022]; if (a >= 2030) return tasasPagoM40[2030];
            return tasasPagoM40[a] || tasasPagoM40[Object.keys(tasasPagoM40).sort((x,y)=>y-x)[0]]; 
        }
         function calcularFechaFinDesdeMeses(fechaInicioStr, numMeses) {
            if (!fechaInicioStr || !numMeses || numMeses <= 0) return null;
            const [anioInicio, mesInicio] = fechaInicioStr.split('-').map(Number);
            if (isNaN(anioInicio) || isNaN(mesInicio)) return null;
            const fechaInicioObj = new Date(Date.UTC(anioInicio, mesInicio - 1, 1)); 
            const fechaFinObj = new Date(Date.UTC(fechaInicioObj.getUTCFullYear(), fechaInicioObj.getUTCMonth() + Number(numMeses), 1));
            fechaFinObj.setUTCDate(0); 
            return `${fechaFinObj.getUTCFullYear()}-${String(fechaFinObj.getUTCMonth() + 1).padStart(2, '0')}`;
        }

        function showError(sectionSuffix, message) {
            const errTextEl = document.querySelector(`#info_mensajeError${sectionSuffix} p`);
            if (errTextEl) {
                errTextEl.textContent = message;
                showElement(`info_mensajeError${sectionSuffix}`);
            }
        }
        function clearError(sectionSuffix) {
            hideElement(`info_mensajeError${sectionSuffix}`);
        }
         function showSBCWarning(message) {
            const warnTextEl = document.querySelector('#info_sbcWarningM40 p');
            if(warnTextEl) {
                warnTextEl.textContent = message;
                showElement('info_sbcWarningM40');
            }
        }
        function clearSBCWarning() {
            hideElement('info_sbcWarningM40');
        }

        function actualizarSBCMaximoM40() {
            const inicioP1Str = document.getElementById('info_m40_p1_inicio').value;
            const sbcM40Input = document.getElementById('info_m40_p1_sbc');
            if (inicioP1Str) {
                const [anioInicioP1, mesInicioP1] = inicioP1Str.split('-').map(Number);
                const umaP1 = getUMA(anioInicioP1, mesInicioP1);
                const sbcMaxP1 = umaP1 * 25;
                sbcM40Input.value = formatNumber(sbcMaxP1, 2).replace(/,/g, '');
                sbcM40Input.setAttribute('data-max-sbc', sbcMaxP1);
            } else {
                sbcM40Input.value = '';
                sbcM40Input.removeAttribute('data-max-sbc');
            }
        }
        
        function actualizarFechaFinM40Display() {
            const fechaInicioStr = document.getElementById('info_m40_p1_inicio').value;
            const numMesesStr = document.getElementById('info_m40_p1_meses').value;
            const displayEl = document.getElementById('info_m40_fecha_fin_display');
            const warningEl = document.getElementById('info_m40_fecha_fin_warning');
            const calcularBtn = document.getElementById('btnCalcularEscenarioM40');

            displayEl.textContent = '';
            warningEl.textContent = '';
            calcularBtn.disabled = false;
            clearError('M40');

            if (fechaInicioStr && numMesesStr) {
                const numMeses = parseInt(numMesesStr);
                if (numMeses > 0) {
                    const fechaFinStr = calcularFechaFinDesdeMeses(fechaInicioStr, numMeses);
                    if (fechaFinStr) {
                        const [finAnio, finMes] = fechaFinStr.split('-').map(Number);
                        const mesesNombres = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                        displayEl.textContent = `Se pagaría hasta: ${mesesNombres[finMes - 1]} ${finAnio}`;

                        const hoy = new Date();
                        const primerDiaMesActual = new Date(Date.UTC(hoy.getUTCFullYear(), hoy.getUTCMonth(), 1));
                        const ultimoDiaMesFinM40 = new Date(Date.UTC(finAnio, finMes -1, getDiasEnMes(finAnio, finMes)));
                        
                        if (ultimoDiaMesFinM40 < primerDiaMesActual) {
                            warningEl.textContent = "La fecha de fin de M40 no puede ser anterior al mes actual.";
                            calcularBtn.disabled = true;
                            showError('M40', "La fecha de fin de M40 es inválida. Ajuste la fecha de inicio o el número de meses.");
                        }
                    }
                }
            }
        }

        function toggleCostoAdicional(tipoCosto, buttonElement) {
            costosAdicionalesActivos[tipoCosto] = !costosAdicionalesActivos[tipoCosto];
            buttonElement.classList.toggle('active');
            totalizadorCostosAdicionalesBotones = Object.keys(costosAdicionalesActivos).reduce((total, key) => {
                return total + (costosAdicionalesActivos[key] ? valoresCostosAdicionales[key] : 0);
            }, 0);
            document.getElementById('info_totalAdicionalBotones').textContent = '$' + formatNumber(totalizadorCostosAdicionalesBotones);
            recalcularCoberturaTrasCambio();
        }

        function toggleModoPrecision() {
            const modoPrecisionToggle = document.getElementById('info_modoPrecisionContrato');
            const usarSBCDetalladoCheckbox = document.getElementById('info_usarSBCDetallado');
            const sbcPromedioInput = document.getElementById('info_sbcPromedio');

            if (modoPrecisionToggle.checked) {
                usarSBCDetalladoCheckbox.checked = true;
                usarSBCDetalladoCheckbox.disabled = true;
                showElement('info_mensajeModoPrecision');
                sbcPromedioInput.placeholder = "Se calculará detalladamente";
                toggleSBCDetalladoSeccion();
            } else {
                usarSBCDetalladoCheckbox.disabled = false;
                hideElement('info_mensajeModoPrecision');
                sbcPromedioInput.placeholder = "Ingresa o calcula detalladamente";
                if (!usarSBCDetalladoCheckbox.checked) {
                     sbcPromedioInput.readOnly = false;
                }
            }
        }

        function toggleSBCDetalladoSeccion() {
            const checkbox = document.getElementById('info_usarSBCDetallado');
            const sbcPromedioInput = document.getElementById('info_sbcPromedio');
            const tbody = document.getElementById('info_tablaHistorialLaboralBody'); 
            if (checkbox.checked) {
                showElement('info_seccionSBCDetallado');
                sbcPromedioInput.readOnly = true;
                sbcPromedioInput.value = document.getElementById('info_histSBCDetalladoCalculado').textContent.replace(/[^0-9.]/g, '') || '';
                 if (sbcPromedioInput.value === '' || sbcPromedioInput.value === '0.00') {
                     sbcPromedioInput.placeholder = "Calcular detalladamente abajo";
                 }
                datosClienteInfo.sbcDetalladoUsado = true;
                 if (tbody.querySelectorAll('tr').length === 0) { 
                    agregarMovimientoHistorialInfografia();
                 }
            } else {
                hideElement('info_seccionSBCDetallado');
                sbcPromedioInput.readOnly = false;
                sbcPromedioInput.placeholder = "Ingresa o calcula detalladamente";
                datosClienteInfo.sbcDetalladoUsado = false;
            }
        }

        function agregarMovimientoHistorialInfografia() {
            const tbody = document.getElementById('info_tablaHistorialLaboralBody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td class="px-4 py-2"><input type="date" name="hist_fechaMov" class="w-full p-2 border rounded"></td>
                <td class="px-4 py-2">
                    <select name="hist_tipoMov" class="w-full p-2 border rounded">
                        <option value="ALTA">ALTA</option>
                        <option value="MODIFICACION">MODIFICACION</option>
                        <option value="BAJA">BAJA</option>
                    </select>
                </td>
                <td class="px-4 py-2"><input type="text" name="hist_patron" placeholder="Patrón" class="w-full p-2 border rounded"></td>
                <td class="px-4 py-2"><input type="number" name="hist_sbc" placeholder="0.00" step="0.01" class="w-full p-2 border rounded"></td>
                <td class="px-4 py-2"><button type="button" class="btn-danger-small" onclick="eliminarMovimientoHistorialInfografia(this)"><i class="fas fa-trash-alt"></i></button></td>
            `;
        }
        function eliminarMovimientoHistorialInfografia(button) {
            button.closest('tr').remove();
        }

        function calcularYUsarSBCDetalladoInfografia() {
            clearError('Base'); 
            const tbody = document.getElementById('info_tablaHistorialLaboralBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            if (rows.length === 0) {
                showError('Base', "Agregue al menos un movimiento para calcular el SBC detallado.");
                return;
            }

            let movimientos = rows.map(row => ({
                fecha: row.querySelector('input[name="hist_fechaMov"]').value,
                tipo: row.querySelector('select[name="hist_tipoMov"]').value,
                patron: row.querySelector('input[name="hist_patron"]').value,
                sbc: parseFloat(row.querySelector('input[name="hist_sbc"]').value) || 0,
                rowElement: row 
            }));

            for (const mov of movimientos) {
                if (!mov.fecha || !mov.tipo || !mov.patron || mov.sbc <= 0) {
                    showError('Base', `Fila inválida en historial: Verifique Fecha, Tipo, Patrón y SBC (>0). Patrón: ${mov.patron || 'N/A'}`);
                    return;
                }
            }
            
            movimientos.sort((a, b) => {
                const dateA = new Date(a.fecha + "T00:00:00Z");
                const dateB = new Date(b.fecha + "T00:00:00Z");
                if (dateA - dateB !== 0) return dateA - dateB;
                const typeOrder = { 'ALTA': 1, 'MODIFICACION': 2, 'BAJA': 3 };
                return (typeOrder[a.tipo] || 99) - (typeOrder[b.tipo] || 99);
            });

            let segmentosSBC = [];
            let fechaInicioSegmentoActual = null;
            let sbcSegmentoActual = 0;
            const todayForCalc = new Date(); todayForCalc.setUTCHours(0,0,0,0);

            for (let i = 0; i < movimientos.length; i++) {
                const mov = movimientos[i];
                const fechaMovimiento = new Date(mov.fecha + "T00:00:00Z");

                if (mov.tipo === 'ALTA' || mov.tipo === 'MODIFICACION') {
                    if (fechaInicioSegmentoActual && sbcSegmentoActual > 0) {
                        const fechaFinPrevSegmento = new Date(fechaMovimiento);
                        fechaFinPrevSegmento.setUTCDate(fechaFinPrevSegmento.getUTCDate() -1);
                        if (fechaFinPrevSegmento >= fechaInicioSegmentoActual) {
                            const dias = (fechaFinPrevSegmento - fechaInicioSegmentoActual) / (1000 * 60 * 60 * 24) + 1;
                            segmentosSBC.push({ sbc: sbcSegmentoActual, dias: dias, fechaInicio: new Date(fechaInicioSegmentoActual), fechaFin: new Date(fechaFinPrevSegmento) });
                        }
                    }
                    fechaInicioSegmentoActual = fechaMovimiento;
                    sbcSegmentoActual = mov.sbc;
                } else if (mov.tipo === 'BAJA') {
                    if (fechaInicioSegmentoActual && sbcSegmentoActual > 0 && fechaMovimiento >= fechaInicioSegmentoActual) {
                        const dias = (fechaMovimiento - fechaInicioSegmentoActual) / (1000 * 60 * 60 * 24) + 1; 
                        segmentosSBC.push({ sbc: sbcSegmentoActual, dias: dias, fechaInicio: new Date(fechaInicioSegmentoActual), fechaFin: new Date(fechaMovimiento) });
                    }
                    fechaInicioSegmentoActual = null;
                    sbcSegmentoActual = 0;
                }

                if (i === movimientos.length - 1 && (mov.tipo === 'ALTA' || mov.tipo === 'MODIFICACION') && fechaInicioSegmentoActual) {
                    if (todayForCalc >= fechaInicioSegmentoActual) {
                        const dias = (todayForCalc - fechaInicioSegmentoActual) / (1000 * 60 * 60 * 24) + 1;
                        segmentosSBC.push({ sbc: sbcSegmentoActual, dias: dias, fechaInicio: new Date(fechaInicioSegmentoActual), fechaFin: new Date(todayForCalc) });
                    }
                }
            }
            
            if (segmentosSBC.length === 0 && movimientos.length > 0) {
                 showError('Base', "No se pudieron determinar periodos de cotización válidos. Asegúrese de tener movimientos de ALTA y BAJA (o MODIFICACION seguida de BAJA), o un ALTA/MODIFICACION como último movimiento.");
                 return;
            }
            
            segmentosSBC.sort((a,b) => b.fechaFin - a.fechaFin); 

            let totalDiasConsiderados = 0;
            let sumaPonderadaSBC = 0;
            
            for (const seg of segmentosSBC) {
                if (totalDiasConsiderados >= DIAS_PROMEDIO_PENSION) break;
                let diasASumarDeSegmento = seg.dias;
                if (totalDiasConsiderados + diasASumarDeSegmento > DIAS_PROMEDIO_PENSION) {
                    diasASumarDeSegmento = DIAS_PROMEDIO_PENSION - totalDiasConsiderados;
                }
                sumaPonderadaSBC += seg.sbc * diasASumarDeSegmento;
                totalDiasConsiderados += diasASumarDeSegmento;
            }

            if (totalDiasConsiderados === 0) {
                showError('Base', "No se calcularon días para el promedio de SBC detallado. Verifique los movimientos y sus fechas.");
                document.getElementById('info_histTotalDiasConsiderados').textContent = '0';
                document.getElementById('info_histSBCDetalladoCalculado').textContent = '$0.00';
                return;
            }

            const sbcPromedioDetallado = sumaPonderadaSBC / totalDiasConsiderados;
            datosClienteInfo.sbcPromedioBase = sbcPromedioDetallado; 
            document.getElementById('info_sbcPromedio').value = formatNumber(sbcPromedioDetallado, 2).replace(/,/g,'');
            document.getElementById('info_histTotalDiasConsiderados').textContent = formatNumber(totalDiasConsiderados,0);
            document.getElementById('info_histSBCDetalladoCalculado').textContent = '$' + formatNumber(sbcPromedioDetallado);
            datosClienteInfo.sbcDetalladoUsado = true;
        }
        
        function calcularPensionBaseInfografia() {
            clearError('Base');
            datosClienteInfo.nombre = document.getElementById('info_nombreCompleto').value;
            datosClienteInfo.semanasCotizadasBase = getNumeroInfo('info_semanasCotizadas');
            datosClienteInfo.edadBase = getNumeroInfo('info_edadCliente');

            if (document.getElementById('info_usarSBCDetallado').checked) {
                if (datosClienteInfo.sbcPromedioBase === 0 || document.getElementById('info_histSBCDetalladoCalculado').textContent === '$0.00') {
                    calcularYUsarSBCDetalladoInfografia(); 
                    if (datosClienteInfo.sbcPromedioBase === 0) {
                        showError('Base', "Por favor, calcule el SBC Detallado o ingrese un SBC Promedio Base manual (desmarcando la opción detallada).");
                        return;
                    }
                }
            } else {
                datosClienteInfo.sbcPromedioBase = getNumeroInfo('info_sbcPromedio');
                datosClienteInfo.sbcDetalladoUsado = false;
            }

            if (!datosClienteInfo.nombre || datosClienteInfo.semanasCotizadasBase < 500 || datosClienteInfo.edadBase < 60 || datosClienteInfo.sbcPromedioBase <= 0) {
                showError('Base', "Verifica los datos: Nombre, Semanas (mín. 500), Edad (mín. 60) y SBC Promedio Base (> 0) son obligatorios.");
                hideElement('info_resultadosPensionBase'); hideElement('infoSection2'); hideElement('infoSection3'); hideElement('infoSection4'); hideElement('infoSection5');
                return;
            }
            
            pensionBaseResultadosInfo = _calcularPensionDetallado(datosClienteInfo.sbcPromedioBase, datosClienteInfo.semanasCotizadasBase, datosClienteInfo.edadBase, SMGV_DF_Global, FACTOR_FOX_Global, tablaCuantiasGlobal);
            
            document.getElementById('info_resPensionMensual').textContent = formatNumber(pensionBaseResultadosInfo.PENSION_MENSUAL_ESTIMADA);
            document.getElementById('info_resAguinaldo').textContent = formatNumber(pensionBaseResultadosInfo.AGUINALDO_ESTIMADO);
            document.getElementById('info_sbcBaseUsadoDisplay').textContent = '$' + formatNumber(datosClienteInfo.sbcPromedioBase) + (datosClienteInfo.sbcDetalladoUsado ? ' (Detallado)' : ' (Manual)');
            showElement('info_resultadosPensionBase');
            showElement('infoSection2'); 
            document.getElementById('info_compPensionBase').textContent = '$' + formatNumber(pensionBaseResultadosInfo.PENSION_MENSUAL_ESTIMADA);
            
            hideElement('info_resultadosEscenarioM40'); hideElement('infoSection3'); hideElement('infoSection4'); hideElement('infoSection5');
            m40ResultadosInfo = { pensionMensualInicial: 0, aguinaldo: 0, costoTotalP1: 0, sbcPromedioParaCalculoPensionM40: 0, sbcM40Ingresado: 0, nuevasSemanas: 0, nuevaEdad: 0 };
            datosCompletosParaPDFInfo = {};
            desgloseDetalladoMensualM40Global = [];
            hideElement('info_btnDescargarActRec');
            actualizarFechaFinM40Display(); 
        }

        function recalcularCoberturaTrasCambio() {
            if (document.getElementById('info_resultadosEscenarioM40').style.display !== 'none') {
                 if (m40ResultadosInfo.pensionMensualInicial > 0 || m40ResultadosInfo.costoTotalP1 > 0) {
                     calcularAFOREProyectadaInfografia(); 
                 }
            }
        }

        function calcularAFOREProyectadaInfografia() {
            const aforeActual = getNumeroInfo('info_aforeActual');
            const tasaAnual = getNumeroInfo('info_tasaAfore') / 100;
            const mesesInversion = getNumeroInfo('info_mesesInversionAfore');
            aforeProyectadaGlobalInfo = aforeActual;
            if (tasaAnual > 0 && mesesInversion > 0 && aforeActual > 0) {
                aforeProyectadaGlobalInfo = aforeActual * Math.pow(1 + tasaAnual, mesesInversion / 12);
            }
            document.getElementById('info_coberturaAfore').textContent = '$' + formatNumber(aforeProyectadaGlobalInfo);
            
             if (document.getElementById('info_resultadosEscenarioM40').style.display !== 'none' && 
                 (m40ResultadosInfo.pensionMensualInicial > 0 || m40ResultadosInfo.costoTotalP1 > 0)) {
                calcularCoberturaInfografia();
            }
        }

        function calcularEscenarioM40Infografia() {
            clearError('M40'); clearSBCWarning();
            if (pensionBaseResultadosInfo.PENSION_MENSUAL_ESTIMADA === 0 && datosClienteInfo.sbcPromedioBase === 0) {
                 showError('M40', "Primero calcula tu Pensión Base en el Paso 1.");
                 return;
            }
             if (document.getElementById('info_modoPrecisionContrato').checked && !datosClienteInfo.sbcDetalladoUsado) {
                showError('M40', "En Modo Precisión, debe calcular primero el SBC Detallado en el Paso 1.");
                return;
            }

            const curp = document.getElementById('info_curpCliente').value;
            if (curp.length !== 18) { showError('M40', "El CURP debe tener 18 caracteres."); return; }
            const fechaNacimiento = extraerFechaNacimientoCURP(curp);
            if (!fechaNacimiento) { showError('M40', "CURP inválido o formato de fecha no reconocido."); return; }

            const inicioP1Str = document.getElementById('info_m40_p1_inicio').value;
            const numMesesP1 = parseInt(document.getElementById('info_m40_p1_meses').value) || 0;
            
            const fechaFinM40Str = calcularFechaFinDesdeMeses(inicioP1Str, numMesesP1);
            if (fechaFinM40Str && inicioP1Str && numMesesP1 > 0) {
                const [finAnioVal, finMesVal] = fechaFinM40Str.split('-').map(Number);
                const hoyVal = new Date();
                const primerDiaMesActualVal = new Date(Date.UTC(hoyVal.getUTCFullYear(), hoyVal.getUTCMonth(), 1));
                const ultimoDiaMesFinM40Val = new Date(Date.UTC(finAnioVal, finMesVal - 1, getDiasEnMes(finAnioVal, finMesVal)));

                if (ultimoDiaMesFinM40Val < primerDiaMesActualVal) {
                    showError('M40', "La fecha de fin de M40 no puede ser anterior al mes actual. Ajuste la fecha de inicio o el número de meses.");
                    document.getElementById('btnCalcularEscenarioM40').disabled = true;
                    return;
                }
            } else if (!inicioP1Str || numMesesP1 <=0) {
                 showError('M40', "Define el periodo M40: Fecha de Inicio y Meses son obligatorios.");
                 return;
            }

            const sbcM40Ingresado = parseFloat(document.getElementById('info_m40_p1_sbc').value.replace(/,/g, '')) || 0;
            m40ResultadosInfo.sbcM40Ingresado = sbcM40Ingresado;

            if (!inicioP1Str || numMesesP1 <= 0 || sbcM40Ingresado <= 0) {
                showError('M40', "Define el periodo M40: Fecha de Inicio, Meses son obligatorios y SBC M40 debe ser > 0 (se calcula al seleccionar fecha).");
                hideElement('info_resultadosEscenarioM40'); hideElement('infoSection3'); hideElement('infoSection4'); hideElement('infoSection5');
                hideElement('info_btnDescargarActRec');
                return;
            }
            if (numMesesP1 > 60) { showError('M40', "El número de meses en M40 no puede exceder 60."); return; }

            const [anioInicioP1Val, mesInicioP1Val] = inicioP1Str.split('-').map(Number);
            const umaP1Val = getUMA(anioInicioP1Val, mesInicioP1Val);
            const sbcMaxP1Teorico = umaP1Val * 25;
            if (sbcM40Ingresado > (sbcMaxP1Teorico + 0.01) && sbcMaxP1Teorico > 0) { 
                showSBCWarning(`El SBC M40 de $${formatNumber(sbcM40Ingresado)} parece exceder el tope de $${formatNumber(sbcMaxP1Teorico)} para ${anioInicioP1Val}. Verifica la fecha de inicio o el SBC ingresado.`);
            }

            const finP1Str = calcularFechaFinDesdeMeses(inicioP1Str, numMesesP1); 
            if (!finP1Str) { showError('M40', "Error calculando fecha fin de M40."); return; }
            const [aF, mF] = finP1Str.split('-').map(Number);
            const fechaFinM40RealObj = new Date(Date.UTC(aF, mF - 1, getDiasEnMes(aF, mF))); 
            
            const edadFinM40 = calcularEdadExacta(fechaNacimiento, fechaFinM40RealObj);
            let edadParaPorcentajeM40 = edadFinM40.anos;
            if (edadFinM40.meses > 6 || (edadFinM40.meses === 6 && edadFinM40.dias >= 1)) {
                edadParaPorcentajeM40++;
            }
            
            const diasEnM40 = numMesesP1 * (365.25 / 12); 
            const diasBasePrevios = Math.max(0, DIAS_PROMEDIO_PENSION - diasEnM40); 
            let sbcPromedioCalculadoParaPensionM40;

            if (diasBasePrevios > 0) {
                sbcPromedioCalculadoParaPensionM40 = ((sbcM40Ingresado * diasEnM40) + (datosClienteInfo.sbcPromedioBase * diasBasePrevios)) / DIAS_PROMEDIO_PENSION;
            } else { 
                sbcPromedioCalculadoParaPensionM40 = sbcM40Ingresado; 
            }
            m40ResultadosInfo.sbcPromedioParaCalculoPensionM40 = sbcPromedioCalculadoParaPensionM40;
            
            m40ResultadosInfo.nuevasSemanas = Math.round((datosClienteInfo.semanasCotizadasBase || 0) + (numMesesP1 * (52/12)));
            m40ResultadosInfo.nuevaEdad = edadParaPorcentajeM40;

            const pensionConM40 = _calcularPensionDetallado(m40ResultadosInfo.sbcPromedioParaCalculoPensionM40, m40ResultadosInfo.nuevasSemanas, m40ResultadosInfo.nuevaEdad, SMGV_DF_Global, FACTOR_FOX_Global, tablaCuantiasGlobal);
            m40ResultadosInfo.pensionMensualInicial = pensionConM40.PENSION_MENSUAL_ESTIMADA; 
            m40ResultadosInfo.aguinaldo = pensionConM40.AGUINALDO_ESTIMADO;

            let costoTotalM40P1 = 0;
            desgloseDetalladoMensualM40Global = []; 
            const fechaSimulacionPagosM40 = new Date(Date.UTC(aF, mF-1, getDiasEnMes(aF,mF))); 
            const mesActualizacionRecargosP1 = new Date(Date.UTC(fechaSimulacionPagosM40.getUTCFullYear(), fechaSimulacionPagosM40.getUTCMonth(), 1));
            mesActualizacionRecargosP1.setUTCDate(0); 
            const inpcNumeradorP1 = calcularINPCProyectado(mesActualizacionRecargosP1.getUTCFullYear(), mesActualizacionRecargosP1.getUTCMonth()+1, mesActualizacionRecargosP1.getUTCFullYear());

            for (let m = 0; m < numMesesP1; m++) {
                const fechaCuotaActual = new Date(Date.UTC(anioInicioP1Val, mesInicioP1Val - 1 + m, 1));
                const anioCuota = fechaCuotaActual.getUTCFullYear(); const mesCuota = fechaCuotaActual.getUTCMonth() + 1;
                const sbcDiarioCuota = sbcM40Ingresado; const diasMesCuota = getDiasEnMes(anioCuota, mesCuota);
                const tasaM40Anual = getTasaM40Porcentaje(anioCuota); const costoBaseMensual = sbcDiarioCuota * tasaM40Anual * diasMesCuota;
                let montoActualizacion = 0; let montoRecargos = 0; let pagoBaseActualizado = costoBaseMensual;
                
                const inpcDenominadorCuota = calcularINPCProyectado(mesCuota, anioCuota);
                let factorActualizacion = 1;
                if (inpcDenominadorCuota > 0 && inpcNumeradorP1 > inpcDenominadorCuota) {
                    factorActualizacion = (inpcNumeradorP1 / inpcDenominadorCuota);
                    montoActualizacion = costoBaseMensual * (factorActualizacion - 1);
                }
                pagoBaseActualizado = costoBaseMensual + montoActualizacion;
                
                const fechaVencimientoPagoCuota = new Date(Date.UTC(anioCuota, mesCuota, 17)); 
                let numMesesRetraso = 0;
                if (fechaSimulacionPagosM40 > fechaVencimientoPagoCuota) {
                    numMesesRetraso = (fechaSimulacionPagosM40.getUTCFullYear() - fechaVencimientoPagoCuota.getUTCFullYear()) * 12 + (fechaSimulacionPagosM40.getUTCMonth() - fechaVencimientoPagoCuota.getUTCMonth());
                     if (fechaSimulacionPagosM40.getUTCDate() <= fechaVencimientoPagoCuota.getUTCDate() && numMesesRetraso > 0) {
                         numMesesRetraso--; 
                     }
                    numMesesRetraso = Math.max(0, numMesesRetraso);
                }
                const tasaRecargoMensual = 0.0147; 
                montoRecargos = pagoBaseActualizado * tasaRecargoMensual * numMesesRetraso;
                const costoTotalMes = pagoBaseActualizado + montoRecargos;
                costoTotalM40P1 += costoTotalMes;
                desgloseDetalladoMensualM40Global.push({
                    mesCuotaStr: `${anioCuota}-${String(mesCuota).padStart(2,'0')}`, sbcDiario: sbcDiarioCuota, diasMes: diasMesCuota, tasaM40: tasaM40Anual,
                    costoBase: costoBaseMensual, inpcDen: inpcDenominadorCuota, inpcNum: inpcNumeradorP1, factorAct: factorActualizacion > 1 ? factorActualizacion : 0, montoAct: montoActualizacion,
                    costoBaseMasAct: pagoBaseActualizado, mesesRet: numMesesRetraso, tasaRec: tasaRecargoMensual, montoRec: montoRecargos, costoTotalMes: costoTotalMes
                });
            }
            m40ResultadosInfo.costoTotalP1 = costoTotalM40P1;

            costosAdicionalesActivos = { ro_retro: false, qp: false, correccion: false };
            totalizadorCostosAdicionalesBotones = 0;
            document.getElementById('info_totalAdicionalBotones').textContent = '$' + formatNumber(totalizadorCostosAdicionalesBotones);
            document.getElementById('btn_ro_retro').classList.remove('active');
            document.getElementById('btn_qp').classList.remove('active');
            document.getElementById('btn_correccion').classList.remove('active');

            document.getElementById('info_compPensionM40').textContent = '$' + formatNumber(m40ResultadosInfo.pensionMensualInicial);
            const incrementoNeto = m40ResultadosInfo.pensionMensualInicial - (pensionBaseResultadosInfo.PENSION_MENSUAL_ESTIMADA || 0);
            document.getElementById('info_compIncrementoNetoM40').textContent = '$' + formatNumber(incrementoNeto);
            document.getElementById('info_compIncrementoNetoM40').className = incrementoNeto >= 0 ? 'highlight-green' : 'highlight-red';
            
            document.getElementById('info_nuevoSBCPromedioM40').textContent = formatNumber(m40ResultadosInfo.sbcPromedioParaCalculoPensionM40);
            document.getElementById('info_nuevasSemanasM40').textContent = formatNumber(m40ResultadosInfo.nuevasSemanas, 0);
            document.getElementById('info_nuevaEdadM40').textContent = m40ResultadosInfo.nuevaEdad;
            document.getElementById('info_costoTotalM40Simulacion').textContent = '$' + formatNumber(m40ResultadosInfo.costoTotalP1);
            
            if(desgloseDetalladoMensualM40Global.length > 0) {
                showElement('info_btnDescargarActRec', 'inline-block');
            } else {
                hideElement('info_btnDescargarActRec');
            }

            showElement('info_resultadosEscenarioM40');
            showElement('infoSection3');
            calcularAFOREProyectadaInfografia(); 
        }

        function calcularCoberturaInfografia() {
            const costoM40P1 = m40ResultadosInfo.costoTotalP1 || 0;
            const pensionM40Inicial = m40ResultadosInfo.pensionMensualInicial || 0; 
            
            const comisionExcedente = getNumeroInfo('info_comisionExcedente'); 
            const costoFijoAdicional = 140000; 
            const comision = costoM40P1 * 0.16;
            const factorMultiplicador = costoM40P1 * 0.5; 
            const costoTotalContrato = costoM40P1 + factorMultiplicador + costoFijoAdicional + comision + comisionExcedente + totalizadorCostosAdicionalesBotones; 
            document.getElementById('info_costoTotalContratoBruto').textContent = '$' + formatNumber(costoTotalContrato);

            const aforeProy = aforeProyectadaGlobalInfo;
            
            let mesesPrimerDepositoInput = parseInt(document.getElementById('info_mesesPrimerDeposito').value) || 6;
            if (mesesPrimerDepositoInput < 6) mesesPrimerDepositoInput = 6;
            if (mesesPrimerDepositoInput > 10) mesesPrimerDepositoInput = 10;
            document.getElementById('info_mesesPrimerDeposito').value = mesesPrimerDepositoInput; 
            document.getElementById('display_mesesPrimerDeposito').textContent = mesesPrimerDepositoInput;

            const primerDeposito = pensionM40Inicial * mesesPrimerDepositoInput; 
            document.getElementById('info_coberturaPrimerDeposito').textContent = '$' + formatNumber(primerDeposito);

            const numMesesP1 = parseInt(document.getElementById('info_m40_p1_meses').value) || 0;
            const sbcM40Ingresado = m40ResultadosInfo.sbcM40Ingresado || 0;
            let diasP1Total = 0;
            if(numMesesP1 > 0){
                diasP1Total = numMesesP1 * (365.25 / 12);
            }
            const extraAfore = diasP1Total * sbcM40Ingresado * 0.02; // SAR 2%
            document.getElementById('info_coberturaExtraAfore').textContent = '$' + formatNumber(extraAfore);

            const subtotalCobertura = aforeProy + primerDeposito + extraAfore;
            document.getElementById('info_coberturaSubtotalSinPrestamo').textContent = '$' + formatNumber(subtotalCobertura);

            const deficit = costoTotalContrato - subtotalCobertura;
            let resultadoAnalisis = ""; let etiquetaSaldo = ""; let montoSaldo = 0;
            let prestamoRealUtilizado = 0; let descuentoMensualRealDelPrestamo = 0;
            let detalleUsoPrestamoMsg = "";
            
            const descuentoMaximoPermitidoPorLey = pensionM40Inicial * 0.30;
            let prestamoAlcanzableConDescMaxLey = 0;
            if (PRESTAMO_PUNTO_B_DESCUENTO - PRESTAMO_PUNTO_A_DESCUENTO !== 0) {
                const slopePrestamoPorDescuento = (PRESTAMO_PUNTO_B_MONTO - PRESTAMO_PUNTO_A_MONTO) / (PRESTAMO_PUNTO_B_DESCUENTO - PRESTAMO_PUNTO_A_DESCUENTO);
                prestamoAlcanzableConDescMaxLey = slopePrestamoPorDescuento * (descuentoMaximoPermitidoPorLey - PRESTAMO_PUNTO_A_DESCUENTO) + PRESTAMO_PUNTO_A_MONTO;
                prestamoAlcanzableConDescMaxLey = Math.max(0, prestamoAlcanzableConDescMaxLey);
            } else if (descuentoMaximoPermitidoPorLey >= PRESTAMO_PUNTO_A_DESCUENTO && PRESTAMO_PUNTO_A_MONTO > 0) {
                 prestamoAlcanzableConDescMaxLey = PRESTAMO_PUNTO_A_MONTO; 
            }

            if (deficit <= 0) { 
                hideElement('info_prestamoInfo');
                resultadoAnalisis = "¡EXCELENTE! El costo se cubre sin necesidad de préstamo.";
                etiquetaSaldo = "Saldo a Favor Estimado:";
                montoSaldo = Math.abs(deficit);
                document.getElementById('info_resultadoAnalisisCredito').className = 'text-green-800';
                document.getElementById('info_montoSaldoFinal').className = 'font-bold text-green-800';
                detalleUsoPrestamoMsg = "No se requirió préstamo.";
            } else { 
                showElement('info_prestamoInfo');
                const prestamoNecesarioOriginalmente = deficit;
                document.getElementById('info_deficitAntesPrestamo').textContent = '$' + formatNumber(prestamoNecesarioOriginalmente);
                document.getElementById('info_prestamoMaximoCapacidad').textContent = '$' + formatNumber(prestamoAlcanzableConDescMaxLey) + ` (con descuento mensual de $${formatNumber(descuentoMaximoPermitidoPorLey)})`;

                if (prestamoNecesarioOriginalmente <= prestamoAlcanzableConDescMaxLey) {
                    prestamoRealUtilizado = prestamoNecesarioOriginalmente;
                    if (PRESTAMO_PUNTO_B_MONTO - PRESTAMO_PUNTO_A_MONTO !== 0) {
                        const slopeDescuentoPorPrestamo = (PRESTAMO_PUNTO_B_DESCUENTO - PRESTAMO_PUNTO_A_DESCUENTO) / (PRESTAMO_PUNTO_B_MONTO - PRESTAMO_PUNTO_A_MONTO);
                        descuentoMensualRealDelPrestamo = slopeDescuentoPorPrestamo * (prestamoRealUtilizado - PRESTAMO_PUNTO_A_MONTO) + PRESTAMO_PUNTO_A_DESCUENTO;
                    } else if (prestamoRealUtilizado > 0) { 
                        descuentoMensualRealDelPrestamo = PRESTAMO_PUNTO_A_DESCUENTO;
                    }
                    descuentoMensualRealDelPrestamo = Math.max(0, descuentoMensualRealDelPrestamo);

                    resultadoAnalisis = "¡VIABLE! El costo se puede cubrir con un préstamo.";
                    etiquetaSaldo = "Préstamo Estimado Utilizado:";
                    montoSaldo = prestamoRealUtilizado;
                    document.getElementById('info_resultadoAnalisisCredito').className = 'text-yellow-700';
                    document.getElementById('info_montoSaldoFinal').className = 'font-bold text-yellow-700';
                    detalleUsoPrestamoMsg = `Se utilizó un préstamo de $${formatNumber(prestamoRealUtilizado)}. Esto implica un descuento mensual de $${formatNumber(descuentoMensualRealDelPrestamo)}, que está dentro del límite del 30% ($${formatNumber(descuentoMaximoPermitidoPorLey)}).`;
                } else { 
                    prestamoRealUtilizado = prestamoAlcanzableConDescMaxLey;
                    descuentoMensualRealDelPrestamo = descuentoMaximoPermitidoPorLey;
                    const deficitRestante = prestamoNecesarioOriginalmente - prestamoRealUtilizado;

                    if (deficitRestante < 0.01) { 
                         resultadoAnalisis = "¡VIABLE CON AJUSTE! El costo se cubre utilizando la capacidad máxima de préstamo del 30%.";
                         etiquetaSaldo = "Préstamo Utilizado (limitado al 30%):";
                         montoSaldo = prestamoRealUtilizado;
                         document.getElementById('info_resultadoAnalisisCredito').className = 'text-yellow-700';
                         document.getElementById('info_montoSaldoFinal').className = 'font-bold text-yellow-700';
                         detalleUsoPrestamoMsg = `El préstamo necesario de $${formatNumber(prestamoNecesarioOriginalmente)} excedía la capacidad. Se utilizó el préstamo máximo posible de $${formatNumber(prestamoRealUtilizado)} con un descuento mensual de $${formatNumber(descuentoMensualRealDelPrestamo)}.`;
                    } else {
                        resultadoAnalisis = "REQUIERE ANÁLISIS. Préstamo necesario ($" + formatNumber(prestamoNecesarioOriginalmente) + ") excede capacidad del 30% ($" + formatNumber(prestamoAlcanzableConDescMaxLey) + ").";
                        etiquetaSaldo = "Déficit restante tras aplicar préstamo máximo:";
                        montoSaldo = deficitRestante;
                        document.getElementById('info_resultadoAnalisisCredito').className = 'text-red-700';
                        document.getElementById('info_montoSaldoFinal').className = 'font-bold text-red-700';
                        detalleUsoPrestamoMsg = `El préstamo necesario de $${formatNumber(prestamoNecesarioOriginalmente)} excede la capacidad del 30%. Se aplicó el préstamo máximo de $${formatNumber(prestamoRealUtilizado)} (descuento $${formatNumber(descuentoMensualRealDelPrestamo)}). Aún existe un déficit de $${formatNumber(deficitRestante)}.`;
                    }
                }
                document.getElementById('info_prestamoNecesario').textContent = '$' + formatNumber(prestamoRealUtilizado);
                document.getElementById('info_descuentoMensualPrestamo').textContent = '$' + formatNumber(descuentoMensualRealDelPrestamo);
            }
            document.getElementById('info_detalleUsoPrestamo').textContent = detalleUsoPrestamoMsg;
            document.getElementById('info_resultadoAnalisisCredito').textContent = resultadoAnalisis;
            document.getElementById('info_etiquetaSaldoFinal').textContent = etiquetaSaldo;
            document.getElementById('info_montoSaldoFinal').textContent = '$' + formatNumber(montoSaldo);
            
            const incrementoNetoGlobalAnio1 = (m40ResultadosInfo.pensionMensualInicial || 0) - (pensionBaseResultadosInfo.PENSION_MENSUAL_ESTIMADA || 0);
            document.getElementById('info_ventajaIncrementoNeto').textContent = '$' + formatNumber(incrementoNetoGlobalAnio1);
            document.getElementById('info_ventajaIncrementoNeto').className = incrementoNetoGlobalAnio1 >= 0 ? 'highlight-green' : 'highlight-red';
            
            const valorInmuebleAnio1 = (m40ResultadosInfo.pensionMensualInicial || 0) / 0.004;
            document.getElementById('info_ventajaValorInmueble').textContent = '$' + formatNumber(valorInmuebleAnio1);
            
            const proyeccionContenedor = document.getElementById('info_proyeccionPensionNetaAnual');
            proyeccionContenedor.innerHTML = ''; 
            const tablaProyeccion = document.createElement('table');
            tablaProyeccion.className = 'w-full text-left border-collapse';
            let htmlProyeccion = `<thead><tr class="bg-purple-100"><th class="p-2 border">Año</th><th class="p-2 border">Pensión Bruta Mensual</th><th class="p-2 border">Descuento Préstamo</th><th class="p-2 border">Pensión Neta Mensual</th></tr></thead><tbody>`;
            
            let proyeccionAnualData = [];
            for (let i = 1; i <= 10; i++) { 
                const pensionBrutaEsteAnio = (m40ResultadosInfo.pensionMensualInicial || 0) * Math.pow(1 + averageAnnualINPCGrowth, i - 1);
                const descuentoEsteAnio = (i <= 5 && deficit > 0) ? descuentoMensualRealDelPrestamo : 0; 
                const pensionNetaEsteAnio = pensionBrutaEsteAnio - descuentoEsteAnio;
                proyeccionAnualData.push({ anio: i, pensionBruta: pensionBrutaEsteAnio, descuento: descuentoEsteAnio, pensionNeta: pensionNetaEsteAnio });
                htmlProyeccion += `<tr>
                    <td class="p-2 border">${i}</td>
                    <td class="p-2 border">$${formatNumber(pensionBrutaEsteAnio)}</td>
                    <td class="p-2 border">$${formatNumber(descuentoEsteAnio)}</td>
                    <td class="p-2 border font-semibold ${pensionNetaEsteAnio >= pensionBrutaEsteAnio ? 'text-green-700' : 'text-yellow-700'}">$${formatNumber(pensionNetaEsteAnio)}</td>
                </tr>`;
            }
            htmlProyeccion += `</tbody>`;
            tablaProyeccion.innerHTML = htmlProyeccion;
            proyeccionContenedor.appendChild(tablaProyeccion);
            document.getElementById('info_notaProyeccionInflacion').textContent = `(Descuento de préstamo aplicado durante los primeros 5 años. Pensión bruta incrementa con inflación estimada del ${formatNumber(averageAnnualINPCGrowth*100,1)}% anual).`;

            showElement('infoSection4'); 
            showElement('infoSection5');
            
             datosCompletosParaPDFInfo = {
                 cliente: datosClienteInfo, pensionBase: pensionBaseResultadosInfo,
                 curp: document.getElementById('info_curpCliente').value,
                 m40Periodo: {
                     inicio: document.getElementById('info_m40_p1_inicio').value,
                     meses: parseInt(document.getElementById('info_m40_p1_meses').value) || 0,
                     fin: calcularFechaFinDesdeMeses(document.getElementById('info_m40_p1_inicio').value, parseInt(document.getElementById('info_m40_p1_meses').value)),
                     sbcTope: m40ResultadosInfo.sbcM40Ingresado }, 
                 m40Resultados: {...m40ResultadosInfo}, 
                 cobertura: {
                     aforeProyectada: aforeProyectadaGlobalInfo, mesesPrimerDeposito: mesesPrimerDepositoInput, primerDeposito: primerDeposito, extraAfore: extraAfore,
                     subtotalSinPrestamo: subtotalCobertura, costoTotalContrato: costoTotalContrato, costoM40P1: costoM40P1, factorMultiplicador: factorMultiplicador,
                     sumaFijaAdicional: costoFijoAdicional, comision: comision, comisionExcedente: comisionExcedente, totalCostosAdicionalesBotones: totalizadorCostosAdicionalesBotones,
                     deficitAntesPrestamo: deficit > 0 ? deficit : 0, prestamoNecesarioOriginal: deficit > 0 ? (costoTotalContrato - subtotalCobertura) : 0,
                     prestamoMaximoAlcanzableCon30PorCiento: prestamoAlcanzableConDescMaxLey, descuentoMaximoPermitidoPorLey: descuentoMaximoPermitidoPorLey,
                     prestamoRealUtilizado: prestamoRealUtilizado, descuentoMensualPrestamoFijo: descuentoMensualRealDelPrestamo, detalleUsoPrestamo: detalleUsoPrestamoMsg, 
                     resultadoAnalisis: resultadoAnalisis, etiquetaSaldoFinal: etiquetaSaldo, montoSaldoFinal: montoSaldo },
                 ventajas: {
                     incrementoNetoGlobalAnio1: incrementoNetoGlobalAnio1, valorInmuebleEquivalenteAnio1: valorInmuebleAnio1, proyeccionAnualPensionNeta: proyeccionAnualData
                  }
             };
        }
        
        async function exportarPropuestaPDFInfografia() {
            const exportButton = document.getElementById('exportPdfButton');
            const originalButtonContent = exportButton.innerHTML;
            exportButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Generando...`;
            exportButton.disabled = true;

            await new Promise(resolve => setTimeout(resolve, 50));

            try {
                let d = datosCompletosParaPDFInfo;

                const isDataReady = d && d.m40Resultados && d.pensionBase && d.cliente && d.cobertura && d.ventajas && (d.m40Resultados.pensionMensualInicial > 0 || d.m40Resultados.costoTotalP1 > 0);

                if (!isDataReady) {
                    if (datosClienteInfo.sbcPromedioBase > 0 && document.getElementById('info_curpCliente').value && document.getElementById('info_m40_p1_inicio').value && document.getElementById('info_m40_p1_meses').value) {
                        calcularEscenarioM40Infografia();
                        await new Promise(resolve => setTimeout(resolve, 500));
                        d = datosCompletosParaPDFInfo;
                    }
                }
                
                const isDataStillNotReady = !d || !d.m40Resultados || !d.pensionBase || !d.cliente || !d.cobertura || !d.ventajas || !(d.m40Resultados.pensionMensualInicial > 0 || d.m40Resultados.costoTotalP1 > 0);

                if (isDataStillNotReady) {
                    showCustomAlert("No se han podido generar los datos para el PDF. Por favor, completa todos los campos de los Pasos 1 y 2 y presiona los botones de cálculo antes de exportar.");
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'pt', 'letter');
                
                generatePdfContent(pdf, d);

            } catch (e) {
                console.error("Error al generar el PDF:", e);
                showCustomAlert(`Ocurrió un error inesperado al generar el PDF. Por favor, avisa al administrador. Detalles del error: ${e.message}`);
            } finally {
                exportButton.innerHTML = originalButtonContent;
                exportButton.disabled = false;
            }
        }

        function generatePdfContent(pdf, d) { 
            const nombreCliente = d.cliente?.nombre || "Cliente";
            const fechaActual = new Date().toLocaleDateString('es-MX', { year: 'numeric', month: 'long', day: 'numeric' });
            const margin = 40; 
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            let yPos = 0;

            const rgcBlueDark = [13, 27, 42], rgcBlueMedium = [65, 90, 119], rgcBlueLight = [235, 240, 246];
            const gold = [212, 175, 55];
            const textDark = [13, 27, 42], textMedium = [65, 90, 119], textLight = [107, 114, 128];
            const accentGreen = [34, 197, 94], accentAmber = [245, 158, 11], accentRed = [239, 68, 68];
            const white = [255, 255, 255], grayBg = [243, 244, 246]; 

            const addPageHeader = (titleText) => {
                pdf.setFillColor(rgcBlueDark[0], rgcBlueDark[1], rgcBlueDark[2]);
                pdf.rect(0, 0, pageWidth, 70, 'F');
                pdf.setFont('helvetica', 'bold'); pdf.setFontSize(18); pdf.setTextColor(gold[0], gold[1], gold[2]);
                pdf.text("RGC Pensiones", margin, 35);
                pdf.setFontSize(10); pdf.setFont('helvetica', 'normal'); pdf.setTextColor(white[0], white[1], white[2]);
                pdf.text(fechaActual, pageWidth - margin, 35, { align: 'right' });
                yPos = 95; 
                pdf.setFontSize(14); pdf.setFont('helvetica', 'bold'); pdf.setTextColor(rgcBlueDark[0], rgcBlueDark[1], rgcBlueDark[2]);
                pdf.text(titleText, pageWidth / 2, yPos, { align: 'center' });
                yPos += 25;
            };
            
            const addPageFooter = (pageNumber, totalPages) => {
                pdf.setFontSize(8); pdf.setFont('helvetica', 'normal'); pdf.setTextColor(textLight[0], textLight[1], textLight[2]);
                pdf.text(`Página ${pageNumber} de ${totalPages}`, pageWidth / 2, pageHeight - margin + 15, { align: 'center' });
                pdf.text("RGC Pensiones - Transformando tu Futuro", margin, pageHeight - margin + 15);
                pdf.text("Consulta a tu asesor.", pageWidth - margin, pageHeight - margin + 15, { align: 'right' });
            };

            const addSectionTitle = (text, currentY) => {
                pdf.setFontSize(12); pdf.setFont('helvetica', 'bold'); pdf.setTextColor(rgcBlueMedium[0], rgcBlueMedium[1], rgcBlueMedium[2]);
                pdf.text(text, margin, currentY);
                currentY += 8;
                pdf.setDrawColor(gold[0], gold[1], gold[2]); pdf.setLineWidth(0.5);
                pdf.line(margin, currentY, pageWidth - margin, currentY);
                currentY += 18;
                return currentY;
            };

            const addDataRowStyled = (label, value, currentY, options = {}) => {
                const { labelColor = textMedium, valueColor = textDark, valueFontWeight = 'bold', valueFontSize = 9, labelFontSize = 9, valueAlign = 'right', labelFontWeight = 'normal' } = options;
                const rightAlignX = pageWidth - margin;

                pdf.setFontSize(labelFontSize);
                pdf.setFont('helvetica', labelFontWeight);
                pdf.setTextColor(labelColor[0], labelColor[1], labelColor[2]);
                pdf.text(label, margin + (options.indent || 0), currentY);

                pdf.setFontSize(valueFontSize);
                pdf.setFont('helvetica', valueFontWeight);
                pdf.setTextColor(valueColor[0], valueColor[1], valueColor[2]);
                
                if (valueAlign === 'right') {
                    pdf.text(String(value), rightAlignX, currentY, { align: 'right' });
                } else {
                    pdf.text(String(value), margin + 200, currentY, { align: 'left' });
                }
                
                return currentY + (options.lineHeight || 15);
            };
            const addParagraph = (text, currentY, options = {}) => {
                const { color = textMedium, fontSize = 9, fontStyle = 'normal', maxWidth = pageWidth - margin * 2, lineHeightFactor = 1.2 } = options;
                pdf.setFontSize(fontSize); pdf.setFont('helvetica', fontStyle); pdf.setTextColor(color[0], color[1], color[2]);
                const lines = pdf.splitTextToSize(text, maxWidth);
                pdf.text(lines, margin, currentY);
                return currentY + lines.length * fontSize * lineHeightFactor;
            };
            
            const addResultAnalysisBox = (currentY, dataCobertura) => {
                const resColor = dataCobertura?.resultadoAnalisis.includes("EXCELENTE") || dataCobertura?.resultadoAnalisis.includes("VIABLE") 
                                 ? accentGreen 
                                 : (dataCobertura?.resultadoAnalisis.includes("REQUIERE ANÁLISIS") ? accentAmber : accentRed);
                let yStartBox = currentY;
                let tempY = yStartBox;
                pdf.setFontSize(10); pdf.setFont('helvetica', 'bold');
                const resultadoLines = pdf.splitTextToSize(dataCobertura?.resultadoAnalisis || "---", pageWidth - margin*2 - 20);
                tempY += resultadoLines.length * 10 * 1.2 + 10;
                tempY += 5;
                pdf.setFontSize(9); pdf.setFont('helvetica', 'bold');
                tempY += 9 * 1.2;
                const boxHeight = (tempY - yStartBox) + 5;
                pdf.setFillColor(grayBg[0], grayBg[1], grayBg[2]);
                pdf.rect(margin - 10, yStartBox - 5, pageWidth - margin*2 + 20, boxHeight, 'F');
                tempY = yStartBox; 
                pdf.setFontSize(10); pdf.setFont('helvetica', 'bold'); pdf.setTextColor(resColor[0], resColor[1], resColor[2]);
                pdf.text(resultadoLines, margin, tempY + 10);
                tempY += resultadoLines.length * 10 * 1.2;
                tempY += 5;
                pdf.setFontSize(9); pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(resColor[0], resColor[1], resColor[2]);
                const etiquetaSaldoText = `${dataCobertura?.etiquetaSaldoFinal || "---"} $${formatNumber(dataCobertura?.montoSaldoFinal || 0)}`;
                pdf.text(etiquetaSaldoText, pageWidth / 2, tempY + 8, { align: 'center' });
                currentY = yStartBox + boxHeight + 5;
                pdf.setTextColor(textDark[0], textDark[1], textDark[2]);
                return currentY;
            };

            // PÁGINA 1: PROPUESTA DETALLADA PARA ASESOR
            addPageHeader("PROPUESTA DETALLADA PARA ASESOR");
            yPos = addDataRowStyled("Cliente:", nombreCliente, yPos, { valueFontWeight: 'bold', valueColor: textDark, valueAlign: 'left' });
            if(d.curp) yPos = addDataRowStyled("CURP:", d.curp, yPos, { valueAlign: 'left' });
            yPos = addDataRowStyled("SBC Base Utilizado:", `$${formatNumber(d.cliente?.sbcPromedioBase)} ${d.cliente?.sbcDetalladoUsado ? '(Detallado)' : '(Manual)'}`, yPos);
            yPos += 10;
            
            yPos = addSectionTitle("Resumen de Costos del Contrato", yPos);
            yPos = addDataRowStyled("Costo Base M40 (P1 c/Act+Rec):", `$${formatNumber(d.cobertura?.costoM40P1)}`, yPos);
            yPos = addDataRowStyled("Factor Multiplicador (0.5x s/P1):", `(+) $${formatNumber(d.cobertura?.factorMultiplicador)}`, yPos);
            yPos = addDataRowStyled("Suma Fija Adicional:", `(+) $${formatNumber(d.cobertura?.sumaFijaAdicional)}`, yPos);
            yPos = addDataRowStyled("Comisión (16% s/P1):", `(+) $${formatNumber(d.cobertura?.comision)}`, yPos);
            if ((d.cobertura?.totalCostosAdicionalesBotones || 0) > 0) yPos = addDataRowStyled("Costos Adicionales (Opcionales):", `(+) $${formatNumber(d.cobertura?.totalCostosAdicionalesBotones)}`, yPos);
            if ((d.cobertura?.comisionExcedente || 0) > 0) yPos = addDataRowStyled("Comisión por Excedente:", `(+) $${formatNumber(d.cobertura?.comisionExcedente)}`, yPos);
            yPos += 5;
            pdf.setDrawColor(textMedium[0], textMedium[1], textMedium[2]);
            pdf.line(pageWidth - margin - 120, yPos, pageWidth - margin, yPos);
            yPos += 5;
            yPos = addDataRowStyled("Costo Total del Contrato (Bruto):", `$${formatNumber(d.cobertura?.costoTotalContrato)}`, yPos, {valueColor: accentRed, valueFontSize: 10, labelFontWeight: 'bold'});
            
            if ((d.cobertura?.comisionExcedente || 0) > 0) {
                yPos += 5; 
                yPos = addParagraph("Nota sobre Comisión por Excedente: Al elegir este esquema, el comisionista acepta que su comisión por excedente no la recibirá a la firma del contrato, sino hasta que la cuenta del cliente sea liquidada...", yPos, { fontSize: 8, color: textLight, fontStyle: 'italic', maxWidth: pageWidth - margin * 2 - 10, lineHeightFactor: 1.3 });
            }
            yPos += 10;
            
            yPos = addSectionTitle("Fuentes de Cobertura Estimadas", yPos);
            yPos = addDataRowStyled("1. Saldo AFORE Proyectado:", `$${formatNumber(d.cobertura?.aforeProyectada)}`, yPos);
            yPos = addDataRowStyled(`2. Primer Depósito (${d.cobertura?.mesesPrimerDeposito} meses pensión M40):`, `(+) $${formatNumber(d.cobertura?.primerDeposito)}`, yPos);
            yPos = addDataRowStyled("3. Extra AFORE (Retiro M40 P1):", `(+) $${formatNumber(d.cobertura?.extraAfore)}`, yPos);
            yPos += 5;
            pdf.setDrawColor(textMedium[0], textMedium[1], textMedium[2]);
            pdf.line(pageWidth - margin - 120, yPos, pageWidth - margin, yPos);
            yPos += 5;
            yPos = addDataRowStyled("Subtotal Cobertura (sin préstamo):", `$${formatNumber(d.cobertura?.subtotalSinPrestamo)}`, yPos, {valueColor: accentGreen, valueFontSize: 10, labelFontWeight: 'bold'});
            
            yPos += 5;
            pdf.setDrawColor(textLight[0],textLight[1],textLight[2]); pdf.line(margin, yPos, pageWidth - margin, yPos); yPos += 15;

            if ((d.cobertura?.deficitAntesPrestamo || 0) > 0) {
                yPos = addDataRowStyled("Déficit antes de Préstamo:", `(-) $${formatNumber(d.cobertura?.deficitAntesPrestamo)}`, yPos, {valueColor: accentRed, valueFontSize: 10});
                yPos = addDataRowStyled("Capacidad Máx. Préstamo (30% Pensión M40):", `$${formatNumber(d.cobertura?.prestamoMaximoAlcanzableCon30PorCiento)}`, yPos, {valueColor: rgcBlueMedium});
                yPos = addDataRowStyled("   con Descuento Mensual Máx:", `$${formatNumber(d.cobertura?.descuentoMaximoPermitidoPorLey)}`, yPos-5, {labelColor: textLight, valueColor: rgcBlueMedium});
                yPos = addDataRowStyled("Préstamo Estimado Utilizado:", `$${formatNumber(d.cobertura?.prestamoRealUtilizado)}`, yPos, {valueColor: accentAmber});
                const porcDescReal = (d.m40Resultados?.pensionMensualInicial || 0) > 0 ? ((d.cobertura?.descuentoMensualPrestamoFijo || 0) / (d.m40Resultados?.pensionMensualInicial || 1)) * 100 : 0;
                yPos = addDataRowStyled("Descuento Mensual Préstamo Fijo:", `$${formatNumber(d.cobertura?.descuentoMensualPrestamoFijo)} (${formatNumber(porcDescReal,1)}% pensión M40)`, yPos, {valueColor: accentAmber});
                if (d.cobertura?.detalleUsoPrestamo) yPos = addParagraph(d.cobertura.detalleUsoPrestamo, yPos, {fontSize: 8, color: textLight, maxWidth: pageWidth - margin*2 - 20, lineHeightFactor: 1.3});
            }
            yPos += 5; 
            yPos = addResultAnalysisBox(yPos, d.cobertura);
            yPos += 5; 
            
            yPos = addSectionTitle("Datos Clave de Proyección M40", yPos);
            yPos = addDataRowStyled("Inicio M40:", d.m40Periodo?.inicio || "N/A", yPos, { valueAlign: 'left' });
            yPos = addDataRowStyled("Meses en M40:", `${d.m40Periodo?.meses || 0} meses`, yPos, { valueAlign: 'left' });
            yPos = addDataRowStyled("Fecha Fin M40 (Baja):", d.m40Periodo?.fin || "N/A", yPos, { valueAlign: 'left' });
            yPos = addDataRowStyled("SBC Diario M40 (Aplicado):", `$${formatNumber(d.m40Periodo?.sbcTope)}`, yPos);
            yPos = addDataRowStyled("SBC Promedio para Cálculo Pensión M40:", `$${formatNumber(d.m40Resultados?.sbcPromedioParaCalculoPensionM40)}`, yPos);
            yPos = addDataRowStyled("Nueva Edad para % Pensión:", `${d.m40Resultados?.nuevaEdad || 0} años`, yPos, { valueAlign: 'left' });
            yPos = addDataRowStyled("Nuevas Semanas Totales:", formatNumber(d.m40Resultados?.nuevasSemanas || 0, 0), yPos, { valueAlign: 'left' });
            yPos = addDataRowStyled("Pensión Mensual M40 Estimada (Inicial):", `$${formatNumber(d.m40Resultados?.pensionMensualInicial)}`, yPos, {valueColor: accentAmber, valueFontSize: 10});
            yPos = addDataRowStyled("Pensión Mensual Base Estimada:", `(-) $${formatNumber(d.pensionBase?.PENSION_MENSUAL_ESTIMADA)}`, yPos, {valueColor: rgcBlueMedium, valueFontSize: 10});
            const incColorAdv = (d.ventajas?.incrementoNetoGlobalAnio1 || 0) >= 0 ? accentGreen : accentRed;
            yPos += 5;
            pdf.setDrawColor(textMedium[0], textMedium[1], textMedium[2]);
            pdf.line(pageWidth - margin - 120, yPos, pageWidth - margin, yPos);
            yPos += 5;
            yPos = addDataRowStyled("Incremento Mensual Bruto (Año 1):", `$${formatNumber(d.ventajas?.incrementoNetoGlobalAnio1)}`, yPos, {valueColor: incColorAdv, valueFontSize: 11, labelFontWeight: 'bold'});
            addPageFooter(1, 2);

            // PÁGINA 2: PROPUESTA PARA CLIENTE
            pdf.addPage();
            addPageHeader(`TU FUTURO MEJORADO CON RGC PENSIONES`);
            yPos = addParagraph(`Estimado(a) ${nombreCliente}, esta es una proyección de cómo Modalidad 40 puede transformar tu pensión:`, yPos, {fontSize:10, color:textDark});
            yPos += 10;
            yPos = addSectionTitle("Tu Pensión: Antes y Después de Modalidad 40", yPos);
            pdf.setFillColor(rgcBlueLight[0], rgcBlueLight[1], rgcBlueLight[2]);
            pdf.rect(margin, yPos, pageWidth - margin*2, 75, 'F');
            yPos = addDataRowStyled("Pensión Mensual con Modalidad 40 (Año 1):", `$${formatNumber(d.m40Resultados?.pensionMensualInicial)}`, yPos + 10, {labelColor: textMedium, valueColor: accentAmber, valueFontSize: 14, indent:10});
            yPos = addDataRowStyled("Pensión Mensual Base (Actual Estimada):", `(-) $${formatNumber(d.pensionBase?.PENSION_MENSUAL_ESTIMADA)}`, yPos, {labelColor: textMedium, valueColor: rgcBlueMedium, valueFontSize: 14, indent:10});
            pdf.setFontSize(14); pdf.setFont('helvetica', 'bold');
            const incColorCli = (d.ventajas?.incrementoNetoGlobalAnio1 || 0) >= 0 ? accentGreen : accentRed;
            pdf.setTextColor(incColorCli[0], incColorCli[1], incColorCli[2]);
            pdf.text(`¡Incremento Mensual de $${formatNumber(d.ventajas?.incrementoNetoGlobalAnio1)}!`, pageWidth/2, yPos + 15, {align:'center'});
            yPos += 45;
            yPos = addSectionTitle("Inversión Estimada en tu Futuro", yPos);
            yPos = addDataRowStyled("Precio Total del Proyecto (aproximado):", `$${formatNumber(d.cobertura?.costoTotalContrato)}`, yPos, {valueColor: accentRed, valueFontSize: 12}); 
            yPos += 10;
            yPos = addSectionTitle("¿Cómo se Cubre esta Inversión?", yPos);
            const bullet = "\u2022"; 
            yPos = addDataRowStyled(`${bullet} Tu Saldo AFORE Proyectado:`, `$${formatNumber(d.cobertura?.aforeProyectada)}`, yPos, {valueColor: accentGreen, indent: 5});
            yPos = addDataRowStyled(`${bullet} Primeros ${d.cobertura?.mesesPrimerDeposito} Meses de tu Nueva Pensión M40:`, `(+) $${formatNumber(d.cobertura?.primerDeposito)}`, yPos, {valueColor: accentGreen, indent: 5});
            yPos = addDataRowStyled(`${bullet} Recuperación SAR/INFONAVIT (de pagos M40):`, `(+) $${formatNumber(d.cobertura?.extraAfore)}`, yPos, {valueColor: accentGreen, indent: 5});
            if ((d.cobertura?.prestamoRealUtilizado || 0) > 0) {
                yPos = addDataRowStyled(`${bullet} Préstamo (si es necesario):`, `(+) $${formatNumber(d.cobertura?.prestamoRealUtilizado)}`, yPos, {valueColor: accentAmber, indent: 5});
                yPos = addParagraph(`   (Este préstamo se pagaría con un descuento mensual fijo de aprox. $${formatNumber(d.cobertura?.descuentoMensualPrestamoFijo)} de tu pensión M40 durante 5 años)`, yPos -8, {fontSize: 8, color: textLight, indent: 25, maxWidth: pageWidth - margin*2 - 30});
            }
            yPos += 5;
            pdf.setDrawColor(textMedium[0], textMedium[1], textMedium[2]);
            pdf.line(pageWidth - margin - 120, yPos, pageWidth - margin, yPos);
            yPos += 5;
            yPos = addDataRowStyled("Cobertura Total Estimada:", `$${formatNumber( (d.cobertura?.subtotalSinPrestamo || 0) + (d.cobertura?.prestamoRealUtilizado || 0) )}`, yPos, {valueColor: accentGreen, valueFontSize: 11, labelFontWeight: 'bold'});
            yPos += 5; 
            yPos = addResultAnalysisBox(yPos, d.cobertura);
            yPos += 5;
            yPos = addSectionTitle("Proyección de tu Pensión Neta Anual con Modalidad 40", yPos);
            const proyeccionData = d.ventajas?.proyeccionAnualPensionNeta || [];
            if (proyeccionData.length > 0) {
                const tableHead = [['Año', 'Pensión Bruta Mensual Estimada', 'Descuento Préstamo (si aplica)', 'Pensión Neta Mensual Estimada']];
                const tableBody = proyeccionData.map(p => [ p.anio, `$${formatNumber(p.pensionBruta)}`, p.descuento > 0 ? `$${formatNumber(p.descuento)}` : '-', `$${formatNumber(p.pensionNeta)}` ]);
                pdf.autoTable({
                    head: tableHead, body: tableBody, startY: yPos, theme: 'grid',
                    headStyles: { fillColor: rgcBlueMedium, textColor: white, fontStyle: 'bold', fontSize: 9, cellPadding: 5 },
                    bodyStyles: { fontSize: 8, cellPadding: 4 }, alternateRowStyles: { fillColor: rgcBlueLight },
                    columnStyles: { 0: { halign: 'center', cellWidth: 40 }, 1: { halign: 'right' }, 2: { halign: 'right' }, 3: { halign: 'right', fontStyle: 'bold' } },
                    didParseCell: (data) => {
                        if (data.section === 'body' && data.column.index === 3) { 
                            const neta = proyeccionData[data.row.index].pensionNeta;
                            const bruta = proyeccionData[data.row.index].pensionBruta;
                            data.cell.styles.textColor = neta >= bruta ? accentGreen : accentAmber; 
                        }
                    }
                });
                yPos = pdf.lastAutoTable.finalY + 10;
            }
            yPos = addParagraph(`Nota: La pensión bruta mensual aumenta con la inflación anual estimada (${formatNumber(averageAnnualINPCGrowth*100,1)}%). El descuento del préstamo es fijo durante los primeros 5 años (si aplica).`, yPos, {fontSize: 8, color: textLight});
            yPos += 15;
            pdf.setFillColor(rgcBlueLight[0], rgcBlueLight[1], rgcBlueLight[2]);
            pdf.rect(margin, yPos, pageWidth - margin*2, 60, 'F');
            pdf.setFontSize(10); pdf.setFont('helvetica', 'bold'); pdf.setTextColor(rgcBlueDark[0], rgcBlueDark[1], rgcBlueDark[2]);
            pdf.text("Tu Pensión M40 (Año 1) Podría Equivaler a un Inmueble de:", pageWidth/2, yPos + 15, {align:'center'});
            pdf.setFontSize(16); pdf.setFont('helvetica', 'bold'); pdf.setTextColor(accentGreen[0], accentGreen[1], accentGreen[2]);
            pdf.text(`$${formatNumber(d.ventajas?.valorInmuebleEquivalenteAnio1)} MXN`, pageWidth/2, yPos + 35, {align:'center'});
            pdf.setFontSize(7); pdf.setFont('helvetica', 'normal'); pdf.setTextColor(textMedium[0], textMedium[1], textMedium[2]);
            pdf.text("(Generando rentas vitalicias, estimado con tasa de capitalización conservadora del 4.8% anual / 0.4% mensual).", pageWidth/2, yPos + 50, {align:'center'});
            addPageFooter(2, 2);
            
            pdf.save(`Propuesta_Pension_RGC_${nombreCliente.replace(/\s+/g, '_')}.pdf`);
        }

        function formatMesCuotaForDisplay(mCS) { 
            if (!mCS) return ''; 
            const [y,m]=mCS.split('-'); 
            const mN=["ENE","FEB","MAR","ABR","MAY","JUN","JUL","AGO","SEP","OCT","NOV","DIC"]; 
            return `${mN[parseInt(m)-1]}-${y.substring(2)}`; 
        }

        async function exportarActRecM40PDFInfografia() {
            const exportButton = document.getElementById('info_btnDescargarActRec');
            const originalButtonContent = exportButton.innerHTML;
            exportButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Generando...`;
            exportButton.disabled = true;
            await new Promise(resolve => setTimeout(resolve, 50));
            try {
                if (desgloseDetalladoMensualM40Global.length === 0) { 
                    showCustomAlert("No hay datos de desglose de Actualizaciones y Recargos para exportar. Calcula primero el Escenario M40."); 
                    return; 
                }
                const { jsPDF } = window.jspdf; 
                const pdf = new jsPDF('l', 'pt', 'letter'); 
                const nombreCliente = datosClienteInfo.nombre || "Cliente"; 
                const fechaActual = new Date().toLocaleDateString('es-MX', {year:'numeric',month:'long',day:'numeric'});
                pdf.setFontSize(14); pdf.setTextColor(0,51,102); 
                pdf.text(`Desglose de Costo Mensual Modalidad 40 (Periodo Principal) - ${nombreCliente}`, pdf.internal.pageSize.getWidth()/2, 40, {align:'center'});
                pdf.setFontSize(9); pdf.setTextColor(50,50,50); 
                pdf.text(`Fecha: ${fechaActual}`, pdf.internal.pageSize.getWidth()-40, 60, {align:'right'});
                
                const head = [['Mes Cuota','SBC Diario','Días','Tasa M40','Costo Base','INPC Den.','INPC Num.','Factor Act.','Monto Act.','Base+Act.','Meses Ret.','Tasa Rec.','Monto Rec.','Costo Total Mes']];
                const body = desgloseDetalladoMensualM40Global.map(r => [ 
                    formatMesCuotaForDisplay(r.mesCuotaStr), formatNumber(r.sbcDiario), r.diasMes, `${(r.tasaM40*100).toFixed(3)}%`, 
                    formatNumber(r.costoBase), formatNumber(r.inpcDen,3), formatNumber(r.inpcNum,3), formatNumber(r.factorAct,4), formatNumber(r.montoAct), formatNumber(r.costoBaseMasAct), 
                    r.mesesRet, `${(r.tasaRec*100).toFixed(2)}%`, formatNumber(r.montoRec), formatNumber(r.costoTotalMes) 
                ]);
                
                let gTCB=0,gTMA=0,gTMR=0,gTCT=0; 
                desgloseDetalladoMensualM40Global.forEach(r => { gTCB+=r.costoBase; gTMA+=r.montoAct; gTMR+=r.montoRec; gTCT+=r.costoTotalMes; });
                body.push([ {content:'TOTAL PERIODO',colSpan:4,styles:{halign:'left',fontStyle:'bold'}}, formatNumber(gTCB), '', '', '', formatNumber(gTMA), '', '', '', formatNumber(gTMR),formatNumber(gTCT) ]);
                
                pdf.autoTable({ 
                    head:head, body:body, startY:70, theme:'grid', 
                    headStyles:{fillColor:[0,51,102],textColor:[255,255,255],fontSize:5.5,cellPadding:1.5}, 
                    bodyStyles:{fontSize:5,cellPadding:1}, alternateRowStyles:{fillColor:[240,244,248]}, 
                    columnStyles:{ 0:{halign:'left',cellWidth:40}, 1:{halign:'right',cellWidth:40}, 2:{halign:'right',cellWidth:18}, 3:{halign:'right',cellWidth:33}, 4:{halign:'right',cellWidth:48}, 5:{halign:'right',cellWidth:38}, 6:{halign:'right',cellWidth:38}, 7:{halign:'right',cellWidth:38}, 8:{halign:'right',cellWidth:48}, 9:{halign:'right',cellWidth:48}, 10:{halign:'right',cellWidth:28}, 11:{halign:'right',cellWidth:33}, 12:{halign:'right',cellWidth:48}, 13:{halign:'right',cellWidth:53} }, 
                    didParseCell: (data) => { if(data.row.index === body.length-1){ data.cell.styles.fontStyle='bold'; data.cell.styles.fillColor=[220,220,220]; data.cell.styles.textColor=[0,0,0]; } } 
                });
                pdf.save(`Desglose_ActRec_M40_${nombreCliente.replace(/\s+/g, '_')}.pdf`);
            } catch (e) {
                console.error("Error exporting Act/Rec PDF:", e);
                showCustomAlert("Error al generar el desglose en PDF.");
            } finally {
                exportButton.innerHTML = originalButtonContent;
                exportButton.disabled = false;
            }
        }
        
        async function generatePdfChartsAsImages(d) {
            try {
                // This function is no longer needed as charts are removed from the main PDF.
                // It can be kept for future use or removed.
                return {};
            } catch(e) {
                console.error("Error generating chart images for PDF:", e);
                showCustomAlert("Hubo un error al preparar las gráficas para el PDF.");
                return {};
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const agreementCheckbox = document.getElementById('agreementCheckbox');
            const acceptAgreementButton = document.getElementById('acceptAgreementButton');
            const agreementDateEl = document.getElementById('agreementDate');

            if (agreementDateEl) {
                agreementDateEl.textContent = new Date().toLocaleDateString('es-MX', { day: 'numeric', month: 'long', year: 'numeric' });
            }

            if (agreementCheckbox && acceptAgreementButton) {
                agreementCheckbox.addEventListener('change', () => {
                    acceptAgreementButton.disabled = !agreementCheckbox.checked;
                });
            }

            ['info_m40_p1_inicio', 'info_m40_p1_meses', 'info_aforeActual', 'info_tasaAfore', 'info_mesesInversionAfore', 'info_mesesPrimerDeposito', 'info_comisionExcedente', 'info_modoPrecisionContrato'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    const eventType = el.type === 'checkbox' || el.tagName === 'SELECT' ? 'change' : 'input';
                    if (id === 'info_m40_p1_inicio') {
                        el.addEventListener('change', () => {
                            actualizarSBCMaximoM40();
                            actualizarFechaFinM40Display();
                        });
                    } else if (id === 'info_m40_p1_meses') {
                        el.addEventListener('input', actualizarFechaFinM40Display);
                    } else if (id === 'info_modoPrecisionContrato') {
                        el.addEventListener('change', toggleModoPrecision);
                    } else {
                        el.addEventListener('input', recalcularCoberturaTrasCambio);
                    }
                }
            });

            document.querySelectorAll('.input-group input, .input-group select').forEach(el => el.classList.add('w-full'));
            document.querySelectorAll('.sbc-detalle-table input, .sbc-detalle-table select').forEach(el => el.classList.add('w-full', 'p-2', 'border', 'rounded'));
            
            const passwordField = document.getElementById('login_password');
            if (passwordField) {
                passwordField.addEventListener('keypress', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault(); 
                        handleLogin();
                    }
                });
            }
        });

    </script>
</body>
</html>

